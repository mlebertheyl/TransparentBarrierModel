





w3r2seed602.n30

```{r}
smalldist = 1.5
width = c(3, 3)
range = 2

max.edge.length = 0.4
n = 30
set.inla.seed = 602

x.mid <- 10
xlim.big <- c(0,20)
xlim.small <- c(3,17)
ylim.big <- c(0,20)
ylim.small <- c(3,17)

poly1 <- local.square.polygon(xlim=c(xlim.big[1]-1, x.mid-smalldist/2), 
                          ylim=x.mid+width[1]*c(-.5, .5))

poly2 <- local.square.polygon(xlim=c(x.mid+smalldist/2, xlim.big[2]+1), 
                          ylim=x.mid+width[2]*c(-.5, .5))

poly.original <- SpatialPolygons(c(poly1@polygons, poly2@polygons))
  
loc1 <- matrix(c(xlim.big[1],ylim.big[1], 
                 xlim.big[2],ylim.big[1], 
                 xlim.big[2],ylim.big[2], 
                 xlim.big[1],ylim.big[2]), 4, 2, byrow = T)
  
seg <- inla.sp2segment(poly.original)
# - Transforms a SpatialPolygon to an "inla polygon"
mesh <- inla.mesh.2d(loc=loc1, 
                     interior = seg, 
                     max.e = max.edge.length, 
                     offset=1)

tl <- length(mesh$graph$tv[,1])
# - the number of triangles in the mesh
posTri <- matrix(0, tl, 2)

for (t in 1:tl){
  temp = mesh$loc[mesh$graph$tv[t, ], ]
  posTri[t,] = colMeans(temp)[c(1,2)] 
}

posTri <- SpatialPoints(posTri)
# - the positions of the triangle centers

bar.original <- over(poly.original, SpatialPoints(posTri), returnList=T)
# - checking which mesh triangles are inside the barrier area
bar.original <- unlist(bar.original)
poly.bar.orginal <- inla.barrier.polygon(mesh, barrier.triangles = bar.original)
# - the Barrier model's polygon
# - in most cases this should be the same as poly.original

# BARRIER 1
bar1 <- over(poly1, SpatialPoints(posTri), returnList=T)
# - checking which mesh triangles are inside the barrier area
bar1 <- unlist(bar1)
poly.bar1 <- inla.barrier.polygon(mesh, barrier.triangles = bar1)
# - the Barrier model's polygon
# - in most cases this should be the same as poly.original

# BARRIER 2
bar2 <- over(poly2, SpatialPoints(posTri), returnList=T)
# - checking which mesh triangles are inside the barrier area
bar2 <- unlist(bar2)
poly.bar2 <- inla.barrier.polygon(mesh, barrier.triangles = bar2)

mat <-  inla.barrier.fem.plus(mesh, list(bar1, bar2)) 
fem <- mat 
barrier.triangles <- list(bar1, bar2)

# PLOTS
poly1_h <- local.square.polygon_T(xlim=c(xlim.small[1], x.mid-smalldist/2), 
                          ylim=x.mid+width[1]*c(-.5, .5))

poly2_h <- local.square.polygon_T(xlim=c(x.mid+smalldist/2, xlim.small[2]), 
                          ylim=x.mid+width[2]*c(-.5, .5))

loc2 <- matrix(c(3,3, 17,3, 17,17, 3,17), 4, 2, byrow = T)

locp2 <- Polygon(loc2, hole = FALSE)
    
poly.water <- SpatialPolygons(list(Polygons(list(locp2, poly1_h, poly2_h), '0')))
poly.water_sf <- st_as_sf(poly.water)
    
set.seed(set.inla.seed)
loc.data <- spsample(x = poly.water, n = n, type = "random")
loc.data_sf <- st_as_sf(loc.data)
loc.data <- loc.data@coords

poly.rect <- SpatialPolygons(list(Polygons(list(poly1_h, poly2_h), '0')))
poly.rect_sf <- st_as_sf(poly.rect)
poly.sq <- SpatialPolygons(list(Polygons(list(locp2), '0')))
poly.sq_sf <- st_as_sf(poly.sq)

sq_bbox <- st_bbox(poly.sq_sf) %>% st_as_sfc()
poly1_bbox <- st_bbox(poly1) %>% st_as_sfc()
poly2_bbox <- st_bbox(poly2) %>% st_as_sfc()

gg.mesh <- ggplot() + 
  inlabru::gg(mesh) +
  geom_sf(data =poly.rect_sf,
          col='black', alpha=0) + #alpha color inside rect
  geom_sf(data=poly1_bbox, fill=NA, color="red", linewidth = 0.7, linetype = "dashed") +
  geom_sf(data=poly2_bbox, fill=NA, color="red", linewidth = 0.7, linetype = "dashed") +
  geom_sf(data=sq_bbox, fill=NA, color="black", linewidth = 0.7)

gg.mesh.water <- ggplot() +
  inlabru::gg(mesh) +
  geom_sf(data =poly.rect_sf,
          col='black', alpha=1) + #alpha color inside rect
  geom_sf(data=sq_bbox, fill=NA, color="black", linewidth = 0.7) +
  geom_sf(data=poly1_bbox, color="black", linewidth = 0.7) +
  geom_sf(data=poly2_bbox, color="black", linewidth = 0.7) +
  ylim(c(3, 17)) +
  xlim(c(3, 17))

gg.mesh +
  geom_sf(data =loc.data_sf,
          col='black',size=1.7,alpha=0.5)

gg.mesh.water +
  geom_sf(data =loc.data_sf,
          col='black',size=1.7,alpha=0.5)

gg2b.1 <- gg.mesh +
  ggtitle("Mesh")

gg2b.2 <- gg.mesh.water +
  ggtitle("Barrier layout")

gg2b.3 <- gg.mesh.water +
  geom_sf(data =loc.data_sf,
          col='black',size=1.7,alpha=0.5) +
  ggtitle("Simulated data")

if (!dir.exists(dir)) dir.create(dir)
fpp <- file.path("2b_mesh.png")
#png(fpp)
gridExtra::grid.arrange(gg2b.1, gg2b.2, gg2b.3, ncol=3, nrow=2, 
               top="Two barriers scenario")
dev.off()
```


0.5*diff(range(cords_Dng.xy[,2])) = 40.94401

```{r}
#0.5*diff(range(loc.data[,2])) = 6.721543
nfrac = 3
max.frac = 0.3
min.r = 0.01
fr <- (seq(from = min.r, 
          to = max.frac, 
          length = nfrac)) #*range
tbm.frac <- list()

prior.range <- c(6, 0.5)

if (fr[1] < min.r) fr[1] <- min.r
for (r in 1:nfrac) { #
  f <- fr[r]
  range.fraction <- c(f, f)
  tbm.frac[[r]] <- model.tbm(mesh = mesh, fem = fem, 
              barrier.triangles = barrier.triangles,
              prior.range = prior.range, prior.sigma = c(1, 0.1),  
              range.fraction = range.fraction,
              range = range,
              set.inla.seed = set.inla.seed, # make sure is the same as prev. fx if loc.data = T
              loc.data = loc.data, 
              sigma.u = 1, sigma.epsilon = 0.2,
              poly.original = poly.bar.orginal,
              prior.range.st = c(1, 0.5),
              prior.sigma.st = c(1, 0.1),
              return.list = TRUE
    )
}

trans <- tbm.frac
#w3r2seed602.n30 <- tbm.frac

plot.model.tbm.flex3(trans, 
                     fr,
                     nfrac,
                     max.frac = max.frac,
                     min.r = 0.01,
                     poly.bar.orginal = poly.bar.orginal,
                     range = range,
                     fps = 1)

for (r in 1:length(trans)) {
  f <- fr[r]
  range.fraction <- c(f, f)
  fpp <- file.path(paste0(f, ".png"))
  png(fpp)
  par(mfrow = c(2, 1))
  tmp = inla.tmarginal(function(x) exp(x), trans[[r]]$pos.bm$res$marginals.hyperpar[[3]]) 
  plot(tmp, type = "l", xlab = "r", ylab = "Density", xlim = c(0,8))
      xvals = seq(0, 10, length.out=1000)
      
  abline(v=range, col="blue")
  
  tmp = inla.tmarginal(function(x) (x), trans[[r]]$pos.st$res$marginals.hyperpar[[2]]) 
  plot(tmp, type = "l", xlab = "r", ylab = "Density", xlim = c(0,8))
      xvals = seq(0, 10, length.out=1000)
  abline(v=range, col="blue")
  dev.off()
}

```

w3r2seed602.n30

```{r}
trial.geom <- 
function(smalldist,
         width,
         range,
         max.edge.length,
         n,
         set.inla.seed,
         x.mid = 10,
         xlim.big  = c(0,20),
         xlim.small = c(3,17),
         ylim.big = c(0,20),
         ylim.small = c(3,17),
         fr,
         prior.range,
         prior.sigma,
         sigma.u = 1, 
         sigma.epsilon = 0.2,
         prior.range.st,
         prior.sigma.st,
         gif.path = "gif/",
         marginals.path = "gif/marginals/"){
  
  poly1 <- local.square.polygon(xlim=c(xlim.big[1]-1, x.mid-smalldist/2), 
                          ylim=x.mid+width[1]*c(-.5, .5))

  poly2 <- local.square.polygon(xlim=c(x.mid+smalldist/2, xlim.big[2]+1), 
                          ylim=x.mid+width[2]*c(-.5, .5))

  poly.original <- SpatialPolygons(c(poly1@polygons, poly2@polygons))
  
  loc1 <- matrix(c(xlim.big[1],ylim.big[1], 
                   xlim.big[2],ylim.big[1], 
                   xlim.big[2],ylim.big[2], 
                   xlim.big[1],ylim.big[2]), 4, 2, byrow = T)
  
  seg <- inla.sp2segment(poly.original)
# - Transforms a SpatialPolygon to an "inla polygon"
  mesh <- inla.mesh.2d(loc=loc1, 
                      interior = seg, 
                       max.e = max.edge.length, 
                       offset=1)

  tl <- length(mesh$graph$tv[,1])
# - the number of triangles in the mesh
  posTri <- matrix(0, tl, 2)

  for (t in 1:tl){
    temp = mesh$loc[mesh$graph$tv[t, ], ]
    posTri[t,] = colMeans(temp)[c(1,2)] 
}

  posTri <- SpatialPoints(posTri)
# - the positions of the triangle centers

  bar.original <- over(poly.original, SpatialPoints(posTri), returnList=T)
# - checking which mesh triangles are inside the barrier area
  bar.original <- unlist(bar.original)
  poly.bar.orginal <- inla.barrier.polygon(mesh, barrier.triangles = bar.original)
# - the Barrier model's polygon
# - in most cases this should be the same as poly.original

# BARRIER 1
  bar1 <- over(poly1, SpatialPoints(posTri), returnList=T)
# - checking which mesh triangles are inside the barrier area
  bar1 <- unlist(bar1)
  poly.bar1 <- inla.barrier.polygon(mesh, barrier.triangles = bar1)
# - the Barrier model's polygon
# - in most cases this should be the same as poly.original

# BARRIER 2
  bar2 <- over(poly2, SpatialPoints(posTri), returnList=T)
# - checking which mesh triangles are inside the barrier area
  bar2 <- unlist(bar2)
  poly.bar2 <- inla.barrier.polygon(mesh, barrier.triangles = bar2)

  mat <-  inla.barrier.fem.plus(mesh, list(bar1, bar2)) 
  fem <- mat 
  barrier.triangles <- list(bar1, bar2)

# PLOTS
  poly1_h <- local.square.polygon_T(xlim=c(xlim.small[1], x.mid-smalldist/2), 
                            ylim=x.mid+width[1]*c(-.5, .5))

  poly2_h <- local.square.polygon_T(xlim=c(x.mid+smalldist/2, xlim.small[2]), 
                            ylim=x.mid+width[2]*c(-.5, .5))

  loc2 <- matrix(c(3,3, 17,3, 17,17, 3,17), 4, 2, byrow = T)

  locp2 <- Polygon(loc2, hole = FALSE)
    
  poly.water <- SpatialPolygons(list(Polygons(list(locp2, poly1_h, poly2_h), '0')))
  poly.water_sf <- st_as_sf(poly.water)
    
  set.seed(set.inla.seed)
  loc.data <- spsample(x = poly.water, n = n, type = "random")
  loc.data_sf <- st_as_sf(loc.data)
  loc.data <- loc.data@coords

  poly.rect <- SpatialPolygons(list(Polygons(list(poly1_h, poly2_h), '0')))
  poly.rect_sf <- st_as_sf(poly.rect)
  poly.sq <- SpatialPolygons(list(Polygons(list(locp2), '0')))
  poly.sq_sf <- st_as_sf(poly.sq)

  sq_bbox <- st_bbox(poly.sq_sf) %>% st_as_sfc()
  poly1_bbox <- st_bbox(poly1) %>% st_as_sfc()
  poly2_bbox <- st_bbox(poly2) %>% st_as_sfc()

  gg.mesh <- ggplot() + 
    inlabru::gg(mesh) +
    geom_sf(data =poly.rect_sf,
            col='black', alpha=0) + #alpha color inside rect
    geom_sf(data=poly1_bbox, fill=NA, color="red", linewidth = 0.7, linetype = "dashed") +
    geom_sf(data=poly2_bbox, fill=NA, color="red", linewidth = 0.7, linetype = "dashed") +
    geom_sf(data=sq_bbox, fill=NA, color="black", linewidth = 0.7)

  gg.mesh.water <- ggplot() +
    inlabru::gg(mesh) +
    geom_sf(data =poly.rect_sf,
            col='black', alpha=1) + #alpha color inside rect
    geom_sf(data=sq_bbox, fill=NA, color="black", linewidth = 0.7) +
    geom_sf(data=poly1_bbox, color="black", linewidth = 0.7) +
    geom_sf(data=poly2_bbox, color="black", linewidth = 0.7) +
    ylim(c(3, 17)) +
    xlim(c(3, 17))

  gg.mesh.data <- gg.mesh +
    geom_sf(data =loc.data_sf,
            col='black',size=1.7,alpha=0.5)

  gg.mesh.water.data <- gg.mesh.water +
    geom_sf(data =loc.data_sf,
            col='black',size=1.7,alpha=0.5)
  gg <- list(mesh = gg.mesh, mesh.water = gg.mesh.water, mesh.data = gg.mesh.data, mesh.water.data = gg.mesh.water.data)
  ###
  tbm.frac <- list()

  for (r in 1:length(fr)) { #
    f <- fr[r]
    range.fraction <- c(f, f)
    tbm.frac[[r]] <- model.tbm(mesh = mesh, fem = fem, 
                               barrier.triangles = barrier.triangles,
                               prior.range = prior.range, prior.sigma = prior.sigma ,  
                               range.fraction = range.fraction,
                               range = range,
                               set.inla.seed = set.inla.seed,
                               loc.data = loc.data,
                               sigma.u = 1, sigma.epsilon = 0.2,
                               poly.original = poly.bar.orginal,
                               prior.range.st = prior.range.st,
                               prior.sigma.st = prior.sigma.st,
                               return.list = TRUE)
  }
  
  trans <- tbm.frac
#w3r2seed602.n30 <- tbm.frac

  plot.model.tbm.flex3(trans, 
                       fr,
                       poly.bar.orginal = poly.bar.orginal,
                       range = range,
                       fps = 1,
                       gif.path = gif.path)

  for (r in 1:length(trans)) {
    f <- fr[r]
    range.fraction <- c(f, f)
    fpp <- file.path(paste0(marginals.path, f, ".png"))
    png(fpp)
    par(mfrow = c(2, 1))
    tmp = inla.tmarginal(function(x) exp(x), trans[[r]]$pos.bm$res$marginals.hyperpar[[3]]) 
    plot(tmp, type = "l", xlab = "r", ylab = "Density", xlim = c(0,8))
         xvals = seq(0, 10, length.out=1000)
      
    abline(v=range, col="blue")
  
    tmp = inla.tmarginal(function(x) (x), trans[[r]]$pos.st$res$marginals.hyperpar[[2]]) 
    plot(tmp, type = "l", xlab = "r", ylab = "Density", xlim = c(0,8))
         xvals = seq(0, 10, length.out=1000)
    abline(v=range, col="blue")
    dev.off()
  }
  return.list <- list(gg=gg, trans = tbm.frac)
  return(return.list)

}


```


```{r}
nfrac = 3
max.frac = 0.3
min.r = 0.01
fr <- (seq(from = min.r, 
          to = max.frac, 
          length = nfrac)) #*range

prior.range <- c(6, 0.5)

trial <- trial.geom(smalldist = 1.5,
         width = c(3,3),
         range = 2,
         max.edge.length = 0.4,
         n = 30,
         set.inla.seed = 702,
         x.mid = 10,
         xlim.big  = c(0,20),
         xlim.small = c(3,17),
         ylim.big = c(0,20),
         ylim.small = c(3,17),
         fr = fr,
         prior.range = prior.range,
         prior.sigma = c(1,0.1),
         sigma.u = 1, 
         sigma.epsilon = 0.2,
         prior.range.st = prior.range,
         prior.sigma.st = c(1,0.1))
#w3r2seed702.n30 <- trial

trial <- trial.geom(smalldist = 1.5,
         width = c(3,3),
         range = 3.2,
         max.edge.length = 0.4,
         n = 30,
         set.inla.seed = 702,
         x.mid = 10,
         xlim.big  = c(0,20),
         xlim.small = c(3,17),
         ylim.big = c(0,20),
         ylim.small = c(3,17),
         fr = fr,
         prior.range = prior.range,
         prior.sigma = c(1,0.1),
         sigma.u = 1, 
         sigma.epsilon = 0.2,
         prior.range.st = prior.range,
         prior.sigma.st = c(1,0.1))
#w3r3.2seed702.n30 <- trial

trial <- trial.geom(smalldist = 1.5,
         width = c(3,3),
         range = 4,
         max.edge.length = 0.4,
         n = 30,
         set.inla.seed = 702,
         x.mid = 10,
         xlim.big  = c(0,20),
         xlim.small = c(3,17),
         ylim.big = c(0,20),
         ylim.small = c(3,17),
         fr = fr,
         prior.range = prior.range,
         prior.sigma = c(1,0.1),
         sigma.u = 1, 
         sigma.epsilon = 0.2,
         prior.range.st = prior.range,
         prior.sigma.st = c(1,0.1))
#w3r4.2seed702.n30 <- trial

trial <- trial.geom(smalldist = 1.5,
         width = c(3,3),
         range = 3,
         max.edge.length = 0.4,
         n = 60,
         set.inla.seed = 702,
         x.mid = 10,
         xlim.big  = c(0,20),
         xlim.small = c(3,17),
         ylim.big = c(0,20),
         ylim.small = c(3,17),
         fr = fr,
         prior.range = prior.range,
         prior.sigma = c(1,0.1),
         sigma.u = 1, 
         sigma.epsilon = 0.2,
         prior.range.st = prior.range,
         prior.sigma.st = c(1,0.1))
#w3r3.2seed702.n60 <- trial #NOT VERY GOOD

trial <- trial.geom(smalldist = 1.5,
         width = c(3,3),
         range = 3,
         max.edge.length = 0.4,
         n = 30,
         set.inla.seed = 802,
         x.mid = 10,
         xlim.big  = c(0,20),
         xlim.small = c(3,17),
         ylim.big = c(0,20),
         ylim.small = c(3,17),
         fr = fr,
         prior.range = prior.range,
         prior.sigma = c(1,0.1),
         sigma.u = 1, 
         sigma.epsilon = 0.2,
         prior.range.st = prior.range,
         prior.sigma.st = c(1,0.1))
#w3r3.2seed802.n30 <- trial #NOT VERY GOOD

trial <- trial.geom(smalldist = 1.5,
         width = c(3,3),
         range = 3,
         max.edge.length = 0.4,
         n = 50,
         set.inla.seed = 1702,
         x.mid = 10,
         xlim.big  = c(0,20),
         xlim.small = c(3,17),
         ylim.big = c(0,20),
         ylim.small = c(3,17),
         fr = fr,
         prior.range = prior.range,
         prior.sigma = c(1,0.1),
         sigma.u = 1, 
         sigma.epsilon = 0.2,
         prior.range.st = prior.range,
         prior.sigma.st = c(1,0.1))
#w3r3.2seed1702.n50 <- trial #NOT VERY GOOD

trial <- trial.geom(smalldist = 1.5,
         width = c(3,3),
         range = 2.5,
         max.edge.length = 0.4,
         n = 40,
         set.inla.seed = 902,
         x.mid = 10,
         xlim.big  = c(0,20),
         xlim.small = c(3,17),
         ylim.big = c(0,20),
         ylim.small = c(3,17),
         fr = fr,
         prior.range = prior.range,
         prior.sigma = c(1,0.1),
         sigma.u = 1, 
         sigma.epsilon = 0.2,
         prior.range.st = prior.range,
         prior.sigma.st = c(1,0.1))
#w3r2.5.2seed902.n40 <- trial #NOT VERY GOOD
```


```{r}
trial <- trial.geom(smalldist = 1.5,
         width = c(3,3),
         range = 5,
         max.edge.length = 0.4,
         n = 30,
         set.inla.seed = 702,
         x.mid = 10,
         xlim.big  = c(0,20),
         xlim.small = c(3,17),
         ylim.big = c(0,20),
         ylim.small = c(3,17),
         fr = fr,
         prior.range = prior.range,
         prior.sigma = c(1,0.1),
         sigma.u = 1, 
         sigma.epsilon = 0.2,
         prior.range.st = prior.range,
         prior.sigma.st = c(1,0.1))

#w3r5.2seed702.n30 <- trial

trial <- trial.geom(smalldist = 1.5,
         width = c(3,3),
         range = 6,
         max.edge.length = 0.4,
         n = 80,
         set.inla.seed = 702,
         x.mid = 10,
         xlim.big  = c(0,20),
         xlim.small = c(3,17),
         ylim.big = c(0,20),
         ylim.small = c(3,17),
         fr = fr,
         prior.range = prior.range,
         prior.sigma = c(1,0.1),
         sigma.u = 1, 
         sigma.epsilon = 0.2,
         prior.range.st = prior.range,
         prior.sigma.st = c(1,0.1))
#w3r6.2seed702.n80 <- trial #NOT VERY GOOD
```

```{r}
trial <- trial.geom.plus(smalldist = 1.5,
         width = c(2,2),
         range = 6,
         max.edge.length = 0.4,
         n = 80,
         set.inla.seed = 702,
         x.mid = 10,
         xlim.big  = c(0,20),
         xlim.small = c(3,17),
         ylim.big = c(0,20),
         ylim.small = c(3,17),
         fr = fr,
         prior.range = prior.range,
         prior.sigma = c(1,0.1),
         sigma.u = 1, 
         sigma.epsilon = 0.2,
         prior.range.st = prior.range,
         prior.sigma.st = c(1,0.1))

#w2r6.2seed702.n80 <- trial
```


```{r}
fr <- c(fr, 0.5)
trial <- trial.geom.plus(smalldist = 1.5,
         width = c(1,1),
         range = 6,
         max.edge.length = 0.4,
         n = 80,
         set.inla.seed = 702,
         x.mid = 10,
         xlim.big  = c(0,20),
         xlim.small = c(3,17),
         ylim.big = c(0,20),
         ylim.small = c(3,17),
         fr = fr,
         prior.range = prior.range,
         prior.sigma = c(1,0.1),
         sigma.u = 1, 
         sigma.epsilon = 0.2,
         prior.range.st = prior.range,
         prior.sigma.st = c(1,0.1))
```

trial.geom.plus solo esta funcionando si corro smalldist, width, etc first

```{r}
fr <- fr[3]
smalldist = 1.5
         width = c(2,2)
         range = 4
         max.edge.length = 0.4
         n = 25
         set.inla.seed = 702
         x.mid = 10
         xlim.big  = c(0,20)
         xlim.small = c(3,17)
         ylim.big = c(0,20)
         ylim.small = c(3,17)
         fr = fr
         prior.range = prior.range
         prior.sigma = c(1,0.1)
         sigma.u = 1
         sigma.epsilon = 0.2
         prior.range.st = prior.range
         prior.sigma.st = c(1,0.1)


  poly1 <- local.square.polygon(xlim=c(xlim.big[1]-1, x.mid-smalldist/2), 
                          ylim=x.mid+width[1]*c(-.5, .5))

  poly2 <- local.square.polygon(xlim=c(x.mid+smalldist/2, xlim.big[2]+1), 
                          ylim=x.mid+width[2]*c(-.5, .5))

  poly.original <- SpatialPolygons(c(poly1@polygons, poly2@polygons))
  
  loc1 <- matrix(c(xlim.big[1],ylim.big[1], 
                   xlim.big[2],ylim.big[1], 
                   xlim.big[2],ylim.big[2], 
                   xlim.big[1],ylim.big[2]), 4, 2, byrow = T)
  
  seg <- inla.sp2segment(poly.original)
# - Transforms a SpatialPolygon to an "inla polygon"
  mesh <- inla.mesh.2d(loc=loc1, 
                      interior = seg, 
                       max.e = max.edge.length, 
                       offset=1)

  tl <- length(mesh$graph$tv[,1])
# - the number of triangles in the mesh
  posTri <- matrix(0, tl, 2)

  for (t in 1:tl){
    temp = mesh$loc[mesh$graph$tv[t, ], ]
    posTri[t,] = colMeans(temp)[c(1,2)] 
}

  posTri <- SpatialPoints(posTri)
# - the positions of the triangle centers

  bar.original <- over(poly.original, SpatialPoints(posTri), returnList=T)
# - checking which mesh triangles are inside the barrier area
  bar.original <- unlist(bar.original)
  poly.bar.orginal <- inla.barrier.polygon(mesh, barrier.triangles = bar.original)
# - the Barrier model's polygon
# - in most cases this should be the same as poly.original

# BARRIER 1
  bar1 <- over(poly1, SpatialPoints(posTri), returnList=T)
# - checking which mesh triangles are inside the barrier area
  bar1 <- unlist(bar1)
  poly.bar1 <- inla.barrier.polygon(mesh, barrier.triangles = bar1)
# - the Barrier model's polygon
# - in most cases this should be the same as poly.original

# BARRIER 2
  bar2 <- over(poly2, SpatialPoints(posTri), returnList=T)
# - checking which mesh triangles are inside the barrier area
  bar2 <- unlist(bar2)
  poly.bar2 <- inla.barrier.polygon(mesh, barrier.triangles = bar2)

  mat <-  inla.barrier.fem.plus(mesh, list(bar1, bar2)) 
  fem <- mat 
  barrier.triangles <- list(bar1, bar2)

# PLOTS
  poly1_h <- local.square.polygon_T(xlim=c(xlim.small[1], x.mid-smalldist/2), 
                            ylim=x.mid+width[1]*c(-.5, .5))

  poly2_h <- local.square.polygon_T(xlim=c(x.mid+smalldist/2, xlim.small[2]), 
                            ylim=x.mid+width[2]*c(-.5, .5))

  loc2 <- matrix(c(3,3, 17,3, 17,17, 3,17), 4, 2, byrow = T)

  locp2 <- Polygon(loc2, hole = FALSE)
    
  poly.water <- SpatialPolygons(list(Polygons(list(locp2, poly1_h, poly2_h), '0')))
  poly.water_sf <- st_as_sf(poly.water)
    
  set.seed(set.inla.seed)
  loc.data <- spsample(x = poly.water, n = n, type = "random")
  loc.data_sf <- st_as_sf(loc.data)
  loc.data <- loc.data@coords

  poly.rect <- SpatialPolygons(list(Polygons(list(poly1_h, poly2_h), '0')))
  poly.rect_sf <- st_as_sf(poly.rect)
  poly.sq <- SpatialPolygons(list(Polygons(list(locp2), '0')))
  poly.sq_sf <- st_as_sf(poly.sq)

  sq_bbox <- st_bbox(poly.sq_sf) %>% st_as_sfc()
  poly1_bbox <- st_bbox(poly1) %>% st_as_sfc()
  poly2_bbox <- st_bbox(poly2) %>% st_as_sfc()

  gg.mesh <- ggplot() + 
    inlabru::gg(mesh) +
    geom_sf(data =poly.rect_sf,
            col='black', alpha=0) + #alpha color inside rect
    geom_sf(data=poly1_bbox, fill=NA, color="red", linewidth = 0.7, linetype = "dashed") +
    geom_sf(data=poly2_bbox, fill=NA, color="red", linewidth = 0.7, linetype = "dashed") +
    geom_sf(data=sq_bbox, fill=NA, color="black", linewidth = 0.7)

  gg.mesh.water <- ggplot() +
    inlabru::gg(mesh) +
    geom_sf(data =poly.rect_sf,
            col='black', alpha=1) + #alpha color inside rect
    geom_sf(data=sq_bbox, fill=NA, color="black", linewidth = 0.7) +
    geom_sf(data=poly1_bbox, color="black", linewidth = 0.7) +
    geom_sf(data=poly2_bbox, color="black", linewidth = 0.7) +
    ylim(c(3, 17)) +
    xlim(c(3, 17))

  gg.mesh.data <- gg.mesh +
    geom_sf(data =loc.data_sf,
            col='black',size=1.7,alpha=0.5)

  gg.mesh.water.data <- gg.mesh.water +
    geom_sf(data =loc.data_sf,
            col='black',size=1.7,alpha=0.5)
  gg <- list(mesh = gg.mesh, mesh.water = gg.mesh.water, mesh.data = gg.mesh.data, mesh.water.data = gg.mesh.water.data)
  ###
  tbm.frac <- list()

  for (r in 1:length(fr)) { #
    f <- fr[r]
    range.fraction <- c(f, f)
    tbm.frac[[r]] <- model.tbm.plus(mesh = mesh, fem = fem, 
                               barrier.triangles = barrier.triangles,
                               prior.range = prior.range, prior.sigma = prior.sigma ,  
                               range.fraction = range.fraction,
                               range = range,
                               set.inla.seed = set.inla.seed,
                               loc.data = loc.data,
                               sigma.u = 1, sigma.epsilon = 0.2,
                               poly.original = poly.bar.orginal,
                               prior.range.st = prior.range.st,
                               prior.sigma.st = prior.sigma.st,
                               return.list = TRUE)
  }
  
  trans <- tbm.frac
  plot.model.tbm.plus(trans, 
                       fr,
                       poly.bar.orginal = poly.bar.orginal,
                       range = range,
                       fps = 1,
                       gif.path = gif.path)

  for (r in 1:length(trans)) {
    f <- fr[r]
    range.fraction <- c(f, f)
    fpp <- file.path(paste0(marginals.path, f, ".png"))
    png(fpp)
    par(mfrow = c(3, 1))
    tmp = inla.tmarginal(function(x) exp(x), trans[[r]]$pos.tbm$res$marginals.hyperpar[[3]]) 
    plot(tmp, type = "l", xlab = "r", ylab = "Density", xlim = c(0,8))
         xvals = seq(0, 10, length.out=1000)
      
    abline(v=range, col="blue")
    
    tmp = inla.tmarginal(function(x) exp(x), trans[[r]]$pos.bm$res$marginals.hyperpar[[3]]) 
    plot(tmp, type = "l", xlab = "r", ylab = "Density", xlim = c(0,8))
         xvals = seq(0, 10, length.out=1000)
      
    abline(v=range, col="blue")
  
    tmp = inla.tmarginal(function(x) (x), trans[[r]]$pos.st$res$marginals.hyperpar[[2]]) 
    plot(tmp, type = "l", xlab = "r", ylab = "Density", xlim = c(0,8))
         xvals = seq(0, 10, length.out=1000)
    abline(v=range, col="blue")
    dev.off()
  }
  
#w2r4.2seed702.n25 <- trans
```

```{r}
fp <- file.path("gif", paste0("sm", SM[1], "w", W[1], "r", R[1], "seed", SS[1], ".n", N[1]))
dir.create(fp, recursive = TRUE)
paste0("sm", SM[1], "w", W[1], "r", R[1], "seed", SS[1], ".n", N[1])

as.character(SM[1])
###
SM <- c(0.5, 1.5)
W <- c(2, 3, 4)
R <- seq(2, 6, 1)
SS <- floor(runif(10, 1, 10000))
fr <- 0.3
N <- c(30, 50, 80)

for (d in 1:length(SM)) {
  for (w in 1:length(W)) {
    for(r in 1:length(R)) {
      for (s in 1:length(SS)) {
        for (n in 1:length(N)) {
          fp <- file.path("gif", paste0("sm", SM[d], "w", W[w], "r", R[r], "seed", SS[s], ".n", N[n]))
          dir.create(fp, recursive = TRUE)
          
          smalldist = SM[d]
          width = c(W[w],W[w])
          range = R[r]
          max.edge.length = 0.4
          n = N[n]
          set.inla.seed = SS[s]
          x.mid = 10
          xlim.big  = c(0,20)
          xlim.small = c(3,17)
          ylim.big = c(0,20)
          ylim.small = c(3,17)
          fr = fr
          prior.range = prior.range
          prior.sigma = c(1,0.1)
          sigma.u = 1
          sigma.epsilon = 0.2
          prior.range.st = prior.range
          prior.sigma.st = c(1,0.1)
          gif.path = fp
          marginals.path = fp
         
          trial <- 
            trial.geom.plus(smalldist = SM[d],
                            width = c(W[w],W[w]),
                            range = R[r],
                            max.edge.length = 0.4,
                            n = N[n],
                            set.inla.seed = SS[s],
                            x.mid = 10,
                            xlim.big  = c(0,20),
                            xlim.small = c(3,17),
                            ylim.big = c(0,20),
                            ylim.small = c(3,17),
                            fr = fr,
                            prior.range = prior.range,
                            prior.sigma = c(1,0.1),
                            sigma.u = 1, 
                            sigma.epsilon = 0.2,
                            prior.range.st = prior.range,
                            prior.sigma.st = c(1,0.1),
                            gif.path = fp,
                            marginals.path = fp)
        }
        
      }
    }
  }
  
}


fp <- file.path("gif", paste0("sm", SM[1], "w", W[1], "r", R[1], "seed", SS[1], ".n", N[1], "/"))
          dir.create(fp, recursive = TRUE)
          
          smalldist = SM[1]
          width = c(W[1],W[1])
          range = R[1]
          max.edge.length = 0.4
          n = N[1]
          set.inla.seed = SS[1]
          x.mid = 10
          xlim.big  = c(0,20)
          xlim.small = c(3,17)
          ylim.big = c(0,20)
          ylim.small = c(3,17)
          fr = fr
          prior.range = prior.range
          prior.sigma = c(1,0.1)
          sigma.u = 1
          sigma.epsilon = 0.2
          prior.range.st = prior.range
          prior.sigma.st = c(1,0.1)
    
          
          smalldist = 1.5
         width = c(2,2)
         range = 4
         max.edge.length = 0.4
         n = 25
         set.inla.seed = 702
         x.mid = 10
         xlim.big  = c(0,20)
         xlim.small = c(3,17)
         ylim.big = c(0,20)
         ylim.small = c(3,17)
         fr = fr
         prior.range = prior.range
         prior.sigma = c(1,0.1)
         sigma.u = 1
         sigma.epsilon = 0.2
         prior.range.st = prior.range
         prior.sigma.st = c(1,0.1)

         
          trial <- 
            trial.geom.plus(smalldist = SM[1],
                            width = c(W[1],W[1]),
                            range = R[1],
                            max.edge.length = 0.4,
                            n = N[1],
                            set.inla.seed = SS[1],
                            x.mid = 10,
                            xlim.big  = c(0,20),
                            xlim.small = c(3,17),
                            ylim.big = c(0,20),
                            ylim.small = c(3,17),
                            fr = fr,
                            prior.range = prior.range,
                            prior.sigma = c(1,0.1),
                            sigma.u = 1, 
                            sigma.epsilon = 0.2,
                            prior.range.st = prior.range,
                            prior.sigma.st = c(1,0.1),
                            gif.path = fp,
                            marginals.path = fp)
         
trial <- trial.geom.plus(smalldist = 1.5,
         width = c(2,2),
         range = 4,
         max.edge.length = 0.4,
         n = 50,
         set.inla.seed = 1002,
         x.mid = 10,
         xlim.big  = c(0,20),
         xlim.small = c(3,17),
         ylim.big = c(0,20),
         ylim.small = c(3,17),
         fr = fr,
         prior.range = prior.range,
         prior.sigma = c(1,0.1),
         sigma.u = 1, 
         sigma.epsilon = 0.2,
         prior.range.st = prior.range,
         prior.sigma.st = c(1,0.1))
#w2r4.2seed702.n40 <- trial

```
Geom 1, 2 barriers range fraction varies equally in both

```{r}
SM <- c(1.5)
W <- c(2, 3)
R <- seq(2, 5, 1)
SS <- floor(runif(5, 1, 1000))
fr <- 0.3
N <- c(50)

for (s in 1:length(SS)) {
  for (d in 1:length(SM)) {
    for (w in 1:length(W)) {
      for(r in 1:length(R)) {
        for (n in 1:length(N)) {
          fp <- file.path("gif", paste0("sm", SM[d], "w", W[w], "r", R[r], "seed", SS[s], ".n", N[n], "/"))
          dir.create(fp, recursive = TRUE)
          
          smalldist = SM[d]
          width = c(W[w],W[w])
          range = R[r]
          max.edge.length = 0.4
          n = N[n]
          set.inla.seed = SS[s]
          x.mid = 10
          xlim.big  = c(0,20)
          xlim.small = c(3,17)
          ylim.big = c(0,20)
          ylim.small = c(3,17)
          fr = fr
          prior.range = prior.range
          prior.sigma = c(1,0.1)
          sigma.u = 1
          sigma.epsilon = 0.2
          prior.range.st = prior.range
          prior.sigma.st = c(1,0.1)
          gif.path = fp
          marginals.path = fp


  poly1 <- local.square.polygon(xlim=c(xlim.big[1]-1, x.mid-smalldist/2), 
                          ylim=x.mid+width[1]*c(-.5, .5))

  poly2 <- local.square.polygon(xlim=c(x.mid+smalldist/2, xlim.big[2]+1), 
                          ylim=x.mid+width[2]*c(-.5, .5))

  poly.original <- SpatialPolygons(c(poly1@polygons, poly2@polygons))
  
  loc1 <- matrix(c(xlim.big[1],ylim.big[1], 
                   xlim.big[2],ylim.big[1], 
                   xlim.big[2],ylim.big[2], 
                   xlim.big[1],ylim.big[2]), 4, 2, byrow = T)
  
  seg <- inla.sp2segment(poly.original)
# - Transforms a SpatialPolygon to an "inla polygon"
  mesh <- inla.mesh.2d(loc=loc1, 
                      interior = seg, 
                       max.e = max.edge.length, 
                       offset=1)

  tl <- length(mesh$graph$tv[,1])
# - the number of triangles in the mesh
  posTri <- matrix(0, tl, 2)

  for (t in 1:tl){
    temp = mesh$loc[mesh$graph$tv[t, ], ]
    posTri[t,] = colMeans(temp)[c(1,2)] 
}

  posTri <- SpatialPoints(posTri)
# - the positions of the triangle centers

  bar.original <- over(poly.original, SpatialPoints(posTri), returnList=T)
# - checking which mesh triangles are inside the barrier area
  bar.original <- unlist(bar.original)
  poly.bar.orginal <- inla.barrier.polygon(mesh, barrier.triangles = bar.original)
# - the Barrier model's polygon
# - in most cases this should be the same as poly.original

# BARRIER 1
  bar1 <- over(poly1, SpatialPoints(posTri), returnList=T)
# - checking which mesh triangles are inside the barrier area
  bar1 <- unlist(bar1)
  poly.bar1 <- inla.barrier.polygon(mesh, barrier.triangles = bar1)
# - the Barrier model's polygon
# - in most cases this should be the same as poly.original

# BARRIER 2
  bar2 <- over(poly2, SpatialPoints(posTri), returnList=T)
# - checking which mesh triangles are inside the barrier area
  bar2 <- unlist(bar2)
  poly.bar2 <- inla.barrier.polygon(mesh, barrier.triangles = bar2)

  mat <-  inla.barrier.fem.plus(mesh, list(bar1, bar2)) 
  fem <- mat 
  barrier.triangles <- list(bar1, bar2)

# PLOTS
  poly1_h <- local.square.polygon_T(xlim=c(xlim.small[1], x.mid-smalldist/2), 
                            ylim=x.mid+width[1]*c(-.5, .5))

  poly2_h <- local.square.polygon_T(xlim=c(x.mid+smalldist/2, xlim.small[2]), 
                            ylim=x.mid+width[2]*c(-.5, .5))

  loc2 <- matrix(c(3,3, 17,3, 17,17, 3,17), 4, 2, byrow = T)

  locp2 <- Polygon(loc2, hole = FALSE)
    
  poly.water <- SpatialPolygons(list(Polygons(list(locp2, poly1_h, poly2_h), '0')))
  poly.water_sf <- st_as_sf(poly.water)
    
  set.seed(set.inla.seed)
  loc.data <- spsample(x = poly.water, n = n, type = "random")
  loc.data_sf <- st_as_sf(loc.data)
  loc.data <- loc.data@coords

  poly.rect <- SpatialPolygons(list(Polygons(list(poly1_h, poly2_h), '0')))
  poly.rect_sf <- st_as_sf(poly.rect)
  poly.sq <- SpatialPolygons(list(Polygons(list(locp2), '0')))
  poly.sq_sf <- st_as_sf(poly.sq)

  sq_bbox <- st_bbox(poly.sq_sf) %>% st_as_sfc()
  poly1_bbox <- st_bbox(poly1) %>% st_as_sfc()
  poly2_bbox <- st_bbox(poly2) %>% st_as_sfc()

  tbm.frac <- list()

  for (p in 1:length(fr)) { #
    f <- fr[p]
    range.fraction <- c(f, f)
    tbm.frac[[p]] <- model.tbm.plus(mesh = mesh, fem = fem, 
                               barrier.triangles = barrier.triangles,
                               prior.range = prior.range, prior.sigma = prior.sigma ,  
                               range.fraction = range.fraction,
                               range = range,
                               set.inla.seed = set.inla.seed,
                               loc.data = loc.data,
                               sigma.u = 1, sigma.epsilon = 0.2,
                               poly.original = poly.bar.orginal,
                               prior.range.st = prior.range.st,
                               prior.sigma.st = prior.sigma.st,
                               return.list = TRUE)
  }
  
  trans <- tbm.frac
  plot.model.tbm.plus(trans, 
                       fr,
                       poly.bar.orginal = poly.bar.orginal,
                       range = range,
                       fps = 1,
                       gif.path = fp)

  for (r in 1:length(trans)) {
    f <- fr[p]
    range.fraction <- c(f, f)
    fpp <- file.path(paste0(marginals.path, f, ".png"))
    png(fpp)
    par(mfrow = c(3, 1))
    tmp = inla.tmarginal(function(x) exp(x), trans[[p]]$pos.tbm$res$marginals.hyperpar[[3]]) 
    plot(tmp, type = "l", xlab = "r", ylab = "Density", xlim = c(0,8))
         xvals = seq(0, 10, length.out=1000)
      
    abline(v=range, col="blue")
    
    tmp = inla.tmarginal(function(x) exp(x), trans[[p]]$pos.bm$res$marginals.hyperpar[[3]]) 
    plot(tmp, type = "l", xlab = "r", ylab = "Density", xlim = c(0,8))
         xvals = seq(0, 10, length.out=1000)
      
    abline(v=range, col="blue")
  
    tmp = inla.tmarginal(function(x) (x), trans[[p]]$pos.st$res$marginals.hyperpar[[2]]) 
    plot(tmp, type = "l", xlab = "r", ylab = "Density", xlim = c(0,8))
         xvals = seq(0, 10, length.out=1000)
    abline(v=range, col="blue")
    dev.off()
  }
        }
        
      }
    }
  }
  
}
```

```{r}
#geom 1.1
SM <- c(1.5)
W <- c(2, 3)
R <- seq(2, 5, 1)
SS <- floor(runif(5, 1, 1000))
fr <- 0.4
N <- c(50, 100)


for (s in 1:length(SS)) {
  for (d in 1:length(SM)) {
    for (w in 1:length(W)) {
      for(r in 1:length(R)) {
        for (n in 1:length(N)) {
          fp <- file.path("gif/geom1.2", paste0("sm", SM[d], "w", W[w], "r", R[r], "seed", SS[s], ".n", N[n], "/"))
          dir.create(fp, recursive = TRUE)
          
          smalldist = SM[d]
          width = c(W[w],W[w])
          range = R[r]
          max.edge.length = 0.4
          n = N[n]
          set.inla.seed = SS[s]
          x.mid = 10
          xlim.big  = c(0,20)
          xlim.small = c(3,17)
          ylim.big = c(0,20)
          ylim.small = c(3,17)
          fr = fr
          prior.range = prior.range
          prior.sigma = c(1,0.1)
          sigma.u = 1
          sigma.epsilon = 0.2
          prior.range.st = prior.range
          prior.sigma.st = c(1,0.1)
          gif.path = fp
          marginals.path = fp


  poly1 <- local.square.polygon(xlim=c(xlim.big[1]-1, x.mid-smalldist/2), 
                          ylim=x.mid+width[1]*c(-.5, .5))

  poly2 <- local.square.polygon(xlim=c(x.mid+smalldist/2, xlim.big[2]+1), 
                          ylim=x.mid+width[2]*c(-.5, .5))

  poly.original <- SpatialPolygons(c(poly1@polygons, poly2@polygons))
  
  loc1 <- matrix(c(xlim.big[1],ylim.big[1], 
                   xlim.big[2],ylim.big[1], 
                   xlim.big[2],ylim.big[2], 
                   xlim.big[1],ylim.big[2]), 4, 2, byrow = T)
  
  seg <- inla.sp2segment(poly.original)
# - Transforms a SpatialPolygon to an "inla polygon"
  mesh <- inla.mesh.2d(loc=loc1, 
                      interior = seg, 
                       max.e = max.edge.length, 
                       offset=1)

  tl <- length(mesh$graph$tv[,1])
# - the number of triangles in the mesh
  posTri <- matrix(0, tl, 2)

  for (t in 1:tl){
    temp = mesh$loc[mesh$graph$tv[t, ], ]
    posTri[t,] = colMeans(temp)[c(1,2)] 
}

  posTri <- SpatialPoints(posTri)
# - the positions of the triangle centers

  bar.original <- over(poly.original, SpatialPoints(posTri), returnList=T)
# - checking which mesh triangles are inside the barrier area
  bar.original <- unlist(bar.original)
  poly.bar.orginal <- inla.barrier.polygon(mesh, barrier.triangles = bar.original)
# - the Barrier model's polygon
# - in most cases this should be the same as poly.original

# BARRIER 1
  bar1 <- over(poly1, SpatialPoints(posTri), returnList=T)
# - checking which mesh triangles are inside the barrier area
  bar1 <- unlist(bar1)
  poly.bar1 <- inla.barrier.polygon(mesh, barrier.triangles = bar1)
# - the Barrier model's polygon
# - in most cases this should be the same as poly.original

# BARRIER 2
  bar2 <- over(poly2, SpatialPoints(posTri), returnList=T)
# - checking which mesh triangles are inside the barrier area
  bar2 <- unlist(bar2)
  poly.bar2 <- inla.barrier.polygon(mesh, barrier.triangles = bar2)

  mat <-  inla.barrier.fem.plus(mesh, list(bar1, bar2)) 
  fem <- mat 
  barrier.triangles <- list(bar1, bar2)

# PLOTS
  poly1_h <- local.square.polygon_T(xlim=c(xlim.small[1], x.mid-smalldist/2), 
                            ylim=x.mid+width[1]*c(-.5, .5))

  poly2_h <- local.square.polygon_T(xlim=c(x.mid+smalldist/2, xlim.small[2]), 
                            ylim=x.mid+width[2]*c(-.5, .5))

  loc2 <- matrix(c(3,3, 17,3, 17,17, 3,17), 4, 2, byrow = T)

  locp2 <- Polygon(loc2, hole = FALSE)
    
  poly.water <- SpatialPolygons(list(Polygons(list(locp2, poly1_h, poly2_h), '0')))
  poly.water_sf <- st_as_sf(poly.water)
    
  set.seed(set.inla.seed)
  loc.data <- spsample(x = poly.water, n = n, type = "random")
  loc.data_sf <- st_as_sf(loc.data)
  loc.data <- loc.data@coords

  poly.rect <- SpatialPolygons(list(Polygons(list(poly1_h, poly2_h), '0')))
  poly.rect_sf <- st_as_sf(poly.rect)
  poly.sq <- SpatialPolygons(list(Polygons(list(locp2), '0')))
  poly.sq_sf <- st_as_sf(poly.sq)

  sq_bbox <- st_bbox(poly.sq_sf) %>% st_as_sfc()
  poly1_bbox <- st_bbox(poly1) %>% st_as_sfc()
  poly2_bbox <- st_bbox(poly2) %>% st_as_sfc()

  tbm.frac <- list()

  for (p in 1:length(fr)) { #
    f <- fr[p]
    range.fraction <- c(0.01, f)
    tbm.frac[[p]] <- model.tbm.plus(mesh = mesh, fem = fem, 
                               barrier.triangles = barrier.triangles,
                               prior.range = prior.range, prior.sigma = prior.sigma ,  
                               range.fraction = range.fraction,
                               range = range,
                               set.inla.seed = set.inla.seed,
                               loc.data = loc.data,
                               sigma.u = 1, sigma.epsilon = 0.2,
                               poly.original = poly.bar.orginal,
                               prior.range.st = prior.range.st,
                               prior.sigma.st = prior.sigma.st,
                               return.list = TRUE)
  }
  
  trans <- tbm.frac
  plot.model.tbm.plus(trans, 
                       fr,
                       poly.bar.orginal = poly.bar.orginal,
                       range = range,
                       fps = 1,
                       gif.path = fp)

  for (r in 1:length(trans)) {
    f <- fr[p]
    range.fraction <- c(0.01, f)
    fpp <- file.path(paste0(marginals.path, f, ".png"))
    png(fpp)
    par(mfrow = c(3, 1))
    tmp = inla.tmarginal(function(x) exp(x), trans[[p]]$pos.tbm$res$marginals.hyperpar[[3]]) 
    plot(tmp, type = "l", xlab = "r", ylab = "Density", xlim = c(0,8))
         xvals = seq(0, 10, length.out=1000)
      
    abline(v=range, col="blue")
    
    tmp = inla.tmarginal(function(x) exp(x), trans[[p]]$pos.bm$res$marginals.hyperpar[[3]]) 
    plot(tmp, type = "l", xlab = "r", ylab = "Density", xlim = c(0,8))
         xvals = seq(0, 10, length.out=1000)
      
    abline(v=range, col="blue")
  
    tmp = inla.tmarginal(function(x) (x), trans[[p]]$pos.st$res$marginals.hyperpar[[2]]) 
    plot(tmp, type = "l", xlab = "r", ylab = "Density", xlim = c(0,8))
         xvals = seq(0, 10, length.out=1000)
    abline(v=range, col="blue")
    dev.off()
  }
        }
        
      }
    }
  }
  
}
```


```{r}
#Geom 2 1b

SM <- c(0)
W <- c(1, 2, 3)
R <- seq(2, 4, 1)
SS <- floor(runif(5, 1, 1000))
fr <- 0.3
N <- c(50)


for (s in 1:length(SS)) {
  for (d in 1:length(SM)) {
    for (w in 1:length(W)) {
      for(r in 1:length(R)) {
        for (n in 1:length(N)) {
          fp <- file.path("gif/geom2", paste0("sm", SM[d], "w", W[w], "r", R[r], "seed", SS[s], ".n", N[n], "/"))
          dir.create(fp, recursive = TRUE)
          
          smalldist = SM[d]
          width = c(W[w],W[w])
          range = R[r]
          max.edge.length = 0.4
          n = N[n]
          set.inla.seed = SS[s]
          x.mid = 10
          xlim.big  = c(0,20)
          xlim.small = c(3,17)
          ylim.big = c(0,20)
          ylim.small = c(3,17)
          fr = fr
          prior.range = prior.range
          prior.sigma = c(1,0.1)
          sigma.u = 1
          sigma.epsilon = 0.2
          prior.range.st = prior.range
          prior.sigma.st = c(1,0.1)
          gif.path = fp
          marginals.path = fp


  poly1 <- local.square.polygon(xlim=c(xlim.big[1]-1, x.mid-smalldist/2), 
                          ylim=x.mid+width[1]*c(-.5, .5))

  poly2 <- local.square.polygon(xlim=c(x.mid+smalldist/2, xlim.big[2]+1), 
                          ylim=x.mid+width[2]*c(-.5, .5))

  poly.original <- SpatialPolygons(c(poly1@polygons, poly2@polygons))
  
  loc1 <- matrix(c(xlim.big[1],ylim.big[1], 
                   xlim.big[2],ylim.big[1], 
                   xlim.big[2],ylim.big[2], 
                   xlim.big[1],ylim.big[2]), 4, 2, byrow = T)
  
  seg <- inla.sp2segment(poly.original)
# - Transforms a SpatialPolygon to an "inla polygon"
  mesh <- inla.mesh.2d(loc=loc1, 
                      interior = seg, 
                       max.e = max.edge.length, 
                       offset=1)

  tl <- length(mesh$graph$tv[,1])
# - the number of triangles in the mesh
  posTri <- matrix(0, tl, 2)

  for (t in 1:tl){
    temp = mesh$loc[mesh$graph$tv[t, ], ]
    posTri[t,] = colMeans(temp)[c(1,2)] 
}

  posTri <- SpatialPoints(posTri)
# - the positions of the triangle centers

  bar.original <- over(poly.original, SpatialPoints(posTri), returnList=T)
# - checking which mesh triangles are inside the barrier area
  bar.original <- unlist(bar.original)
  poly.bar.orginal <- inla.barrier.polygon(mesh, barrier.triangles = bar.original)
# - the Barrier model's polygon
# - in most cases this should be the same as poly.original

# BARRIER 1
  bar1 <- over(poly1, SpatialPoints(posTri), returnList=T)
# - checking which mesh triangles are inside the barrier area
  bar1 <- unlist(bar1)
  poly.bar1 <- inla.barrier.polygon(mesh, barrier.triangles = bar1)
# - the Barrier model's polygon
# - in most cases this should be the same as poly.original

# BARRIER 2
  bar2 <- over(poly2, SpatialPoints(posTri), returnList=T)
# - checking which mesh triangles are inside the barrier area
  bar2 <- unlist(bar2)
  poly.bar2 <- inla.barrier.polygon(mesh, barrier.triangles = bar2)

  mat <-  inla.barrier.fem.plus(mesh, list(bar1, bar2)) 
  fem <- mat 
  barrier.triangles <- list(bar1, bar2)

# PLOTS
  poly1_h <- local.square.polygon_T(xlim=c(xlim.small[1], x.mid-smalldist/2), 
                            ylim=x.mid+width[1]*c(-.5, .5))

  poly2_h <- local.square.polygon_T(xlim=c(x.mid+smalldist/2, xlim.small[2]), 
                            ylim=x.mid+width[2]*c(-.5, .5))

  loc2 <- matrix(c(3,3, 17,3, 17,17, 3,17), 4, 2, byrow = T)

  locp2 <- Polygon(loc2, hole = FALSE)
    
  poly.water <- SpatialPolygons(list(Polygons(list(locp2, poly1_h, poly2_h), '0')))
  poly.water_sf <- st_as_sf(poly.water)
    
  set.seed(set.inla.seed)
  loc.data <- spsample(x = poly.water, n = n, type = "random")
  loc.data_sf <- st_as_sf(loc.data)
  loc.data <- loc.data@coords

  poly.rect <- SpatialPolygons(list(Polygons(list(poly1_h, poly2_h), '0')))
  poly.rect_sf <- st_as_sf(poly.rect)
  poly.sq <- SpatialPolygons(list(Polygons(list(locp2), '0')))
  poly.sq_sf <- st_as_sf(poly.sq)

  sq_bbox <- st_bbox(poly.sq_sf) %>% st_as_sfc()
  poly1_bbox <- st_bbox(poly1) %>% st_as_sfc()
  poly2_bbox <- st_bbox(poly2) %>% st_as_sfc()

  tbm.frac <- list()

  for (p in 1:length(fr)) { #
    f <- fr[p]
    range.fraction <- c(f, f)
    tbm.frac[[p]] <- model.tbm.plus(mesh = mesh, fem = fem, 
                               barrier.triangles = barrier.triangles,
                               prior.range = prior.range, prior.sigma = prior.sigma ,  
                               range.fraction = range.fraction,
                               range = range,
                               set.inla.seed = set.inla.seed,
                               loc.data = loc.data,
                               sigma.u = 1, sigma.epsilon = 0.2,
                               poly.original = poly.bar.orginal,
                               prior.range.st = prior.range.st,
                               prior.sigma.st = prior.sigma.st,
                               return.list = TRUE)
  }
  
  trans <- tbm.frac
  plot.model.tbm.plus(trans, 
                       fr,
                       poly.bar.orginal = poly.bar.orginal,
                       range = range,
                       fps = 1,
                       gif.path = fp)

  for (r in 1:length(trans)) {
    f <- fr[p]
    range.fraction <- c(f, f)
    fpp <- file.path(paste0(marginals.path, f, ".png"))
    png(fpp)
    par(mfrow = c(3, 1))
    tmp = inla.tmarginal(function(x) exp(x), trans[[p]]$pos.tbm$res$marginals.hyperpar[[3]]) 
    plot(tmp, type = "l", xlab = "r", ylab = "Density", xlim = c(0,8))
         xvals = seq(0, 10, length.out=1000)
      
    abline(v=range, col="blue")
    
    tmp = inla.tmarginal(function(x) exp(x), trans[[p]]$pos.bm$res$marginals.hyperpar[[3]]) 
    plot(tmp, type = "l", xlab = "r", ylab = "Density", xlim = c(0,8))
         xvals = seq(0, 10, length.out=1000)
      
    abline(v=range, col="blue")
  
    tmp = inla.tmarginal(function(x) (x), trans[[p]]$pos.st$res$marginals.hyperpar[[2]]) 
    plot(tmp, type = "l", xlab = "r", ylab = "Density", xlim = c(0,8))
         xvals = seq(0, 10, length.out=1000)
    abline(v=range, col="blue")
    dev.off()
  }
        }
        
      }
    }
  }
  
}

#geom2.2
for (s in 1:length(SS)) {
  for (d in 1:length(SM)) {
    for (w in 1:length(W)) {
      for(r in 1:length(R)) {
        for (n in 1:length(N)) {
          fp <- file.path("gif/geom2.2", paste0("sm", SM[d], "w", W[w], "r", R[r], "seed", SS[s], ".n", N[n], "/"))
          dir.create(fp, recursive = TRUE)
          
          smalldist = SM[d]
          width = c(W[w],W[w])
          range = R[r]
          max.edge.length = 0.4
          n = N[n]
          set.inla.seed = SS[s]
          x.mid = 10
          xlim.big  = c(0,20)
          xlim.small = c(3,17)
          ylim.big = c(0,20)
          ylim.small = c(3,17)
          fr = fr
          prior.range = prior.range
          prior.sigma = c(1,0.1)
          sigma.u = 1
          sigma.epsilon = 0.2
          prior.range.st = prior.range
          prior.sigma.st = c(1,0.1)
          gif.path = fp
          marginals.path = fp


  poly1 <- local.square.polygon(xlim=c(xlim.big[1]-1, x.mid-smalldist/2), 
                          ylim=x.mid+width[1]*c(-.5, .5))

  poly2 <- local.square.polygon(xlim=c(x.mid+smalldist/2, xlim.big[2]+1), 
                          ylim=x.mid+width[2]*c(-.5, .5))

  poly.original <- SpatialPolygons(c(poly1@polygons, poly2@polygons))
  
  loc1 <- matrix(c(xlim.big[1],ylim.big[1], 
                   xlim.big[2],ylim.big[1], 
                   xlim.big[2],ylim.big[2], 
                   xlim.big[1],ylim.big[2]), 4, 2, byrow = T)
  
  seg <- inla.sp2segment(poly.original)
# - Transforms a SpatialPolygon to an "inla polygon"
  mesh <- inla.mesh.2d(loc=loc1, 
                      interior = seg, 
                       max.e = max.edge.length, 
                       offset=1)

  tl <- length(mesh$graph$tv[,1])
# - the number of triangles in the mesh
  posTri <- matrix(0, tl, 2)

  for (t in 1:tl){
    temp = mesh$loc[mesh$graph$tv[t, ], ]
    posTri[t,] = colMeans(temp)[c(1,2)] 
}

  posTri <- SpatialPoints(posTri)
# - the positions of the triangle centers

  bar.original <- over(poly.original, SpatialPoints(posTri), returnList=T)
# - checking which mesh triangles are inside the barrier area
  bar.original <- unlist(bar.original)
  poly.bar.orginal <- inla.barrier.polygon(mesh, barrier.triangles = bar.original)
# - the Barrier model's polygon
# - in most cases this should be the same as poly.original

# BARRIER 1
  bar1 <- over(poly1, SpatialPoints(posTri), returnList=T)
# - checking which mesh triangles are inside the barrier area
  bar1 <- unlist(bar1)
  poly.bar1 <- inla.barrier.polygon(mesh, barrier.triangles = bar1)
# - the Barrier model's polygon
# - in most cases this should be the same as poly.original

# BARRIER 2
  bar2 <- over(poly2, SpatialPoints(posTri), returnList=T)
# - checking which mesh triangles are inside the barrier area
  bar2 <- unlist(bar2)
  poly.bar2 <- inla.barrier.polygon(mesh, barrier.triangles = bar2)

  mat <-  inla.barrier.fem.plus(mesh, list(bar1, bar2)) 
  fem <- mat 
  barrier.triangles <- list(bar1, bar2)

# PLOTS
  poly1_h <- local.square.polygon_T(xlim=c(xlim.small[1], x.mid-smalldist/2), 
                            ylim=x.mid+width[1]*c(-.5, .5))

  poly2_h <- local.square.polygon_T(xlim=c(x.mid+smalldist/2, xlim.small[2]), 
                            ylim=x.mid+width[2]*c(-.5, .5))

  loc2 <- matrix(c(3,3, 17,3, 17,17, 3,17), 4, 2, byrow = T)

  locp2 <- Polygon(loc2, hole = FALSE)
    
  poly.water <- SpatialPolygons(list(Polygons(list(locp2, poly1_h, poly2_h), '0')))
  poly.water_sf <- st_as_sf(poly.water)
    
  set.seed(set.inla.seed)
  loc.data <- spsample(x = poly.water, n = n, type = "random")
  loc.data_sf <- st_as_sf(loc.data)
  loc.data <- loc.data@coords

  poly.rect <- SpatialPolygons(list(Polygons(list(poly1_h, poly2_h), '0')))
  poly.rect_sf <- st_as_sf(poly.rect)
  poly.sq <- SpatialPolygons(list(Polygons(list(locp2), '0')))
  poly.sq_sf <- st_as_sf(poly.sq)

  sq_bbox <- st_bbox(poly.sq_sf) %>% st_as_sfc()
  poly1_bbox <- st_bbox(poly1) %>% st_as_sfc()
  poly2_bbox <- st_bbox(poly2) %>% st_as_sfc()

  tbm.frac <- list()

  for (p in 1:length(fr)) { #
    f <- fr[p]
    range.fraction <- c(0.01, f)
    tbm.frac[[p]] <- model.tbm.plus(mesh = mesh, fem = fem, 
                               barrier.triangles = barrier.triangles,
                               prior.range = prior.range, prior.sigma = prior.sigma ,  
                               range.fraction = range.fraction,
                               range = range,
                               set.inla.seed = set.inla.seed,
                               loc.data = loc.data,
                               sigma.u = 1, sigma.epsilon = 0.2,
                               poly.original = poly.bar.orginal,
                               prior.range.st = prior.range.st,
                               prior.sigma.st = prior.sigma.st,
                               return.list = TRUE)
  }
  
  trans <- tbm.frac
  plot.model.tbm.plus(trans, 
                       fr,
                       poly.bar.orginal = poly.bar.orginal,
                       range = range,
                       fps = 1,
                       gif.path = fp)

  for (r in 1:length(trans)) {
    f <- fr[p]
    range.fraction <- c(0.01, f)
    fpp <- file.path(paste0(marginals.path, f, ".png"))
    png(fpp)
    par(mfrow = c(3, 1))
    tmp = inla.tmarginal(function(x) exp(x), trans[[p]]$pos.tbm$res$marginals.hyperpar[[3]]) 
    plot(tmp, type = "l", xlab = "r", ylab = "Density", xlim = c(0,8))
         xvals = seq(0, 10, length.out=1000)
      
    abline(v=range, col="blue")
    
    tmp = inla.tmarginal(function(x) exp(x), trans[[p]]$pos.bm$res$marginals.hyperpar[[3]]) 
    plot(tmp, type = "l", xlab = "r", ylab = "Density", xlim = c(0,8))
         xvals = seq(0, 10, length.out=1000)
      
    abline(v=range, col="blue")
  
    tmp = inla.tmarginal(function(x) (x), trans[[p]]$pos.st$res$marginals.hyperpar[[2]]) 
    plot(tmp, type = "l", xlab = "r", ylab = "Density", xlim = c(0,8))
         xvals = seq(0, 10, length.out=1000)
    abline(v=range, col="blue")
    dev.off()
  }
        }
        
      }
    }
  }
  
}


#Geom 3, asymetric barrier 2


SM <- c(1.5)
Wl <- c(1, 1)
Wr <- c(3, 4)

R <- seq(2, 5
         
         , 1)
SS <- floor(runif(4, 1, 1000))
fr <- 0.3
N <- c(50)

#SM <- c(1.5)
#Wl <- c(2)
#Wr <- c(4)
#R <- 2
#SS <- floor(runif(1, 1, 1000))
#fr <- 0.3
#N <- c(50)

for (s in 1:length(SS)) {
  for (d in 1:length(SM)) {
    for (w in 1:length(Wl)) {
      for(r in 1:length(R)) {
        for (n in 1:length(N)) {
          fp <- file.path("gif/geom3", paste0("sm", SM[d], "wl", Wl[w], "wr", Wr[w], "r", R[r], "seed", SS[s], ".n", N[n], "/"))
          dir.create(fp, recursive = TRUE)
          
          smalldist = SM[d]
          width = c(Wl[w],Wr[w])
          range = R[r]
          max.edge.length = 0.4
          n = N[n]
          set.inla.seed = SS[s]
          x.mid = 10
          xlim.big  = c(0,20)
          xlim.small = c(3,17)
          ylim.big = c(0,20)
          ylim.small = c(3,17)
          fr = fr
          prior.range = prior.range
          prior.sigma = c(1,0.1)
          sigma.u = 1
          sigma.epsilon = 0.2
          prior.range.st = prior.range
          prior.sigma.st = c(1,0.1)
          gif.path = fp
          marginals.path = fp


  poly1 <- local.square.polygon(xlim=c(xlim.big[1]-1, x.mid-smalldist/2), 
                          ylim=x.mid+width[1]*c(-.5, .5))

  poly2 <- local.square.polygon(xlim=c(x.mid+smalldist/2, xlim.big[2]+1), 
                          ylim=x.mid+width[2]*c(-.5, .5))

  poly.original <- SpatialPolygons(c(poly1@polygons, poly2@polygons))
  
  loc1 <- matrix(c(xlim.big[1],ylim.big[1], 
                   xlim.big[2],ylim.big[1], 
                   xlim.big[2],ylim.big[2], 
                   xlim.big[1],ylim.big[2]), 4, 2, byrow = T)
  
  seg <- inla.sp2segment(poly.original)
# - Transforms a SpatialPolygon to an "inla polygon"
  mesh <- inla.mesh.2d(loc=loc1, 
                      interior = seg, 
                       max.e = max.edge.length, 
                       offset=1)

  tl <- length(mesh$graph$tv[,1])
# - the number of triangles in the mesh
  posTri <- matrix(0, tl, 2)

  for (t in 1:tl){
    temp = mesh$loc[mesh$graph$tv[t, ], ]
    posTri[t,] = colMeans(temp)[c(1,2)] 
}

  posTri <- SpatialPoints(posTri)
# - the positions of the triangle centers

  bar.original <- over(poly.original, SpatialPoints(posTri), returnList=T)
# - checking which mesh triangles are inside the barrier area
  bar.original <- unlist(bar.original)
  poly.bar.orginal <- inla.barrier.polygon(mesh, barrier.triangles = bar.original)
# - the Barrier model's polygon
# - in most cases this should be the same as poly.original

# BARRIER 1
  bar1 <- over(poly1, SpatialPoints(posTri), returnList=T)
# - checking which mesh triangles are inside the barrier area
  bar1 <- unlist(bar1)
  poly.bar1 <- inla.barrier.polygon(mesh, barrier.triangles = bar1)
# - the Barrier model's polygon
# - in most cases this should be the same as poly.original

# BARRIER 2
  bar2 <- over(poly2, SpatialPoints(posTri), returnList=T)
# - checking which mesh triangles are inside the barrier area
  bar2 <- unlist(bar2)
  poly.bar2 <- inla.barrier.polygon(mesh, barrier.triangles = bar2)

  mat <-  inla.barrier.fem.plus(mesh, list(bar1, bar2)) 
  fem <- mat 
  barrier.triangles <- list(bar1, bar2)

# PLOTS
  poly1_h <- local.square.polygon_T(xlim=c(xlim.small[1], x.mid-smalldist/2), 
                            ylim=x.mid+width[1]*c(-.5, .5))

  poly2_h <- local.square.polygon_T(xlim=c(x.mid+smalldist/2, xlim.small[2]), 
                            ylim=x.mid+width[2]*c(-.5, .5))

  loc2 <- matrix(c(3,3, 17,3, 17,17, 3,17), 4, 2, byrow = T)

  locp2 <- Polygon(loc2, hole = FALSE)
    
  poly.water <- SpatialPolygons(list(Polygons(list(locp2, poly1_h, poly2_h), '0')))
  poly.water_sf <- st_as_sf(poly.water)
    
  set.seed(set.inla.seed)
  loc.data <- spsample(x = poly.water, n = n, type = "random")
  loc.data_sf <- st_as_sf(loc.data)
  loc.data <- loc.data@coords

  poly.rect <- SpatialPolygons(list(Polygons(list(poly1_h, poly2_h), '0')))
  poly.rect_sf <- st_as_sf(poly.rect)
  poly.sq <- SpatialPolygons(list(Polygons(list(locp2), '0')))
  poly.sq_sf <- st_as_sf(poly.sq)

  sq_bbox <- st_bbox(poly.sq_sf) %>% st_as_sfc()
  poly1_bbox <- st_bbox(poly1) %>% st_as_sfc()
  poly2_bbox <- st_bbox(poly2) %>% st_as_sfc()

  tbm.frac <- list()

  for (p in 1:length(fr)) { #
    f <- fr[p]
    range.fraction <- c(f, f)
    tbm.frac[[p]] <- model.tbm.plus(mesh = mesh, fem = fem, 
                               barrier.triangles = barrier.triangles,
                               prior.range = prior.range, prior.sigma = prior.sigma ,  
                               range.fraction = range.fraction,
                               range = range,
                               set.inla.seed = set.inla.seed,
                               loc.data = loc.data,
                               sigma.u = 1, sigma.epsilon = 0.2,
                               poly.original = poly.bar.orginal,
                               prior.range.st = prior.range.st,
                               prior.sigma.st = prior.sigma.st,
                               return.list = TRUE)
  }
  
  trans <- tbm.frac
  plot.model.tbm.plus(trans, 
                       fr,
                       poly.bar.orginal = poly.bar.orginal,
                       range = range,
                       fps = 1,
                       gif.path = fp)

  for (r in 1:length(trans)) {
    f <- fr[p]
    range.fraction <- c(f, f)
    fpp <- file.path(paste0(marginals.path, f, ".png"))
    png(fpp)
    par(mfrow = c(3, 1))
    tmp = inla.tmarginal(function(x) exp(x), trans[[p]]$pos.tbm$res$marginals.hyperpar[[3]]) 
    plot(tmp, type = "l", xlab = "r", ylab = "Density", xlim = c(0,8))
         xvals = seq(0, 10, length.out=1000)
      
    abline(v=range, col="blue")
    
    tmp = inla.tmarginal(function(x) exp(x), trans[[p]]$pos.bm$res$marginals.hyperpar[[3]]) 
    plot(tmp, type = "l", xlab = "r", ylab = "Density", xlim = c(0,8))
         xvals = seq(0, 10, length.out=1000)
      
    abline(v=range, col="blue")
  
    tmp = inla.tmarginal(function(x) (x), trans[[p]]$pos.st$res$marginals.hyperpar[[2]]) 
    plot(tmp, type = "l", xlab = "r", ylab = "Density", xlim = c(0,8))
         xvals = seq(0, 10, length.out=1000)
    abline(v=range, col="blue")
    dev.off()
  }
        }
        
      }
    }
  }
  
}

##geom 3.2
for (s in 1:length(SS)) {
  for (d in 1:length(SM)) {
    for (w in 1:length(Wl)) {
      for(r in 1:length(R)) {
        for (n in 1:length(N)) {
          fp <- file.path("gif/geom3.2", paste0("sm", SM[d], "wl", Wl[w], "wr", Wr[w], "r", R[r], "seed", SS[s], ".n", N[n], "/"))
          dir.create(fp, recursive = TRUE)
          
          smalldist = SM[d]
          width = c(Wl[w],Wr[w])
          range = R[r]
          max.edge.length = 0.4
          n = N[n]
          set.inla.seed = SS[s]
          x.mid = 10
          xlim.big  = c(0,20)
          xlim.small = c(3,17)
          ylim.big = c(0,20)
          ylim.small = c(3,17)
          fr = fr
          prior.range = prior.range
          prior.sigma = c(1,0.1)
          sigma.u = 1
          sigma.epsilon = 0.2
          prior.range.st = prior.range
          prior.sigma.st = c(1,0.1)
          gif.path = fp
          marginals.path = fp


  poly1 <- local.square.polygon(xlim=c(xlim.big[1]-1, x.mid-smalldist/2), 
                          ylim=x.mid+width[1]*c(-.5, .5))

  poly2 <- local.square.polygon(xlim=c(x.mid+smalldist/2, xlim.big[2]+1), 
                          ylim=x.mid+width[2]*c(-.5, .5))

  poly.original <- SpatialPolygons(c(poly1@polygons, poly2@polygons))
  
  loc1 <- matrix(c(xlim.big[1],ylim.big[1], 
                   xlim.big[2],ylim.big[1], 
                   xlim.big[2],ylim.big[2], 
                   xlim.big[1],ylim.big[2]), 4, 2, byrow = T)
  
  seg <- inla.sp2segment(poly.original)
# - Transforms a SpatialPolygon to an "inla polygon"
  mesh <- inla.mesh.2d(loc=loc1, 
                      interior = seg, 
                       max.e = max.edge.length, 
                       offset=1)

  tl <- length(mesh$graph$tv[,1])
# - the number of triangles in the mesh
  posTri <- matrix(0, tl, 2)

  for (t in 1:tl){
    temp = mesh$loc[mesh$graph$tv[t, ], ]
    posTri[t,] = colMeans(temp)[c(1,2)] 
}

  posTri <- SpatialPoints(posTri)
# - the positions of the triangle centers

  bar.original <- over(poly.original, SpatialPoints(posTri), returnList=T)
# - checking which mesh triangles are inside the barrier area
  bar.original <- unlist(bar.original)
  poly.bar.orginal <- inla.barrier.polygon(mesh, barrier.triangles = bar.original)
# - the Barrier model's polygon
# - in most cases this should be the same as poly.original

# BARRIER 1
  bar1 <- over(poly1, SpatialPoints(posTri), returnList=T)
# - checking which mesh triangles are inside the barrier area
  bar1 <- unlist(bar1)
  poly.bar1 <- inla.barrier.polygon(mesh, barrier.triangles = bar1)
# - the Barrier model's polygon
# - in most cases this should be the same as poly.original

# BARRIER 2
  bar2 <- over(poly2, SpatialPoints(posTri), returnList=T)
# - checking which mesh triangles are inside the barrier area
  bar2 <- unlist(bar2)
  poly.bar2 <- inla.barrier.polygon(mesh, barrier.triangles = bar2)

  mat <-  inla.barrier.fem.plus(mesh, list(bar1, bar2)) 
  fem <- mat 
  barrier.triangles <- list(bar1, bar2)

# PLOTS
  poly1_h <- local.square.polygon_T(xlim=c(xlim.small[1], x.mid-smalldist/2), 
                            ylim=x.mid+width[1]*c(-.5, .5))

  poly2_h <- local.square.polygon_T(xlim=c(x.mid+smalldist/2, xlim.small[2]), 
                            ylim=x.mid+width[2]*c(-.5, .5))

  loc2 <- matrix(c(3,3, 17,3, 17,17, 3,17), 4, 2, byrow = T)

  locp2 <- Polygon(loc2, hole = FALSE)
    
  poly.water <- SpatialPolygons(list(Polygons(list(locp2, poly1_h, poly2_h), '0')))
  poly.water_sf <- st_as_sf(poly.water)
    
  set.seed(set.inla.seed)
  loc.data <- spsample(x = poly.water, n = n, type = "random")
  loc.data_sf <- st_as_sf(loc.data)
  loc.data <- loc.data@coords

  poly.rect <- SpatialPolygons(list(Polygons(list(poly1_h, poly2_h), '0')))
  poly.rect_sf <- st_as_sf(poly.rect)
  poly.sq <- SpatialPolygons(list(Polygons(list(locp2), '0')))
  poly.sq_sf <- st_as_sf(poly.sq)

  sq_bbox <- st_bbox(poly.sq_sf) %>% st_as_sfc()
  poly1_bbox <- st_bbox(poly1) %>% st_as_sfc()
  poly2_bbox <- st_bbox(poly2) %>% st_as_sfc()

  tbm.frac <- list()

  for (p in 1:length(fr)) { #
    f <- fr[p]
    range.fraction <- c(0.01, f)
    tbm.frac[[p]] <- model.tbm.plus(mesh = mesh, fem = fem, 
                               barrier.triangles = barrier.triangles,
                               prior.range = prior.range, prior.sigma = prior.sigma ,  
                               range.fraction = range.fraction,
                               range = range,
                               set.inla.seed = set.inla.seed,
                               loc.data = loc.data,
                               sigma.u = 1, sigma.epsilon = 0.2,
                               poly.original = poly.bar.orginal,
                               prior.range.st = prior.range.st,
                               prior.sigma.st = prior.sigma.st,
                               return.list = TRUE)
  }
  
  trans <- tbm.frac
  plot.model.tbm.plus(trans, 
                       fr,
                       poly.bar.orginal = poly.bar.orginal,
                       range = range,
                       fps = 1,
                       gif.path = fp)

  for (r in 1:length(trans)) {
    f <- fr[p]
    range.fraction <- c(0.01, f)
    fpp <- file.path(paste0(marginals.path, f, ".png"))
    png(fpp)
    par(mfrow = c(3, 1))
    tmp = inla.tmarginal(function(x) exp(x), trans[[p]]$pos.tbm$res$marginals.hyperpar[[3]]) 
    plot(tmp, type = "l", xlab = "r", ylab = "Density", xlim = c(0,8))
         xvals = seq(0, 10, length.out=1000)
      
    abline(v=range, col="blue")
    
    tmp = inla.tmarginal(function(x) exp(x), trans[[p]]$pos.bm$res$marginals.hyperpar[[3]]) 
    plot(tmp, type = "l", xlab = "r", ylab = "Density", xlim = c(0,8))
         xvals = seq(0, 10, length.out=1000)
      
    abline(v=range, col="blue")
  
    tmp = inla.tmarginal(function(x) (x), trans[[p]]$pos.st$res$marginals.hyperpar[[2]]) 
    plot(tmp, type = "l", xlab = "r", ylab = "Density", xlim = c(0,8))
         xvals = seq(0, 10, length.out=1000)
    abline(v=range, col="blue")
    dev.off()
  }
        }
        
      }
    }
  }
  
}

##geom 3.3
for (s in 1:length(SS)) {
  for (d in 1:length(SM)) {
    for (w in 1:length(Wl)) {
      for(r in 1:length(R)) {
        for (n in 1:length(N)) {
          fp <- file.path("gif/geom3.3", paste0("sm", SM[d], "wl", Wl[w], "wr", Wr[w], "r", R[r], "seed", SS[s], ".n", N[n], "/"))
          dir.create(fp, recursive = TRUE)
          
          smalldist = SM[d]
          width = c(Wl[w],Wr[w])
          range = R[r]
          max.edge.length = 0.4
          n = N[n]
          set.inla.seed = SS[s]
          x.mid = 10
          xlim.big  = c(0,20)
          xlim.small = c(3,17)
          ylim.big = c(0,20)
          ylim.small = c(3,17)
          fr = fr
          prior.range = prior.range
          prior.sigma = c(1,0.1)
          sigma.u = 1
          sigma.epsilon = 0.2
          prior.range.st = prior.range
          prior.sigma.st = c(1,0.1)
          gif.path = fp
          marginals.path = fp


  poly1 <- local.square.polygon(xlim=c(xlim.big[1]-1, x.mid-smalldist/2), 
                          ylim=x.mid+width[1]*c(-.5, .5))

  poly2 <- local.square.polygon(xlim=c(x.mid+smalldist/2, xlim.big[2]+1), 
                          ylim=x.mid+width[2]*c(-.5, .5))

  poly.original <- SpatialPolygons(c(poly1@polygons, poly2@polygons))
  
  loc1 <- matrix(c(xlim.big[1],ylim.big[1], 
                   xlim.big[2],ylim.big[1], 
                   xlim.big[2],ylim.big[2], 
                   xlim.big[1],ylim.big[2]), 4, 2, byrow = T)
  
  seg <- inla.sp2segment(poly.original)
# - Transforms a SpatialPolygon to an "inla polygon"
  mesh <- inla.mesh.2d(loc=loc1, 
                      interior = seg, 
                       max.e = max.edge.length, 
                       offset=1)

  tl <- length(mesh$graph$tv[,1])
# - the number of triangles in the mesh
  posTri <- matrix(0, tl, 2)

  for (t in 1:tl){
    temp = mesh$loc[mesh$graph$tv[t, ], ]
    posTri[t,] = colMeans(temp)[c(1,2)] 
}

  posTri <- SpatialPoints(posTri)
# - the positions of the triangle centers

  bar.original <- over(poly.original, SpatialPoints(posTri), returnList=T)
# - checking which mesh triangles are inside the barrier area
  bar.original <- unlist(bar.original)
  poly.bar.orginal <- inla.barrier.polygon(mesh, barrier.triangles = bar.original)
# - the Barrier model's polygon
# - in most cases this should be the same as poly.original

# BARRIER 1
  bar1 <- over(poly1, SpatialPoints(posTri), returnList=T)
# - checking which mesh triangles are inside the barrier area
  bar1 <- unlist(bar1)
  poly.bar1 <- inla.barrier.polygon(mesh, barrier.triangles = bar1)
# - the Barrier model's polygon
# - in most cases this should be the same as poly.original

# BARRIER 2
  bar2 <- over(poly2, SpatialPoints(posTri), returnList=T)
# - checking which mesh triangles are inside the barrier area
  bar2 <- unlist(bar2)
  poly.bar2 <- inla.barrier.polygon(mesh, barrier.triangles = bar2)

  mat <-  inla.barrier.fem.plus(mesh, list(bar1, bar2)) 
  fem <- mat 
  barrier.triangles <- list(bar1, bar2)

# PLOTS
  poly1_h <- local.square.polygon_T(xlim=c(xlim.small[1], x.mid-smalldist/2), 
                            ylim=x.mid+width[1]*c(-.5, .5))

  poly2_h <- local.square.polygon_T(xlim=c(x.mid+smalldist/2, xlim.small[2]), 
                            ylim=x.mid+width[2]*c(-.5, .5))

  loc2 <- matrix(c(3,3, 17,3, 17,17, 3,17), 4, 2, byrow = T)

  locp2 <- Polygon(loc2, hole = FALSE)
    
  poly.water <- SpatialPolygons(list(Polygons(list(locp2, poly1_h, poly2_h), '0')))
  poly.water_sf <- st_as_sf(poly.water)
    
  set.seed(set.inla.seed)
  loc.data <- spsample(x = poly.water, n = n, type = "random")
  loc.data_sf <- st_as_sf(loc.data)
  loc.data <- loc.data@coords

  poly.rect <- SpatialPolygons(list(Polygons(list(poly1_h, poly2_h), '0')))
  poly.rect_sf <- st_as_sf(poly.rect)
  poly.sq <- SpatialPolygons(list(Polygons(list(locp2), '0')))
  poly.sq_sf <- st_as_sf(poly.sq)

  sq_bbox <- st_bbox(poly.sq_sf) %>% st_as_sfc()
  poly1_bbox <- st_bbox(poly1) %>% st_as_sfc()
  poly2_bbox <- st_bbox(poly2) %>% st_as_sfc()

  tbm.frac <- list()

  for (p in 1:length(fr)) { #
    f <- fr[p]
    range.fraction <- c(f, 0.01)
    tbm.frac[[p]] <- model.tbm.plus(mesh = mesh, fem = fem, 
                               barrier.triangles = barrier.triangles,
                               prior.range = prior.range, prior.sigma = prior.sigma ,  
                               range.fraction = range.fraction,
                               range = range,
                               set.inla.seed = set.inla.seed,
                               loc.data = loc.data,
                               sigma.u = 1, sigma.epsilon = 0.2,
                               poly.original = poly.bar.orginal,
                               prior.range.st = prior.range.st,
                               prior.sigma.st = prior.sigma.st,
                               return.list = TRUE)
  }
  
  trans <- tbm.frac
  plot.model.tbm.plus(trans, 
                       fr,
                       poly.bar.orginal = poly.bar.orginal,
                       range = range,
                       fps = 1,
                       gif.path = fp)

  for (r in 1:length(trans)) {
    f <- fr[p]
    range.fraction <- c(f, 0.01)
    fpp <- file.path(paste0(marginals.path, f, ".png"))
    png(fpp)
    par(mfrow = c(3, 1))
    tmp = inla.tmarginal(function(x) exp(x), trans[[p]]$pos.tbm$res$marginals.hyperpar[[3]]) 
    plot(tmp, type = "l", xlab = "r", ylab = "Density", xlim = c(0,8))
         xvals = seq(0, 10, length.out=1000)
      
    abline(v=range, col="blue")
    
    tmp = inla.tmarginal(function(x) exp(x), trans[[p]]$pos.bm$res$marginals.hyperpar[[3]]) 
    plot(tmp, type = "l", xlab = "r", ylab = "Density", xlim = c(0,8))
         xvals = seq(0, 10, length.out=1000)
      
    abline(v=range, col="blue")
  
    tmp = inla.tmarginal(function(x) (x), trans[[p]]$pos.st$res$marginals.hyperpar[[2]]) 
    plot(tmp, type = "l", xlab = "r", ylab = "Density", xlim = c(0,8))
         xvals = seq(0, 10, length.out=1000)
    abline(v=range, col="blue")
    dev.off()
  }
        }
        
      }
    }
  }
  
}

#geom 1.1
SM <- c(1.5)
W <- c(2, 3)
R <- seq(2, 5, 1)
SS <- floor(runif(5, 1, 1000))
fr <- 0.4
N <- c(30, 60)


for (s in 1:length(SS)) {
  for (d in 1:length(SM)) {
    for (w in 1:length(W)) {
      for(r in 1:length(R)) {
        for (n in 1:length(N)) {
          fp <- file.path("gif/geom1.2", paste0("sm", SM[d], "w", W[w], "r", R[r], "seed", SS[s], ".n", N[n], "/"))
          dir.create(fp, recursive = TRUE)
          
          smalldist = SM[d]
          width = c(W[w],W[w])
          range = R[r]
          max.edge.length = 0.4
          n = N[n]
          set.inla.seed = SS[s]
          x.mid = 10
          xlim.big  = c(0,20)
          xlim.small = c(3,17)
          ylim.big = c(0,20)
          ylim.small = c(3,17)
          fr = fr
          prior.range = prior.range
          prior.sigma = c(1,0.1)
          sigma.u = 1
          sigma.epsilon = 0.2
          prior.range.st = prior.range
          prior.sigma.st = c(1,0.1)
          gif.path = fp
          marginals.path = fp


  poly1 <- local.square.polygon(xlim=c(xlim.big[1]-1, x.mid-smalldist/2), 
                          ylim=x.mid+width[1]*c(-.5, .5))

  poly2 <- local.square.polygon(xlim=c(x.mid+smalldist/2, xlim.big[2]+1), 
                          ylim=x.mid+width[2]*c(-.5, .5))

  poly.original <- SpatialPolygons(c(poly1@polygons, poly2@polygons))
  
  loc1 <- matrix(c(xlim.big[1],ylim.big[1], 
                   xlim.big[2],ylim.big[1], 
                   xlim.big[2],ylim.big[2], 
                   xlim.big[1],ylim.big[2]), 4, 2, byrow = T)
  
  seg <- inla.sp2segment(poly.original)
# - Transforms a SpatialPolygon to an "inla polygon"
  mesh <- inla.mesh.2d(loc=loc1, 
                      interior = seg, 
                       max.e = max.edge.length, 
                       offset=1)

  tl <- length(mesh$graph$tv[,1])
# - the number of triangles in the mesh
  posTri <- matrix(0, tl, 2)

  for (t in 1:tl){
    temp = mesh$loc[mesh$graph$tv[t, ], ]
    posTri[t,] = colMeans(temp)[c(1,2)] 
}

  posTri <- SpatialPoints(posTri)
# - the positions of the triangle centers

  bar.original <- over(poly.original, SpatialPoints(posTri), returnList=T)
# - checking which mesh triangles are inside the barrier area
  bar.original <- unlist(bar.original)
  poly.bar.orginal <- inla.barrier.polygon(mesh, barrier.triangles = bar.original)
# - the Barrier model's polygon
# - in most cases this should be the same as poly.original

# BARRIER 1
  bar1 <- over(poly1, SpatialPoints(posTri), returnList=T)
# - checking which mesh triangles are inside the barrier area
  bar1 <- unlist(bar1)
  poly.bar1 <- inla.barrier.polygon(mesh, barrier.triangles = bar1)
# - the Barrier model's polygon
# - in most cases this should be the same as poly.original

# BARRIER 2
  bar2 <- over(poly2, SpatialPoints(posTri), returnList=T)
# - checking which mesh triangles are inside the barrier area
  bar2 <- unlist(bar2)
  poly.bar2 <- inla.barrier.polygon(mesh, barrier.triangles = bar2)

  mat <-  inla.barrier.fem.plus(mesh, list(bar1, bar2)) 
  fem <- mat 
  barrier.triangles <- list(bar1, bar2)

# PLOTS
  poly1_h <- local.square.polygon_T(xlim=c(xlim.small[1], x.mid-smalldist/2), 
                            ylim=x.mid+width[1]*c(-.5, .5))

  poly2_h <- local.square.polygon_T(xlim=c(x.mid+smalldist/2, xlim.small[2]), 
                            ylim=x.mid+width[2]*c(-.5, .5))

  loc2 <- matrix(c(3,3, 17,3, 17,17, 3,17), 4, 2, byrow = T)

  locp2 <- Polygon(loc2, hole = FALSE)
    
  poly.water <- SpatialPolygons(list(Polygons(list(locp2, poly1_h, poly2_h), '0')))
  poly.water_sf <- st_as_sf(poly.water)
    
  set.seed(set.inla.seed)
  loc.data <- spsample(x = poly.water, n = n, type = "random")
  loc.data_sf <- st_as_sf(loc.data)
  loc.data <- loc.data@coords

  poly.rect <- SpatialPolygons(list(Polygons(list(poly1_h, poly2_h), '0')))
  poly.rect_sf <- st_as_sf(poly.rect)
  poly.sq <- SpatialPolygons(list(Polygons(list(locp2), '0')))
  poly.sq_sf <- st_as_sf(poly.sq)

  sq_bbox <- st_bbox(poly.sq_sf) %>% st_as_sfc()
  poly1_bbox <- st_bbox(poly1) %>% st_as_sfc()
  poly2_bbox <- st_bbox(poly2) %>% st_as_sfc()

  tbm.frac <- list()

  for (p in 1:length(fr)) { #
    f <- fr[p]
    range.fraction <- c(0.01, f)
    tbm.frac[[p]] <- model.tbm.plus(mesh = mesh, fem = fem, 
                               barrier.triangles = barrier.triangles,
                               prior.range = prior.range, prior.sigma = prior.sigma ,  
                               range.fraction = range.fraction,
                               range = range,
                               set.inla.seed = set.inla.seed,
                               loc.data = loc.data,
                               sigma.u = 1, sigma.epsilon = 0.2,
                               poly.original = poly.bar.orginal,
                               prior.range.st = prior.range.st,
                               prior.sigma.st = prior.sigma.st,
                               return.list = TRUE)
  }
  
  trans <- tbm.frac
  plot.model.tbm.plus(trans, 
                       fr,
                       poly.bar.orginal = poly.bar.orginal,
                       range = range,
                       fps = 1,
                       gif.path = fp)

  for (r in 1:length(trans)) {
    f <- fr[p]
    range.fraction <- c(0.01, f)
    fpp <- file.path(paste0(marginals.path, f, ".png"))
    png(fpp)
    par(mfrow = c(3, 1))
    tmp = inla.tmarginal(function(x) exp(x), trans[[p]]$pos.tbm$res$marginals.hyperpar[[3]]) 
    plot(tmp, type = "l", xlab = "r", ylab = "Density", xlim = c(0,8))
         xvals = seq(0, 10, length.out=1000)
      
    abline(v=range, col="blue")
    
    tmp = inla.tmarginal(function(x) exp(x), trans[[p]]$pos.bm$res$marginals.hyperpar[[3]]) 
    plot(tmp, type = "l", xlab = "r", ylab = "Density", xlim = c(0,8))
         xvals = seq(0, 10, length.out=1000)
      
    abline(v=range, col="blue")
  
    tmp = inla.tmarginal(function(x) (x), trans[[p]]$pos.st$res$marginals.hyperpar[[2]]) 
    plot(tmp, type = "l", xlab = "r", ylab = "Density", xlim = c(0,8))
         xvals = seq(0, 10, length.out=1000)
    abline(v=range, col="blue")
    dev.off()
  }
        }
        
      }
    }
  }
  
}


```

Geom 4 1b

```{r}
SM <- c(0)
W <- c(1, 2, 3)
R <- seq(2, 5, 1)
SS <- floor(runif(5, 1, 1000))
fr <- 0.3
N <- c(50, 100)


for (s in 1:length(SS)) {
  for (d in 1:length(SM)) {
    for (w in 1:length(W)) {
      for(r in 1:length(R)) {
        for (n in 1:length(N)) {
          fp <- file.path("gif/geom2", paste0("sm", SM[d], "w", W[w], "r", R[r], "seed", SS[s], ".n", N[n], "/"))
          dir.create(fp, recursive = TRUE)
          
          smalldist = SM[d]
          width = c(W[w],W[w])
          range = R[r]
          max.edge.length = 0.4
          n = N[n]
          set.inla.seed = SS[s]
          x.mid = 10
          xlim.big  = c(0,20)
          xlim.small = c(3,17)
          ylim.big = c(0,20)
          ylim.small = c(3,17)
          fr = fr
          prior.range = prior.range
          prior.sigma = c(1,0.1)
          sigma.u = 1
          sigma.epsilon = 0.2
          prior.range.st = prior.range
          prior.sigma.st = c(1,0.1)
          gif.path = fp
          marginals.path = fp


  poly1 <- local.square.polygon(xlim=c(xlim.big[1]-1, x.mid-smalldist/2), 
                          ylim=x.mid+width[1]*c(-.5, .5))

  poly2 <- local.square.polygon(xlim=c(x.mid+smalldist/2, xlim.big[2]+1), 
                          ylim=x.mid+width[2]*c(-.5, .5))

  poly.original <- SpatialPolygons(c(poly1@polygons, poly2@polygons))
  
  loc1 <- matrix(c(xlim.big[1],ylim.big[1], 
                   xlim.big[2],ylim.big[1], 
                   xlim.big[2],ylim.big[2], 
                   xlim.big[1],ylim.big[2]), 4, 2, byrow = T)
  
  seg <- inla.sp2segment(poly.original)
# - Transforms a SpatialPolygon to an "inla polygon"
  mesh <- inla.mesh.2d(loc=loc1, 
                      interior = seg, 
                       max.e = max.edge.length, 
                       offset=1)

  tl <- length(mesh$graph$tv[,1])
# - the number of triangles in the mesh
  posTri <- matrix(0, tl, 2)

  for (t in 1:tl){
    temp = mesh$loc[mesh$graph$tv[t, ], ]
    posTri[t,] = colMeans(temp)[c(1,2)] 
}

  posTri <- SpatialPoints(posTri)
# - the positions of the triangle centers

  bar.original <- over(poly.original, SpatialPoints(posTri), returnList=T)
# - checking which mesh triangles are inside the barrier area
  bar.original <- unlist(bar.original)
  poly.bar.orginal <- inla.barrier.polygon(mesh, barrier.triangles = bar.original)
# - the Barrier model's polygon
# - in most cases this should be the same as poly.original

# BARRIER 1
  bar1 <- over(poly1, SpatialPoints(posTri), returnList=T)
# - checking which mesh triangles are inside the barrier area
  bar1 <- unlist(bar1)
  poly.bar1 <- inla.barrier.polygon(mesh, barrier.triangles = bar1)
# - the Barrier model's polygon
# - in most cases this should be the same as poly.original

# BARRIER 2
  bar2 <- over(poly2, SpatialPoints(posTri), returnList=T)
# - checking which mesh triangles are inside the barrier area
  bar2 <- unlist(bar2)
  poly.bar2 <- inla.barrier.polygon(mesh, barrier.triangles = bar2)

  mat <-  inla.barrier.fem.plus(mesh, list(bar1, bar2)) 
  fem <- mat 
  barrier.triangles <- list(bar1, bar2)

# PLOTS
  poly1_h <- local.square.polygon_T(xlim=c(xlim.small[1], x.mid-smalldist/2), 
                            ylim=x.mid+width[1]*c(-.5, .5))

  poly2_h <- local.square.polygon_T(xlim=c(x.mid+smalldist/2, xlim.small[2]), 
                            ylim=x.mid+width[2]*c(-.5, .5))

  loc2 <- matrix(c(3,3, 17,3, 17,17, 3,17), 4, 2, byrow = T)

  locp2 <- Polygon(loc2, hole = FALSE)
    
  poly.water <- SpatialPolygons(list(Polygons(list(locp2, poly1_h, poly2_h), '0')))
  poly.water_sf <- st_as_sf(poly.water)
    
  set.seed(set.inla.seed)
  loc.data <- spsample(x = poly.water, n = n, type = "random")
  loc.data_sf <- st_as_sf(loc.data)
  loc.data <- loc.data@coords

  poly.rect <- SpatialPolygons(list(Polygons(list(poly1_h, poly2_h), '0')))
  poly.rect_sf <- st_as_sf(poly.rect)
  poly.sq <- SpatialPolygons(list(Polygons(list(locp2), '0')))
  poly.sq_sf <- st_as_sf(poly.sq)

  sq_bbox <- st_bbox(poly.sq_sf) %>% st_as_sfc()
  poly1_bbox <- st_bbox(poly1) %>% st_as_sfc()
  poly2_bbox <- st_bbox(poly2) %>% st_as_sfc()

  tbm.frac <- list()

  for (p in 1:length(fr)) { #
    f <- fr[p]
    range.fraction <- c(f, f)
    tbm.frac[[p]] <- model.tbm.plus(mesh = mesh, fem = fem, 
                               barrier.triangles = barrier.triangles,
                               prior.range = prior.range, prior.sigma = prior.sigma ,  
                               range.fraction = range.fraction,
                               range = range,
                               set.inla.seed = set.inla.seed,
                               loc.data = loc.data,
                               sigma.u = 1, sigma.epsilon = 0.2,
                               poly.original = poly.bar.orginal,
                               prior.range.st = prior.range.st,
                               prior.sigma.st = prior.sigma.st,
                               return.list = TRUE)
  }
  
  trans <- tbm.frac
  plot.model.tbm.plus(trans, 
                       fr,
                       poly.bar.orginal = poly.bar.orginal,
                       range = range,
                       fps = 1,
                       gif.path = fp)

  for (r in 1:length(trans)) {
    f <- fr[p]
    range.fraction <- c(f, f)
    fpp <- file.path(paste0(marginals.path, f, ".png"))
    png(fpp)
    par(mfrow = c(3, 1))
    tmp = inla.tmarginal(function(x) exp(x), trans[[p]]$pos.tbm$res$marginals.hyperpar[[3]]) 
    plot(tmp, type = "l", xlab = "r", ylab = "Density", xlim = c(0,8))
         xvals = seq(0, 10, length.out=1000)
      
    abline(v=range, col="blue")
    
    tmp = inla.tmarginal(function(x) exp(x), trans[[p]]$pos.bm$res$marginals.hyperpar[[3]]) 
    plot(tmp, type = "l", xlab = "r", ylab = "Density", xlim = c(0,8))
         xvals = seq(0, 10, length.out=1000)
      
    abline(v=range, col="blue")
  
    tmp = inla.tmarginal(function(x) (x), trans[[p]]$pos.st$res$marginals.hyperpar[[2]]) 
    plot(tmp, type = "l", xlab = "r", ylab = "Density", xlim = c(0,8))
         xvals = seq(0, 10, length.out=1000)
    abline(v=range, col="blue")
    dev.off()
  }
        }
        
      }
    }
  }
  
}
```

Geom 5, asymetric barrier 2

```{r}
SM <- c(1.5, 2)
Wl <- c(1, 1)
Wr <- c(3, 4)

R <- seq(2, 5, 1)
SS <- floor(runif(5, 1, 1000))
fr <- 0.3
N <- c(50, 100)

#SM <- c(1.5)
#Wl <- c(2)
#Wr <- c(4)
#R <- 2
#SS <- floor(runif(1, 1, 1000))
#fr <- 0.3
#N <- c(50)

for (s in 1:length(SS)) {
  for (d in 1:length(SM)) {
    for (w in 1:length(Wl)) {
      for(r in 1:length(R)) {
        for (n in 1:length(N)) {
          fp <- file.path("gif/geom3", paste0("sm", SM[d], "wl", Wl[w], "wr", Wr[w], "r", R[r], "seed", SS[s], ".n", N[n], "/"))
          dir.create(fp, recursive = TRUE)
          
          smalldist = SM[d]
          width = c(Wl[w],Wr[w])
          range = R[r]
          max.edge.length = 0.4
          n = N[n]
          set.inla.seed = SS[s]
          x.mid = 10
          xlim.big  = c(0,20)
          xlim.small = c(3,17)
          ylim.big = c(0,20)
          ylim.small = c(3,17)
          fr = fr
          prior.range = prior.range
          prior.sigma = c(1,0.1)
          sigma.u = 1
          sigma.epsilon = 0.2
          prior.range.st = prior.range
          prior.sigma.st = c(1,0.1)
          gif.path = fp
          marginals.path = fp


  poly1 <- local.square.polygon(xlim=c(xlim.big[1]-1, x.mid-smalldist/2), 
                          ylim=x.mid+width[1]*c(-.5, .5))

  poly2 <- local.square.polygon(xlim=c(x.mid+smalldist/2, xlim.big[2]+1), 
                          ylim=x.mid+width[2]*c(-.5, .5))

  poly.original <- SpatialPolygons(c(poly1@polygons, poly2@polygons))
  
  loc1 <- matrix(c(xlim.big[1],ylim.big[1], 
                   xlim.big[2],ylim.big[1], 
                   xlim.big[2],ylim.big[2], 
                   xlim.big[1],ylim.big[2]), 4, 2, byrow = T)
  
  seg <- inla.sp2segment(poly.original)
# - Transforms a SpatialPolygon to an "inla polygon"
  mesh <- inla.mesh.2d(loc=loc1, 
                      interior = seg, 
                       max.e = max.edge.length, 
                       offset=1)

  tl <- length(mesh$graph$tv[,1])
# - the number of triangles in the mesh
  posTri <- matrix(0, tl, 2)

  for (t in 1:tl){
    temp = mesh$loc[mesh$graph$tv[t, ], ]
    posTri[t,] = colMeans(temp)[c(1,2)] 
}

  posTri <- SpatialPoints(posTri)
# - the positions of the triangle centers

  bar.original <- over(poly.original, SpatialPoints(posTri), returnList=T)
# - checking which mesh triangles are inside the barrier area
  bar.original <- unlist(bar.original)
  poly.bar.orginal <- inla.barrier.polygon(mesh, barrier.triangles = bar.original)
# - the Barrier model's polygon
# - in most cases this should be the same as poly.original

# BARRIER 1
  bar1 <- over(poly1, SpatialPoints(posTri), returnList=T)
# - checking which mesh triangles are inside the barrier area
  bar1 <- unlist(bar1)
  poly.bar1 <- inla.barrier.polygon(mesh, barrier.triangles = bar1)
# - the Barrier model's polygon
# - in most cases this should be the same as poly.original

# BARRIER 2
  bar2 <- over(poly2, SpatialPoints(posTri), returnList=T)
# - checking which mesh triangles are inside the barrier area
  bar2 <- unlist(bar2)
  poly.bar2 <- inla.barrier.polygon(mesh, barrier.triangles = bar2)

  mat <-  inla.barrier.fem.plus(mesh, list(bar1, bar2)) 
  fem <- mat 
  barrier.triangles <- list(bar1, bar2)

# PLOTS
  poly1_h <- local.square.polygon_T(xlim=c(xlim.small[1], x.mid-smalldist/2), 
                            ylim=x.mid+width[1]*c(-.5, .5))

  poly2_h <- local.square.polygon_T(xlim=c(x.mid+smalldist/2, xlim.small[2]), 
                            ylim=x.mid+width[2]*c(-.5, .5))

  loc2 <- matrix(c(3,3, 17,3, 17,17, 3,17), 4, 2, byrow = T)

  locp2 <- Polygon(loc2, hole = FALSE)
    
  poly.water <- SpatialPolygons(list(Polygons(list(locp2, poly1_h, poly2_h), '0')))
  poly.water_sf <- st_as_sf(poly.water)
    
  set.seed(set.inla.seed)
  loc.data <- spsample(x = poly.water, n = n, type = "random")
  loc.data_sf <- st_as_sf(loc.data)
  loc.data <- loc.data@coords

  poly.rect <- SpatialPolygons(list(Polygons(list(poly1_h, poly2_h), '0')))
  poly.rect_sf <- st_as_sf(poly.rect)
  poly.sq <- SpatialPolygons(list(Polygons(list(locp2), '0')))
  poly.sq_sf <- st_as_sf(poly.sq)

  sq_bbox <- st_bbox(poly.sq_sf) %>% st_as_sfc()
  poly1_bbox <- st_bbox(poly1) %>% st_as_sfc()
  poly2_bbox <- st_bbox(poly2) %>% st_as_sfc()

  tbm.frac <- list()

  for (p in 1:length(fr)) { #
    f <- fr[p]
    range.fraction <- c(f, f)
    tbm.frac[[p]] <- model.tbm.plus(mesh = mesh, fem = fem, 
                               barrier.triangles = barrier.triangles,
                               prior.range = prior.range, prior.sigma = prior.sigma ,  
                               range.fraction = range.fraction,
                               range = range,
                               set.inla.seed = set.inla.seed,
                               loc.data = loc.data,
                               sigma.u = 1, sigma.epsilon = 0.2,
                               poly.original = poly.bar.orginal,
                               prior.range.st = prior.range.st,
                               prior.sigma.st = prior.sigma.st,
                               return.list = TRUE)
  }
  
  trans <- tbm.frac
  plot.model.tbm.plus(trans, 
                       fr,
                       poly.bar.orginal = poly.bar.orginal,
                       range = range,
                       fps = 1,
                       gif.path = fp)

  for (r in 1:length(trans)) {
    f <- fr[p]
    range.fraction <- c(f, f)
    fpp <- file.path(paste0(marginals.path, f, ".png"))
    png(fpp)
    par(mfrow = c(3, 1))
    tmp = inla.tmarginal(function(x) exp(x), trans[[p]]$pos.tbm$res$marginals.hyperpar[[3]]) 
    plot(tmp, type = "l", xlab = "r", ylab = "Density", xlim = c(0,8))
         xvals = seq(0, 10, length.out=1000)
      
    abline(v=range, col="blue")
    
    tmp = inla.tmarginal(function(x) exp(x), trans[[p]]$pos.bm$res$marginals.hyperpar[[3]]) 
    plot(tmp, type = "l", xlab = "r", ylab = "Density", xlim = c(0,8))
         xvals = seq(0, 10, length.out=1000)
      
    abline(v=range, col="blue")
  
    tmp = inla.tmarginal(function(x) (x), trans[[p]]$pos.st$res$marginals.hyperpar[[2]]) 
    plot(tmp, type = "l", xlab = "r", ylab = "Density", xlim = c(0,8))
         xvals = seq(0, 10, length.out=1000)
    abline(v=range, col="blue")
    dev.off()
  }
        }
        
      }
    }
  }
  
}
```

```{r}

```


POISSON
https://stackoverflow.com/questions/63359861/simulate-inhomogenous-poisson-point-process-and-retrieve-the-covariate-coefficie
```{r}
library(spatstat)
library(sf)
library(sp)
library(maptools)
library(raster)
library(fields)
library(rstan)
library(tidyverse)

# Generate species distribution
genDat_pp <- function(b1, b2, dim, plotdat = TRUE){

# Define the window of interest
win <- owin(c(0,dim[1]), c(0,dim[2]))

# set number of pixels to simulate an environmental covariate
spatstat.options(npixel=c(dim[1],dim[2]))

y0 <- seq(win$yrange[1], win$yrange[2],
        length=spatstat.options()$npixel[2])
x0 <- seq(win$xrange[1], win$xrange[2],
        length=spatstat.options()$npixel[1])
multiplier <- 1/dim[2]

# Make the environmental covariate
gridcov <- outer(x0,y0, function (x,y) multiplier*y + 0*x)

# Set the coefficients
beta0 <- b1
beta1 <- b2

# Simulate the point pattern
pp <- rpoispp(im(beta0 + beta1*gridcov, xcol=x0, yrow=y0))
qcounts <- quadratcount(pp, ny=dim[1], nx=dim[2])
dens <- density(pp)
Lambda <- as.vector(t(qcounts))

if(plotdat == TRUE){
  par(mfrow=c(1,2), mar=c(2,2,1,1), mgp=c(1,0.5,0))
  plot(im(gridcov), main = 'Covariate')
  plot(dens, main = 'Intensity')
}
# Return a list with which I can play with
return(list(Lambda = Lambda, pp = pp, gridcov = gridcov))
}

b1 <- 2
b2 <- 5
dim <- c(20,20)

# Generate data
pp <- genDat_pp(b1, b2, dim)
```


```{r}
# comparison between tbm, bm and stat
model.tbm.plus <- function(mesh = mesh, 
                      fem = fem, 
                      barrier.triangles = barrier.triangles, 
                      prior.range = c(1, 0.5), prior.sigma = c(1, 0.1),
                      range.fraction = range.fraction,
                      range = range,
                      set.inla.seed = set.inla.seed, # make sure is the same as prev. fx if loc.data = T
                      loc.data = loc.data, 
                      sigma.u = 1, sigma.epsilon = 0.2,
                      poly.original = poly.bar.orginal,
                      prior.range.st = c(1, 0.5),    
                      prior.sigma.st = c(1, 0.1),
                      return.list = TRUE) {
  
  # field = TRUE has to be true to start
  tbm <- inla.barrier.pcmatern.plus(mesh, fem, barrier.triangles, 
                                              prior.range, prior.sigma, 
                                              range.fraction)
  # range fraction has to have the same length as barrier triangles
  Q <- inla.rgeneric.q(tbm, "Q", theta = c(log(1), log(range))) #log(1) or log(prior.sigma[1])
  u <- suppressWarnings(inla.qsample(n=1, Q=Q, seed = set.inla.seed))
  u <- u[ ,1]
    
  A.data <- inla.spde.make.A(mesh, loc.data)
  #Q from mydiff.r function
    
  u.data <- A.data %*% u
  
  df <- data.frame(loc.data)
  names(df) <- c('locx', 'locy')
  df$y <- drop(sigma.u * u.data + sigma.epsilon * rnorm(nrow(df)))
  
    
  stk <- inla.stack(data=list(y=df$y), 
                    A=list(A.data, 1),
                    effects=list(s=1:mesh$n, 
                                 intercept=rep(1, nrow(df))), 
                    remove.unused = FALSE, 
                    tag='est')

    
  formula <- y ~ 0 + intercept + f(s, model = tbm)
  # - The spatial model component is different from stationary
  # - The rest of the model setup is the same as in the stationary case!
  # - - e.g. the inla(...) call below is the same, 
  #     only this formula is different
  
    
  res.tbm <- inla(formula, data = inla.stack.data(stk),
                  control.predictor = list(A = inla.stack.A(stk)),
                  family = 'gaussian',
                  control.family = list(hyper = list(
                    prec = list(prior = "pc.prec", fixed = FALSE, param = c(0.2,0.5)))),
                  control.mode=list(restart=T, theta=c(3.2, 0.4, 1.6)))
  
  ##barrier model (classic)
  bm <- inla.barrier.pcmatern.plus(mesh, fem, barrier.triangles,
                                   prior.range, prior.sigma, 
                                   range.fraction = c(0.01, 0.01))
  
  formula.bm <- y ~ 0 + intercept + f(s, model = bm)
  
  res.bm <- inla(formula.bm, 
                 data = inla.stack.data(stk),
                 control.predictor = list(A = inla.stack.A(stk)),
                 family = 'gaussian',
                 control.family = list(hyper = list(
                   prec = list(prior = "pc.prec", fixed = FALSE, param = c(0.2,0.5)))),
                 control.mode=list(restart=T, theta=c(3.2, 0.4, 1.6)))
  ##stationary
  model.stat <- inla.spde2.pcmatern(mesh, 
                                    prior.range = c(prior.range.st[1], prior.range.st[2]),
                                    prior.sigma = c(prior.sigma.st[1], prior.sigma.st[2]))
  
  formula.st <- y ~ 0 + intercept + f(s, model=model.stat)
  
  res.stationary <- inla(formula.st, data=inla.stack.data(stk),
            control.predictor=list(A = inla.stack.A(stk)),
            family = 'gaussian',
            control.family = list(hyper = list(prec = list(
              prior = "pc.prec", fixed = FALSE, 
              param = c(0.2,0.5)))),
            control.mode=list(restart=T, theta=c(4,-1.7,0.25)))
  
  if (return.list == TRUE) {
    
    list.field <- list(barrier.model = tbm, Q = Q, sample = u, df = df)
    pos.tbm <- list(res = res.tbm)
    pos.bm <- list(res = res.bm)
    pos.st <- list(res = res.stationary)
    
    return(list(list.field = list.field, pos.tbm = pos.tbm, pos.bm = pos.bm, pos.st = pos.st))
  }
                     
}

```

```{r}
trial.geom.plus <- 
function(smalldist,
         width,
         range,
         max.edge.length,
         n,
         set.inla.seed,
         x.mid = 10,
         xlim.big  = c(0,20),
         xlim.small = c(3,17),
         ylim.big = c(0,20),
         ylim.small = c(3,17),
         fr,
         prior.range,
         prior.sigma,
         sigma.u = 1, 
         sigma.epsilon = 0.2,
         prior.range.st,
         prior.sigma.st,
         gif.path = "gif/",
         marginals.path = "gif/"){
  
  poly1 <- local.square.polygon(xlim=c(xlim.big[1]-1, x.mid-smalldist/2), 
                          ylim=x.mid+width[1]*c(-.5, .5))

  poly2 <- local.square.polygon(xlim=c(x.mid+smalldist/2, xlim.big[2]+1), 
                          ylim=x.mid+width[2]*c(-.5, .5))

  poly.original <- SpatialPolygons(c(poly1@polygons, poly2@polygons))
  
  loc1 <- matrix(c(xlim.big[1],ylim.big[1], 
                   xlim.big[2],ylim.big[1], 
                   xlim.big[2],ylim.big[2], 
                   xlim.big[1],ylim.big[2]), 4, 2, byrow = T)
  
  seg <- inla.sp2segment(poly.original)
# - Transforms a SpatialPolygon to an "inla polygon"
  mesh <- inla.mesh.2d(loc=loc1, 
                      interior = seg, 
                       max.e = max.edge.length, 
                       offset=1)

  tl <- length(mesh$graph$tv[,1])
# - the number of triangles in the mesh
  posTri <- matrix(0, tl, 2)

  for (t in 1:tl){
    temp = mesh$loc[mesh$graph$tv[t, ], ]
    posTri[t,] = colMeans(temp)[c(1,2)] 
}

  posTri <- SpatialPoints(posTri)
# - the positions of the triangle centers

  bar.original <- over(poly.original, SpatialPoints(posTri), returnList=T)
# - checking which mesh triangles are inside the barrier area
  bar.original <- unlist(bar.original)
  poly.bar.orginal <- inla.barrier.polygon(mesh, barrier.triangles = bar.original)
# - the Barrier model's polygon
# - in most cases this should be the same as poly.original

# BARRIER 1
  bar1 <- over(poly1, SpatialPoints(posTri), returnList=T)
# - checking which mesh triangles are inside the barrier area
  bar1 <- unlist(bar1)
  poly.bar1 <- inla.barrier.polygon(mesh, barrier.triangles = bar1)
# - the Barrier model's polygon
# - in most cases this should be the same as poly.original

# BARRIER 2
  bar2 <- over(poly2, SpatialPoints(posTri), returnList=T)
# - checking which mesh triangles are inside the barrier area
  bar2 <- unlist(bar2)
  poly.bar2 <- inla.barrier.polygon(mesh, barrier.triangles = bar2)

  mat <-  inla.barrier.fem.plus(mesh, list(bar1, bar2)) 
  fem <- mat 
  barrier.triangles <- list(bar1, bar2)

# PLOTS
  poly1_h <- local.square.polygon_T(xlim=c(xlim.small[1], x.mid-smalldist/2), 
                            ylim=x.mid+width[1]*c(-.5, .5))

  poly2_h <- local.square.polygon_T(xlim=c(x.mid+smalldist/2, xlim.small[2]), 
                            ylim=x.mid+width[2]*c(-.5, .5))

  loc2 <- matrix(c(3,3, 17,3, 17,17, 3,17), 4, 2, byrow = T)

  locp2 <- Polygon(loc2, hole = FALSE)
    
  poly.water <- SpatialPolygons(list(Polygons(list(locp2, poly1_h, poly2_h), '0')))
  poly.water_sf <- st_as_sf(poly.water)
    
  set.seed(set.inla.seed)
  loc.data <- spsample(x = poly.water, n = n, type = "random")
  loc.data_sf <- st_as_sf(loc.data)
  loc.data <- loc.data@coords

  poly.rect <- SpatialPolygons(list(Polygons(list(poly1_h, poly2_h), '0')))
  poly.rect_sf <- st_as_sf(poly.rect)
  poly.sq <- SpatialPolygons(list(Polygons(list(locp2), '0')))
  poly.sq_sf <- st_as_sf(poly.sq)

  sq_bbox <- st_bbox(poly.sq_sf) %>% st_as_sfc()
  poly1_bbox <- st_bbox(poly1) %>% st_as_sfc()
  poly2_bbox <- st_bbox(poly2) %>% st_as_sfc()

  gg.mesh <- ggplot() + 
    inlabru::gg(mesh) +
    geom_sf(data =poly.rect_sf,
            col='black', alpha=0) + #alpha color inside rect
    geom_sf(data=poly1_bbox, fill=NA, color="red", linewidth = 0.7, linetype = "dashed") +
    geom_sf(data=poly2_bbox, fill=NA, color="red", linewidth = 0.7, linetype = "dashed") +
    geom_sf(data=sq_bbox, fill=NA, color="black", linewidth = 0.7)

  gg.mesh.water <- ggplot() +
    inlabru::gg(mesh) +
    geom_sf(data =poly.rect_sf,
            col='black', alpha=1) + #alpha color inside rect
    geom_sf(data=sq_bbox, fill=NA, color="black", linewidth = 0.7) +
    geom_sf(data=poly1_bbox, color="black", linewidth = 0.7) +
    geom_sf(data=poly2_bbox, color="black", linewidth = 0.7) +
    ylim(c(3, 17)) +
    xlim(c(3, 17))

  gg.mesh.data <- gg.mesh +
    geom_sf(data =loc.data_sf,
            col='black',size=1.7,alpha=0.5)

  gg.mesh.water.data <- gg.mesh.water +
    geom_sf(data =loc.data_sf,
            col='black',size=1.7,alpha=0.5)
  gg <- list(mesh = gg.mesh, mesh.water = gg.mesh.water, mesh.data = gg.mesh.data, mesh.water.data = gg.mesh.water.data)
  ###
  tbm.frac <- list()

  for (r in 1:length(fr)) { #
    f <- fr[r]
    range.fraction <- c(f, f)
    tbm.frac[[r]] <- model.tbm.plus(mesh = mesh, fem = fem, 
                               barrier.triangles = barrier.triangles,
                               prior.range = prior.range, prior.sigma = prior.sigma ,  
                               range.fraction = range.fraction,
                               range = range,
                               set.inla.seed = set.inla.seed,
                               loc.data = loc.data,
                               sigma.u = 1, sigma.epsilon = 0.2,
                               poly.original = poly.bar.orginal,
                               prior.range.st = prior.range.st,
                               prior.sigma.st = prior.sigma.st,
                               return.list = TRUE)
  }
  
  trans <- tbm.frac
  plot.model.tbm.plus(trans, 
                       fr,
                       poly.bar.orginal = poly.bar.orginal,
                       range = range,
                       fps = 1,
                       gif.path = gif.path)

  for (r in 1:length(trans)) {
    f <- fr[r]
    range.fraction <- c(f, f)
    fpp <- file.path(paste0(marginals.path, f, ".png"))
    png(fpp)
    par(mfrow = c(3, 1))
    tmp = inla.tmarginal(function(x) exp(x), trans[[r]]$pos.tbm$res$marginals.hyperpar[[3]]) 
    plot(tmp, type = "l", xlab = "r", ylab = "Density", xlim = c(0,8))
         xvals = seq(0, 10, length.out=1000)
      
    abline(v=range, col="blue")
    
    tmp = inla.tmarginal(function(x) exp(x), trans[[r]]$pos.bm$res$marginals.hyperpar[[3]]) 
    plot(tmp, type = "l", xlab = "r", ylab = "Density", xlim = c(0,8))
         xvals = seq(0, 10, length.out=1000)
      
    abline(v=range, col="blue")
  
    tmp = inla.tmarginal(function(x) (x), trans[[r]]$pos.st$res$marginals.hyperpar[[2]]) 
    plot(tmp, type = "l", xlab = "r", ylab = "Density", xlim = c(0,8))
         xvals = seq(0, 10, length.out=1000)
    abline(v=range, col="blue")
    dev.off()
  }
  return.list <- list(gg=gg, trans = tbm.frac)
  return(return.list)

}

```

```{r}
plot.model.tbm.flex3 <- 
function(trans, 
           fr,
           nfrac,
           max.frac = 1,
           min.r = min.r,
           poly.bar.orginal = poly.bar.orginal,
           range = range,
           fps = 1,
           set.inla.seed = set.inla.seed,
                              col=alpha('grey', 0),
                              plot.points = points(loc.data, 
                                              pch = 16, 
                                              cex = 0.8, 
                                              col=alpha('gray', 0)),
                              gif.path = "gif/",
                              pal.field = turbo(50),
                              pal.pos.mean = turbo(50),
                              pal.pos.sd = turbo(50),
                              pal.pos.q25 = turbo(50),
                              pal.pos.q50 = turbo(50),
                              pal.pos.q975 = turbo(50),
                              
                              pal.pos.mean.st = turbo(50),
                              pal.pos.sd.st = turbo(50),
                              pal.pos.q25.st = turbo(50),
                              pal.pos.q50.st = turbo(50),
                              pal.pos.q975.st = turbo(50),
                              ...
    ){
  dir_out_f <- file.path(tempdir(), "truefield_gif")
  dir.create(dir_out_f, recursive = TRUE)
  
  # barrier model
  dir_out_pm <- file.path(tempdir(), "posmean_gif")
  dir.create(dir_out_pm, recursive = TRUE)
  
  dir_out_sd <- file.path(tempdir(), "possd_gif")
  dir.create(dir_out_sd, recursive = TRUE)
  
  dir_out_q25 <- file.path(tempdir(), "posq25_gif")
  dir.create(dir_out_q25, recursive = TRUE)
  
  dir_out_q5 <- file.path(tempdir(), "posq5_gif")
  dir.create(dir_out_q5, recursive = TRUE)
  
  dir_out_q975 <- file.path(tempdir(), "posq975_gif")
  dir.create(dir_out_q975, recursive = TRUE)
  
  # stationary model
  dir_out_s <- file.path(tempdir(), "statmodel_gif")
  dir.create(dir_out_s, recursive = TRUE)
  
  dir_out_st.sd <- file.path(tempdir(), "st.sd_gif")
  dir.create(dir_out_st.sd, recursive = TRUE)
  
  dir_out_st.q25 <- file.path(tempdir(), "pos.st.q25_gif")
  dir.create(dir_out_st.q25, recursive = TRUE)
  
  dir_out_st.q5 <- file.path(tempdir(), "pos.st.q5_gif")
  dir.create(dir_out_st.q5, recursive = TRUE)
  
  dir_out_st.q975 <- file.path(tempdir(), "pos.st.q975_gif")
  dir.create(dir_out_st.q975, recursive = TRUE)
  
  for (r in 1:length(trans)) {
    
    f <- fr[r]
    range.fraction <- c(f, f)
    
    # SPATIAL FIELD, u
    fpp <- file.path(dir_out_f, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$list.field$sample, 
                     main="Spatial (simulated) true field",
                     sub = paste("Barrier Model, range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     pal = pal.field)
    plot(poly.bar.orginal, add=T, col = col)
    plot.points
    dev.off()
    
    # POSTERIOR MEAN
    fpp <- file.path(dir_out_pm, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.bm$res$summary.random$s$mean, 
                     main="Spatial estimate for Barrier model",
                     sub = paste("range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     pal = pal.pos.mean)
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()
    
    #POS SD
    fpp <- file.path(dir_out_sd, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.bm$res$summary.random$s$sd, 
                     main="Spatial sd estimate for Barrier model",
                     sub = paste("Barrier Model, range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     pal = pal.pos.sd)
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()
    
    #POS QUANTILES
    # 0.025
    fpp <- file.path(dir_out_q25, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.bm$res$summary.random$s[,4], 
                     main="Spatial 0.025 quantile estimate for Barrier model",
                     sub = paste("Barrier Model, range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     pal = pal.pos.q25)
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()

    # 0.5
    fpp <- file.path(dir_out_q5, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.bm$res$summary.random$s[,5], 
                     main="Spatial 0.5 quantile estimate for Barrier model",
                     sub = paste("Barrier Model, range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     pal = pal.pos.q50)
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()
    
    # 0.975
    fpp <- file.path(dir_out_q975, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.bm$res$summary.random$s[,6], 
                     main="Spatial 0.975 quantile estimate for Barrier model",
                     sub = paste("Barrier Model, range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     pal = pal.pos.q975)
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()
    
    # SPATIAL ESTIMATE WITH STATIONARY MODEL
    fpp <- file.path(dir_out_s, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.st$res$summary.random$s$mean,
                     main="Spatial estimate with the stationary model",
                     sub = paste("Barrier Model, range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     pal = pal.pos.mean.st) 
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()
    
    #POS SD st
    fpp <- file.path(dir_out_st.sd, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.st$res$summary.random$s$sd, 
                     main="Spatial sd estimate with the stationary model",
                     sub = paste("Barrier Model, range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     pal = pal.pos.sd.st)
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()
    
    #POS QUANTILES st
    # 0.025 st
    fpp <- file.path(dir_out_st.q25, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.st$res$summary.random$s[,4], 
                     main="Spatial 0.025 estimate with the stationary model",
                     sub = paste("Barrier Model, range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     pal = pal.pos.q25.st)
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()

    # 0.5 st
    fpp <- file.path(dir_out_st.q5, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.st$res$summary.random$s[,5], 
                     main="Spatial 0.5 quantile estimate with the stationary model",
                     sub = paste("Barrier Model, range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     pal = pal.pos.q50.st)
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()
    
    # 0.975 st
    fpp <- file.path(dir_out_st.q975, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.st$res$summary.random$s[,6], 
                     main="Spatial 0.975 quantile estimate with the stationary model",
                     sub = paste("Barrier Model, range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     pal = pal.pos.q975.st)
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()
  }
  
    ## bm
    # SPATIAL FIELD, u
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_f, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "true.field.gif"))
    
    # POSTERIOR MEAN
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_pm, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "pos.mean.gif"))
    
    #POS SD
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_sd, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "pos.sd.gif"))
    
    #POS QUANTILES
    # 0.025
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_q25, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "pos.q25.gif"))
    
    # 0.5
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_q5, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "pos.q5.gif"))
    
    # 0.975
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_q975, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "pos.q975.gif"))
    
    ## st
    # u
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_s, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "stat.rnadom.mean.gif"))
    
    # st sd
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_st.sd, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "pos.sd.st.gif"))
    
    #POS QUANTILES st
    # 0.025
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_st.q25, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "pos.q25.st.gif"))
    
    # 0.5
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_st.q5, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "pos.q5.st.gif"))
    
    # 0.975
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_st.q975, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "pos.q975.st.gif"))
    
    unlink(dir_out_f, recursive = T)
    unlink(dir_out_pm, recursive = T)
    unlink(dir_out_sd, recursive = T)
    unlink(dir_out_q25, recursive = T)
    unlink(dir_out_q5, recursive = T)
    unlink(dir_out_q975, recursive = T)
    unlink(dir_out_s, recursive = T)
    unlink(dir_out_st.sd, recursive = T)
    unlink(dir_out_st.q25, recursive = T)
    unlink(dir_out_st.q5, recursive = T)
    unlink(dir_out_st.q975, recursive = T)
}
```


```{r}
plot.model.tbm.plus <- 
function(trans, 
           fr,
           max.frac = 1,
           min.r = min.r,
           poly.bar.orginal = poly.bar.orginal,
           range = range,
           fps = 1,
           set.inla.seed = set.inla.seed,
                              col=alpha('grey', 0),
                              plot.points = points(loc.data, 
                                              pch = 16, 
                                              cex = 0.8, 
                                              col=alpha('gray', 0)),
                              gif.path = "gif/",
                              pal.field = turbo(50),
                              pal.pos.mean = turbo(50),
                              pal.pos.sd = turbo(50),
                              pal.pos.q25 = turbo(50),
                              pal.pos.q50 = turbo(50),
                              pal.pos.q975 = turbo(50),
                              
                              pal.pos.mean.st = turbo(50),
                              pal.pos.sd.st = turbo(50),
                              pal.pos.q25.st = turbo(50),
                              pal.pos.q50.st = turbo(50),
                              pal.pos.q975.st = turbo(50),
                              ...
    ){
  dir_out_f <- file.path(tempdir(), "truefield_gif")
  dir.create(dir_out_f, recursive = TRUE)
  
  # t. barrier model
  dir_out_pm.tbm <- file.path(tempdir(), "mean.tbm_gif")
  dir.create(dir_out_pm.tbm, recursive = TRUE)
  
  dir_out_sd.tbm <- file.path(tempdir(), "sd.tbm_gif")
  dir.create(dir_out_sd.tbm, recursive = TRUE)
  
  dir_out_q25.tbm <- file.path(tempdir(), "q25.tbm_gif")
  dir.create(dir_out_q25.tbm, recursive = TRUE)
  
  dir_out_q5.tbm <- file.path(tempdir(), "q5.tbm_gif")
  dir.create(dir_out_q5.tbm, recursive = TRUE)
  
  dir_out_q975.tbm <- file.path(tempdir(), "q975.tbm_gif")
  dir.create(dir_out_q975.tbm, recursive = TRUE)
  
  # barrier model
  dir_out_pm <- file.path(tempdir(), "mean.bm_gif")
  dir.create(dir_out_pm, recursive = TRUE)
  
  dir_out_sd <- file.path(tempdir(), "sd.bm_gif")
  dir.create(dir_out_sd, recursive = TRUE)
  
  dir_out_q25 <- file.path(tempdir(), "q25.bm_gif")
  dir.create(dir_out_q25, recursive = TRUE)
  
  dir_out_q5 <- file.path(tempdir(), "q5.bm_gif")
  dir.create(dir_out_q5, recursive = TRUE)
  
  dir_out_q975 <- file.path(tempdir(), "q975.bm_gif")
  dir.create(dir_out_q975, recursive = TRUE)
  
  # stationary model
  dir_out_s <- file.path(tempdir(), "mean.st_gif")
  dir.create(dir_out_s, recursive = TRUE)
  
  dir_out_st.sd <- file.path(tempdir(), "sd.st_gif")
  dir.create(dir_out_st.sd, recursive = TRUE)
  
  dir_out_st.q25 <- file.path(tempdir(), "q25.st_gif")
  dir.create(dir_out_st.q25, recursive = TRUE)
  
  dir_out_st.q5 <- file.path(tempdir(), "q5.st_gif")
  dir.create(dir_out_st.q5, recursive = TRUE)
  
  dir_out_st.q975 <- file.path(tempdir(), "q975.st_gif")
  dir.create(dir_out_st.q975, recursive = TRUE)
  
  for (r in 1:length(trans)) {
    
    f <- fr[r]
    range.fraction <- c(f, f)
    
    # SPATIAL FIELD, u
    fpp <- file.path(dir_out_f, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$list.field$sample, 
                     main="Spatial true (simulated) field",
                     sub = paste("Barrier Model, range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     axes = F, pal = pal.field)
    plot(poly.bar.orginal, add=T, col = col)
    plot.points
    dev.off()
    
    ## TBM
    # POSTERIOR MEAN
    fpp <- file.path(dir_out_pm.tbm, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.tbm$res$summary.random$s$mean, 
                     main="Spatial estimate for Transparent Barrier model",
                     sub = paste("range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     axes = F, pal = pal.pos.mean)
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()
    
    #POS SD
    fpp <- file.path(dir_out_sd.tbm, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.tbm$res$summary.random$s$sd, 
                     main="Spatial sd estimate for Transparent Barrier model",
                     sub = paste("Barrier Model, range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     axes = F, pal = pal.pos.sd)
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()
    
    #POS QUANTILES
    # 0.025
    fpp <- file.path(dir_out_q25.tbm, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.tbm$res$summary.random$s[,4], 
                     main="Spatial 0.025 quantile estimate for Transparent Barrier model",
                     sub = paste("Barrier Model, range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     axes = F, pal = pal.pos.q25)
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()

    # 0.5
    fpp <- file.path(dir_out_q5.tbm, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.tbm$res$summary.random$s[,5], 
                     main="Spatial 0.5 quantile estimate for Transparent Barrier model",
                     sub = paste("Barrier Model, range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     axes = F, pal = pal.pos.q50)
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()
    
    # 0.975
    fpp <- file.path(dir_out_q975.tbm, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.tbm$res$summary.random$s[,6], 
                     main="Spatial 0.975 quantile estimate for Transparent Barrier model",
                     sub = paste("Barrier Model, range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     axes = F, pal = pal.pos.q975)
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()
    
    ##BM
    fpp <- file.path(dir_out_pm, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.bm$res$summary.random$s$mean, 
                     main="Spatial estimate for Barrier model",
                     sub = paste("range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     axes = F, pal = pal.pos.mean)
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()
    
    #POS SD
    fpp <- file.path(dir_out_sd, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.bm$res$summary.random$s$sd, 
                     main="Spatial sd estimate for Barrier model",
                     sub = paste("Barrier Model, range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     axes = F, pal = pal.pos.sd)
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()
    
    #POS QUANTILES
    # 0.025
    fpp <- file.path(dir_out_q25, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.bm$res$summary.random$s[,4], 
                     main="Spatial 0.025 quantile estimate for Barrier model",
                     sub = paste("Barrier Model, range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     axes = F, pal = pal.pos.q25)
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()

    # 0.5
    fpp <- file.path(dir_out_q5, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.bm$res$summary.random$s[,5], 
                     main="Spatial 0.5 quantile estimate for Barrier model",
                     sub = paste("Barrier Model, range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     axes = F, pal = pal.pos.q50)
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()
    
    # 0.975
    fpp <- file.path(dir_out_q975, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.bm$res$summary.random$s[,6], 
                     main="Spatial 0.975 quantile estimate for Barrier model",
                     sub = paste("Barrier Model, range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     axes = F, pal = pal.pos.q975)
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()
    
    # SPATIAL ESTIMATE WITH STATIONARY MODEL
    fpp <- file.path(dir_out_s, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.st$res$summary.random$s$mean,
                     main="Spatial estimate with the stationary model",
                     sub = paste("Barrier Model, range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     axes = F, pal = pal.pos.mean.st) 
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()
    
    #POS SD st
    fpp <- file.path(dir_out_st.sd, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.st$res$summary.random$s$sd, 
                     main="Spatial sd estimate with the stationary model",
                     sub = paste("Barrier Model, range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     axes = F, pal = pal.pos.sd.st)
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()
    
    #POS QUANTILES st
    # 0.025 st
    fpp <- file.path(dir_out_st.q25, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.st$res$summary.random$s[,4], 
                     main="Spatial 0.025 estimate with the stationary model",
                     sub = paste("Barrier Model, range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     axes = F, pal = pal.pos.q25.st)
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()

    # 0.5 st
    fpp <- file.path(dir_out_st.q5, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.st$res$summary.random$s[,5], 
                     main="Spatial 0.5 quantile estimate with the stationary model",
                     sub = paste("Barrier Model, range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     axes = F, pal = pal.pos.q50.st)
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()
    
    # 0.975 st
    fpp <- file.path(dir_out_st.q975, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.st$res$summary.random$s[,6], 
                     main="Spatial 0.975 quantile estimate with the stationary model",
                     sub = paste("Barrier Model, range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     axes = F, pal = pal.pos.q975.st)
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()
  }
  
    ## bm
    # SPATIAL FIELD, u
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_f, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "true.field.gif"))
    
    ## TBM
    # POSTERIOR MEAN
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_pm.tbm, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "mean.tbm.gif"))
    
    #POS SD
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_sd.tbm, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "sd.tbm.gif"))
    
    #POS QUANTILES
    # 0.025
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_q25.tbm, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "q25.tbm.gif"))
    
    # 0.5
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_q5.tbm, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "q5.tbm.gif"))
    
    # 0.975
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_q975.tbm, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "q975.tbm.gif"))
    
    ## BM
    # POSTERIOR MEAN
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_pm, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "mean.bm.gif"))
    
    #POS SD
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_sd, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "sd.bm.gif"))
    
    #POS QUANTILES
    # 0.025
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_q25, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "q25.bm.gif"))
    
    # 0.5
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_q5, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "q5.bm.gif"))
    
    # 0.975
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_q975, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "q975.bm.gif"))
    
    ## st
    # u
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_s, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "mean.st.gif"))
    
    # st sd
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_st.sd, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "sd.st.gif"))
    
    #POS QUANTILES st
    # 0.025
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_st.q25, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "q25.st.gif"))
    
    # 0.5
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_st.q5, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "q5.st.gif"))
    
    # 0.975
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_st.q975, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "q975.st.gif"))
    
    unlink(dir_out_f, recursive = T)
    unlink(dir_out_pm.tbm, recursive = T)
    unlink(dir_out_sd.tbm, recursive = T)
    unlink(dir_out_q25.tbm, recursive = T)
    unlink(dir_out_q5.tbm, recursive = T)
    unlink(dir_out_q975.tbm, recursive = T)
    
    unlink(dir_out_pm, recursive = T)
    unlink(dir_out_sd, recursive = T)
    unlink(dir_out_q25, recursive = T)
    unlink(dir_out_q5, recursive = T)
    unlink(dir_out_q975, recursive = T)
    unlink(dir_out_s, recursive = T)
    unlink(dir_out_st.sd, recursive = T)
    unlink(dir_out_st.q25, recursive = T)
    unlink(dir_out_st.q5, recursive = T)
    unlink(dir_out_st.q975, recursive = T)
}
```


```{r}
plot.model.tbm.plus.l <- 
function(trans, 
           fr,
           max.frac = 1,
           min.r = min.r,
           poly.bar.orginal = poly.bar.orginal,
           range = range,
           fps = 1,
           set.inla.seed = set.inla.seed,
                              col=alpha('grey', 0),
                              plot.points = points(loc.data, 
                                              pch = 16, 
                                              cex = 0.8, 
                                              col=alpha('gray', 0)),
                              gif.path = "gif/",
                              pal.field = turbo(50),
                              pal.pos.mean = turbo(50),
                              pal.pos.sd = turbo(50),
                              pal.pos.q25 = turbo(50),
                              pal.pos.q50 = turbo(50),
                              pal.pos.q975 = turbo(50),
                              
                              pal.pos.mean.st = turbo(50),
                              pal.pos.sd.st = turbo(50),
                              pal.pos.q25.st = turbo(50),
                              pal.pos.q50.st = turbo(50),
                              pal.pos.q975.st = turbo(50),
                              ...
    ){
  dir_out_f <- file.path(tempdir(), "truefield_gif")
  dir.create(dir_out_f, recursive = TRUE)
  
  # t. barrier model
  dir_out_pm.tbm <- file.path(tempdir(), "mean.tbm_gif")
  dir.create(dir_out_pm.tbm, recursive = TRUE)
  
  dir_out_sd.tbm <- file.path(tempdir(), "sd.tbm_gif")
  dir.create(dir_out_sd.tbm, recursive = TRUE)
  
  dir_out_q25.tbm <- file.path(tempdir(), "q25.tbm_gif")
  dir.create(dir_out_q25.tbm, recursive = TRUE)
  
  dir_out_q5.tbm <- file.path(tempdir(), "q5.tbm_gif")
  dir.create(dir_out_q5.tbm, recursive = TRUE)
  
  dir_out_q975.tbm <- file.path(tempdir(), "q975.tbm_gif")
  dir.create(dir_out_q975.tbm, recursive = TRUE)
  
  # barrier model
  dir_out_pm <- file.path(tempdir(), "mean.bm_gif")
  dir.create(dir_out_pm, recursive = TRUE)
  
  dir_out_sd <- file.path(tempdir(), "sd.bm_gif")
  dir.create(dir_out_sd, recursive = TRUE)
  
  dir_out_q25 <- file.path(tempdir(), "q25.bm_gif")
  dir.create(dir_out_q25, recursive = TRUE)
  
  dir_out_q5 <- file.path(tempdir(), "q5.bm_gif")
  dir.create(dir_out_q5, recursive = TRUE)
  
  dir_out_q975 <- file.path(tempdir(), "q975.bm_gif")
  dir.create(dir_out_q975, recursive = TRUE)
  
  # stationary model
  dir_out_s <- file.path(tempdir(), "mean.st_gif")
  dir.create(dir_out_s, recursive = TRUE)
  
  dir_out_st.sd <- file.path(tempdir(), "sd.st_gif")
  dir.create(dir_out_st.sd, recursive = TRUE)
  
  dir_out_st.q25 <- file.path(tempdir(), "q25.st_gif")
  dir.create(dir_out_st.q25, recursive = TRUE)
  
  dir_out_st.q5 <- file.path(tempdir(), "q5.st_gif")
  dir.create(dir_out_st.q5, recursive = TRUE)
  
  dir_out_st.q975 <- file.path(tempdir(), "q975.st_gif")
  dir.create(dir_out_st.q975, recursive = TRUE)
  
  for (r in 1:length(trans)) {
    
    f <- fr[r]
    range.fraction <- c(0.01, f)
    
    # SPATIAL FIELD, u
    fpp <- file.path(dir_out_f, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$list.field$sample, 
                     main="Spatial true (simulated) field",
                     sub = paste("Barrier Model, range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     pal = pal.field)
    plot(poly.bar.orginal, add=T, col = col)
    plot.points
    dev.off()
    
    ## TBM
    # POSTERIOR MEAN
    fpp <- file.path(dir_out_pm.tbm, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.tbm$res$summary.random$s$mean, 
                     main="Spatial estimate for Transparent Barrier model",
                     sub = paste("range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     pal = pal.pos.mean)
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()
    
    #POS SD
    fpp <- file.path(dir_out_sd.tbm, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.tbm$res$summary.random$s$sd, 
                     main="Spatial sd estimate for Transparent Barrier model",
                     sub = paste("Barrier Model, range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     pal = pal.pos.sd)
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()
    
    #POS QUANTILES
    # 0.025
    fpp <- file.path(dir_out_q25.tbm, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.tbm$res$summary.random$s[,4], 
                     main="Spatial 0.025 quantile estimate for Transparent Barrier model",
                     sub = paste("Barrier Model, range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     pal = pal.pos.q25)
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()

    # 0.5
    fpp <- file.path(dir_out_q5.tbm, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.tbm$res$summary.random$s[,5], 
                     main="Spatial 0.5 quantile estimate for Transparent Barrier model",
                     sub = paste("Barrier Model, range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     pal = pal.pos.q50)
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()
    
    # 0.975
    fpp <- file.path(dir_out_q975.tbm, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.tbm$res$summary.random$s[,6], 
                     main="Spatial 0.975 quantile estimate for Transparent Barrier model",
                     sub = paste("Barrier Model, range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     pal = pal.pos.q975)
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()
    
    ##BM
    fpp <- file.path(dir_out_pm, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.bm$res$summary.random$s$mean, 
                     main="Spatial estimate for Barrier model",
                     sub = paste("range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     pal = pal.pos.mean)
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()
    
    #POS SD
    fpp <- file.path(dir_out_sd, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.bm$res$summary.random$s$sd, 
                     main="Spatial sd estimate for Barrier model",
                     sub = paste("Barrier Model, range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     pal = pal.pos.sd)
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()
    
    #POS QUANTILES
    # 0.025
    fpp <- file.path(dir_out_q25, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.bm$res$summary.random$s[,4], 
                     main="Spatial 0.025 quantile estimate for Barrier model",
                     sub = paste("Barrier Model, range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     pal = pal.pos.q25)
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()

    # 0.5
    fpp <- file.path(dir_out_q5, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.bm$res$summary.random$s[,5], 
                     main="Spatial 0.5 quantile estimate for Barrier model",
                     sub = paste("Barrier Model, range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     pal = pal.pos.q50)
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()
    
    # 0.975
    fpp <- file.path(dir_out_q975, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.bm$res$summary.random$s[,6], 
                     main="Spatial 0.975 quantile estimate for Barrier model",
                     sub = paste("Barrier Model, range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     pal = pal.pos.q975)
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()
    
    # SPATIAL ESTIMATE WITH STATIONARY MODEL
    fpp <- file.path(dir_out_s, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.st$res$summary.random$s$mean,
                     main="Spatial estimate with the stationary model",
                     sub = paste("Barrier Model, range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     pal = pal.pos.mean.st) 
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()
    
    #POS SD st
    fpp <- file.path(dir_out_st.sd, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.st$res$summary.random$s$sd, 
                     main="Spatial sd estimate with the stationary model",
                     sub = paste("Barrier Model, range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     pal = pal.pos.sd.st)
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()
    
    #POS QUANTILES st
    # 0.025 st
    fpp <- file.path(dir_out_st.q25, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.st$res$summary.random$s[,4], 
                     main="Spatial 0.025 estimate with the stationary model",
                     sub = paste("Barrier Model, range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     pal = pal.pos.q25.st)
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()

    # 0.5 st
    fpp <- file.path(dir_out_st.q5, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.st$res$summary.random$s[,5], 
                     main="Spatial 0.5 quantile estimate with the stationary model",
                     sub = paste("Barrier Model, range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     pal = pal.pos.q50.st)
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()
    
    # 0.975 st
    fpp <- file.path(dir_out_st.q975, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.st$res$summary.random$s[,6], 
                     main="Spatial 0.975 quantile estimate with the stationary model",
                     sub = paste("Barrier Model, range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     pal = pal.pos.q975.st)
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()
  }
  
    ## bm
    # SPATIAL FIELD, u
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_f, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "true.field.gif"))
    
    ## TBM
    # POSTERIOR MEAN
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_pm.tbm, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "mean.tbm.gif"))
    
    #POS SD
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_sd.tbm, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "sd.tbm.gif"))
    
    #POS QUANTILES
    # 0.025
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_q25.tbm, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "q25.tbm.gif"))
    
    # 0.5
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_q5.tbm, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "q5.tbm.gif"))
    
    # 0.975
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_q975.tbm, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "q975.tbm.gif"))
    
    ## BM
    # POSTERIOR MEAN
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_pm, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "mean.bm.gif"))
    
    #POS SD
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_sd, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "sd.bm.gif"))
    
    #POS QUANTILES
    # 0.025
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_q25, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "q25.bm.gif"))
    
    # 0.5
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_q5, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "q5.bm.gif"))
    
    # 0.975
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_q975, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "q975.bm.gif"))
    
    ## st
    # u
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_s, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "mean.st.gif"))
    
    # st sd
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_st.sd, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "sd.st.gif"))
    
    #POS QUANTILES st
    # 0.025
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_st.q25, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "q25.st.gif"))
    
    # 0.5
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_st.q5, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "q5.st.gif"))
    
    # 0.975
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_st.q975, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "q975.st.gif"))
    
    unlink(dir_out_f, recursive = T)
    unlink(dir_out_pm.tbm, recursive = T)
    unlink(dir_out_sd.tbm, recursive = T)
    unlink(dir_out_q25.tbm, recursive = T)
    unlink(dir_out_q5.tbm, recursive = T)
    unlink(dir_out_q975.tbm, recursive = T)
    
    unlink(dir_out_pm, recursive = T)
    unlink(dir_out_sd, recursive = T)
    unlink(dir_out_q25, recursive = T)
    unlink(dir_out_q5, recursive = T)
    unlink(dir_out_q975, recursive = T)
    unlink(dir_out_s, recursive = T)
    unlink(dir_out_st.sd, recursive = T)
    unlink(dir_out_st.q25, recursive = T)
    unlink(dir_out_st.q5, recursive = T)
    unlink(dir_out_st.q975, recursive = T)
}
```


```{r}
plot.model.tbm.plus.r <- 
function(trans, 
           fr,
           max.frac = 1,
           min.r = min.r,
           poly.bar.orginal = poly.bar.orginal,
           range = range,
           fps = 1,
           set.inla.seed = set.inla.seed,
                              col=alpha('grey', 0),
                              plot.points = points(loc.data, 
                                              pch = 16, 
                                              cex = 0.8, 
                                              col=alpha('gray', 0)),
                              gif.path = "gif/",
                              pal.field = turbo(50),
                              pal.pos.mean = turbo(50),
                              pal.pos.sd = turbo(50),
                              pal.pos.q25 = turbo(50),
                              pal.pos.q50 = turbo(50),
                              pal.pos.q975 = turbo(50),
                              
                              pal.pos.mean.st = turbo(50),
                              pal.pos.sd.st = turbo(50),
                              pal.pos.q25.st = turbo(50),
                              pal.pos.q50.st = turbo(50),
                              pal.pos.q975.st = turbo(50),
                              ...
    ){
  dir_out_f <- file.path(tempdir(), "truefield_gif")
  dir.create(dir_out_f, recursive = TRUE)
  
  # t. barrier model
  dir_out_pm.tbm <- file.path(tempdir(), "mean.tbm_gif")
  dir.create(dir_out_pm.tbm, recursive = TRUE)
  
  dir_out_sd.tbm <- file.path(tempdir(), "sd.tbm_gif")
  dir.create(dir_out_sd.tbm, recursive = TRUE)
  
  dir_out_q25.tbm <- file.path(tempdir(), "q25.tbm_gif")
  dir.create(dir_out_q25.tbm, recursive = TRUE)
  
  dir_out_q5.tbm <- file.path(tempdir(), "q5.tbm_gif")
  dir.create(dir_out_q5.tbm, recursive = TRUE)
  
  dir_out_q975.tbm <- file.path(tempdir(), "q975.tbm_gif")
  dir.create(dir_out_q975.tbm, recursive = TRUE)
  
  # barrier model
  dir_out_pm <- file.path(tempdir(), "mean.bm_gif")
  dir.create(dir_out_pm, recursive = TRUE)
  
  dir_out_sd <- file.path(tempdir(), "sd.bm_gif")
  dir.create(dir_out_sd, recursive = TRUE)
  
  dir_out_q25 <- file.path(tempdir(), "q25.bm_gif")
  dir.create(dir_out_q25, recursive = TRUE)
  
  dir_out_q5 <- file.path(tempdir(), "q5.bm_gif")
  dir.create(dir_out_q5, recursive = TRUE)
  
  dir_out_q975 <- file.path(tempdir(), "q975.bm_gif")
  dir.create(dir_out_q975, recursive = TRUE)
  
  # stationary model
  dir_out_s <- file.path(tempdir(), "mean.st_gif")
  dir.create(dir_out_s, recursive = TRUE)
  
  dir_out_st.sd <- file.path(tempdir(), "sd.st_gif")
  dir.create(dir_out_st.sd, recursive = TRUE)
  
  dir_out_st.q25 <- file.path(tempdir(), "q25.st_gif")
  dir.create(dir_out_st.q25, recursive = TRUE)
  
  dir_out_st.q5 <- file.path(tempdir(), "q5.st_gif")
  dir.create(dir_out_st.q5, recursive = TRUE)
  
  dir_out_st.q975 <- file.path(tempdir(), "q975.st_gif")
  dir.create(dir_out_st.q975, recursive = TRUE)
  
  for (r in 1:length(trans)) {
    
    f <- fr[r]
    range.fraction <- c(f, 0.01)
    
    # SPATIAL FIELD, u
    fpp <- file.path(dir_out_f, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$list.field$sample, 
                     main="Spatial true (simulated) field",
                     sub = paste("Barrier Model, range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     pal = pal.field)
    plot(poly.bar.orginal, add=T, col = col)
    plot.points
    dev.off()
    
    ## TBM
    # POSTERIOR MEAN
    fpp <- file.path(dir_out_pm.tbm, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.tbm$res$summary.random$s$mean, 
                     main="Spatial estimate for Transparent Barrier model",
                     sub = paste("range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     pal = pal.pos.mean)
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()
    
    #POS SD
    fpp <- file.path(dir_out_sd.tbm, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.tbm$res$summary.random$s$sd, 
                     main="Spatial sd estimate for Transparent Barrier model",
                     sub = paste("Barrier Model, range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     pal = pal.pos.sd)
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()
    
    #POS QUANTILES
    # 0.025
    fpp <- file.path(dir_out_q25.tbm, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.tbm$res$summary.random$s[,4], 
                     main="Spatial 0.025 quantile estimate for Transparent Barrier model",
                     sub = paste("Barrier Model, range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     pal = pal.pos.q25)
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()

    # 0.5
    fpp <- file.path(dir_out_q5.tbm, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.tbm$res$summary.random$s[,5], 
                     main="Spatial 0.5 quantile estimate for Transparent Barrier model",
                     sub = paste("Barrier Model, range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     pal = pal.pos.q50)
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()
    
    # 0.975
    fpp <- file.path(dir_out_q975.tbm, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.tbm$res$summary.random$s[,6], 
                     main="Spatial 0.975 quantile estimate for Transparent Barrier model",
                     sub = paste("Barrier Model, range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     pal = pal.pos.q975)
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()
    
    ##BM
    fpp <- file.path(dir_out_pm, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.bm$res$summary.random$s$mean, 
                     main="Spatial estimate for Barrier model",
                     sub = paste("range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     pal = pal.pos.mean)
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()
    
    #POS SD
    fpp <- file.path(dir_out_sd, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.bm$res$summary.random$s$sd, 
                     main="Spatial sd estimate for Barrier model",
                     sub = paste("Barrier Model, range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     pal = pal.pos.sd)
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()
    
    #POS QUANTILES
    # 0.025
    fpp <- file.path(dir_out_q25, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.bm$res$summary.random$s[,4], 
                     main="Spatial 0.025 quantile estimate for Barrier model",
                     sub = paste("Barrier Model, range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     pal = pal.pos.q25)
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()

    # 0.5
    fpp <- file.path(dir_out_q5, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.bm$res$summary.random$s[,5], 
                     main="Spatial 0.5 quantile estimate for Barrier model",
                     sub = paste("Barrier Model, range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     pal = pal.pos.q50)
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()
    
    # 0.975
    fpp <- file.path(dir_out_q975, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.bm$res$summary.random$s[,6], 
                     main="Spatial 0.975 quantile estimate for Barrier model",
                     sub = paste("Barrier Model, range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     pal = pal.pos.q975)
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()
    
    # SPATIAL ESTIMATE WITH STATIONARY MODEL
    fpp <- file.path(dir_out_s, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.st$res$summary.random$s$mean,
                     main="Spatial estimate with the stationary model",
                     sub = paste("Barrier Model, range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     pal = pal.pos.mean.st) 
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()
    
    #POS SD st
    fpp <- file.path(dir_out_st.sd, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.st$res$summary.random$s$sd, 
                     main="Spatial sd estimate with the stationary model",
                     sub = paste("Barrier Model, range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     pal = pal.pos.sd.st)
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()
    
    #POS QUANTILES st
    # 0.025 st
    fpp <- file.path(dir_out_st.q25, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.st$res$summary.random$s[,4], 
                     main="Spatial 0.025 estimate with the stationary model",
                     sub = paste("Barrier Model, range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     pal = pal.pos.q25.st)
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()

    # 0.5 st
    fpp <- file.path(dir_out_st.q5, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.st$res$summary.random$s[,5], 
                     main="Spatial 0.5 quantile estimate with the stationary model",
                     sub = paste("Barrier Model, range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     pal = pal.pos.q50.st)
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()
    
    # 0.975 st
    fpp <- file.path(dir_out_st.q975, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.st$res$summary.random$s[,6], 
                     main="Spatial 0.975 quantile estimate with the stationary model",
                     sub = paste("Barrier Model, range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     pal = pal.pos.q975.st)
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()
  }
  
    ## bm
    # SPATIAL FIELD, u
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_f, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "true.field.gif"))
    
    ## TBM
    # POSTERIOR MEAN
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_pm.tbm, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "mean.tbm.gif"))
    
    #POS SD
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_sd.tbm, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "sd.tbm.gif"))
    
    #POS QUANTILES
    # 0.025
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_q25.tbm, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "q25.tbm.gif"))
    
    # 0.5
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_q5.tbm, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "q5.tbm.gif"))
    
    # 0.975
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_q975.tbm, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "q975.tbm.gif"))
    
    ## BM
    # POSTERIOR MEAN
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_pm, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "mean.bm.gif"))
    
    #POS SD
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_sd, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "sd.bm.gif"))
    
    #POS QUANTILES
    # 0.025
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_q25, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "q25.bm.gif"))
    
    # 0.5
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_q5, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "q5.bm.gif"))
    
    # 0.975
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_q975, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "q975.bm.gif"))
    
    ## st
    # u
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_s, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "mean.st.gif"))
    
    # st sd
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_st.sd, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "sd.st.gif"))
    
    #POS QUANTILES st
    # 0.025
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_st.q25, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "q25.st.gif"))
    
    # 0.5
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_st.q5, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "q5.st.gif"))
    
    # 0.975
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_st.q975, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "q975.st.gif"))
    
    unlink(dir_out_f, recursive = T)
    unlink(dir_out_pm.tbm, recursive = T)
    unlink(dir_out_sd.tbm, recursive = T)
    unlink(dir_out_q25.tbm, recursive = T)
    unlink(dir_out_q5.tbm, recursive = T)
    unlink(dir_out_q975.tbm, recursive = T)
    
    unlink(dir_out_pm, recursive = T)
    unlink(dir_out_sd, recursive = T)
    unlink(dir_out_q25, recursive = T)
    unlink(dir_out_q5, recursive = T)
    unlink(dir_out_q975, recursive = T)
    unlink(dir_out_s, recursive = T)
    unlink(dir_out_st.sd, recursive = T)
    unlink(dir_out_st.q25, recursive = T)
    unlink(dir_out_st.q5, recursive = T)
    unlink(dir_out_st.q975, recursive = T)
}
```

selected

```{r}
#geom 1.1
SM <- c(1.5)
W <- c(3)
R <- 2
SS <- 880
fr <- 0.4
N <- c(30)


for (s in 1:length(SS)) {
  for (d in 1:length(SM)) {
    for (w in 1:length(W)) {
      for(r in 1:length(R)) {
        for (n in 1:length(N)) {
          fp <- file.path("gif.sel/geom1", paste0("sm", SM[d], "w", W[w], "r", R[r], "seed", SS[s], ".n", N[n], "/"))
          dir.create(fp, recursive = TRUE)
          
          smalldist = SM[d]
          width = c(W[w],W[w])
          range = R[r]
          max.edge.length = 0.4
          n = N[n]
          set.inla.seed = SS[s]
          x.mid = 10
          xlim.big  = c(0,20)
          xlim.small = c(3,17)
          ylim.big = c(0,20)
          ylim.small = c(3,17)
          fr = fr
          prior.range = prior.range
          prior.sigma = c(1,0.1)
          sigma.u = 1
          sigma.epsilon = 0.2
          prior.range.st = prior.range
          prior.sigma.st = c(1,0.1)
          gif.path = fp
          marginals.path = fp


  poly1 <- local.square.polygon(xlim=c(xlim.big[1]-1, x.mid-smalldist/2), 
                          ylim=x.mid+width[1]*c(-.5, .5))

  poly2 <- local.square.polygon(xlim=c(x.mid+smalldist/2, xlim.big[2]+1), 
                          ylim=x.mid+width[2]*c(-.5, .5))

  poly.original <- SpatialPolygons(c(poly1@polygons, poly2@polygons))
  
  loc1 <- matrix(c(xlim.big[1],ylim.big[1], 
                   xlim.big[2],ylim.big[1], 
                   xlim.big[2],ylim.big[2], 
                   xlim.big[1],ylim.big[2]), 4, 2, byrow = T)
  
  seg <- inla.sp2segment(poly.original)
# - Transforms a SpatialPolygon to an "inla polygon"
  mesh <- inla.mesh.2d(loc=loc1, 
                      interior = seg, 
                       max.e = max.edge.length, 
                       offset=1)

  tl <- length(mesh$graph$tv[,1])
# - the number of triangles in the mesh
  posTri <- matrix(0, tl, 2)

  for (t in 1:tl){
    temp = mesh$loc[mesh$graph$tv[t, ], ]
    posTri[t,] = colMeans(temp)[c(1,2)] 
}

  posTri <- SpatialPoints(posTri)
# - the positions of the triangle centers

  bar.original <- over(poly.original, SpatialPoints(posTri), returnList=T)
# - checking which mesh triangles are inside the barrier area
  bar.original <- unlist(bar.original)
  poly.bar.orginal <- inla.barrier.polygon(mesh, barrier.triangles = bar.original)
# - the Barrier model's polygon
# - in most cases this should be the same as poly.original

# BARRIER 1
  bar1 <- over(poly1, SpatialPoints(posTri), returnList=T)
# - checking which mesh triangles are inside the barrier area
  bar1 <- unlist(bar1)
  poly.bar1 <- inla.barrier.polygon(mesh, barrier.triangles = bar1)
# - the Barrier model's polygon
# - in most cases this should be the same as poly.original

# BARRIER 2
  bar2 <- over(poly2, SpatialPoints(posTri), returnList=T)
# - checking which mesh triangles are inside the barrier area
  bar2 <- unlist(bar2)
  poly.bar2 <- inla.barrier.polygon(mesh, barrier.triangles = bar2)

  mat <-  inla.barrier.fem.plus(mesh, list(bar1, bar2)) 
  fem <- mat 
  barrier.triangles <- list(bar1, bar2)

# PLOTS
  poly1_h <- local.square.polygon_T(xlim=c(xlim.small[1], x.mid-smalldist/2), 
                            ylim=x.mid+width[1]*c(-.5, .5))

  poly2_h <- local.square.polygon_T(xlim=c(x.mid+smalldist/2, xlim.small[2]), 
                            ylim=x.mid+width[2]*c(-.5, .5))

  loc2 <- matrix(c(3,3, 17,3, 17,17, 3,17), 4, 2, byrow = T)

  locp2 <- Polygon(loc2, hole = FALSE)
    
  poly.water <- SpatialPolygons(list(Polygons(list(locp2, poly1_h, poly2_h), '0')))
  poly.water_sf <- st_as_sf(poly.water)
    
  set.seed(set.inla.seed)
  loc.data <- spsample(x = poly.water, n = n, type = "random")
  loc.data_sf <- st_as_sf(loc.data)
  loc.data <- loc.data@coords

  poly.rect <- SpatialPolygons(list(Polygons(list(poly1_h, poly2_h), '0')))
  poly.rect_sf <- st_as_sf(poly.rect)
  poly.sq <- SpatialPolygons(list(Polygons(list(locp2), '0')))
  poly.sq_sf <- st_as_sf(poly.sq)

  sq_bbox <- st_bbox(poly.sq_sf) %>% st_as_sfc()
  poly1_bbox <- st_bbox(poly1) %>% st_as_sfc()
  poly2_bbox <- st_bbox(poly2) %>% st_as_sfc()

  tbm.frac <- list()

  for (p in 1:length(fr)) { #
    f <- fr[p]
    range.fraction <- c(0.01, f)
    tbm.frac[[p]] <- model.tbm.plus(mesh = mesh, fem = fem, 
                               barrier.triangles = barrier.triangles,
                               prior.range = prior.range, prior.sigma = prior.sigma ,  
                               range.fraction = range.fraction,
                               range = range,
                               set.inla.seed = set.inla.seed,
                               loc.data = loc.data,
                               sigma.u = 1, sigma.epsilon = 0.2,
                               poly.original = poly.bar.orginal,
                               prior.range.st = prior.range.st,
                               prior.sigma.st = prior.sigma.st,
                               return.list = TRUE)
  }
  
  trans <- tbm.frac
  trans.Ggeom1 <- trans
  plot.model.tbm.plus(trans, 
                       fr,
                       poly.bar.orginal = poly.bar.orginal,
                       range = range,
                       fps = 1,
                       gif.path = fp)

  for (r in 1:length(trans)) {
    f <- fr[p]
    range.fraction <- c(0.01, f)
    fpp <- file.path(paste0(marginals.path, f, ".png"))
    png(fpp)
    par(mfrow = c(3, 1))
    tmp = inla.tmarginal(function(x) exp(x), trans[[p]]$pos.tbm$res$marginals.hyperpar[[3]]) 
    plot(tmp, type = "l", xlab = "r", ylab = "Density TBM", xlim = c(0,8))
         xvals = seq(0, 10, length.out=1000)
      
    abline(v=range, col="blue")
    
    tmp = inla.tmarginal(function(x) exp(x), trans[[p]]$pos.bm$res$marginals.hyperpar[[3]]) 
    plot(tmp, type = "l", xlab = "r", ylab = "Density BM", xlim = c(0,8))
         xvals = seq(0, 10, length.out=1000)
      
    abline(v=range, col="blue")
  
    tmp = inla.tmarginal(function(x) (x), trans[[p]]$pos.st$res$marginals.hyperpar[[2]]) 
    plot(tmp, type = "l", xlab = "r", ylab = "Density st", xlim = c(0,8))
         xvals = seq(0, 10, length.out=1000)
    abline(v=range, col="blue")
    dev.off()
  }
  
  ###
  #geom1.2
  fp <- file.path("gif.sel/geom1.2", paste0("sm", SM[d], "w", W[w], "r", R[r], "seed", SS[s], ".n", N[n], "/"))
  dir.create(fp, recursive = TRUE)
  gif.path = fp
  marginals.path = fp
  
  for (p in 1:length(fr)) { #
    f <- fr[p]
    range.fraction <- c(0.01, f)
    tbm.frac[[p]] <- model.tbm.plus(mesh = mesh, fem = fem, 
                               barrier.triangles = barrier.triangles,
                               prior.range = prior.range, prior.sigma = prior.sigma ,  
                               range.fraction = range.fraction,
                               range = range,
                               set.inla.seed = set.inla.seed,
                               loc.data = loc.data,
                               sigma.u = 1, sigma.epsilon = 0.2,
                               poly.original = poly.bar.orginal,
                               prior.range.st = prior.range.st,
                               prior.sigma.st = prior.sigma.st,
                               return.list = TRUE)
  }
  
  trans <- tbm.frac
  trans.Ggeom1.2 <- trans
  plot.model.tbm.plus.l(trans, 
                       fr,
                       poly.bar.orginal = poly.bar.orginal,
                       range = range,
                       fps = 1,
                       gif.path = fp)

  for (r in 1:length(trans)) {
    f <- fr[p]
    range.fraction <- c(0.01, f)
    fpp <- file.path(paste0(marginals.path, f, ".png"))
    png(fpp)
    par(mfrow = c(3, 1))
    tmp = inla.tmarginal(function(x) exp(x), trans[[p]]$pos.tbm$res$marginals.hyperpar[[3]]) 
    plot(tmp, type = "l", xlab = "r", ylab = "Density TBM", xlim = c(0,8))
         xvals = seq(0, 10, length.out=1000)
      
    abline(v=range, col="blue")
    
    tmp = inla.tmarginal(function(x) exp(x), trans[[p]]$pos.bm$res$marginals.hyperpar[[3]]) 
    plot(tmp, type = "l", xlab = "r", ylab = "Density BM", xlim = c(0,8))
         xvals = seq(0, 10, length.out=1000)
      
    abline(v=range, col="blue")
  
    tmp = inla.tmarginal(function(x) (x), trans[[p]]$pos.st$res$marginals.hyperpar[[2]]) 
    plot(tmp, type = "l", xlab = "r", ylab = "Density st", xlim = c(0,8))
         xvals = seq(0, 10, length.out=1000)
    abline(v=range, col="blue")
    dev.off()
  }
        }
   
        }
        
      }
    }
  }
  

```

```{r}
#geom 2
SM <- c(0)
W <- c(1)
R <- 4
SS <- 987
fr <- 0.3
N <- c(50)


for (s in 1:length(SS)) {
  for (d in 1:length(SM)) {
    for (w in 1:length(W)) {
      for(r in 1:length(R)) {
        for (n in 1:length(N)) {
          fp <- file.path("gif.sel/geom2", paste0("sm", SM[d], "w", W[w], "r", R[r], "seed", SS[s], ".n", N[n], "/"))
          dir.create(fp, recursive = TRUE)
          
          smalldist = SM[d]
          width = c(W[w],W[w])
          range = R[r]
          max.edge.length = 0.4
          n = N[n]
          set.inla.seed = SS[s]
          x.mid = 10
          xlim.big  = c(0,20)
          xlim.small = c(3,17)
          ylim.big = c(0,20)
          ylim.small = c(3,17)
          fr = fr
          prior.range = prior.range
          prior.sigma = c(1,0.1)
          sigma.u = 1
          sigma.epsilon = 0.2
          prior.range.st = prior.range
          prior.sigma.st = c(1,0.1)
          gif.path = fp
          marginals.path = fp


  poly1 <- local.square.polygon(xlim=c(xlim.big[1]-1, x.mid-smalldist/2), 
                          ylim=x.mid+width[1]*c(-.5, .5))

  poly2 <- local.square.polygon(xlim=c(x.mid+smalldist/2, xlim.big[2]+1), 
                          ylim=x.mid+width[2]*c(-.5, .5))

  poly.original <- SpatialPolygons(c(poly1@polygons, poly2@polygons))
  
  loc1 <- matrix(c(xlim.big[1],ylim.big[1], 
                   xlim.big[2],ylim.big[1], 
                   xlim.big[2],ylim.big[2], 
                   xlim.big[1],ylim.big[2]), 4, 2, byrow = T)
  
  seg <- inla.sp2segment(poly.original)
# - Transforms a SpatialPolygon to an "inla polygon"
  mesh <- inla.mesh.2d(loc=loc1, 
                      interior = seg, 
                       max.e = max.edge.length, 
                       offset=1)

  tl <- length(mesh$graph$tv[,1])
# - the number of triangles in the mesh
  posTri <- matrix(0, tl, 2)

  for (t in 1:tl){
    temp = mesh$loc[mesh$graph$tv[t, ], ]
    posTri[t,] = colMeans(temp)[c(1,2)] 
}

  posTri <- SpatialPoints(posTri)
# - the positions of the triangle centers

  bar.original <- over(poly.original, SpatialPoints(posTri), returnList=T)
# - checking which mesh triangles are inside the barrier area
  bar.original <- unlist(bar.original)
  poly.bar.orginal <- inla.barrier.polygon(mesh, barrier.triangles = bar.original)
# - the Barrier model's polygon
# - in most cases this should be the same as poly.original

# BARRIER 1
  bar1 <- over(poly1, SpatialPoints(posTri), returnList=T)
# - checking which mesh triangles are inside the barrier area
  bar1 <- unlist(bar1)
  poly.bar1 <- inla.barrier.polygon(mesh, barrier.triangles = bar1)
# - the Barrier model's polygon
# - in most cases this should be the same as poly.original

# BARRIER 2
  bar2 <- over(poly2, SpatialPoints(posTri), returnList=T)
# - checking which mesh triangles are inside the barrier area
  bar2 <- unlist(bar2)
  poly.bar2 <- inla.barrier.polygon(mesh, barrier.triangles = bar2)

  mat <-  inla.barrier.fem.plus(mesh, list(bar1, bar2)) 
  fem <- mat 
  barrier.triangles <- list(bar1, bar2)

# PLOTS
  poly1_h <- local.square.polygon_T(xlim=c(xlim.small[1], x.mid-smalldist/2), 
                            ylim=x.mid+width[1]*c(-.5, .5))

  poly2_h <- local.square.polygon_T(xlim=c(x.mid+smalldist/2, xlim.small[2]), 
                            ylim=x.mid+width[2]*c(-.5, .5))

  loc2 <- matrix(c(3,3, 17,3, 17,17, 3,17), 4, 2, byrow = T)

  locp2 <- Polygon(loc2, hole = FALSE)
    
  poly.water <- SpatialPolygons(list(Polygons(list(locp2, poly1_h, poly2_h), '0')))
  poly.water_sf <- st_as_sf(poly.water)
    
  set.seed(set.inla.seed)
  loc.data <- spsample(x = poly.water, n = n, type = "random")
  loc.data_sf <- st_as_sf(loc.data)
  loc.data <- loc.data@coords

  poly.rect <- SpatialPolygons(list(Polygons(list(poly1_h, poly2_h), '0')))
  poly.rect_sf <- st_as_sf(poly.rect)
  poly.sq <- SpatialPolygons(list(Polygons(list(locp2), '0')))
  poly.sq_sf <- st_as_sf(poly.sq)

  sq_bbox <- st_bbox(poly.sq_sf) %>% st_as_sfc()
  poly1_bbox <- st_bbox(poly1) %>% st_as_sfc()
  poly2_bbox <- st_bbox(poly2) %>% st_as_sfc()

  tbm.frac <- list()

  for (p in 1:length(fr)) { #
    f <- fr[p]
    range.fraction <- c(0.01, f)
    tbm.frac[[p]] <- model.tbm.plus(mesh = mesh, fem = fem, 
                               barrier.triangles = barrier.triangles,
                               prior.range = prior.range, prior.sigma = prior.sigma ,  
                               range.fraction = range.fraction,
                               range = range,
                               set.inla.seed = set.inla.seed,
                               loc.data = loc.data,
                               sigma.u = 1, sigma.epsilon = 0.2,
                               poly.original = poly.bar.orginal,
                               prior.range.st = prior.range.st,
                               prior.sigma.st = prior.sigma.st,
                               return.list = TRUE)
  }
  
  trans <- tbm.frac
  trans.Ggeom2 <- trans
  plot.model.tbm.plus(trans, 
                       fr,
                       poly.bar.orginal = poly.bar.orginal,
                       range = range,
                       fps = 1,
                       gif.path = fp)

  for (r in 1:length(trans)) {
    f <- fr[p]
    range.fraction <- c(0.01, f)
    fpp <- file.path(paste0(marginals.path, f, ".png"))
    png(fpp)
    par(mfrow = c(3, 1))
    tmp = inla.tmarginal(function(x) exp(x), trans[[p]]$pos.tbm$res$marginals.hyperpar[[3]]) 
    plot(tmp, type = "l", xlab = "r", ylab = "Density TBM", xlim = c(0,8))
         xvals = seq(0, 10, length.out=1000)
      
    abline(v=range, col="blue")
    
    tmp = inla.tmarginal(function(x) exp(x), trans[[p]]$pos.bm$res$marginals.hyperpar[[3]]) 
    plot(tmp, type = "l", xlab = "r", ylab = "Density BM", xlim = c(0,8))
         xvals = seq(0, 10, length.out=1000)
      
    abline(v=range, col="blue")
  
    tmp = inla.tmarginal(function(x) (x), trans[[p]]$pos.st$res$marginals.hyperpar[[2]]) 
    plot(tmp, type = "l", xlab = "r", ylab = "Density st", xlim = c(0,8))
         xvals = seq(0, 10, length.out=1000)
    abline(v=range, col="blue")
    dev.off()
  }
  
  ###
  #geom1.2
  fp <- file.path("gif.sel/geom2.2", paste0("sm", SM[d], "w", W[w], "r", R[r], "seed", SS[s], ".n", N[n], "/"))
  dir.create(fp, recursive = TRUE)
  gif.path = fp
  marginals.path = fp
  
  for (p in 1:length(fr)) { #
    f <- fr[p]
    range.fraction <- c(0.01, f)
    tbm.frac[[p]] <- model.tbm.plus(mesh = mesh, fem = fem, 
                               barrier.triangles = barrier.triangles,
                               prior.range = prior.range, prior.sigma = prior.sigma ,  
                               range.fraction = range.fraction,
                               range = range,
                               set.inla.seed = set.inla.seed,
                               loc.data = loc.data,
                               sigma.u = 1, sigma.epsilon = 0.2,
                               poly.original = poly.bar.orginal,
                               prior.range.st = prior.range.st,
                               prior.sigma.st = prior.sigma.st,
                               return.list = TRUE)
  }
  
  trans <- tbm.frac
  trans.Ggeom2.2 <- trans
  plot.model.tbm.plus.l(trans, 
                       fr,
                       poly.bar.orginal = poly.bar.orginal,
                       range = range,
                       fps = 1,
                       gif.path = fp)

  for (r in 1:length(trans)) {
    f <- fr[p]
    range.fraction <- c(0.01, f)
    fpp <- file.path(paste0(marginals.path, f, ".png"))
    png(fpp)
    par(mfrow = c(3, 1))
    tmp = inla.tmarginal(function(x) exp(x), trans[[p]]$pos.tbm$res$marginals.hyperpar[[3]]) 
    plot(tmp, type = "l", xlab = "r", ylab = "Density TBM", xlim = c(0,8))
         xvals = seq(0, 10, length.out=1000)
      
    abline(v=range, col="blue")
    
    tmp = inla.tmarginal(function(x) exp(x), trans[[p]]$pos.bm$res$marginals.hyperpar[[3]]) 
    plot(tmp, type = "l", xlab = "r", ylab = "Density BM", xlim = c(0,8))
         xvals = seq(0, 10, length.out=1000)
      
    abline(v=range, col="blue")
  
    tmp = inla.tmarginal(function(x) (x), trans[[p]]$pos.st$res$marginals.hyperpar[[2]]) 
    plot(tmp, type = "l", xlab = "r", ylab = "Density st", xlim = c(0,8))
         xvals = seq(0, 10, length.out=1000)
    abline(v=range, col="blue")
    dev.off()
  }
        }
   
        }
        
      }
    }
  }
  

```


```{r}
#geom 3
SM <- c(1.5)
W <- 4
R <- 4
SS <- 43
fr <- 0.3
N <- c(50)



for (s in 1:length(SS)) {
  for (d in 1:length(SM)) {
    for (w in 1:length(W)) {
      for(r in 1:length(R)) {
        for (n in 1:length(N)) {
          fp <- file.path("gif.sel/geom3", paste0("sm", SM[d], "w", W[w], "r", R[r], "seed", SS[s], ".n", N[n], "/"))
          dir.create(fp, recursive = TRUE)
          
          smalldist = SM[d]
          width = c(1,W[w])
          range = R[r]
          max.edge.length = 0.4
          n = N[n]
          set.inla.seed = SS[s]
          x.mid = 10
          xlim.big  = c(0,20)
          xlim.small = c(3,17)
          ylim.big = c(0,20)
          ylim.small = c(3,17)
          fr = fr
          prior.range = prior.range
          prior.sigma = c(1,0.1)
          sigma.u = 1
          sigma.epsilon = 0.2
          prior.range.st = prior.range
          prior.sigma.st = c(1,0.1)
          gif.path = fp
          marginals.path = fp


  poly1 <- local.square.polygon(xlim=c(xlim.big[1]-1, x.mid-smalldist/2), 
                          ylim=x.mid+width[1]*c(-.5, .5))

  poly2 <- local.square.polygon(xlim=c(x.mid+smalldist/2, xlim.big[2]+1), 
                          ylim=x.mid+width[2]*c(-.5, .5))

  poly.original <- SpatialPolygons(c(poly1@polygons, poly2@polygons))
  
  loc1 <- matrix(c(xlim.big[1],ylim.big[1], 
                   xlim.big[2],ylim.big[1], 
                   xlim.big[2],ylim.big[2], 
                   xlim.big[1],ylim.big[2]), 4, 2, byrow = T)
  
  seg <- inla.sp2segment(poly.original)
# - Transforms a SpatialPolygon to an "inla polygon"
  mesh <- inla.mesh.2d(loc=loc1, 
                      interior = seg, 
                       max.e = max.edge.length, 
                       offset=1)

  tl <- length(mesh$graph$tv[,1])
# - the number of triangles in the mesh
  posTri <- matrix(0, tl, 2)

  for (t in 1:tl){
    temp = mesh$loc[mesh$graph$tv[t, ], ]
    posTri[t,] = colMeans(temp)[c(1,2)] 
}

  posTri <- SpatialPoints(posTri)
# - the positions of the triangle centers

  bar.original <- over(poly.original, SpatialPoints(posTri), returnList=T)
# - checking which mesh triangles are inside the barrier area
  bar.original <- unlist(bar.original)
  poly.bar.orginal <- inla.barrier.polygon(mesh, barrier.triangles = bar.original)
# - the Barrier model's polygon
# - in most cases this should be the same as poly.original

# BARRIER 1
  bar1 <- over(poly1, SpatialPoints(posTri), returnList=T)
# - checking which mesh triangles are inside the barrier area
  bar1 <- unlist(bar1)
  poly.bar1 <- inla.barrier.polygon(mesh, barrier.triangles = bar1)
# - the Barrier model's polygon
# - in most cases this should be the same as poly.original

# BARRIER 2
  bar2 <- over(poly2, SpatialPoints(posTri), returnList=T)
# - checking which mesh triangles are inside the barrier area
  bar2 <- unlist(bar2)
  poly.bar2 <- inla.barrier.polygon(mesh, barrier.triangles = bar2)

  mat <-  inla.barrier.fem.plus(mesh, list(bar1, bar2)) 
  fem <- mat 
  barrier.triangles <- list(bar1, bar2)

# PLOTS
  poly1_h <- local.square.polygon_T(xlim=c(xlim.small[1], x.mid-smalldist/2), 
                            ylim=x.mid+width[1]*c(-.5, .5))

  poly2_h <- local.square.polygon_T(xlim=c(x.mid+smalldist/2, xlim.small[2]), 
                            ylim=x.mid+width[2]*c(-.5, .5))

  loc2 <- matrix(c(3,3, 17,3, 17,17, 3,17), 4, 2, byrow = T)

  locp2 <- Polygon(loc2, hole = FALSE)
    
  poly.water <- SpatialPolygons(list(Polygons(list(locp2, poly1_h, poly2_h), '0')))
  poly.water_sf <- st_as_sf(poly.water)
    
  set.seed(set.inla.seed)
  loc.data <- spsample(x = poly.water, n = n, type = "random")
  loc.data_sf <- st_as_sf(loc.data)
  loc.data <- loc.data@coords

  poly.rect <- SpatialPolygons(list(Polygons(list(poly1_h, poly2_h), '0')))
  poly.rect_sf <- st_as_sf(poly.rect)
  poly.sq <- SpatialPolygons(list(Polygons(list(locp2), '0')))
  poly.sq_sf <- st_as_sf(poly.sq)

  sq_bbox <- st_bbox(poly.sq_sf) %>% st_as_sfc()
  poly1_bbox <- st_bbox(poly1) %>% st_as_sfc()
  poly2_bbox <- st_bbox(poly2) %>% st_as_sfc()

  tbm.frac <- list()

  for (p in 1:length(fr)) { #
    f <- fr[p]
    range.fraction <- c(0.01, f)
    tbm.frac[[p]] <- model.tbm.plus(mesh = mesh, fem = fem, 
                               barrier.triangles = barrier.triangles,
                               prior.range = prior.range, prior.sigma = prior.sigma ,  
                               range.fraction = range.fraction,
                               range = range,
                               set.inla.seed = set.inla.seed,
                               loc.data = loc.data,
                               sigma.u = 1, sigma.epsilon = 0.2,
                               poly.original = poly.bar.orginal,
                               prior.range.st = prior.range.st,
                               prior.sigma.st = prior.sigma.st,
                               return.list = TRUE)
  }
  
  trans <- tbm.frac
  trans.Ggeom3 <- trans
  plot.model.tbm.plus(trans, 
                       fr,
                       poly.bar.orginal = poly.bar.orginal,
                       range = range,
                       fps = 1,
                       gif.path = fp)

  for (r in 1:length(trans)) {
    f <- fr[p]
    range.fraction <- c(0.01, f)
    fpp <- file.path(paste0(marginals.path, f, ".png"))
    png(fpp)
    par(mfrow = c(3, 1))
    tmp = inla.tmarginal(function(x) exp(x), trans[[p]]$pos.tbm$res$marginals.hyperpar[[3]]) 
    plot(tmp, type = "l", xlab = "r", ylab = "Density TBM", xlim = c(0,8))
         xvals = seq(0, 10, length.out=1000)
      
    abline(v=range, col="blue")
    
    tmp = inla.tmarginal(function(x) exp(x), trans[[p]]$pos.bm$res$marginals.hyperpar[[3]]) 
    plot(tmp, type = "l", xlab = "r", ylab = "Density BM", xlim = c(0,8))
         xvals = seq(0, 10, length.out=1000)
      
    abline(v=range, col="blue")
  
    tmp = inla.tmarginal(function(x) (x), trans[[p]]$pos.st$res$marginals.hyperpar[[2]]) 
    plot(tmp, type = "l", xlab = "r", ylab = "Density st", xlim = c(0,8))
         xvals = seq(0, 10, length.out=1000)
    abline(v=range, col="blue")
    dev.off()
  }
  
  ###
  #geom3.2
  fp <- file.path("gif.sel/geom3.2", paste0("sm", SM[d], "w", W[w], "r", R[r], "seed", SS[s], ".n", N[n], "/"))
  dir.create(fp, recursive = TRUE)
  gif.path = fp
  marginals.path = fp
  
  for (p in 1:length(fr)) { #
    f <- fr[p]
    range.fraction <- c(0.01, f)
    tbm.frac[[p]] <- model.tbm.plus(mesh = mesh, fem = fem, 
                               barrier.triangles = barrier.triangles,
                               prior.range = prior.range, prior.sigma = prior.sigma ,  
                               range.fraction = range.fraction,
                               range = range,
                               set.inla.seed = set.inla.seed,
                               loc.data = loc.data,
                               sigma.u = 1, sigma.epsilon = 0.2,
                               poly.original = poly.bar.orginal,
                               prior.range.st = prior.range.st,
                               prior.sigma.st = prior.sigma.st,
                               return.list = TRUE)
  }
  
  trans <- tbm.frac
  trans.Ggeom3.2 <- trans
  plot.model.tbm.plus.l(trans, 
                       fr,
                       poly.bar.orginal = poly.bar.orginal,
                       range = range,
                       fps = 1,
                       gif.path = fp)

  for (r in 1:length(trans)) {
    f <- fr[p]
    range.fraction <- c(0.01, f)
    fpp <- file.path(paste0(marginals.path, f, ".png"))
    png(fpp)
    par(mfrow = c(3, 1))
    tmp = inla.tmarginal(function(x) exp(x), trans[[p]]$pos.tbm$res$marginals.hyperpar[[3]]) 
    plot(tmp, type = "l", xlab = "r", ylab = "Density TBM", xlim = c(0,8))
         xvals = seq(0, 10, length.out=1000)
      
    abline(v=range, col="blue")
    
    tmp = inla.tmarginal(function(x) exp(x), trans[[p]]$pos.bm$res$marginals.hyperpar[[3]]) 
    plot(tmp, type = "l", xlab = "r", ylab = "Density BM", xlim = c(0,8))
         xvals = seq(0, 10, length.out=1000)
      
    abline(v=range, col="blue")
  
    tmp = inla.tmarginal(function(x) (x), trans[[p]]$pos.st$res$marginals.hyperpar[[2]]) 
    plot(tmp, type = "l", xlab = "r", ylab = "Density st", xlim = c(0,8))
         xvals = seq(0, 10, length.out=1000)
    abline(v=range, col="blue")
    dev.off()
  }
        }
        
        #geom3.3
  fp <- file.path("gif.sel/geom3.3", paste0("sm", SM[d], "w", W[w], "r", R[r], "seed", SS[s], ".n", N[n], "/"))
  dir.create(fp, recursive = TRUE)
  gif.path = fp
  marginals.path = fp
  
  for (p in 1:length(fr)) { #
    f <- fr[p]
    range.fraction <- c(f, 0.01)
    tbm.frac[[p]] <- model.tbm.plus(mesh = mesh, fem = fem, 
                               barrier.triangles = barrier.triangles,
                               prior.range = prior.range, prior.sigma = prior.sigma ,  
                               range.fraction = range.fraction,
                               range = range,
                               set.inla.seed = set.inla.seed,
                               loc.data = loc.data,
                               sigma.u = 1, sigma.epsilon = 0.2,
                               poly.original = poly.bar.orginal,
                               prior.range.st = prior.range.st,
                               prior.sigma.st = prior.sigma.st,
                               return.list = TRUE)
  }
  
  trans <- tbm.frac
  trans.Ggeom3.3 <- trans
  plot.model.tbm.plus.r(trans, 
                       fr,
                       poly.bar.orginal = poly.bar.orginal,
                       range = range,
                       fps = 1,
                       gif.path = fp)

  for (r in 1:length(trans)) {
    f <- fr[p]
    range.fraction <- c(f, 0.01)
    fpp <- file.path(paste0(marginals.path, f, ".png"))
    png(fpp)
    par(mfrow = c(3, 1))
    tmp = inla.tmarginal(function(x) exp(x), trans[[p]]$pos.tbm$res$marginals.hyperpar[[3]]) 
    plot(tmp, type = "l", xlab = "r", ylab = "Density TBM", xlim = c(0,8))
         xvals = seq(0, 10, length.out=1000)
      
    abline(v=range, col="blue")
    
    tmp = inla.tmarginal(function(x) exp(x), trans[[p]]$pos.bm$res$marginals.hyperpar[[3]]) 
    plot(tmp, type = "l", xlab = "r", ylab = "Density BM", xlim = c(0,8))
         xvals = seq(0, 10, length.out=1000)
      
    abline(v=range, col="blue")
  
    tmp = inla.tmarginal(function(x) (x), trans[[p]]$pos.st$res$marginals.hyperpar[[2]]) 
    plot(tmp, type = "l", xlab = "r", ylab = "Density st", xlim = c(0,8))
         xvals = seq(0, 10, length.out=1000)
    abline(v=range, col="blue")
    dev.off()
  }
        }
   
        }
        
      }
    }
  
  

```


```{r}
#geom 3
SM <- c(1.5)
W <- 4
R <- 4
SS <- 970
fr <- 0.3
N <- c(50)


for (s in 1:length(SS)) {
  for (d in 1:length(SM)) {
    for (w in 1:length(W)) {
      for(r in 1:length(R)) {
        for (n in 1:length(N)) {
          fp <- file.path("gif.sel/geom3", paste0("sm", SM[d], "w", W[w], "r", R[r], "seed", SS[s], ".n", N[n], "/"))
          dir.create(fp, recursive = TRUE)
          
          smalldist = SM[d]
          width = c(1,W[w])
          range = R[r]
          max.edge.length = 0.4
          n = N[n]
          set.inla.seed = SS[s]
          x.mid = 10
          xlim.big  = c(0,20)
          xlim.small = c(3,17)
          ylim.big = c(0,20)
          ylim.small = c(3,17)
          fr = fr
          prior.range = prior.range
          prior.sigma = c(1,0.1)
          sigma.u = 1
          sigma.epsilon = 0.2
          prior.range.st = prior.range
          prior.sigma.st = c(1,0.1)
          gif.path = fp
          marginals.path = fp


  poly1 <- local.square.polygon(xlim=c(xlim.big[1]-1, x.mid-smalldist/2), 
                          ylim=x.mid+width[1]*c(-.5, .5))

  poly2 <- local.square.polygon(xlim=c(x.mid+smalldist/2, xlim.big[2]+1), 
                          ylim=x.mid+width[2]*c(-.5, .5))

  poly.original <- SpatialPolygons(c(poly1@polygons, poly2@polygons))
  
  loc1 <- matrix(c(xlim.big[1],ylim.big[1], 
                   xlim.big[2],ylim.big[1], 
                   xlim.big[2],ylim.big[2], 
                   xlim.big[1],ylim.big[2]), 4, 2, byrow = T)
  
  seg <- inla.sp2segment(poly.original)
# - Transforms a SpatialPolygon to an "inla polygon"
  mesh <- inla.mesh.2d(loc=loc1, 
                      interior = seg, 
                       max.e = max.edge.length, 
                       offset=1)

  tl <- length(mesh$graph$tv[,1])
# - the number of triangles in the mesh
  posTri <- matrix(0, tl, 2)

  for (t in 1:tl){
    temp = mesh$loc[mesh$graph$tv[t, ], ]
    posTri[t,] = colMeans(temp)[c(1,2)] 
}

  posTri <- SpatialPoints(posTri)
# - the positions of the triangle centers

  bar.original <- over(poly.original, SpatialPoints(posTri), returnList=T)
# - checking which mesh triangles are inside the barrier area
  bar.original <- unlist(bar.original)
  poly.bar.orginal <- inla.barrier.polygon(mesh, barrier.triangles = bar.original)
# - the Barrier model's polygon
# - in most cases this should be the same as poly.original

# BARRIER 1
  bar1 <- over(poly1, SpatialPoints(posTri), returnList=T)
# - checking which mesh triangles are inside the barrier area
  bar1 <- unlist(bar1)
  poly.bar1 <- inla.barrier.polygon(mesh, barrier.triangles = bar1)
# - the Barrier model's polygon
# - in most cases this should be the same as poly.original

# BARRIER 2
  bar2 <- over(poly2, SpatialPoints(posTri), returnList=T)
# - checking which mesh triangles are inside the barrier area
  bar2 <- unlist(bar2)
  poly.bar2 <- inla.barrier.polygon(mesh, barrier.triangles = bar2)

  mat <-  inla.barrier.fem.plus(mesh, list(bar1, bar2)) 
  fem <- mat 
  barrier.triangles <- list(bar1, bar2)

# PLOTS
  poly1_h <- local.square.polygon_T(xlim=c(xlim.small[1], x.mid-smalldist/2), 
                            ylim=x.mid+width[1]*c(-.5, .5))

  poly2_h <- local.square.polygon_T(xlim=c(x.mid+smalldist/2, xlim.small[2]), 
                            ylim=x.mid+width[2]*c(-.5, .5))

  loc2 <- matrix(c(3,3, 17,3, 17,17, 3,17), 4, 2, byrow = T)

  locp2 <- Polygon(loc2, hole = FALSE)
    
  poly.water <- SpatialPolygons(list(Polygons(list(locp2, poly1_h, poly2_h), '0')))
  poly.water_sf <- st_as_sf(poly.water)
    
  set.seed(set.inla.seed)
  loc.data <- spsample(x = poly.water, n = n, type = "random")
  loc.data_sf <- st_as_sf(loc.data)
  loc.data <- loc.data@coords

  poly.rect <- SpatialPolygons(list(Polygons(list(poly1_h, poly2_h), '0')))
  poly.rect_sf <- st_as_sf(poly.rect)
  poly.sq <- SpatialPolygons(list(Polygons(list(locp2), '0')))
  poly.sq_sf <- st_as_sf(poly.sq)

  sq_bbox <- st_bbox(poly.sq_sf) %>% st_as_sfc()
  poly1_bbox <- st_bbox(poly1) %>% st_as_sfc()
  poly2_bbox <- st_bbox(poly2) %>% st_as_sfc()

  tbm.frac <- list()

  for (p in 1:length(fr)) { #
    f <- fr[p]
    range.fraction <- c(0.01, f)
    tbm.frac[[p]] <- model.tbm.plus(mesh = mesh, fem = fem, 
                               barrier.triangles = barrier.triangles,
                               prior.range = prior.range, prior.sigma = prior.sigma ,  
                               range.fraction = range.fraction,
                               range = range,
                               set.inla.seed = set.inla.seed,
                               loc.data = loc.data,
                               sigma.u = 1, sigma.epsilon = 0.2,
                               poly.original = poly.bar.orginal,
                               prior.range.st = prior.range.st,
                               prior.sigma.st = prior.sigma.st,
                               return.list = TRUE)
  }
  
  trans <- tbm.frac
  trans.Ggeom3_970 <- trans
  plot.model.tbm.plus(trans, 
                       fr,
                       poly.bar.orginal = poly.bar.orginal,
                       range = range,
                       fps = 1,
                       gif.path = fp)

  for (r in 1:length(trans)) {
    f <- fr[p]
    range.fraction <- c(0.01, f)
    fpp <- file.path(paste0(marginals.path, f, ".png"))
    png(fpp)
    par(mfrow = c(3, 1))
    tmp = inla.tmarginal(function(x) exp(x), trans[[p]]$pos.tbm$res$marginals.hyperpar[[3]]) 
    plot(tmp, type = "l", xlab = "r", ylab = "Density TBM", xlim = c(0,8))
         xvals = seq(0, 10, length.out=1000)
      
    abline(v=range, col="blue")
    
    tmp = inla.tmarginal(function(x) exp(x), trans[[p]]$pos.bm$res$marginals.hyperpar[[3]]) 
    plot(tmp, type = "l", xlab = "r", ylab = "Density BM", xlim = c(0,8))
         xvals = seq(0, 10, length.out=1000)
      
    abline(v=range, col="blue")
  
    tmp = inla.tmarginal(function(x) (x), trans[[p]]$pos.st$res$marginals.hyperpar[[2]]) 
    plot(tmp, type = "l", xlab = "r", ylab = "Density st", xlim = c(0,8))
         xvals = seq(0, 10, length.out=1000)
    abline(v=range, col="blue")
    dev.off()
  }
  
  ###
  #geom3.2
  fp <- file.path("gif.sel/geom3.2", paste0("sm", SM[d], "w", W[w], "r", R[r], "seed", SS[s], ".n", N[n], "/"))
  dir.create(fp, recursive = TRUE)
  gif.path = fp
  marginals.path = fp
  
  for (p in 1:length(fr)) { #
    f <- fr[p]
    range.fraction <- c(0.01, f)
    tbm.frac[[p]] <- model.tbm.plus(mesh = mesh, fem = fem, 
                               barrier.triangles = barrier.triangles,
                               prior.range = prior.range, prior.sigma = prior.sigma ,  
                               range.fraction = range.fraction,
                               range = range,
                               set.inla.seed = set.inla.seed,
                               loc.data = loc.data,
                               sigma.u = 1, sigma.epsilon = 0.2,
                               poly.original = poly.bar.orginal,
                               prior.range.st = prior.range.st,
                               prior.sigma.st = prior.sigma.st,
                               return.list = TRUE)
  }
  
  trans <- tbm.frac
  trans.Ggeom3.2_970 <- trans
  plot.model.tbm.plus.l(trans, 
                       fr,
                       poly.bar.orginal = poly.bar.orginal,
                       range = range,
                       fps = 1,
                       gif.path = fp)

  for (r in 1:length(trans)) {
    f <- fr[p]
    range.fraction <- c(0.01, f)
    fpp <- file.path(paste0(marginals.path, f, ".png"))
    png(fpp)
    par(mfrow = c(3, 1))
    tmp = inla.tmarginal(function(x) exp(x), trans[[p]]$pos.tbm$res$marginals.hyperpar[[3]]) 
    plot(tmp, type = "l", xlab = "r", ylab = "Density TBM", xlim = c(0,8))
         xvals = seq(0, 10, length.out=1000)
      
    abline(v=range, col="blue")
    
    tmp = inla.tmarginal(function(x) exp(x), trans[[p]]$pos.bm$res$marginals.hyperpar[[3]]) 
    plot(tmp, type = "l", xlab = "r", ylab = "Density BM", xlim = c(0,8))
         xvals = seq(0, 10, length.out=1000)
      
    abline(v=range, col="blue")
  
    tmp = inla.tmarginal(function(x) (x), trans[[p]]$pos.st$res$marginals.hyperpar[[2]]) 
    plot(tmp, type = "l", xlab = "r", ylab = "Density st", xlim = c(0,8))
         xvals = seq(0, 10, length.out=1000)
    abline(v=range, col="blue")
    dev.off()
  }
        }
        
        #geom3.3
  fp <- file.path("gif.sel/geom3.3", paste0("sm", SM[d], "w", W[w], "r", R[r], "seed", SS[s], ".n", N[n], "/"))
  dir.create(fp, recursive = TRUE)
  gif.path = fp
  marginals.path = fp
  
  for (p in 1:length(fr)) { #
    f <- fr[p]
    range.fraction <- c(f, 0.01)
    tbm.frac[[p]] <- model.tbm.plus(mesh = mesh, fem = fem, 
                               barrier.triangles = barrier.triangles,
                               prior.range = prior.range, prior.sigma = prior.sigma ,  
                               range.fraction = range.fraction,
                               range = range,
                               set.inla.seed = set.inla.seed,
                               loc.data = loc.data,
                               sigma.u = 1, sigma.epsilon = 0.2,
                               poly.original = poly.bar.orginal,
                               prior.range.st = prior.range.st,
                               prior.sigma.st = prior.sigma.st,
                               return.list = TRUE)
  }
  
  trans <- tbm.frac
  trans.Ggeom3.3_970 <- trans
  plot.model.tbm.plus.r(trans, 
                       fr,
                       poly.bar.orginal = poly.bar.orginal,
                       range = range,
                       fps = 1,
                       gif.path = fp)

  for (r in 1:length(trans)) {
    f <- fr[p]
    range.fraction <- c(f, 0.01)
    fpp <- file.path(paste0(marginals.path, f, ".png"))
    png(fpp)
    par(mfrow = c(3, 1))
    tmp = inla.tmarginal(function(x) exp(x), trans[[p]]$pos.tbm$res$marginals.hyperpar[[3]]) 
    plot(tmp, type = "l", xlab = "r", ylab = "Density TBM", xlim = c(0,8))
         xvals = seq(0, 10, length.out=1000)
      
    abline(v=range, col="blue")
    
    tmp = inla.tmarginal(function(x) exp(x), trans[[p]]$pos.bm$res$marginals.hyperpar[[3]]) 
    plot(tmp, type = "l", xlab = "r", ylab = "Density BM", xlim = c(0,8))
         xvals = seq(0, 10, length.out=1000)
      
    abline(v=range, col="blue")
  
    tmp = inla.tmarginal(function(x) (x), trans[[p]]$pos.st$res$marginals.hyperpar[[2]]) 
    plot(tmp, type = "l", xlab = "r", ylab = "Density st", xlim = c(0,8))
         xvals = seq(0, 10, length.out=1000)
    abline(v=range, col="blue")
    dev.off()
  }
        }
   
        }
        
      }
    }
  
  

```

mesh plots


```{r}
#geom1
SM <- c(1.5)
W <- c(3)
R <- 2
SS <- 880
fr <- 0.4
N <- c(30)


for (s in 1:length(SS)) {
  for (d in 1:length(SM)) {
    for (w in 1:length(W)) {
      for(r in 1:length(R)) {
        for (n in 1:length(N)) {
          
          smalldist = SM[d]
          width = c(W[w],W[w])
          range = R[r]
          max.edge.length = 0.4
          n = N[n]
          set.inla.seed = SS[s]
          x.mid = 10
          xlim.big  = c(0,20)
          xlim.small = c(3,17)
          ylim.big = c(0,20)
          ylim.small = c(3,17)
          fr = fr
          prior.range = prior.range
          prior.sigma = c(1,0.1)
          sigma.u = 1
          sigma.epsilon = 0.2
          prior.range.st = prior.range
          prior.sigma.st = c(1,0.1)
          gif.path = fp
          marginals.path = fp


  poly1 <- local.square.polygon(xlim=c(xlim.big[1]-1, x.mid-smalldist/2), 
                          ylim=x.mid+width[1]*c(-.5, .5))

  poly2 <- local.square.polygon(xlim=c(x.mid+smalldist/2, xlim.big[2]+1), 
                          ylim=x.mid+width[2]*c(-.5, .5))

  poly.original <- SpatialPolygons(c(poly1@polygons, poly2@polygons))
  
  loc1 <- matrix(c(xlim.big[1],ylim.big[1], 
                   xlim.big[2],ylim.big[1], 
                   xlim.big[2],ylim.big[2], 
                   xlim.big[1],ylim.big[2]), 4, 2, byrow = T)
  
  seg <- inla.sp2segment(poly.original)
# - Transforms a SpatialPolygon to an "inla polygon"
  mesh <- inla.mesh.2d(loc=loc1, 
                      interior = seg, 
                       max.e = max.edge.length, 
                       offset=1)

  tl <- length(mesh$graph$tv[,1])
# - the number of triangles in the mesh
  posTri <- matrix(0, tl, 2)

  for (t in 1:tl){
    temp = mesh$loc[mesh$graph$tv[t, ], ]
    posTri[t,] = colMeans(temp)[c(1,2)] 
}

  posTri <- SpatialPoints(posTri)
# - the positions of the triangle centers

  bar.original <- over(poly.original, SpatialPoints(posTri), returnList=T)
# - checking which mesh triangles are inside the barrier area
  bar.original <- unlist(bar.original)
  poly.bar.orginal <- inla.barrier.polygon(mesh, barrier.triangles = bar.original)
# - the Barrier model's polygon
# - in most cases this should be the same as poly.original

# BARRIER 1
  bar1 <- over(poly1, SpatialPoints(posTri), returnList=T)
# - checking which mesh triangles are inside the barrier area
  bar1 <- unlist(bar1)
  poly.bar1 <- inla.barrier.polygon(mesh, barrier.triangles = bar1)
# - the Barrier model's polygon
# - in most cases this should be the same as poly.original

# BARRIER 2
  bar2 <- over(poly2, SpatialPoints(posTri), returnList=T)
# - checking which mesh triangles are inside the barrier area
  bar2 <- unlist(bar2)
  poly.bar2 <- inla.barrier.polygon(mesh, barrier.triangles = bar2)

  mat <-  inla.barrier.fem.plus(mesh, list(bar1, bar2)) 
  fem <- mat 
  barrier.triangles <- list(bar1, bar2)

# PLOTS
  poly1_h <- local.square.polygon_T(xlim=c(xlim.small[1], x.mid-smalldist/2), 
                            ylim=x.mid+width[1]*c(-.5, .5))

  poly2_h <- local.square.polygon_T(xlim=c(x.mid+smalldist/2, xlim.small[2]), 
                            ylim=x.mid+width[2]*c(-.5, .5))

  loc2 <- matrix(c(3,3, 17,3, 17,17, 3,17), 4, 2, byrow = T)

  locp2 <- Polygon(loc2, hole = FALSE)
    
  poly.water <- SpatialPolygons(list(Polygons(list(locp2, poly1_h, poly2_h), '0')))
  poly.water_sf <- st_as_sf(poly.water)
    
  set.seed(set.inla.seed)
  loc.data <- spsample(x = poly.water, n = n, type = "random")
  loc.data_sf <- st_as_sf(loc.data)
  loc.data <- loc.data@coords

  poly.rect <- SpatialPolygons(list(Polygons(list(poly1_h, poly2_h), '0')))
  poly.rect_sf <- st_as_sf(poly.rect)
  poly.sq <- SpatialPolygons(list(Polygons(list(locp2), '0')))
  poly.sq_sf <- st_as_sf(poly.sq)

  sq_bbox <- st_bbox(poly.sq_sf) %>% st_as_sfc()
  poly1_bbox <- st_bbox(poly1) %>% st_as_sfc()
  poly2_bbox <- st_bbox(poly2) %>% st_as_sfc()
      
      gg.mesh <- ggplot() + 
      inlabru::gg(mesh) +
      geom_sf(data =poly.rect_sf,
          col='black', alpha=0) + #alpha color inside rect
      geom_sf(data=poly1_bbox, fill=NA, color="red", linewidth = 0.7, linetype = "dashed") +
      geom_sf(data=poly2_bbox, fill=NA, color="red", linewidth = 0.7, linetype = "dashed") +
      geom_sf(data=sq_bbox, fill=NA, color="black", linewidth = 0.7)
      
      gg.mesh.water <- ggplot() +
      inlabru::gg(mesh) +
      geom_sf(data =poly.rect_sf,
          col='black', alpha=1) + #alpha color inside rect
      geom_sf(data=sq_bbox, fill=NA, color="black", linewidth = 0.7) +
      geom_sf(data=poly1_bbox, color="black", linewidth = 0.7) +
      geom_sf(data=poly2_bbox, color="black", linewidth = 0.7) +
      ylim(c(3, 17)) +
      xlim(c(3, 17))


      gg2b.1 <- gg.mesh +
        ggtitle("Mesh")

      gg2b.2 <- gg.mesh.water +
        ggtitle("Barrier layout")

      gg2b.3 <- gg.mesh.water +
        geom_sf(data =loc.data_sf,
          col='black',size=1.7,alpha=0.5) +
        ggtitle("Simulated data")

#      fpp <- file.path("gif.sel/geom1/mesh.g880.png")
#png(fpp)
#      gridExtra::grid.arrange(gg2b.1, gg2b.2, gg2b.3, ncol=3, nrow=2, 
#               top="Two symmaterical barriers and a canal scenario")
#      dev.off()
        }
      }
    }
  }
}

  

  
```

```{r}
#geom2
#geom 2
SM <- c(0)
W <- c(1)
R <- 4
SS <- 987
fr <- 0.3
N <- c(50)


for (s in 1:length(SS)) {
  for (d in 1:length(SM)) {
    for (w in 1:length(W)) {
      for(r in 1:length(R)) {
        for (n in 1:length(N)) {
          
          smalldist = SM[d]
          width = c(W[w],W[w])
          range = R[r]
          max.edge.length = 0.4
          n = N[n]
          set.inla.seed = SS[s]
          x.mid = 10
          xlim.big  = c(0,20)
          xlim.small = c(3,17)
          ylim.big = c(0,20)
          ylim.small = c(3,17)
          fr = fr
          prior.range = prior.range
          prior.sigma = c(1,0.1)
          sigma.u = 1
          sigma.epsilon = 0.2
          prior.range.st = prior.range
          prior.sigma.st = c(1,0.1)
          gif.path = fp
          marginals.path = fp


  poly1 <- local.square.polygon(xlim=c(xlim.big[1]-1, x.mid-smalldist/2), 
                          ylim=x.mid+width[1]*c(-.5, .5))

  poly2 <- local.square.polygon(xlim=c(x.mid+smalldist/2, xlim.big[2]+1), 
                          ylim=x.mid+width[2]*c(-.5, .5))

  poly.original <- SpatialPolygons(c(poly1@polygons, poly2@polygons))
  
  loc1 <- matrix(c(xlim.big[1],ylim.big[1], 
                   xlim.big[2],ylim.big[1], 
                   xlim.big[2],ylim.big[2], 
                   xlim.big[1],ylim.big[2]), 4, 2, byrow = T)
  
  seg <- inla.sp2segment(poly.original)
# - Transforms a SpatialPolygon to an "inla polygon"
  mesh <- inla.mesh.2d(loc=loc1, 
                      interior = seg, 
                       max.e = max.edge.length, 
                       offset=1)

  tl <- length(mesh$graph$tv[,1])
# - the number of triangles in the mesh
  posTri <- matrix(0, tl, 2)

  for (t in 1:tl){
    temp = mesh$loc[mesh$graph$tv[t, ], ]
    posTri[t,] = colMeans(temp)[c(1,2)] 
}

  posTri <- SpatialPoints(posTri)
# - the positions of the triangle centers

  bar.original <- over(poly.original, SpatialPoints(posTri), returnList=T)
# - checking which mesh triangles are inside the barrier area
  bar.original <- unlist(bar.original)
  poly.bar.orginal <- inla.barrier.polygon(mesh, barrier.triangles = bar.original)
# - the Barrier model's polygon
# - in most cases this should be the same as poly.original

# BARRIER 1
  bar1 <- over(poly1, SpatialPoints(posTri), returnList=T)
# - checking which mesh triangles are inside the barrier area
  bar1 <- unlist(bar1)
  poly.bar1 <- inla.barrier.polygon(mesh, barrier.triangles = bar1)
# - the Barrier model's polygon
# - in most cases this should be the same as poly.original

# BARRIER 2
  bar2 <- over(poly2, SpatialPoints(posTri), returnList=T)
# - checking which mesh triangles are inside the barrier area
  bar2 <- unlist(bar2)
  poly.bar2 <- inla.barrier.polygon(mesh, barrier.triangles = bar2)

  mat <-  inla.barrier.fem.plus(mesh, list(bar1, bar2)) 
  fem <- mat 
  barrier.triangles <- list(bar1, bar2)

# PLOTS
  poly1_h <- local.square.polygon_T(xlim=c(xlim.small[1], x.mid-smalldist/2), 
                            ylim=x.mid+width[1]*c(-.5, .5))

  poly2_h <- local.square.polygon_T(xlim=c(x.mid+smalldist/2, xlim.small[2]), 
                            ylim=x.mid+width[2]*c(-.5, .5))

  loc2 <- matrix(c(3,3, 17,3, 17,17, 3,17), 4, 2, byrow = T)

  locp2 <- Polygon(loc2, hole = FALSE)
    
  poly.water <- SpatialPolygons(list(Polygons(list(locp2, poly1_h, poly2_h), '0')))
  poly.water_sf <- st_as_sf(poly.water)
    
  set.seed(set.inla.seed)
  loc.data <- spsample(x = poly.water, n = n, type = "random")
  loc.data_sf <- st_as_sf(loc.data)
  loc.data <- loc.data@coords

  poly.rect <- SpatialPolygons(list(Polygons(list(poly1_h, poly2_h), '0')))
  poly.rect_sf <- st_as_sf(poly.rect)
  poly.sq <- SpatialPolygons(list(Polygons(list(locp2), '0')))
  poly.sq_sf <- st_as_sf(poly.sq)

  sq_bbox <- st_bbox(poly.sq_sf) %>% st_as_sfc()
  poly1_bbox <- st_bbox(poly1) %>% st_as_sfc()
  poly2_bbox <- st_bbox(poly2) %>% st_as_sfc()
      
      gg.mesh <- ggplot() + 
      inlabru::gg(mesh) +
      geom_sf(data =poly.rect_sf,
          col='black', alpha=0) + #alpha color inside rect
      geom_sf(data=poly1_bbox, fill=NA, color="red", linewidth = 0.7, linetype = "dashed") +
      geom_sf(data=poly2_bbox, fill=NA, color="red", linewidth = 0.7, linetype = "dashed") +
      geom_sf(data=sq_bbox, fill=NA, color="black", linewidth = 0.7)
      
      gg.mesh.water <- ggplot() +
      inlabru::gg(mesh) +
      geom_sf(data =poly.rect_sf,
          col='black', alpha=1) + #alpha color inside rect
      geom_sf(data=sq_bbox, fill=NA, color="black", linewidth = 0.7) +
      geom_sf(data=poly1_bbox, color="black", linewidth = 0.7) +
      geom_sf(data=poly2_bbox, color="black", linewidth = 0.7) +
      ylim(c(3, 17)) +
      xlim(c(3, 17))

      gg.mesh +
        geom_sf(data =loc.data_sf,
          col='black',size=1.7,alpha=0.5)

      gg.mesh.water +
        geom_sf(data =loc.data_sf,
          col='black',size=1.7,alpha=0.5)

      gg2b.1 <- gg.mesh +
        ggtitle("Mesh")

      gg2b.2 <- gg.mesh.water +
        ggtitle("Barrier layout")

      gg2b.3 <- gg.mesh.water +
        geom_sf(data =loc.data_sf,
          col='black',size=1.7,alpha=0.5) +
        ggtitle("Simulated data")

      fpp <- file.path("gif.sel/geom2/mesh.g987.png")
png(fpp)
      gridExtra::grid.arrange(gg2b.1, gg2b.2, gg2b.3, ncol=3, nrow=2, 
               top="One barrier separating the study area scenario")
      dev.off()
        }
      }
    }
  }
}

  

  
```

```{r}
#geom 3
SM <- c(1.5)
W <- 4
R <- 4
SS <- 43
fr <- 0.3
N <- c(50)


for (s in 1:length(SS)) {
  for (d in 1:length(SM)) {
    for (w in 1:length(W)) {
      for(r in 1:length(R)) {
        for (n in 1:length(N)) {
          
          smalldist = SM[d]
          width = c(1,W[w])
          range = R[r]
          max.edge.length = 0.4
          n = N[n]
          set.inla.seed = SS[s]
          x.mid = 10
          xlim.big  = c(0,20)
          xlim.small = c(3,17)
          ylim.big = c(0,20)
          ylim.small = c(3,17)
          fr = fr
          prior.range = prior.range
          prior.sigma = c(1,0.1)
          sigma.u = 1
          sigma.epsilon = 0.2
          prior.range.st = prior.range
          prior.sigma.st = c(1,0.1)
          gif.path = fp
          marginals.path = fp


  poly1 <- local.square.polygon(xlim=c(xlim.big[1]-1, x.mid-smalldist/2), 
                          ylim=x.mid+width[1]*c(-.5, .5))

  poly2 <- local.square.polygon(xlim=c(x.mid+smalldist/2, xlim.big[2]+1), 
                          ylim=x.mid+width[2]*c(-.5, .5))

  poly.original <- SpatialPolygons(c(poly1@polygons, poly2@polygons))
  
  loc1 <- matrix(c(xlim.big[1],ylim.big[1], 
                   xlim.big[2],ylim.big[1], 
                   xlim.big[2],ylim.big[2], 
                   xlim.big[1],ylim.big[2]), 4, 2, byrow = T)
  
  seg <- inla.sp2segment(poly.original)
# - Transforms a SpatialPolygon to an "inla polygon"
  mesh <- inla.mesh.2d(loc=loc1, 
                      interior = seg, 
                       max.e = max.edge.length, 
                       offset=1)

  tl <- length(mesh$graph$tv[,1])
# - the number of triangles in the mesh
  posTri <- matrix(0, tl, 2)

  for (t in 1:tl){
    temp = mesh$loc[mesh$graph$tv[t, ], ]
    posTri[t,] = colMeans(temp)[c(1,2)] 
}

  posTri <- SpatialPoints(posTri)
# - the positions of the triangle centers

  bar.original <- over(poly.original, SpatialPoints(posTri), returnList=T)
# - checking which mesh triangles are inside the barrier area
  bar.original <- unlist(bar.original)
  poly.bar.orginal <- inla.barrier.polygon(mesh, barrier.triangles = bar.original)
# - the Barrier model's polygon
# - in most cases this should be the same as poly.original

# BARRIER 1
  bar1 <- over(poly1, SpatialPoints(posTri), returnList=T)
# - checking which mesh triangles are inside the barrier area
  bar1 <- unlist(bar1)
  poly.bar1 <- inla.barrier.polygon(mesh, barrier.triangles = bar1)
# - the Barrier model's polygon
# - in most cases this should be the same as poly.original

# BARRIER 2
  bar2 <- over(poly2, SpatialPoints(posTri), returnList=T)
# - checking which mesh triangles are inside the barrier area
  bar2 <- unlist(bar2)
  poly.bar2 <- inla.barrier.polygon(mesh, barrier.triangles = bar2)

  mat <-  inla.barrier.fem.plus(mesh, list(bar1, bar2)) 
  fem <- mat 
  barrier.triangles <- list(bar1, bar2)

# PLOTS
  poly1_h <- local.square.polygon_T(xlim=c(xlim.small[1], x.mid-smalldist/2), 
                            ylim=x.mid+width[1]*c(-.5, .5))

  poly2_h <- local.square.polygon_T(xlim=c(x.mid+smalldist/2, xlim.small[2]), 
                            ylim=x.mid+width[2]*c(-.5, .5))

  loc2 <- matrix(c(3,3, 17,3, 17,17, 3,17), 4, 2, byrow = T)

  locp2 <- Polygon(loc2, hole = FALSE)
    
  poly.water <- SpatialPolygons(list(Polygons(list(locp2, poly1_h, poly2_h), '0')))
  poly.water_sf <- st_as_sf(poly.water)
    
  set.seed(set.inla.seed)
  loc.data <- spsample(x = poly.water, n = n, type = "random")
  loc.data_sf <- st_as_sf(loc.data)
  loc.data <- loc.data@coords

  poly.rect <- SpatialPolygons(list(Polygons(list(poly1_h, poly2_h), '0')))
  poly.rect_sf <- st_as_sf(poly.rect)
  poly.sq <- SpatialPolygons(list(Polygons(list(locp2), '0')))
  poly.sq_sf <- st_as_sf(poly.sq)

  sq_bbox <- st_bbox(poly.sq_sf) %>% st_as_sfc()
  poly1_bbox <- st_bbox(poly1) %>% st_as_sfc()
  poly2_bbox <- st_bbox(poly2) %>% st_as_sfc()
      
      gg.mesh <- ggplot() + 
      inlabru::gg(mesh) +
      geom_sf(data =poly.rect_sf,
          col='black', alpha=0) + #alpha color inside rect
      geom_sf(data=poly1_bbox, fill=NA, color="red", linewidth = 0.7, linetype = "dashed") +
      geom_sf(data=poly2_bbox, fill=NA, color="red", linewidth = 0.7, linetype = "dashed") +
      geom_sf(data=sq_bbox, fill=NA, color="black", linewidth = 0.7)
      
      gg.mesh.water <- ggplot() +
      inlabru::gg(mesh) +
      geom_sf(data =poly.rect_sf,
          col='black', alpha=1) + #alpha color inside rect
      geom_sf(data=sq_bbox, fill=NA, color="black", linewidth = 0.7) +
      geom_sf(data=poly1_bbox, color="black", linewidth = 0.7) +
      geom_sf(data=poly2_bbox, color="black", linewidth = 0.7) +
      ylim(c(3, 17)) +
      xlim(c(3, 17))

      gg.mesh +
        geom_sf(data =loc.data_sf,
          col='black',size=1.7,alpha=0.5)

      gg.mesh.water +
        geom_sf(data =loc.data_sf,
          col='black',size=1.7,alpha=0.5)

      gg2b.1 <- gg.mesh +
        ggtitle("Mesh")

      gg2b.2 <- gg.mesh.water +
        ggtitle("Barrier layout")

      gg2b.3 <- gg.mesh.water +
        geom_sf(data =loc.data_sf,
          col='black',size=1.7,alpha=0.5) +
        ggtitle("Simulated data")

      fpp <- file.path("gif.sel/geom3/mesh.g43.png")
png(fpp)
      gridExtra::grid.arrange(gg2b.1, gg2b.2, gg2b.3, ncol=3, nrow=2, 
               top="Two assymetrical barriers scenario")
      dev.off()
        }
      }
    }
  }
}

  

  
```

```{r}
#geom 3
SM <- c(1.5)
W <- 4
R <- 4
SS <- 970
fr <- 0.3
N <- c(50)


for (s in 1:length(SS)) {
  for (d in 1:length(SM)) {
    for (w in 1:length(W)) {
      for(r in 1:length(R)) {
        for (n in 1:length(N)) {
          
          smalldist = SM[d]
          width = c(1,W[w])
          range = R[r]
          max.edge.length = 0.4
          n = N[n]
          set.inla.seed = SS[s]
          x.mid = 10
          xlim.big  = c(0,20)
          xlim.small = c(3,17)
          ylim.big = c(0,20)
          ylim.small = c(3,17)
          fr = fr
          prior.range = prior.range
          prior.sigma = c(1,0.1)
          sigma.u = 1
          sigma.epsilon = 0.2
          prior.range.st = prior.range
          prior.sigma.st = c(1,0.1)
          gif.path = fp
          marginals.path = fp


  poly1 <- local.square.polygon(xlim=c(xlim.big[1]-1, x.mid-smalldist/2), 
                          ylim=x.mid+width[1]*c(-.5, .5))

  poly2 <- local.square.polygon(xlim=c(x.mid+smalldist/2, xlim.big[2]+1), 
                          ylim=x.mid+width[2]*c(-.5, .5))

  poly.original <- SpatialPolygons(c(poly1@polygons, poly2@polygons))
  
  loc1 <- matrix(c(xlim.big[1],ylim.big[1], 
                   xlim.big[2],ylim.big[1], 
                   xlim.big[2],ylim.big[2], 
                   xlim.big[1],ylim.big[2]), 4, 2, byrow = T)
  
  seg <- inla.sp2segment(poly.original)
# - Transforms a SpatialPolygon to an "inla polygon"
  mesh <- inla.mesh.2d(loc=loc1, 
                      interior = seg, 
                       max.e = max.edge.length, 
                       offset=1)

  tl <- length(mesh$graph$tv[,1])
# - the number of triangles in the mesh
  posTri <- matrix(0, tl, 2)

  for (t in 1:tl){
    temp = mesh$loc[mesh$graph$tv[t, ], ]
    posTri[t,] = colMeans(temp)[c(1,2)] 
}

  posTri <- SpatialPoints(posTri)
# - the positions of the triangle centers

  bar.original <- over(poly.original, SpatialPoints(posTri), returnList=T)
# - checking which mesh triangles are inside the barrier area
  bar.original <- unlist(bar.original)
  poly.bar.orginal <- inla.barrier.polygon(mesh, barrier.triangles = bar.original)
# - the Barrier model's polygon
# - in most cases this should be the same as poly.original

# BARRIER 1
  bar1 <- over(poly1, SpatialPoints(posTri), returnList=T)
# - checking which mesh triangles are inside the barrier area
  bar1 <- unlist(bar1)
  poly.bar1 <- inla.barrier.polygon(mesh, barrier.triangles = bar1)
# - the Barrier model's polygon
# - in most cases this should be the same as poly.original

# BARRIER 2
  bar2 <- over(poly2, SpatialPoints(posTri), returnList=T)
# - checking which mesh triangles are inside the barrier area
  bar2 <- unlist(bar2)
  poly.bar2 <- inla.barrier.polygon(mesh, barrier.triangles = bar2)

  mat <-  inla.barrier.fem.plus(mesh, list(bar1, bar2)) 
  fem <- mat 
  barrier.triangles <- list(bar1, bar2)

# PLOTS
  poly1_h <- local.square.polygon_T(xlim=c(xlim.small[1], x.mid-smalldist/2), 
                            ylim=x.mid+width[1]*c(-.5, .5))

  poly2_h <- local.square.polygon_T(xlim=c(x.mid+smalldist/2, xlim.small[2]), 
                            ylim=x.mid+width[2]*c(-.5, .5))

  loc2 <- matrix(c(3,3, 17,3, 17,17, 3,17), 4, 2, byrow = T)

  locp2 <- Polygon(loc2, hole = FALSE)
    
  poly.water <- SpatialPolygons(list(Polygons(list(locp2, poly1_h, poly2_h), '0')))
  poly.water_sf <- st_as_sf(poly.water)
    
  set.seed(set.inla.seed)
  loc.data <- spsample(x = poly.water, n = n, type = "random")
  loc.data_sf <- st_as_sf(loc.data)
  loc.data <- loc.data@coords

  poly.rect <- SpatialPolygons(list(Polygons(list(poly1_h, poly2_h), '0')))
  poly.rect_sf <- st_as_sf(poly.rect)
  poly.sq <- SpatialPolygons(list(Polygons(list(locp2), '0')))
  poly.sq_sf <- st_as_sf(poly.sq)

  sq_bbox <- st_bbox(poly.sq_sf) %>% st_as_sfc()
  poly1_bbox <- st_bbox(poly1) %>% st_as_sfc()
  poly2_bbox <- st_bbox(poly2) %>% st_as_sfc()
      
      gg.mesh <- ggplot() + 
      inlabru::gg(mesh) +
      geom_sf(data =poly.rect_sf,
          col='black', alpha=0) + #alpha color inside rect
      geom_sf(data=poly1_bbox, fill=NA, color="red", linewidth = 0.7, linetype = "dashed") +
      geom_sf(data=poly2_bbox, fill=NA, color="red", linewidth = 0.7, linetype = "dashed") +
      geom_sf(data=sq_bbox, fill=NA, color="black", linewidth = 0.7)
      
      gg.mesh.water <- ggplot() +
      inlabru::gg(mesh) +
      geom_sf(data =poly.rect_sf,
          col='black', alpha=1) + #alpha color inside rect
      geom_sf(data=sq_bbox, fill=NA, color="black", linewidth = 0.7) +
      geom_sf(data=poly1_bbox, color="black", linewidth = 0.7) +
      geom_sf(data=poly2_bbox, color="black", linewidth = 0.7) +
      ylim(c(3, 17)) +
      xlim(c(3, 17))

      gg.mesh +
        geom_sf(data =loc.data_sf,
          col='black',size=1.7,alpha=0.5)

      gg.mesh.water +
        geom_sf(data =loc.data_sf,
          col='black',size=1.7,alpha=0.5)

      gg2b.1 <- gg.mesh +
        ggtitle("Mesh")

      gg2b.2 <- gg.mesh.water +
        ggtitle("Barrier layout")

      gg2b.3 <- gg.mesh.water +
        geom_sf(data =loc.data_sf,
          col='black',size=1.7,alpha=0.5) +
        ggtitle("Simulated data")

      fpp <- file.path("gif.sel/geom3/mesh.g970.png")
png(fpp)
      gridExtra::grid.arrange(gg2b.1, gg2b.2, gg2b.3, ncol=3, nrow=2, 
               top="Two assymetrical barriers scenario")
      dev.off()
        }
      }
    }
  }
}

  

  
```


#geom1
SM <- c(1.5)
W <- c(3)
R <- 2
SS <- 880
fr <- 0.4
N <- c(30)

#geom 2
SM <- c(0)
W <- c(1)
R <- 4
SS <- 987
fr <- 0.3
N <- c(50)

#geom 3
SM <- c(1.5)
W <- 4
R <- 4
SS <- 43
fr <- 0.3
N <- c(50)

#geom 3
SM <- c(1.5)
W <- 4
R <- 4
SS <- 970
fr <- 0.3
N <- c(50)

  
for article
sm1.5w2r4seed468.n30

```{r}
local.plot.field = function(field, pal = plasma(50), ...){
  xlim = c(3, 17); ylim = xlim;
  proj = inla.mesh.projector(mesh, xlim = xlim, 
                             ylim = ylim, dims=c(300, 300))
  # - Can project from the mesh onto a 300x300 grid 
  #   for plots
  field.proj = inla.mesh.project(proj, field)
  # - Do the projection
  image.plot(list(x = proj$x, y=proj$y, z = field.proj), 
             xlim = xlim, ylim = ylim, col = pal, ...)  
  # - Use image.plot to get nice colors and legend
}
```



sm1.5w3r2seed880.n30
```{r}
prior.range = c(1, 0.5); prior.sigma = c(1, 0.1)
#geom 
SM <- c(1.5)
W <- c(3)
R <- 2
SS <- 880
N <- c(30)
fr <- c(0.01, 0.2, 0.3, 0.4, 0.5,0.7,0.8,1)

for (s in 1:length(SS)) {
  for (d in 1:length(SM)) {
    for (w in 1:length(W)) {
      for(r in 1:length(R)) {
        for (n in 1:length(N)) {
         
          
         
          
          smalldist = SM[d]
          width = c(W[w],W[w])
          range = R[r]
          max.edge.length = 0.4
          n = N[n]
          set.inla.seed = SS[s]
          x.mid = 10
          xlim.big  = c(0,20)
          xlim.small = c(3,17)
          ylim.big = c(0,20)
          ylim.small = c(3,17)
  
          prior.range = prior.range
          prior.sigma = c(1,0.1)
          sigma.u = 1
          sigma.epsilon = 0.2
          prior.range.st = prior.range
          prior.sigma.st = c(1,0.1)
          
        

  poly1 <- local.square.polygon(xlim=c(xlim.big[1]-1, x.mid-smalldist/2), 
                          ylim=x.mid+width[1]*c(-.5, .5))

  poly2 <- local.square.polygon(xlim=c(x.mid+smalldist/2, xlim.big[2]+1), 
                          ylim=x.mid+width[2]*c(-.5, .5))

  poly.original <- SpatialPolygons(c(poly1@polygons, poly2@polygons))
  
  loc1 <- matrix(c(xlim.big[1],ylim.big[1], 
                   xlim.big[2],ylim.big[1], 
                   xlim.big[2],ylim.big[2], 
                   xlim.big[1],ylim.big[2]), 4, 2, byrow = T)
  
  seg <- inla.sp2segment(poly.original)
# - Transforms a SpatialPolygon to an "inla polygon"
  mesh <- inla.mesh.2d(loc=loc1, 
                      interior = seg, 
                       max.e = max.edge.length, 
                       offset=1)

  tl <- length(mesh$graph$tv[,1])
# - the number of triangles in the mesh
  posTri <- matrix(0, tl, 2)

  for (t in 1:tl){
    temp = mesh$loc[mesh$graph$tv[t, ], ]
    posTri[t,] = colMeans(temp)[c(1,2)] 
}

  posTri <- SpatialPoints(posTri)
# - the positions of the triangle centers

  bar.original <- over(poly.original, SpatialPoints(posTri), returnList=T)
# - checking which mesh triangles are inside the barrier area
  bar.original <- unlist(bar.original)
  poly.bar.orginal <- inla.barrier.polygon(mesh, barrier.triangles = bar.original)
# - the Barrier model's polygon
# - in most cases this should be the same as poly.original

# BARRIER 1
  bar1 <- over(poly1, SpatialPoints(posTri), returnList=T)
# - checking which mesh triangles are inside the barrier area
  bar1 <- unlist(bar1)
  poly.bar1 <- inla.barrier.polygon(mesh, barrier.triangles = bar1)
# - the Barrier model's polygon
# - in most cases this should be the same as poly.original

# BARRIER 2
  bar2 <- over(poly2, SpatialPoints(posTri), returnList=T)
# - checking which mesh triangles are inside the barrier area
  bar2 <- unlist(bar2)
  poly.bar2 <- inla.barrier.polygon(mesh, barrier.triangles = bar2)

  mat <-  inla.barrier.fem.plus(mesh, list(bar1, bar2)) 
  fem <- mat 
  barrier.triangles <- list(bar1, bar2)

# PLOTS
  poly1_h <- local.square.polygon_T(xlim=c(xlim.small[1], x.mid-smalldist/2), 
                            ylim=x.mid+width[1]*c(-.5, .5))

  poly2_h <- local.square.polygon_T(xlim=c(x.mid+smalldist/2, xlim.small[2]), 
                            ylim=x.mid+width[2]*c(-.5, .5))

  loc2 <- matrix(c(3,3, 17,3, 17,17, 3,17), 4, 2, byrow = T)

  locp2 <- Polygon(loc2, hole = FALSE)
    
  poly.water <- SpatialPolygons(list(Polygons(list(locp2, poly1_h, poly2_h), '0')))
  poly.water_sf <- st_as_sf(poly.water)
    
  set.seed(set.inla.seed)
  loc.data <- spsample(x = poly.water, n = n, type = "random")
  loc.data_sf <- st_as_sf(loc.data)
  loc.data <- loc.data@coords

  poly.rect <- SpatialPolygons(list(Polygons(list(poly1_h, poly2_h), '0')))
  poly.rect_sf <- st_as_sf(poly.rect)
  poly.sq <- SpatialPolygons(list(Polygons(list(locp2), '0')))
  poly.sq_sf <- st_as_sf(poly.sq)

  sq_bbox <- st_bbox(poly.sq_sf) %>% st_as_sfc()
  poly1_bbox <- st_bbox(poly1) %>% st_as_sfc()
  poly2_bbox <- st_bbox(poly2) %>% st_as_sfc()
  


  tbm.frac <- list()
  trans <- list()
  

  for (p in 1:length(fr)) { #
     fp <- file.path("plots", paste0("sm", SM[d], "w", W[w], "r", R[r], "seed", SS[s], ".n30", "fr",fr[p], "/"))
      dir.create(fp, recursive = TRUE)
      gif.path = fp
        marginals.path = fp

    f <- fr[p]
    range.fraction <- c(0.01, f)
    tbm.frac[[p]] <- model.tbm.plus(mesh = mesh, fem = fem, 
                               barrier.triangles = barrier.triangles,
                               prior.range = prior.range, prior.sigma = prior.sigma ,  
                               range.fraction = range.fraction,
                               range = range,
                               set.inla.seed = set.inla.seed,
                               loc.data = loc.data,
                               sigma.u = 1, sigma.epsilon = 0.2,
                               poly.original = poly.bar.orginal,
                               prior.range.st = prior.range.st,
                               prior.sigma.st = prior.sigma.st,
                               return.list = TRUE)
    
    trans[[1]] <- tbm.frac[[p]]
    plot.model.tbm.plus(trans, 
                       fr = fr[p],
                       poly.bar.orginal = poly.bar.orginal,
                       range = range,
                       fps = 1,
                       gif.path = fp)
  
   
    
    fpp <- file.path(paste0(marginals.path, "tbm", f, ".png"))
    png(fpp)
    #par(mfrow = c(3, 1))
    tmp = inla.tmarginal(function(x) exp(x), trans[[1]]$pos.tbm$res$marginals.hyperpar[[3]]) 
    plot(tmp, type = "l", xlab = "r", ylab = "Density", xlim = c(0,10))
         xvals = seq(0, 10, length.out=1000)
      
    abline(v=range, col="blue")
    dev.off()
    
    
    
    fpp <- file.path(paste0(marginals.path, "st", f, ".png"))
    png(fpp)
    tmp = inla.tmarginal(function(x) (x), trans[[1]]$pos.st$res$marginals.hyperpar[[2]]) 
    plot(tmp, type = "l", xlab = "r", ylab = "Density", xlim = c(0,10))
         xvals = seq(0, 10, length.out=1000)
    abline(v=range, col="blue")
    dev.off()
    
    fpp <- file.path(paste0(marginals.path, "bm", f, ".png"))
    png(fpp)
    tmp = inla.tmarginal(function(x) exp(x), trans[[1]]$pos.bm$res$marginals.hyperpar[[3]]) 
    plot(tmp, type = "l", xlab = "r", ylab = "Density", xlim = c(0,10))
         xvals = seq(0, 10, length.out=1000)
      
    abline(v=range, col="blue")
    dev.off()

  
  

  }
  
  
        }
        
      }
    }
  }
  
}

#sm1.5w3r2seed880.n30 <- list(trans = tbm.frac, mesh = mesh, gg.mesh.water = gg.mesh.water.sim1.2, gg.mesh = gg.mesh.sim1.2, gg.mesh.data = gg.mesh.data.sim1.2, barrier.triangles = barrier.triangles)

```



```{r}
loc.out <- matrix(c(xlim.big[1],ylim.big[1], 
                 xlim.big[2],ylim.big[1], 
                 xlim.big[2],ylim.big[2], 
                 xlim.big[1],ylim.big[2],
                 xlim.big[1],ylim.big[1]), 5, 2, byrow = T)
loc.out.sp <- SpatialPolygons(list(Polygons(list(Polygon(loc.out, FALSE)), '0')))

loc.in <- matrix(c(xlim.small[1], ylim.small[1],
                   xlim.small[2], xlim.small[1],
                   xlim.small[2], ylim.small[2],
                   xlim.small[1], xlim.small[2],
                   xlim.small[1], ylim.small[1]), 5, 2, byrow = T)
loc.in.sp <- SpatialPolygons(list(Polygons(list(Polygon(loc.in, FALSE)), '0')))

plot(loc.out.sp)
plot(loc.in.sp)

poly.out <- gDifference(loc.out.sp, loc.in.sp)
plot(poly.out, col = alpha("skyblue", 0.5))
poly.out_sf <- st_as_sf(poly.out)

gg.mesh.sim1.2 <- ggplot() + 
  inlabru::gg(mesh) +
  geom_sf(data =poly.rect_sf,
          col='black', alpha=0) + #alpha color inside rect
  geom_sf(data=poly1_bbox, fill=NA, color="red", linewidth = 0.7) +
  geom_sf(data=poly2_bbox, fill=NA, color="red", linewidth = 0.7) +
  geom_sf(data=sq_bbox, fill=NA, color="black", linewidth = 0.7, linetype = "dashed")

gg.mesh.water.sim1.2 <- ggplot() +
  inlabru::gg(mesh) +
  geom_sf(data =poly.rect_sf,
          col='black', alpha=1) + #alpha color inside rect
  geom_sf(data=sq_bbox, fill=NA, color="black", linewidth = 0.7) +
  geom_sf(data=poly1_bbox, color="red", linewidth = 0.7, fill = "white") +
  geom_sf(data=poly2_bbox, color="red", linewidth = 0.7, fill = "white") +
  geom_sf(data=poly.out_sf, color="black", linewidth = 0.7, fill = "white",  linetype = "dashed") +
  ylim(c(2, 18)) +
  xlim(c(2, 18)) +
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank())
gg.mesh.sim1.2; gg.mesh.water.sim1.2

gg.mesh.data.sim1.2 <- gg.mesh.water.sim1.2 +
        geom_sf(data =loc.data_sf,
        col='black',size=1.7,alpha=0.5) 

fpp <- file.path("plots/mesh/geom1.2.mesh.png")
# png(fpp)

gg.mesh.water.sim1.2 +
        geom_sf(data =loc.data_sf,
        col='black',size=1.7,alpha=0.5) 
      
dev.off()
```


sm0w1r4seed987.n50

```{r}
prior.range = c(1, 0.5); prior.sigma = c(1, 0.1)
#geom 
SM <- c(0)
W <- c(1)
R <- 4
SS <- 987
N <- c(50)
fr <- c(0.01, 0.2, 0.3, 0.4, 0.5,0.7,0.8,1)

for (s in 1:length(SS)) {
  for (d in 1:length(SM)) {
    for (w in 1:length(W)) {
      for(r in 1:length(R)) {
        for (n in 1:length(N)) {
         
          
         
          
          smalldist = SM[d]
          width = c(W[w],W[w])
          range = R[r]
          max.edge.length = 0.4
          n = N[n]
          set.inla.seed = SS[s]
          x.mid = 10
          xlim.big  = c(0,20)
          xlim.small = c(3,17)
          ylim.big = c(0,20)
          ylim.small = c(3,17)
  
          prior.range = prior.range
          prior.sigma = c(1,0.1)
          sigma.u = 1
          sigma.epsilon = 0.2
          prior.range.st = prior.range
          prior.sigma.st = c(1,0.1)
          
        

  poly1 <- local.square.polygon(xlim=c(xlim.big[1]-1, x.mid-smalldist/2), 
                          ylim=x.mid+width[1]*c(-.5, .5))

  poly2 <- local.square.polygon(xlim=c(x.mid+smalldist/2, xlim.big[2]+1), 
                          ylim=x.mid+width[2]*c(-.5, .5))

  poly.original <- SpatialPolygons(c(poly1@polygons, poly2@polygons))
  
  loc1 <- matrix(c(xlim.big[1],ylim.big[1], 
                   xlim.big[2],ylim.big[1], 
                   xlim.big[2],ylim.big[2], 
                   xlim.big[1],ylim.big[2]), 4, 2, byrow = T)
  
  seg <- inla.sp2segment(poly.original)
# - Transforms a SpatialPolygon to an "inla polygon"
  mesh <- inla.mesh.2d(loc=loc1, 
                      interior = seg, 
                       max.e = max.edge.length, 
                       offset=1)

  tl <- length(mesh$graph$tv[,1])
# - the number of triangles in the mesh
  posTri <- matrix(0, tl, 2)

  for (t in 1:tl){
    temp = mesh$loc[mesh$graph$tv[t, ], ]
    posTri[t,] = colMeans(temp)[c(1,2)] 
}

  posTri <- SpatialPoints(posTri)
# - the positions of the triangle centers

  bar.original <- over(poly.original, SpatialPoints(posTri), returnList=T)
# - checking which mesh triangles are inside the barrier area
  bar.original <- unlist(bar.original)
  poly.bar.orginal <- inla.barrier.polygon(mesh, barrier.triangles = bar.original)
# - the Barrier model's polygon
# - in most cases this should be the same as poly.original

# BARRIER 1
  bar1 <- over(poly1, SpatialPoints(posTri), returnList=T)
# - checking which mesh triangles are inside the barrier area
  bar1 <- unlist(bar1)
  poly.bar1 <- inla.barrier.polygon(mesh, barrier.triangles = bar1)
# - the Barrier model's polygon
# - in most cases this should be the same as poly.original

# BARRIER 2
  bar2 <- over(poly2, SpatialPoints(posTri), returnList=T)
# - checking which mesh triangles are inside the barrier area
  bar2 <- unlist(bar2)
  poly.bar2 <- inla.barrier.polygon(mesh, barrier.triangles = bar2)

  mat <-  inla.barrier.fem.plus(mesh, list(bar1, bar2)) 
  fem <- mat 
  barrier.triangles <- list(bar1, bar2)

# PLOTS
  poly1_h <- local.square.polygon_T(xlim=c(xlim.small[1], x.mid-smalldist/2), 
                            ylim=x.mid+width[1]*c(-.5, .5))

  poly2_h <- local.square.polygon_T(xlim=c(x.mid+smalldist/2, xlim.small[2]), 
                            ylim=x.mid+width[2]*c(-.5, .5))

  loc2 <- matrix(c(3,3, 17,3, 17,17, 3,17), 4, 2, byrow = T)

  locp2 <- Polygon(loc2, hole = FALSE)
    
  poly.water <- SpatialPolygons(list(Polygons(list(locp2, poly1_h, poly2_h), '0')))
  poly.water_sf <- st_as_sf(poly.water)
    
  set.seed(set.inla.seed)
  loc.data <- spsample(x = poly.water, n = n, type = "random")
  loc.data_sf <- st_as_sf(loc.data)
  loc.data <- loc.data@coords

  poly.rect <- SpatialPolygons(list(Polygons(list(poly1_h, poly2_h), '0')))
  poly.rect_sf <- st_as_sf(poly.rect)
  poly.sq <- SpatialPolygons(list(Polygons(list(locp2), '0')))
  poly.sq_sf <- st_as_sf(poly.sq)

  sq_bbox <- st_bbox(poly.sq_sf) %>% st_as_sfc()
  poly1_bbox <- st_bbox(poly1) %>% st_as_sfc()
  poly2_bbox <- st_bbox(poly2) %>% st_as_sfc()
  


  tbm.frac <- list()
  trans <- list()
  

  for (p in 1:length(fr)) { #
     fp <- file.path("plots", paste0("sm", SM[d], "w", W[w], "r", R[r], "seed", SS[s], ".n50", "fr", fr[p], "/"))
      dir.create(fp, recursive = TRUE)
      gif.path = fp
      marginals.path = fp

    f <- fr[p]
    range.fraction <- c(0.01, f)
    tbm.frac[[p]] <- model.tbm.plus(mesh = mesh, fem = fem, 
                               barrier.triangles = barrier.triangles,
                               prior.range = prior.range, prior.sigma = prior.sigma,  
                               range.fraction = range.fraction,
                               range = range,
                               set.inla.seed = set.inla.seed,
                               loc.data = loc.data,
                               sigma.u = 1, sigma.epsilon = 0.2,
                               poly.original = poly.bar.orginal,
                               prior.range.st = prior.range.st,
                               prior.sigma.st = prior.sigma.st,
                               return.list = TRUE)
    
    trans[[1]] <- tbm.frac[[p]]
    plot.model.tbm.plus(trans, 
                       fr = fr[p],
                       poly.bar.orginal = poly.bar.orginal,
                       range = range,
                       fps = 1,
                       gif.path = fp)
  
   
    
    fpp <- file.path(paste0(marginals.path, "tbm", f, ".png"))
    png(fpp)
    #par(mfrow = c(3, 1))
    tmp = inla.tmarginal(function(x) exp(x), trans[[1]]$pos.tbm$res$marginals.hyperpar[[3]]) 
    plot(tmp, type = "l", xlab = "r", ylab = "Density", xlim = c(1,8))
         xvals = seq(0, 10, length.out=1000)
      
    abline(v=range, col="blue")
    dev.off()
    
    fpp <- file.path(paste0(marginals.path, "st", f, ".png"))
    png(fpp)
    tmp = inla.tmarginal(function(x) (x), trans[[1]]$pos.st$res$marginals.hyperpar[[2]]) 
    plot(tmp, type = "l", xlab = "r", ylab = "Density", xlim = c(1,8))
         xvals = seq(0, 10, length.out=1000)
    abline(v=range, col="blue")
    dev.off()
    
    fpp <- file.path(paste0(marginals.path, "bm", f, ".png"))
    png(fpp)
    tmp = inla.tmarginal(function(x) exp(x), trans[[1]]$pos.bm$res$marginals.hyperpar[[3]]) 
    plot(tmp, type = "l", xlab = "r", ylab = "Density", xlim = c(1,8))
         xvals = seq(0, 10, length.out=1000)
      
    abline(v=range, col="blue")
    dev.off()

  
  

  }
  
  
        }
        
      }
    }
  }
  
}
```

```{r}
loc.out <- matrix(c(xlim.big[1],ylim.big[1], 
                 xlim.big[2],ylim.big[1], 
                 xlim.big[2],ylim.big[2], 
                 xlim.big[1],ylim.big[2],
                 xlim.big[1],ylim.big[1]), 5, 2, byrow = T)
loc.out.sp <- SpatialPolygons(list(Polygons(list(Polygon(loc.out, FALSE)), '0')))

loc.in <- matrix(c(xlim.small[1], ylim.small[1],
                   xlim.small[2], xlim.small[1],
                   xlim.small[2], ylim.small[2],
                   xlim.small[1], xlim.small[2],
                   xlim.small[1], ylim.small[1]), 5, 2, byrow = T)
loc.in.sp <- SpatialPolygons(list(Polygons(list(Polygon(loc.in, FALSE)), '0')))

plot(loc.out.sp)
plot(loc.in.sp)

poly.out <- gDifference(loc.out.sp, loc.in.sp)
plot(poly.out, col = alpha("skyblue", 0.5))
poly.out_sf <- st_as_sf(poly.out)

gg.mesh.sim2 <- ggplot() + 
  inlabru::gg(mesh) +
  geom_sf(data =poly.rect_sf,
          col='black', alpha=0) + #alpha color inside rect
  geom_sf(data=poly1_bbox, fill=NA, color="red", linewidth = 0.7) +
  geom_sf(data=poly2_bbox, fill=NA, color="red", linewidth = 0.7) +
  geom_sf(data=sq_bbox, fill=NA, color="black", linewidth = 0.7, linetype = "dashed")

gg.mesh.water.sim2 <- ggplot() +
  inlabru::gg(mesh) +
  geom_sf(data =poly.rect_sf,
          col='black', alpha=1) + #alpha color inside rect
  geom_sf(data=sq_bbox, fill=NA, color="black", linewidth = 0.7) +
  geom_sf(data=poly1_bbox, color="red", linewidth = 0.7, fill = "white") +
  geom_sf(data=poly2_bbox, color="red", linewidth = 0.7, fill = "white") +
  geom_sf(data=poly.out_sf, color="black", linewidth = 0.7, fill = "white",  linetype = "dashed") +
  ylim(c(2, 18)) +
  xlim(c(2, 18)) +
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank())
gg.mesh.sim2; gg.mesh.water.sim2

gg.mesh.data.sim2 <- gg.mesh.water.sim2 +
        geom_sf(data =loc.data_sf,
        col='black',size=1.7,alpha=0.5) 

fpp <- file.path("plots/mesh/geom2.mesh.png")
#png(fpp)

gg.mesh.data.sim2 
      
dev.off()

#sm0w1r4seed987.n50 <- list(trans = tbm.frac, mesh = mesh, gg.mesh.water = gg.mesh.water.sim2, gg.mesh = gg.mesh.sim2, gg.mesh.data = gg.mesh.data.sim2, barrier.triangles = barrier.triangles)
```

