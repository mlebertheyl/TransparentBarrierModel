

```{r}
#geom 1.1
SM <- c(1.5)
W <- c(2, 3)
R <- seq(2, 5, 1)
SS <- floor(runif(5, 1, 1000))
fr <- 0.4
N <- c(30, 60)
          
          smalldist = SM[1]
          width = c(W[1],W[1])
          range = R[3]
          max.edge.length = 0.4
          n = N[1]
          set.inla.seed = SS[1]
          x.mid = 10
          xlim.big  = c(0,20)
          xlim.small = c(3,17)
          ylim.big = c(0,20)
          ylim.small = c(3,17)
          fr = fr
          prior.range = prior.range
          prior.sigma = c(1,0.1)
          sigma.u = 1
          sigma.epsilon = 0.2
          prior.range.st = prior.range
          prior.sigma.st = c(1,0.1)
          gif.path = fp
          marginals.path = fp


  poly1 <- local.square.polygon(xlim=c(xlim.big[1]-1, x.mid-smalldist/2), 
                          ylim=x.mid+width[1]*c(-.5, .5))

  poly2 <- local.square.polygon(xlim=c(x.mid+smalldist/2, xlim.big[2]+1), 
                          ylim=x.mid+width[2]*c(-.5, .5))

  poly.original <- SpatialPolygons(c(poly1@polygons, poly2@polygons))
  
  loc1 <- matrix(c(xlim.big[1],ylim.big[1], 
                   xlim.big[2],ylim.big[1], 
                   xlim.big[2],ylim.big[2], 
                   xlim.big[1],ylim.big[2]), 4, 2, byrow = T)
  
  seg <- inla.sp2segment(poly.original)
  mesh <- inla.mesh.2d(loc=loc1, 
                      interior = seg, 
                       max.e = max.edge.length, 
                       offset=1)

  tl <- length(mesh$graph$tv[,1])
  posTri <- matrix(0, tl, 2)

  for (t in 1:tl){
    temp = mesh$loc[mesh$graph$tv[t, ], ]
    posTri[t,] = colMeans(temp)[c(1,2)] 
}

  posTri <- SpatialPoints(posTri)
  bar.original <- over(poly.original, SpatialPoints(posTri), returnList=T)
  bar.original <- unlist(bar.original)
  
  #THIS TAKES A FEW SECONDS AND IT'S ACTUALLY NOT NEEDED IN EVERY LOOP, inla.barrier.polygon
  poly.bar.orginal <- inla.barrier.polygon(mesh, barrier.triangles = bar.original)

# BARRIER 1
  bar1 <- over(poly1, SpatialPoints(posTri), returnList=T)
  bar1 <- unlist(bar1)
  poly.bar1 <- inla.barrier.polygon(mesh, barrier.triangles = bar1)


# BARRIER 2
  bar2 <- over(poly2, SpatialPoints(posTri), returnList=T)
  bar2 <- unlist(bar2)
  poly.bar2 <- inla.barrier.polygon(mesh, barrier.triangles = bar2)

  mat <-  inla.barrier.fem.plus(mesh, list(bar1, bar2)) 
  fem <- mat 
  barrier.triangles <- list(bar1, bar2)

# PLOTS
  poly1_h <- local.square.polygon_T(xlim=c(xlim.small[1], x.mid-smalldist/2), 
                            ylim=x.mid+width[1]*c(-.5, .5))

  poly2_h <- local.square.polygon_T(xlim=c(x.mid+smalldist/2, xlim.small[2]), 
                            ylim=x.mid+width[2]*c(-.5, .5))

  loc2 <- matrix(c(3,3, 17,3, 17,17, 3,17), 4, 2, byrow = T)

  locp2 <- Polygon(loc2, hole = FALSE)
    
  poly.water <- SpatialPolygons(list(Polygons(list(locp2, poly1_h, poly2_h), '0')))
  poly.water_sf <- st_as_sf(poly.water)
  
  #SAME AS THE GAUSSIAN FIELD UNTIL HERE
```

Change poly.win to simulate points on the big square instead of the smaller area like the gaussian case, this is so I can cimulate a lower number of points for the poisson, otherwise I end up simulating like 400 points of the rLGCP simulation function
```{r}
poly.win <- SpatialPolygons(list(Polygons(list(Polygon(loc1, hole = FALSE), 
                                               Polygon(poly1@polygons[[1]]@Polygons[[1]]@coords, hole = TRUE),
                                               Polygon(poly2@polygons[[1]]@Polygons[[1]]@coords, hole = TRUE)), 
                                          '0')))

#Polygon(poly1@polygons[[1]]@Polygons[[1]]@coords, hole = TRUE) same as local.square.polygon_T but the limites of the barrier are the ones of the poly1, i.e. big barriers
win <- polyCub::as.owin.SpatialPolygons(poly.win)
plot(win)
npix <- 300
spatstat.options(npixel = npix)

beta0 <- 1
exp(beta0) * diff(range(win$x)) * diff(range(win$y))

sigma2x <- 0.01
nu <- 1

## ----simulapp,eval=TRUE, warning=FALSE, message=FALSE--------------------
set.seed(set.inla.seed)
lg.s <- rLGCP('matern', beta0, var = sigma2x,
              scale = range / sqrt(8), 
              nu = nu, win = win)

## ----xy------------------------------------------------------------------
xy <- cbind(lg.s$x, lg.s$y)
loc.data <- SpatialPoints(xy)
loc.data_sf <- st_as_sf(loc.data)
#loc.data <- loc.data@coords

ggplot() + 
      inlabru::gg(mesh) +
      geom_sf(data =loc.data_sf,
          col='purple',size=1.7,alpha=0.5) 

xy <- xy[(which(xy[,1] < 17 & xy[,1] > 3)),]
xy <- xy[(which(xy[,2] < 17 & xy[,2] > 3)),]

dim(xy)
loc.data <- SpatialPoints(xy)
loc.data_sf <- st_as_sf(loc.data)

ggplot() + 
      inlabru::gg(mesh) +
      geom_sf(data =loc.data_sf,
          col='purple',size=1.7,alpha=0.5)

#sample from both loc.data the one using the entire area and the reduce one

fit.pois <- kppm(lg.s, clusters="LGCP", model="matern", nu=1)
kppm.data <- simulate.kppm(fit.pois, nsim = 8)
plot(kppm.data)

kppm.xy <- cbind(kppm.data$`Simulation 1`$x, kppm.data$`Simulation 1`$y)

kppm.xy <- kppm.xy[(which(kppm.xy[,1] < 17 & kppm.xy[,1] > 3)),]
kppm.xy <- kppm.xy[(which(kppm.xy[,2] < 17 & kppm.xy[,2] > 3)),]

k.loc.data <- SpatialPoints(kppm.xy)
k.loc.data_sf <- st_as_sf(k.loc.data)

ggplot() + 
      inlabru::gg(mesh) +
      geom_sf(data =k.loc.data_sf,
          col='purple',size=1.7,alpha=0.5)


```

Now using the small square to simulate the points and use simulate kppm twice

```{r}
win <- polyCub::as.owin.SpatialPolygons(poly.water)
plot(win)
npix <- 300
spatstat.options(npixel = npix)

beta0 <- 0.1
exp(beta0) * diff(range(win$x)) * diff(range(win$y))

sigma2x <- 0.01
nu <- 1

## ----simulapp,eval=TRUE, warning=FALSE, message=FALSE--------------------
set.seed(set.inla.seed)
lg.s <- rLGCP('matern', beta0, var = sigma2x,
              scale = range / sqrt(8), 
              nu = nu, win = win)

## ----xy------------------------------------------------------------------
xy <- cbind(lg.s$x, lg.s$y)
loc.data <- SpatialPoints(xy)
loc.data_sf <- st_as_sf(loc.data)
#loc.data <- loc.data@coords

ggplot() + 
      inlabru::gg(mesh) +
      geom_sf(data =loc.data_sf,
          col='purple',size=1.7,alpha=0.5) 

fit.pois <- kppm(lg.s, clusters="LGCP", model="matern", nu=1)
kppm.data <- simulate.kppm(fit.pois, nsim = 15)
plot(kppm.data)

n <- c()
nsim = 15
for (i in 1:nsim) {
  n[i] <- kppm.data[[i]]$n
}

kppm.data <- kppm.data[[order(n)[1]]]

kppm.xy <- cbind(kppm.data$x, kppm.data$y)

k.loc.data <- SpatialPoints(kppm.xy)
k.loc.data_sf <- st_as_sf(k.loc.data)

ggplot() + 
      inlabru::gg(mesh) +
      geom_sf(data =k.loc.data_sf,
          col='purple',size=1.7,alpha=0.5)

## kppm again

fit.pois <- kppm(kppm.data, clusters="LGCP", model="matern", nu=1)
kppm.data <- simulate.kppm(fit.pois, nsim = nsim)
plot(kppm.data)

n <- c()
nsim = 15
for (i in 1:nsim) {
  n[i] <- kppm.data[[i]]$n
}

kppm.data <- kppm.data[[order(n)[1]]]

kppm.xy <- cbind(kppm.data$x, kppm.data$y)

k.loc.data <- SpatialPoints(kppm.xy)
k.loc.data_sf <- st_as_sf(k.loc.data)

ggplot() + 
      inlabru::gg(mesh) +
      geom_sf(data =k.loc.data_sf,
          col='purple',size=1.7,alpha=0.5)

## kppm again... until heating a number lower than 100 maybe

fit.pois <- kppm(kppm.data, clusters="LGCP", model="matern", nu=1)
kppm.data <- simulate.kppm(fit.pois, nsim = nsim)
plot(kppm.data)

n <- c()
nsim = 15
for (i in 1:nsim) {
  n[i] <- kppm.data[[i]]$n
}

kppm.data <- kppm.data[[order(n)[1]]]

kppm.xy <- cbind(kppm.data$x, kppm.data$y)

k.loc.data <- SpatialPoints(kppm.xy)
k.loc.data_sf <- st_as_sf(k.loc.data)

ggplot() + 
      inlabru::gg(mesh) +
      geom_sf(data =k.loc.data_sf,
          col='purple',size=1.7,alpha=0.5)

gg.mesh +
  geom_sf(data =k.loc.data_sf,
          col='black',size=1.7,alpha=0.5)

gg.mesh.water +
  geom_sf(data =k.loc.data_sf,
          col='black',size=1.7,alpha=0.5)
```
Plot spde book, but it's sideways 

```{r}
Lam <- attr(lg.s, 'Lambda')
rf.s <- log(Lam$v)
summary(as.vector(rf.s))

## ----lgrfpp, echo = FALSE, fig.cap = "Simulated intensity of the point process and simulated point pattern (black dots)."----
par(mfrow =c(1, 1), mar=c(0, 0, 0, 0))
book.plot.field(list(x = Lam$yrow, y = Lam$xcol, z = rf.s))
               # xlim=c(0,3), ylim=c(0,3))
points(xy_, pch = 19) 

xy_ <- cbind(lg.s$x, lg.s$y)

## ----mesh----------------------------------------------------------------
loc.d <- 3 * cbind(c(0, 1, 1, 0, 0), c(0, 0, 1, 1, 0))
mesh <- inla.mesh.2d(loc.domain = loc.d, offset = c(0.3, 1), 
  max.edge = c(0.3, 0.7), cutoff = 0.05)
nv <- mesh$n

## ----ppmesh, echo = FALSE, fig.cap = "Mesh used to fit a log-Gaussian Cox process to a point pattern."----

par(mar = c(0, 0, 0, 0))
plot(mesh, asp = 1, main = '')
points(xy, col = 4, pch = 19)
lines(loc.d, col = 3)
```

Use negative beta0

```{r}
#geom 1.1
SM <- c(1.5)
W <- c(2, 3)
R <- seq(2, 5, 1)
SS <- floor(runif(5, 1, 1000))
fr <- 0.4
N <- c(30, 60)
          
          smalldist = SM[1]
          width = c(W[1],W[1])
          range = R[3]
          max.edge.length = 0.4
          n = N[1]
          set.inla.seed = SS[1]
          x.mid = 10
          xlim.big  = c(0,20)
          xlim.small = c(3,17)
          ylim.big = c(0,20)
          ylim.small = c(3,17)
          fr = fr
          prior.range = prior.range
          prior.sigma = c(1,0.1)
          sigma.u = 1
          sigma.epsilon = 0.2
          prior.range.st = prior.range
          prior.sigma.st = c(1,0.1)
          gif.path = fp
          marginals.path = fp


  poly1 <- local.square.polygon(xlim=c(xlim.big[1]-1, x.mid-smalldist/2), 
                          ylim=x.mid+width[1]*c(-.5, .5))

  poly2 <- local.square.polygon(xlim=c(x.mid+smalldist/2, xlim.big[2]+1), 
                          ylim=x.mid+width[2]*c(-.5, .5))

  poly.original <- SpatialPolygons(c(poly1@polygons, poly2@polygons))
  
  loc1 <- matrix(c(xlim.big[1],ylim.big[1], 
                   xlim.big[2],ylim.big[1], 
                   xlim.big[2],ylim.big[2], 
                   xlim.big[1],ylim.big[2]), 4, 2, byrow = T)
  
  seg <- inla.sp2segment(poly.original)
  mesh <- inla.mesh.2d(loc=loc1, 
                      interior = seg, 
                       max.e = max.edge.length, 
                       offset=1)

  tl <- length(mesh$graph$tv[,1])
  posTri <- matrix(0, tl, 2)

  for (t in 1:tl){
    temp = mesh$loc[mesh$graph$tv[t, ], ]
    posTri[t,] = colMeans(temp)[c(1,2)] 
}

  posTri <- SpatialPoints(posTri)
  bar.original <- over(poly.original, SpatialPoints(posTri), returnList=T)
  bar.original <- unlist(bar.original)
  
  #THIS TAKES A FEW SECONDS AND IT'S ACTUALLY NOT NEEDED IN EVERY LOOP, inla.barrier.polygon
  poly.bar.orginal <- inla.barrier.polygon(mesh, barrier.triangles = bar.original)

# BARRIER 1
  bar1 <- over(poly1, SpatialPoints(posTri), returnList=T)
  bar1 <- unlist(bar1)
  poly.bar1 <- inla.barrier.polygon(mesh, barrier.triangles = bar1)


# BARRIER 2
  bar2 <- over(poly2, SpatialPoints(posTri), returnList=T)
  bar2 <- unlist(bar2)
  poly.bar2 <- inla.barrier.polygon(mesh, barrier.triangles = bar2)

  mat <-  inla.barrier.fem.plus(mesh, list(bar1, bar2)) 
  fem <- mat 
  barrier.triangles <- list(bar1, bar2)

# PLOTS
  poly1_h <- local.square.polygon_T(xlim=c(xlim.small[1], x.mid-smalldist/2), 
                            ylim=x.mid+width[1]*c(-.5, .5))

  poly2_h <- local.square.polygon_T(xlim=c(x.mid+smalldist/2, xlim.small[2]), 
                            ylim=x.mid+width[2]*c(-.5, .5))

  loc2 <- matrix(c(3,3, 17,3, 17,17, 3,17), 4, 2, byrow = T)

  locp2 <- Polygon(loc2, hole = FALSE)
    
  poly.water <- SpatialPolygons(list(Polygons(list(locp2, poly1_h, poly2_h), '0')))
  poly.water_sf <- st_as_sf(poly.water)
  
  #SAME AS THE GAUSSIAN FIELD UNTIL HERE
win <- polyCub::as.owin.SpatialPolygons(poly.water)
plot(win)
npix <- 300
spatstat.options(npixel = npix)

beta0 <- -2
exp(beta0) * diff(range(win$x)) * diff(range(win$y))

sigma2x <- 0.01
nu <- 1

## ----simulapp,eval=TRUE, warning=FALSE, message=FALSE--------------------
set.seed(set.inla.seed) #132
lg.s <- rLGCP('matern', beta0, var = sigma2x,
              scale = range / sqrt(8), 
              nu = nu, win = win)

## ----xy------------------------------------------------------------------
xy <- cbind(lg.s$x, lg.s$y)
length(xy)
loc.data <- SpatialPoints(xy)
loc.data_sf <- st_as_sf(loc.data)
#loc.data <- loc.data@coords

ggplot() + 
      inlabru::gg(mesh) +
      geom_sf(data =loc.data_sf,
          col='purple',size=1.7,alpha=0.5)
```


```{r}
Lam <- attr(lg.s, 'Lambda')
rf.s <- log(Lam$v)
summary(as.vector(rf.s))

nv <- mesh$n
dmesh <- book.mesh.dual(mesh)

domain.polys <- Polygons(list(Polygon(loc1)), '0')
domainSP <- SpatialPolygons(list(domain.polys))
domainSPsf <- st_as_sf(domainSP)

dmesh_sf <- st_as_sf(dmesh) 

# with sapply
w <- sapply(1:length(dmesh), function(i) {
  if (length(st_intersects(dmesh_sf[i, ], domainSPsf)[[1]]) == 1)
    return(st_area(st_intersection(dmesh_sf[i, ], domainSPsf)))
  else {
    return(0)
  }
})

# for w
n <- nrow(xy)
y.pp <- rep(0:1, c(nv, n))
#The exposure vector can be defined as:
e.pp <- c(w, rep(0, n)) 
length(y.pp); length(e.pp); sum(w); table(w > 0)
# The projection matrix is defined in two steps. For the integration points this is just a diagonal matrix because these locations are just the mesh vertices:
imat <- Diagonal(nv, rep(1, nv))
# For the observed points, another projection matrix is defined:
lmat <- inla.spde.make.A(mesh, xy)
# The entire projection matrix is:
A.pp <- rbind(imat, lmat)
# We set up the data stack as follows:
stk.pp <- inla.stack(
  data = list(y = y.pp, e = e.pp), 
  A = list(1, A.pp),
  effects = list(list(b0 = rep(1, nv + n)), list(i = 1:nv)),
  tag = 'pp')


spde <- 
    inla.spde2.pcmatern(mesh, 
                        prior.range = c(prior.range.st[1], prior.range.st[2]),
                        prior.sigma = c(prior.sigma.st[1], prior.sigma.st[2]))

formula.st <- y ~ 0 + b0 + f(i, model = spde)
res.pp.st <- inla(formula.st, 
                  family = 'poisson', 
                  data = inla.stack.data(stk.pp), 
                  control.predictor = list(A = inla.stack.A(stk.pp)), 
                  E = inla.stack.data(stk.pp)$e)

res.pp.st$summary.hyperpar

# PLOTS
par(mfrow = c(1, 3), mar = c(3, 3, 1, 0.3), mgp = c(2, 1, 0)) 

plot(res.pp.st$marginals.fixed[[1]], type = 'l', xlab = expression(beta[0]),
     ylab = 'Density')
abline(v = beta0, col = 2)

plot(res.pp.st$marginals.hyperpar[[2]], type = 'l', xlab = expression(sigma),
     ylab = 'Density') #, xlim = c(0,2)
abline(v = sqrt(sigma2x), col = 2)

plot(res.pp.st$marginals.hyperpar[[1]], type = 'l', xlab = 'Nominal range',
     ylab = 'Density')
abline(v = range, col = 2)

barrier.model <- 
    inla.barrier.pcmatern.plus(mesh, 
                               fem, 
                               barrier.triangles, 
                               prior.range = prior.range,
                               prior.sigma = prior.sigma,
                               range.fraction = c(0.1, 0.1))

formula <- y ~ 0 + b0 + f(i, model = barrier.model)
  
res.pp.bm <- inla(formula,
                 data = inla.stack.data(stk.pp),
                 control.predictor = list(A = inla.stack.A(stk.pp)),
                 family = 'poisson', 
                 E = inla.stack.data(stk.pp)$e, 
                 control.inla = list(int.strategy = "eb"))

list.field <- list(barrier.model = barrier.model)
pos.bm <- list(res = res.pp.bm)
pos.st <- list(res = res.pp.st)
    
trans <- list(list.field = list.field, pos.bm = pos.bm, pos.st = pos.st)

par(mfrow = c(1, 2))
local.plot.field(trans$pos.bm$res$summary.random$i$mean, 
                     main="Spatial mean posterior for Barrier model",
                     sub = paste("Barrier Model, range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"))
plot(poly.bar.orginal, add=T)

local.plot.field(res.pp.st$summary.random$i$mean); plot(poly.bar.orginal, add=T)
                     
```

Now for the loop

```{r}
model.tbm.plus.pp <- 
             function(mesh = mesh, 
                      fem = fem, 
                      stk.pp = stk.pp, 
                      barrier.triangles = barrier.triangles, 
                      prior.range = c(1, 0.5), prior.sigma = c(1, 0.1),
                      range.fraction = range.fraction,
                      range = range,
                      set.inla.seed = set.inla.seed, # make sure is the same as prev. fx if loc.data = T
                      loc.data = loc.data, 
                      sigma.u = 1, sigma.epsilon = 0.2,
                      poly.original = poly.bar.orginal,
                      prior.range.st = c(1, 0.5),    
                      prior.sigma.st = c(1, 0.1),
                      return.list = TRUE) {
  

  tbm <- inla.barrier.pcmatern.plus(mesh, fem, barrier.triangles, 
                                    prior.range, prior.sigma, 
                                    range.fraction)

  formula <- y ~ 0 + b0 + f(i, model = tbm)
  
  res.tbm <- inla(formula,
                 data = inla.stack.data(stk.pp),
                 control.predictor = list(A = inla.stack.A(stk.pp)),
                 family = 'poisson', 
                 E = inla.stack.data(stk.pp)$e, 
                 control.inla = list(int.strategy = "eb"))
  ##
  bm <- inla.barrier.pcmatern.plus(mesh, fem, barrier.triangles,
                                   prior.range, prior.sigma, 
                                   range.fraction = c(0.01, 0.01))
  
  formula.bm <- y ~ 0 + b0 + f(i, model = bm)
  
  res.bm <- inla(formula.bm,
                 data = inla.stack.data(stk.pp),
                 control.predictor = list(A = inla.stack.A(stk.pp)),
                 family = 'poisson', 
                 E = inla.stack.data(stk.pp)$e, 
                 control.inla = list(int.strategy = "eb"))
  
  model.stat <- inla.spde2.pcmatern(mesh, 
                                    prior.range = c(prior.range.st[1], prior.range.st[2]),
                                    prior.sigma = c(prior.sigma.st[1], prior.sigma.st[2]))

  formula.st <- y ~ 0 + b0 + f(i, model = model.stat)
  
  res.st <- inla(formula.st, 
                 data = inla.stack.data(stk.pp), 
                 control.predictor = list(A = inla.stack.A(stk.pp)), 
                 family = 'poisson', 
                 E = inla.stack.data(stk.pp)$e)
  
  if (return.list == TRUE) {
    
    list.field <- list(barrier.model = tbm)
    pos.tbm <- list(res = res.tbm)
    pos.bm <- list(res = res.bm)
    pos.st <- list(res = res.st)
    
    return(list(list.field = list.field, pos.tbm = pos.tbm, pos.bm = pos.bm, pos.st = pos.st))
  }
                     
}
```


```{r}
plot.model.tbm.plus.pp <- 
  function(trans, 
           fr,
           max.frac = 1,
           poly.bar.orginal = poly.bar.orginal,
           range = range,
           fps = 1,
           set.inla.seed = set.inla.seed,
                              col=alpha('grey', 0),
                              plot.points = points(loc.data, 
                                              pch = 16, 
                                              cex = 0.8, 
                                              col=alpha('gray', 0)),
                              gif.path = "gif.pp/",
                              pal.field = turbo(50),
                              pal.pos.mean = turbo(50),
                              pal.pos.sd = turbo(50),
                              pal.pos.q25 = turbo(50),
                              pal.pos.q50 = turbo(50),
                              pal.pos.q975 = turbo(50),
                              
                              pal.pos.mean.st = turbo(50),
                              pal.pos.sd.st = turbo(50),
                              pal.pos.q25.st = turbo(50),
                              pal.pos.q50.st = turbo(50),
                              pal.pos.q975.st = turbo(50),
                              ...
    ){
#  dir_out_f <- file.path(tempdir(), "truefield_gif")
#  dir.create(dir_out_f, recursive = TRUE)
  
  # t. barrier model
  dir_out_pm.tbm <- file.path(tempdir(), "mean.tbm_gif")
  dir.create(dir_out_pm.tbm, recursive = TRUE)
  
  dir_out_sd.tbm <- file.path(tempdir(), "sd.tbm_gif")
  dir.create(dir_out_sd.tbm, recursive = TRUE)
  
  dir_out_q25.tbm <- file.path(tempdir(), "q25.tbm_gif")
  dir.create(dir_out_q25.tbm, recursive = TRUE)
  
  dir_out_q5.tbm <- file.path(tempdir(), "q5.tbm_gif")
  dir.create(dir_out_q5.tbm, recursive = TRUE)
  
  dir_out_q975.tbm <- file.path(tempdir(), "q975.tbm_gif")
  dir.create(dir_out_q975.tbm, recursive = TRUE)
  
  # barrier model
  dir_out_pm <- file.path(tempdir(), "mean.bm_gif")
  dir.create(dir_out_pm, recursive = TRUE)
  
  dir_out_sd <- file.path(tempdir(), "sd.bm_gif")
  dir.create(dir_out_sd, recursive = TRUE)
  
  dir_out_q25 <- file.path(tempdir(), "q25.bm_gif")
  dir.create(dir_out_q25, recursive = TRUE)
  
  dir_out_q5 <- file.path(tempdir(), "q5.bm_gif")
  dir.create(dir_out_q5, recursive = TRUE)
  
  dir_out_q975 <- file.path(tempdir(), "q975.bm_gif")
  dir.create(dir_out_q975, recursive = TRUE)
  
  # stationary model
  dir_out_s <- file.path(tempdir(), "mean.st_gif")
  dir.create(dir_out_s, recursive = TRUE)
  
  dir_out_st.sd <- file.path(tempdir(), "sd.st_gif")
  dir.create(dir_out_st.sd, recursive = TRUE)
  
  dir_out_st.q25 <- file.path(tempdir(), "q25.st_gif")
  dir.create(dir_out_st.q25, recursive = TRUE)
  
  dir_out_st.q5 <- file.path(tempdir(), "q5.st_gif")
  dir.create(dir_out_st.q5, recursive = TRUE)
  
  dir_out_st.q975 <- file.path(tempdir(), "q975.st_gif")
  dir.create(dir_out_st.q975, recursive = TRUE)
  
  for (r in 1:length(trans)) {
    
    f <- fr[r]
    range.fraction <- c(f, f)
    
    ## TBM
    # POSTERIOR MEAN
    fpp <- file.path(dir_out_pm.tbm, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.tbm$res$summary.random$i$mean, 
                     main="Spatial estimate for Transparent Barrier model",
                     sub = paste("range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     axes = F, pal = pal.pos.mean)
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()
    
    #POS SD
    fpp <- file.path(dir_out_sd.tbm, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.tbm$res$summary.random$i$sd, 
                     main="Spatial sd estimate for Transparent Barrier model",
                     sub = paste("Barrier Model, range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     axes = F, pal = pal.pos.sd)
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()
    
    #POS QUANTILES
    # 0.025
    fpp <- file.path(dir_out_q25.tbm, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.tbm$res$summary.random$i[,4], 
                     main="Spatial 0.025 quantile estimate for Transparent Barrier model",
                     sub = paste("Barrier Model, range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     axes = F, pal = pal.pos.q25)
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()

    # 0.5
    fpp <- file.path(dir_out_q5.tbm, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.tbm$res$summary.random$i[,5], 
                     main="Spatial 0.5 quantile estimate for Transparent Barrier model",
                     sub = paste("Barrier Model, range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     axes = F, pal = pal.pos.q50)
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()
    
    # 0.975
    fpp <- file.path(dir_out_q975.tbm, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.tbm$res$summary.random$i[,6], 
                     main="Spatial 0.975 quantile estimate for Transparent Barrier model",
                     sub = paste("Barrier Model, range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     axes = F, pal = pal.pos.q975)
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()
    
    ##BM
    fpp <- file.path(dir_out_pm, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.bm$res$summary.random$i$mean, 
                     main="Spatial estimate for Barrier model",
                     sub = paste("range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     axes = F, pal = pal.pos.mean)
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()
    
    #POS SD
    fpp <- file.path(dir_out_sd, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.bm$res$summary.random$i$sd, 
                     main="Spatial sd estimate for Barrier model",
                     sub = paste("Barrier Model, range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     axes = F, pal = pal.pos.sd)
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()
    
    #POS QUANTILES
    # 0.025
    fpp <- file.path(dir_out_q25, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.bm$res$summary.random$i[,4], 
                     main="Spatial 0.025 quantile estimate for Barrier model",
                     sub = paste("Barrier Model, range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     axes = F, pal = pal.pos.q25)
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()

    # 0.5
    fpp <- file.path(dir_out_q5, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.bm$res$summary.random$i[,5], 
                     main="Spatial 0.5 quantile estimate for Barrier model",
                     sub = paste("Barrier Model, range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     axes = F, pal = pal.pos.q50)
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()
    
    # 0.975
    fpp <- file.path(dir_out_q975, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.bm$res$summary.random$i[,6], 
                     main="Spatial 0.975 quantile estimate for Barrier model",
                     sub = paste("Barrier Model, range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     axes = F, pal = pal.pos.q975)
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()
    
    # SPATIAL ESTIMATE WITH STATIONARY MODEL
    fpp <- file.path(dir_out_s, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.st$res$summary.random$i$mean,
                     main="Spatial estimate with the stationary model",
                     sub = paste("Barrier Model, range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     axes = F, pal = pal.pos.mean.st) 
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()
    
    #POS SD st
    fpp <- file.path(dir_out_st.sd, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.st$res$summary.random$i$sd, 
                     main="Spatial sd estimate with the stationary model",
                     sub = paste("Barrier Model, range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     axes = F, pal = pal.pos.sd.st)
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()
    
    #POS QUANTILES st
    # 0.025 st
    fpp <- file.path(dir_out_st.q25, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.st$res$summary.random$i[,4], 
                     main="Spatial 0.025 estimate with the stationary model",
                     sub = paste("Barrier Model, range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     axes = F, pal = pal.pos.q25.st)
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()

    # 0.5 st
    fpp <- file.path(dir_out_st.q5, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.st$res$summary.random$i[,5], 
                     main="Spatial 0.5 quantile estimate with the stationary model",
                     sub = paste("Barrier Model, range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     axes = F, pal = pal.pos.q50.st)
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()
    
    # 0.975 st
    fpp <- file.path(dir_out_st.q975, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.st$res$summary.random$i[,6], 
                     main="Spatial 0.975 quantile estimate with the stationary model",
                     sub = paste("Barrier Model, range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     axes = F, pal = pal.pos.q975.st)
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()
  }
    
    ## TBM
    # POSTERIOR MEAN
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_pm.tbm, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "mean.tbm.gif"))
    
    #POS SD
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_sd.tbm, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "sd.tbm.gif"))
    
    #POS QUANTILES
    # 0.025
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_q25.tbm, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "q25.tbm.gif"))
    
    # 0.5
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_q5.tbm, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "q5.tbm.gif"))
    
    # 0.975
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_q975.tbm, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "q975.tbm.gif"))
    
    ## BM
    # POSTERIOR MEAN
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_pm, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "mean.bm.gif"))
    
    #POS SD
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_sd, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "sd.bm.gif"))
    
    #POS QUANTILES
    # 0.025
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_q25, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "q25.bm.gif"))
    
    # 0.5
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_q5, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "q5.bm.gif"))
    
    # 0.975
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_q975, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "q975.bm.gif"))
    
    ## st
    # u
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_s, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "mean.st.gif"))
    
    # st sd
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_st.sd, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "sd.st.gif"))
    
    #POS QUANTILES st
    # 0.025
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_st.q25, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "q25.st.gif"))
    
    # 0.5
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_st.q5, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "q5.st.gif"))
    
    # 0.975
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_st.q975, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "q975.st.gif"))
    
    unlink(dir_out_pm.tbm, recursive = T)
    unlink(dir_out_sd.tbm, recursive = T)
    unlink(dir_out_q25.tbm, recursive = T)
    unlink(dir_out_q5.tbm, recursive = T)
    unlink(dir_out_q975.tbm, recursive = T)
    
    unlink(dir_out_pm, recursive = T)
    unlink(dir_out_sd, recursive = T)
    unlink(dir_out_q25, recursive = T)
    unlink(dir_out_q5, recursive = T)
    unlink(dir_out_q975, recursive = T)
    unlink(dir_out_s, recursive = T)
    unlink(dir_out_st.sd, recursive = T)
    unlink(dir_out_st.q25, recursive = T)
    unlink(dir_out_st.q5, recursive = T)
    unlink(dir_out_st.q975, recursive = T)
}
```


```{r}
plot.model.tbm.plus.pp.01l <- 
  function(trans, 
           fr,
           max.frac = 1,
           poly.bar.orginal = poly.bar.orginal,
           range = range,
           fps = 1,
           set.inla.seed = set.inla.seed,
                              col=alpha('grey', 0),
                              plot.points = points(loc.data, 
                                              pch = 16, 
                                              cex = 0.8, 
                                              col=alpha('gray', 0)),
                              gif.path = "gif.pp/",
                              pal.field = turbo(50),
                              pal.pos.mean = turbo(50),
                              pal.pos.sd = turbo(50),
                              pal.pos.q25 = turbo(50),
                              pal.pos.q50 = turbo(50),
                              pal.pos.q975 = turbo(50),
                              
                              pal.pos.mean.st = turbo(50),
                              pal.pos.sd.st = turbo(50),
                              pal.pos.q25.st = turbo(50),
                              pal.pos.q50.st = turbo(50),
                              pal.pos.q975.st = turbo(50),
                              ...
    ){
#  dir_out_f <- file.path(tempdir(), "truefield_gif")
#  dir.create(dir_out_f, recursive = TRUE)
  
  # t. barrier model
  dir_out_pm.tbm <- file.path(tempdir(), "mean.tbm_gif")
  dir.create(dir_out_pm.tbm, recursive = TRUE)
  
  dir_out_sd.tbm <- file.path(tempdir(), "sd.tbm_gif")
  dir.create(dir_out_sd.tbm, recursive = TRUE)
  
  dir_out_q25.tbm <- file.path(tempdir(), "q25.tbm_gif")
  dir.create(dir_out_q25.tbm, recursive = TRUE)
  
  dir_out_q5.tbm <- file.path(tempdir(), "q5.tbm_gif")
  dir.create(dir_out_q5.tbm, recursive = TRUE)
  
  dir_out_q975.tbm <- file.path(tempdir(), "q975.tbm_gif")
  dir.create(dir_out_q975.tbm, recursive = TRUE)
  
  # barrier model
  dir_out_pm <- file.path(tempdir(), "mean.bm_gif")
  dir.create(dir_out_pm, recursive = TRUE)
  
  dir_out_sd <- file.path(tempdir(), "sd.bm_gif")
  dir.create(dir_out_sd, recursive = TRUE)
  
  dir_out_q25 <- file.path(tempdir(), "q25.bm_gif")
  dir.create(dir_out_q25, recursive = TRUE)
  
  dir_out_q5 <- file.path(tempdir(), "q5.bm_gif")
  dir.create(dir_out_q5, recursive = TRUE)
  
  dir_out_q975 <- file.path(tempdir(), "q975.bm_gif")
  dir.create(dir_out_q975, recursive = TRUE)
  
  # stationary model
  dir_out_s <- file.path(tempdir(), "mean.st_gif")
  dir.create(dir_out_s, recursive = TRUE)
  
  dir_out_st.sd <- file.path(tempdir(), "sd.st_gif")
  dir.create(dir_out_st.sd, recursive = TRUE)
  
  dir_out_st.q25 <- file.path(tempdir(), "q25.st_gif")
  dir.create(dir_out_st.q25, recursive = TRUE)
  
  dir_out_st.q5 <- file.path(tempdir(), "q5.st_gif")
  dir.create(dir_out_st.q5, recursive = TRUE)
  
  dir_out_st.q975 <- file.path(tempdir(), "q975.st_gif")
  dir.create(dir_out_st.q975, recursive = TRUE)
  
  for (r in 1:length(trans)) {
    
    f <- fr[r]
    range.fraction <- c(0.01, f)
    
    ## TBM
    # POSTERIOR MEAN
    fpp <- file.path(dir_out_pm.tbm, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.tbm$res$summary.random$i$mean, 
                     main="Spatial estimate for Transparent Barrier model",
                     sub = paste("range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     axes = F, pal = pal.pos.mean)
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()
    
    #POS SD
    fpp <- file.path(dir_out_sd.tbm, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.tbm$res$summary.random$i$sd, 
                     main="Spatial sd estimate for Transparent Barrier model",
                     sub = paste("Barrier Model, range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     axes = F, pal = pal.pos.sd)
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()
    
    #POS QUANTILES
    # 0.025
    fpp <- file.path(dir_out_q25.tbm, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.tbm$res$summary.random$i[,4], 
                     main="Spatial 0.025 quantile estimate for Transparent Barrier model",
                     sub = paste("Barrier Model, range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     axes = F, pal = pal.pos.q25)
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()

    # 0.5
    fpp <- file.path(dir_out_q5.tbm, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.tbm$res$summary.random$i[,5], 
                     main="Spatial 0.5 quantile estimate for Transparent Barrier model",
                     sub = paste("Barrier Model, range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     axes = F, pal = pal.pos.q50)
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()
    
    # 0.975
    fpp <- file.path(dir_out_q975.tbm, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.tbm$res$summary.random$i[,6], 
                     main="Spatial 0.975 quantile estimate for Transparent Barrier model",
                     sub = paste("Barrier Model, range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     axes = F, pal = pal.pos.q975)
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()
    
    ##BM
    fpp <- file.path(dir_out_pm, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.bm$res$summary.random$i$mean, 
                     main="Spatial estimate for Barrier model",
                     sub = paste("range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     axes = F, pal = pal.pos.mean)
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()
    
    #POS SD
    fpp <- file.path(dir_out_sd, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.bm$res$summary.random$i$sd, 
                     main="Spatial sd estimate for Barrier model",
                     sub = paste("Barrier Model, range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     axes = F, pal = pal.pos.sd)
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()
    
    #POS QUANTILES
    # 0.025
    fpp <- file.path(dir_out_q25, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.bm$res$summary.random$i[,4], 
                     main="Spatial 0.025 quantile estimate for Barrier model",
                     sub = paste("Barrier Model, range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     axes = F, pal = pal.pos.q25)
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()

    # 0.5
    fpp <- file.path(dir_out_q5, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.bm$res$summary.random$i[,5], 
                     main="Spatial 0.5 quantile estimate for Barrier model",
                     sub = paste("Barrier Model, range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     axes = F, pal = pal.pos.q50)
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()
    
    # 0.975
    fpp <- file.path(dir_out_q975, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.bm$res$summary.random$i[,6], 
                     main="Spatial 0.975 quantile estimate for Barrier model",
                     sub = paste("Barrier Model, range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     axes = F, pal = pal.pos.q975)
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()
    
    # SPATIAL ESTIMATE WITH STATIONARY MODEL
    fpp <- file.path(dir_out_s, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.st$res$summary.random$i$mean,
                     main="Spatial estimate with the stationary model",
                     sub = paste("Barrier Model, range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     axes = F, pal = pal.pos.mean.st) 
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()
    
    #POS SD st
    fpp <- file.path(dir_out_st.sd, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.st$res$summary.random$i$sd, 
                     main="Spatial sd estimate with the stationary model",
                     sub = paste("Barrier Model, range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     axes = F, pal = pal.pos.sd.st)
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()
    
    #POS QUANTILES st
    # 0.025 st
    fpp <- file.path(dir_out_st.q25, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.st$res$summary.random$i[,4], 
                     main="Spatial 0.025 estimate with the stationary model",
                     sub = paste("Barrier Model, range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     axes = F, pal = pal.pos.q25.st)
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()

    # 0.5 st
    fpp <- file.path(dir_out_st.q5, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.st$res$summary.random$i[,5], 
                     main="Spatial 0.5 quantile estimate with the stationary model",
                     sub = paste("Barrier Model, range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     axes = F, pal = pal.pos.q50.st)
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()
    
    # 0.975 st
    fpp <- file.path(dir_out_st.q975, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.st$res$summary.random$i[,6], 
                     main="Spatial 0.975 quantile estimate with the stationary model",
                     sub = paste("Barrier Model, range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     axes = F, pal = pal.pos.q975.st)
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()
  }
    
    ## TBM
    # POSTERIOR MEAN
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_pm.tbm, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "mean.tbm.gif"))
    
    #POS SD
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_sd.tbm, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "sd.tbm.gif"))
    
    #POS QUANTILES
    # 0.025
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_q25.tbm, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "q25.tbm.gif"))
    
    # 0.5
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_q5.tbm, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "q5.tbm.gif"))
    
    # 0.975
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_q975.tbm, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "q975.tbm.gif"))
    
    ## BM
    # POSTERIOR MEAN
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_pm, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "mean.bm.gif"))
    
    #POS SD
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_sd, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "sd.bm.gif"))
    
    #POS QUANTILES
    # 0.025
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_q25, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "q25.bm.gif"))
    
    # 0.5
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_q5, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "q5.bm.gif"))
    
    # 0.975
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_q975, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "q975.bm.gif"))
    
    ## st
    # u
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_s, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "mean.st.gif"))
    
    # st sd
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_st.sd, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "sd.st.gif"))
    
    #POS QUANTILES st
    # 0.025
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_st.q25, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "q25.st.gif"))
    
    # 0.5
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_st.q5, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "q5.st.gif"))
    
    # 0.975
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_st.q975, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "q975.st.gif"))
    
    unlink(dir_out_pm.tbm, recursive = T)
    unlink(dir_out_sd.tbm, recursive = T)
    unlink(dir_out_q25.tbm, recursive = T)
    unlink(dir_out_q5.tbm, recursive = T)
    unlink(dir_out_q975.tbm, recursive = T)
    
    unlink(dir_out_pm, recursive = T)
    unlink(dir_out_sd, recursive = T)
    unlink(dir_out_q25, recursive = T)
    unlink(dir_out_q5, recursive = T)
    unlink(dir_out_q975, recursive = T)
    unlink(dir_out_s, recursive = T)
    unlink(dir_out_st.sd, recursive = T)
    unlink(dir_out_st.q25, recursive = T)
    unlink(dir_out_st.q5, recursive = T)
    unlink(dir_out_st.q975, recursive = T)
}
```


```{r}
plot.model.tbm.plus.pp.01r <- 
  function(trans, 
           fr,
           max.frac = 1,
           poly.bar.orginal = poly.bar.orginal,
           range = range,
           fps = 1,
           set.inla.seed = set.inla.seed,
                              col=alpha('grey', 0),
                              plot.points = points(loc.data, 
                                              pch = 16, 
                                              cex = 0.8, 
                                              col=alpha('gray', 0)),
                              gif.path = "gif.pp/",
                              pal.field = turbo(50),
                              pal.pos.mean = turbo(50),
                              pal.pos.sd = turbo(50),
                              pal.pos.q25 = turbo(50),
                              pal.pos.q50 = turbo(50),
                              pal.pos.q975 = turbo(50),
                              
                              pal.pos.mean.st = turbo(50),
                              pal.pos.sd.st = turbo(50),
                              pal.pos.q25.st = turbo(50),
                              pal.pos.q50.st = turbo(50),
                              pal.pos.q975.st = turbo(50),
                              ...
    ){
#  dir_out_f <- file.path(tempdir(), "truefield_gif")
#  dir.create(dir_out_f, recursive = TRUE)
  
  # t. barrier model
  dir_out_pm.tbm <- file.path(tempdir(), "mean.tbm_gif")
  dir.create(dir_out_pm.tbm, recursive = TRUE)
  
  dir_out_sd.tbm <- file.path(tempdir(), "sd.tbm_gif")
  dir.create(dir_out_sd.tbm, recursive = TRUE)
  
  dir_out_q25.tbm <- file.path(tempdir(), "q25.tbm_gif")
  dir.create(dir_out_q25.tbm, recursive = TRUE)
  
  dir_out_q5.tbm <- file.path(tempdir(), "q5.tbm_gif")
  dir.create(dir_out_q5.tbm, recursive = TRUE)
  
  dir_out_q975.tbm <- file.path(tempdir(), "q975.tbm_gif")
  dir.create(dir_out_q975.tbm, recursive = TRUE)
  
  # barrier model
  dir_out_pm <- file.path(tempdir(), "mean.bm_gif")
  dir.create(dir_out_pm, recursive = TRUE)
  
  dir_out_sd <- file.path(tempdir(), "sd.bm_gif")
  dir.create(dir_out_sd, recursive = TRUE)
  
  dir_out_q25 <- file.path(tempdir(), "q25.bm_gif")
  dir.create(dir_out_q25, recursive = TRUE)
  
  dir_out_q5 <- file.path(tempdir(), "q5.bm_gif")
  dir.create(dir_out_q5, recursive = TRUE)
  
  dir_out_q975 <- file.path(tempdir(), "q975.bm_gif")
  dir.create(dir_out_q975, recursive = TRUE)
  
  # stationary model
  dir_out_s <- file.path(tempdir(), "mean.st_gif")
  dir.create(dir_out_s, recursive = TRUE)
  
  dir_out_st.sd <- file.path(tempdir(), "sd.st_gif")
  dir.create(dir_out_st.sd, recursive = TRUE)
  
  dir_out_st.q25 <- file.path(tempdir(), "q25.st_gif")
  dir.create(dir_out_st.q25, recursive = TRUE)
  
  dir_out_st.q5 <- file.path(tempdir(), "q5.st_gif")
  dir.create(dir_out_st.q5, recursive = TRUE)
  
  dir_out_st.q975 <- file.path(tempdir(), "q975.st_gif")
  dir.create(dir_out_st.q975, recursive = TRUE)
  
  for (r in 1:length(trans)) {
    
    f <- fr[r]
    range.fraction <- c(f, 0.01)
    
    ## TBM
    # POSTERIOR MEAN
    fpp <- file.path(dir_out_pm.tbm, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.tbm$res$summary.random$i$mean, 
                     main="Spatial estimate for Transparent Barrier model",
                     sub = paste("range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     axes = F, pal = pal.pos.mean)
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()
    
    #POS SD
    fpp <- file.path(dir_out_sd.tbm, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.tbm$res$summary.random$i$sd, 
                     main="Spatial sd estimate for Transparent Barrier model",
                     sub = paste("Barrier Model, range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     axes = F, pal = pal.pos.sd)
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()
    
    #POS QUANTILES
    # 0.025
    fpp <- file.path(dir_out_q25.tbm, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.tbm$res$summary.random$i[,4], 
                     main="Spatial 0.025 quantile estimate for Transparent Barrier model",
                     sub = paste("Barrier Model, range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     axes = F, pal = pal.pos.q25)
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()

    # 0.5
    fpp <- file.path(dir_out_q5.tbm, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.tbm$res$summary.random$i[,5], 
                     main="Spatial 0.5 quantile estimate for Transparent Barrier model",
                     sub = paste("Barrier Model, range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     axes = F, pal = pal.pos.q50)
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()
    
    # 0.975
    fpp <- file.path(dir_out_q975.tbm, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.tbm$res$summary.random$i[,6], 
                     main="Spatial 0.975 quantile estimate for Transparent Barrier model",
                     sub = paste("Barrier Model, range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     axes = F, pal = pal.pos.q975)
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()
    
    ##BM
    fpp <- file.path(dir_out_pm, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.bm$res$summary.random$i$mean, 
                     main="Spatial estimate for Barrier model",
                     sub = paste("range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     axes = F, pal = pal.pos.mean)
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()
    
    #POS SD
    fpp <- file.path(dir_out_sd, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.bm$res$summary.random$i$sd, 
                     main="Spatial sd estimate for Barrier model",
                     sub = paste("Barrier Model, range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     axes = F, pal = pal.pos.sd)
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()
    
    #POS QUANTILES
    # 0.025
    fpp <- file.path(dir_out_q25, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.bm$res$summary.random$i[,4], 
                     main="Spatial 0.025 quantile estimate for Barrier model",
                     sub = paste("Barrier Model, range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     axes = F, pal = pal.pos.q25)
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()

    # 0.5
    fpp <- file.path(dir_out_q5, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.bm$res$summary.random$i[,5], 
                     main="Spatial 0.5 quantile estimate for Barrier model",
                     sub = paste("Barrier Model, range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     axes = F, pal = pal.pos.q50)
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()
    
    # 0.975
    fpp <- file.path(dir_out_q975, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.bm$res$summary.random$i[,6], 
                     main="Spatial 0.975 quantile estimate for Barrier model",
                     sub = paste("Barrier Model, range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     axes = F, pal = pal.pos.q975)
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()
    
    # SPATIAL ESTIMATE WITH STATIONARY MODEL
    fpp <- file.path(dir_out_s, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.st$res$summary.random$i$mean,
                     main="Spatial estimate with the stationary model",
                     sub = paste("Barrier Model, range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     axes = F, pal = pal.pos.mean.st) 
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()
    
    #POS SD st
    fpp <- file.path(dir_out_st.sd, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.st$res$summary.random$i$sd, 
                     main="Spatial sd estimate with the stationary model",
                     sub = paste("Barrier Model, range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     axes = F, pal = pal.pos.sd.st)
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()
    
    #POS QUANTILES st
    # 0.025 st
    fpp <- file.path(dir_out_st.q25, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.st$res$summary.random$i[,4], 
                     main="Spatial 0.025 estimate with the stationary model",
                     sub = paste("Barrier Model, range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     axes = F, pal = pal.pos.q25.st)
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()

    # 0.5 st
    fpp <- file.path(dir_out_st.q5, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.st$res$summary.random$i[,5], 
                     main="Spatial 0.5 quantile estimate with the stationary model",
                     sub = paste("Barrier Model, range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     axes = F, pal = pal.pos.q50.st)
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()
    
    # 0.975 st
    fpp <- file.path(dir_out_st.q975, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.st$res$summary.random$i[,6], 
                     main="Spatial 0.975 quantile estimate with the stationary model",
                     sub = paste("Barrier Model, range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     axes = F, pal = pal.pos.q975.st)
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()
  }
    
    ## TBM
    # POSTERIOR MEAN
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_pm.tbm, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "mean.tbm.gif"))
    
    #POS SD
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_sd.tbm, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "sd.tbm.gif"))
    
    #POS QUANTILES
    # 0.025
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_q25.tbm, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "q25.tbm.gif"))
    
    # 0.5
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_q5.tbm, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "q5.tbm.gif"))
    
    # 0.975
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_q975.tbm, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "q975.tbm.gif"))
    
    ## BM
    # POSTERIOR MEAN
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_pm, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "mean.bm.gif"))
    
    #POS SD
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_sd, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "sd.bm.gif"))
    
    #POS QUANTILES
    # 0.025
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_q25, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "q25.bm.gif"))
    
    # 0.5
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_q5, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "q5.bm.gif"))
    
    # 0.975
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_q975, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "q975.bm.gif"))
    
    ## st
    # u
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_s, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "mean.st.gif"))
    
    # st sd
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_st.sd, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "sd.st.gif"))
    
    #POS QUANTILES st
    # 0.025
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_st.q25, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "q25.st.gif"))
    
    # 0.5
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_st.q5, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "q5.st.gif"))
    
    # 0.975
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_st.q975, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "q975.st.gif"))
    
    unlink(dir_out_pm.tbm, recursive = T)
    unlink(dir_out_sd.tbm, recursive = T)
    unlink(dir_out_q25.tbm, recursive = T)
    unlink(dir_out_q5.tbm, recursive = T)
    unlink(dir_out_q975.tbm, recursive = T)
    
    unlink(dir_out_pm, recursive = T)
    unlink(dir_out_sd, recursive = T)
    unlink(dir_out_q25, recursive = T)
    unlink(dir_out_q5, recursive = T)
    unlink(dir_out_q975, recursive = T)
    unlink(dir_out_s, recursive = T)
    unlink(dir_out_st.sd, recursive = T)
    unlink(dir_out_st.q25, recursive = T)
    unlink(dir_out_st.q5, recursive = T)
    unlink(dir_out_st.q975, recursive = T)
}
```


```{r}
tbm.frac <- list()

  for (p in 1:length(fr)) { #
    f <- fr[p]
    range.fraction <- c(f, f)
    tbm.frac[[p]] <- model.tbm.plus.pp(mesh = mesh, fem = fem, 
                                       stk.pp = stk.pp,
                               barrier.triangles = barrier.triangles,
                               prior.range = prior.range, prior.sigma = prior.sigma ,  
                               range.fraction = range.fraction,
                               range = range,
                               set.inla.seed = set.inla.seed,
                               loc.data = loc.data,
                               sigma.u = 1, sigma.epsilon = 0.2,
                               poly.original = poly.bar.orginal,
                               prior.range.st = prior.range.st,
                               prior.sigma.st = prior.sigma.st,
                               return.list = TRUE)
  }
  
  trans <- tbm.frac
  plot.model.tbm.plus.pp(trans, 
                       fr,
                       poly.bar.orginal = poly.bar.orginal,
                       range = range,
                       fps = 1)

  marginals.path <- "gif.pp/"
  for (r in 1:length(trans)) {
    f <- fr[p]
    range.fraction <- c(f, f)
    fpp <- file.path(paste0(marginals.path, f, ".png"))
    png(fpp)
    par(mfrow = c(3, 1))
    tmp = inla.tmarginal(function(x) exp(x), trans[[p]]$pos.tbm$res$marginals.hyperpar[[2]]) 
    plot(tmp, type = "l", xlab = "r", ylab = "Density")
         xvals = seq(0, 10, length.out=1000)
      
    abline(v=range, col="blue")
    
    tmp = inla.tmarginal(function(x) exp(x), trans[[p]]$pos.bm$res$marginals.hyperpar[[2]]) 
    plot(tmp, type = "l", xlab = "r", ylab = "Density")
         xvals = seq(0, 10, length.out=1000)
      
    abline(v=range, col="blue")
  
    tmp = inla.tmarginal(function(x) (x), trans[[p]]$pos.st$res$marginals.hyperpar[[1]]) 
    plot(tmp, type = "l", xlab = "r", ylab = "Density")
         xvals = seq(0, 10, length.out=1000)
    abline(v=range, col="blue")
    dev.off()
  }
```


```{r}
#geom 1, and 1.2
SM <- c(1.5)
W <- c(1, 2, 3)
R <- seq(2, 4, 1)
SS <- floor(runif(5, 1, 1000))
fr <- 0.3
      
for (d in 1:length(SM)) {
  for (v in 1:length(W)) {
    for(r in 1:length(R)) { #3->| this 3 loops
      smalldist = SM[d]
      width = c(W[v],W[v])
      range = R[r]        
      max.edge.length = 0.4
      x.mid = 10
      xlim.big  = c(0,20)
      xlim.small = c(3,17)
      ylim.big = c(0,20)
      ylim.small = c(3,17)
      fr = fr
      prior.range = prior.range
      prior.sigma = c(1,0.1)
      sigma.u = 1
      sigma.epsilon = 0.2
      prior.range.st = prior.range
      prior.sigma.st = c(1,0.1)
          
        

      poly1 <- local.square.polygon(xlim=c(xlim.big[1]-1, x.mid-smalldist/2), 
                                    ylim=x.mid+width[1]*c(-.5, .5))

      poly2 <- local.square.polygon(xlim=c(x.mid+smalldist/2, xlim.big[2]+1), 
                                    ylim=x.mid+width[2]*c(-.5, .5))

      poly.original <- SpatialPolygons(c(poly1@polygons, poly2@polygons))
  
      loc1 <- matrix(c(xlim.big[1],ylim.big[1], 
                   xlim.big[2],ylim.big[1], 
                   xlim.big[2],ylim.big[2], 
                   xlim.big[1],ylim.big[2]), 4, 2, byrow = T)
  
      seg <- inla.sp2segment(poly.original)
      mesh <- inla.mesh.2d(loc=loc1, 
                       interior = seg, 
                       max.e = max.edge.length, 
                       offset=1)

      tl <- length(mesh$graph$tv[,1])
      posTri <- matrix(0, tl, 2)

      for (t in 1:tl){
        temp = mesh$loc[mesh$graph$tv[t, ], ]
        posTri[t,] = colMeans(temp)[c(1,2)] 
      }
      
      posTri <- SpatialPoints(posTri)
      bar.original <- over(poly.original, SpatialPoints(posTri), returnList=T)
      bar.original <- unlist(bar.original)
  
      #THIS TAKES A FEW SECONDS AND IT'S ACTUALLY NOT NEEDED IN EVERY LOOP, inla.barrier.polygon
      poly.bar.orginal <- inla.barrier.polygon(mesh, barrier.triangles = bar.original)

      # BARRIER 1
      bar1 <- over(poly1, SpatialPoints(posTri), returnList=T)
      bar1 <- unlist(bar1)
      poly.bar1 <- inla.barrier.polygon(mesh, barrier.triangles = bar1)

      # BARRIER 2
      bar2 <- over(poly2, SpatialPoints(posTri), returnList=T)
      bar2 <- unlist(bar2)
      poly.bar2 <- inla.barrier.polygon(mesh, barrier.triangles = bar2)

      mat <-  inla.barrier.fem.plus(mesh, list(bar1, bar2)) 
      fem <- mat 
      barrier.triangles <- list(bar1, bar2)

      # PLOTS
      poly1_h <- local.square.polygon_T(xlim=c(xlim.small[1], x.mid-smalldist/2), 
                                        ylim=x.mid+width[1]*c(-.5, .5))

      poly2_h <- local.square.polygon_T(xlim=c(x.mid+smalldist/2, xlim.small[2]), 
                                        ylim=x.mid+width[2]*c(-.5, .5))

      loc2 <- matrix(c(3,3, 17,3, 17,17, 3,17), 4, 2, byrow = T)

      locp2 <- Polygon(loc2, hole = FALSE)
    
      poly.water <- SpatialPolygons(list(Polygons(list(locp2, poly1_h, poly2_h), '0')))
      poly.water_sf <- st_as_sf(poly.water)
  
      #I'm missing the poly.rect and other that I need for the ggplot, but I don't need it for this loop
      nv <- mesh$n
      dmesh <- book.mesh.dual(mesh)

      domain.polys <- Polygons(list(Polygon(loc1)), '0')
      domainSP <- SpatialPolygons(list(domain.polys))
      domainSPsf <- st_as_sf(domainSP)

      dmesh_sf <- st_as_sf(dmesh) 

      # with sapply
      w <- sapply(1:length(dmesh), function(i) {
        if (length(st_intersects(dmesh_sf[i, ], domainSPsf)[[1]]) == 1)
          return(st_area(st_intersection(dmesh_sf[i, ], domainSPsf)))
        else {
          return(0)
        }
      })
      
      #SAME AS THE GAUSSIAN FIELD UNTIL HERE
      win <- polyCub::as.owin.SpatialPolygons(poly.water)
      npix <- 300
      spatstat.options(npixel = npix)

      beta0 <- -2
      sigma2x <- 0.01
      nu <- 1
  
      #START LOOP FOR SEED
      for (s in 1:length(SS)) { #4->| SS loop
        set.inla.seed = SS[s]
        
        # common for geom 1, and geom 1.2
        set.seed(set.inla.seed) 
        lg.s <- rLGCP('matern', beta0, var = sigma2x,
                   scale = range / sqrt(8), 
                   nu = nu, win = win)

        xy <- cbind(lg.s$x, lg.s$y)
        loc.data <- SpatialPoints(xy)
        loc.data_sf <- st_as_sf(loc.data)

        Lam <- attr(lg.s, 'Lambda')
        rf.s <- log(Lam$v)

        n <- nrow(xy)
        y.pp <- rep(0:1, c(nv, n))
        e.pp <- c(w, rep(0, n)) 
        imat <- Diagonal(nv, rep(1, nv))
        lmat <- inla.spde.make.A(mesh, xy)
        A.pp <- rbind(imat, lmat)
  
        stk.pp <- inla.stack(
          data = list(y = y.pp, e = e.pp), 
          A = list(1, A.pp),
          effects = list(list(b0 = rep(1, nv + n)), list(i = 1:nv)),
          tag = 'pp')
   
        tbm.frac <- list()
        
        # FOR geom1
        fp <- file.path("gif.pp/geom1", paste0("sm", SM[d], "w", W[v], "r", R[r], "seed", SS[s], "/"))
                        dir.create(fp, recursive = TRUE)
        gif.path = fp
        marginals.path = fp

        for (p in 1:length(fr)) { #
          f <- fr[p]
          range.fraction <- c(f, f)
          tbm.frac[[p]] <- model.tbm.plus.pp(mesh = mesh, fem = fem, 
                               stk.pp = stk.pp,
                               barrier.triangles = barrier.triangles,
                               prior.range = prior.range, prior.sigma = prior.sigma ,  
                               range.fraction = range.fraction,
                               range = range,
                               set.inla.seed = set.inla.seed,
                               loc.data = loc.data,
                               sigma.u = 1, sigma.epsilon = 0.2,
                               poly.original = poly.bar.orginal,
                               prior.range.st = prior.range.st,
                               prior.sigma.st = prior.sigma.st,
                               return.list = TRUE)
        }
        trans <- tbm.frac
        plot.model.tbm.plus.pp(trans, 
                       fr,
                       poly.bar.orginal = poly.bar.orginal,
                       range = range,
                       fps = 1,
                       gif.path = fp)

  
        for (r in 1:length(trans)) {
          f <- fr[p]
          range.fraction <- c(f, f)
          fpp <- file.path(paste0(marginals.path, f, ".png"))
          png(fpp)
          par(mfrow = c(3, 1))
          tmp = inla.tmarginal(function(x) exp(x), trans[[p]]$pos.tbm$res$marginals.hyperpar[[2]]) 
          plot(tmp, type = "l", xlab = "r", ylab = "Density")
          xvals = seq(0, 10, length.out=1000)
          abline(v=range, col="blue")
    
          tmp = inla.tmarginal(function(x) exp(x), trans[[p]]$pos.bm$res$marginals.hyperpar[[2]]) 
          plot(tmp, type = "l", xlab = "r", ylab = "Density")
          xvals = seq(0, 10, length.out=1000)
          abline(v=range, col="blue")
  
          tmp = inla.tmarginal(function(x) (x), trans[[p]]$pos.st$res$marginals.hyperpar[[1]]) 
          plot(tmp, type = "l", xlab = "r", ylab = "Density")
          xvals = seq(0, 10, length.out=1000)
          abline(v=range, col="blue")
          dev.off()
        }
        
        # FOR geom1.2
        fp <- file.path("gif.pp/geom1.2", paste0("sm", SM[d], "w", W[v], "r", R[r], "seed", SS[s], "/"))
        dir.create(fp, recursive = TRUE)
        gif.path = fp
        marginals.path = fp

        for (p in 1:length(fr)) {
          f <- fr[p]
          range.fraction <- c(0.01, f)
          tbm.frac[[p]] <- model.tbm.plus.pp(mesh = mesh, fem = fem, 
                               stk.pp = stk.pp,
                               barrier.triangles = barrier.triangles,
                               prior.range = prior.range, prior.sigma = prior.sigma ,  
                               range.fraction = range.fraction,
                               range = range,
                               set.inla.seed = set.inla.seed,
                               loc.data = loc.data,
                               sigma.u = 1, sigma.epsilon = 0.2,
                               poly.original = poly.bar.orginal,
                               prior.range.st = prior.range.st,
                               prior.sigma.st = prior.sigma.st,
                               return.list = TRUE)
        }
        
        trans <- tbm.frac
        plot.model.tbm.plus.pp(trans, 
                       fr,
                       poly.bar.orginal = poly.bar.orginal,
                       range = range,
                       fps = 1,
                       gif.path = fp)
        
        for (r in 1:length(trans)) {
          f <- fr[p]
          range.fraction <- c(0.01, f)
          fpp <- file.path(paste0(marginals.path, f, ".png"))
          png(fpp)
          par(mfrow = c(3, 1))
          tmp = inla.tmarginal(function(x) exp(x), trans[[p]]$pos.tbm$res$marginals.hyperpar[[2]]) 
          plot(tmp, type = "l", xlab = "r", ylab = "Density")
          xvals = seq(0, 10, length.out=1000)
          abline(v=range, col="blue")
    
          tmp = inla.tmarginal(function(x) exp(x), trans[[p]]$pos.bm$res$marginals.hyperpar[[2]]) 
          plot(tmp, type = "l", xlab = "r", ylab = "Density")
          xvals = seq(0, 10, length.out=1000)
          abline(v=range, col="blue")
  
          tmp = inla.tmarginal(function(x) (x), trans[[p]]$pos.st$res$marginals.hyperpar[[1]]) 
          plot(tmp, type = "l", xlab = "r", ylab = "Density")
          xvals = seq(0, 10, length.out=1000)
          abline(v=range, col="blue")
          
          dev.off()
        }
      }
    }
  }
}
```


```{r}
#geom 2, and 2.1
SM <- c(0)
W <- c(1, 2, 3)
R <- c(2, 4)
SS <- floor(runif(5, 1, 1000))
fr <- 0.3
      
for (d in 1:length(SM)) {
  for (v in 1:length(W)) {
    for(r in 1:length(R)) { #3->| this 3 loops
      smalldist = SM[d]
      width = c(W[v],W[v])
      range = R[r]        
      max.edge.length = 0.4
      x.mid = 10
      xlim.big  = c(0,20)
      xlim.small = c(3,17)
      ylim.big = c(0,20)
      ylim.small = c(3,17)
      fr = fr
      prior.range = prior.range
      prior.sigma = c(1,0.1)
      sigma.u = 1
      sigma.epsilon = 0.2
      prior.range.st = prior.range
      prior.sigma.st = c(1,0.1)
          
        

      poly1 <- local.square.polygon(xlim=c(xlim.big[1]-1, x.mid-smalldist/2), 
                                    ylim=x.mid+width[1]*c(-.5, .5))

      poly2 <- local.square.polygon(xlim=c(x.mid+smalldist/2, xlim.big[2]+1), 
                                    ylim=x.mid+width[2]*c(-.5, .5))

      poly.original <- SpatialPolygons(c(poly1@polygons, poly2@polygons))
  
      loc1 <- matrix(c(xlim.big[1],ylim.big[1], 
                   xlim.big[2],ylim.big[1], 
                   xlim.big[2],ylim.big[2], 
                   xlim.big[1],ylim.big[2]), 4, 2, byrow = T)
  
      seg <- inla.sp2segment(poly.original)
      mesh <- inla.mesh.2d(loc=loc1, 
                       interior = seg, 
                       max.e = max.edge.length, 
                       offset=1)

      tl <- length(mesh$graph$tv[,1])
      posTri <- matrix(0, tl, 2)

      for (t in 1:tl){
        temp = mesh$loc[mesh$graph$tv[t, ], ]
        posTri[t,] = colMeans(temp)[c(1,2)] 
      }
      
      posTri <- SpatialPoints(posTri)
      bar.original <- over(poly.original, SpatialPoints(posTri), returnList=T)
      bar.original <- unlist(bar.original)
  
      #THIS TAKES A FEW SECONDS AND IT'S ACTUALLY NOT NEEDED IN EVERY LOOP, inla.barrier.polygon
      poly.bar.orginal <- inla.barrier.polygon(mesh, barrier.triangles = bar.original)

      # BARRIER 1
      bar1 <- over(poly1, SpatialPoints(posTri), returnList=T)
      bar1 <- unlist(bar1)

      # BARRIER 2
      bar2 <- over(poly2, SpatialPoints(posTri), returnList=T)
      bar2 <- unlist(bar2)

      mat <-  inla.barrier.fem.plus(mesh, list(bar1, bar2)) 
      fem <- mat 
      barrier.triangles <- list(bar1, bar2)

      # PLOTS
      poly1_h <- local.square.polygon_T(xlim=c(xlim.small[1], x.mid-smalldist/2), 
                                        ylim=x.mid+width[1]*c(-.5, .5))

      poly2_h <- local.square.polygon_T(xlim=c(x.mid+smalldist/2, xlim.small[2]), 
                                        ylim=x.mid+width[2]*c(-.5, .5))

      loc2 <- matrix(c(3,3, 17,3, 17,17, 3,17), 4, 2, byrow = T)

      locp2 <- Polygon(loc2, hole = FALSE)
    
      poly.water <- SpatialPolygons(list(Polygons(list(locp2, poly1_h, poly2_h), '0')))
      poly.water_sf <- st_as_sf(poly.water)
  
      #I'm missing the poly.rect and other that I need for the ggplot, but I don't need it for this loop
      nv <- mesh$n
      dmesh <- book.mesh.dual(mesh)

      domain.polys <- Polygons(list(Polygon(loc1)), '0')
      domainSP <- SpatialPolygons(list(domain.polys))
      domainSPsf <- st_as_sf(domainSP)

      dmesh_sf <- st_as_sf(dmesh) 

      # with sapply
      w <- sapply(1:length(dmesh), function(i) {
        if (length(st_intersects(dmesh_sf[i, ], domainSPsf)[[1]]) == 1)
          return(st_area(st_intersection(dmesh_sf[i, ], domainSPsf)))
        else {
          return(0)
        }
      })
      
      #SAME AS THE GAUSSIAN FIELD UNTIL HERE
      win <- polyCub::as.owin.SpatialPolygons(poly.water)
      npix <- 300
      spatstat.options(npixel = npix)

      beta0 <- -2
      sigma2x <- 0.01
      nu <- 1
  
      #START LOOP FOR SEED
      for (s in 1:length(SS)) { #4->| SS loop
        set.inla.seed = SS[s]
        
        # common for geom 2, and geom 2.2
        set.seed(set.inla.seed) 
        lg.s <- rLGCP('matern', beta0, var = sigma2x,
                   scale = range / sqrt(8), 
                   nu = nu, win = win)

        xy <- cbind(lg.s$x, lg.s$y)
        loc.data <- SpatialPoints(xy)
        loc.data_sf <- st_as_sf(loc.data)

        n <- nrow(xy)
        y.pp <- rep(0:1, c(nv, n))
        e.pp <- c(w, rep(0, n)) 
        imat <- Diagonal(nv, rep(1, nv))
        lmat <- inla.spde.make.A(mesh, xy)
        A.pp <- rbind(imat, lmat)
  
        stk.pp <- inla.stack(
          data = list(y = y.pp, e = e.pp), 
          A = list(1, A.pp),
          effects = list(list(b0 = rep(1, nv + n)), list(i = 1:nv)),
          tag = 'pp')
   
        tbm.frac <- list()
        
        # FOR geom2 
        fp <- file.path("gif.pp/geom2", paste0("sm", SM[d], "w", W[v], "r", R[r], "seed", SS[s], "/"))
                        dir.create(fp, recursive = TRUE)
        gif.path = fp
        marginals.path = fp

        for (p in 1:length(fr)) { #
          f <- fr[p]
          range.fraction <- c(f, f)
          tbm.frac[[p]] <- model.tbm.plus.pp(mesh = mesh, fem = fem, 
                               stk.pp = stk.pp,
                               barrier.triangles = barrier.triangles,
                               prior.range = prior.range, prior.sigma = prior.sigma ,  
                               range.fraction = range.fraction,
                               range = range,
                               set.inla.seed = set.inla.seed,
                               loc.data = loc.data,
                               sigma.u = 1, sigma.epsilon = 0.2,
                               poly.original = poly.bar.orginal,
                               prior.range.st = prior.range.st,
                               prior.sigma.st = prior.sigma.st,
                               return.list = TRUE)
        }
        trans <- tbm.frac
        plot.model.tbm.plus.pp(trans, 
                       fr,
                       poly.bar.orginal = poly.bar.orginal,
                       range = range,
                       fps = 1,
                       gif.path = fp)

  
        for (r in 1:length(trans)) {
          f <- fr[p]
          range.fraction <- c(f, f)
          fpp <- file.path(paste0(marginals.path, f, ".png"))
          png(fpp)
          par(mfrow = c(3, 1))
          tmp = inla.tmarginal(function(x) exp(x), trans[[p]]$pos.tbm$res$marginals.hyperpar[[2]]) 
          plot(tmp, type = "l", xlab = "r", ylab = "Density")
          xvals = seq(0, 10, length.out=1000)
          abline(v=range, col="blue")
    
          tmp = inla.tmarginal(function(x) exp(x), trans[[p]]$pos.bm$res$marginals.hyperpar[[2]]) 
          plot(tmp, type = "l", xlab = "r", ylab = "Density")
          xvals = seq(0, 10, length.out=1000)
          abline(v=range, col="blue")
  
          tmp = inla.tmarginal(function(x) (x), trans[[p]]$pos.st$res$marginals.hyperpar[[1]]) 
          plot(tmp, type = "l", xlab = "r", ylab = "Density")
          xvals = seq(0, 10, length.out=1000)
          abline(v=range, col="blue")
          dev.off()
        }
        
        # FOR geom2.2
        fp <- file.path("gif.pp/geom2.2", paste0("sm", SM[d], "w", W[v], "r", R[r], "seed", SS[s], "/"))
        dir.create(fp, recursive = TRUE)
        gif.path = fp
        marginals.path = fp

        for (p in 1:length(fr)) {
          f <- fr[p]
          range.fraction <- c(0.01, f)
          tbm.frac[[p]] <- model.tbm.plus.pp(mesh = mesh, fem = fem, 
                               stk.pp = stk.pp,
                               barrier.triangles = barrier.triangles,
                               prior.range = prior.range, prior.sigma = prior.sigma ,  
                               range.fraction = range.fraction,
                               range = range,
                               set.inla.seed = set.inla.seed,
                               loc.data = loc.data,
                               sigma.u = 1, sigma.epsilon = 0.2,
                               poly.original = poly.bar.orginal,
                               prior.range.st = prior.range.st,
                               prior.sigma.st = prior.sigma.st,
                               return.list = TRUE)
        }
        
        trans <- tbm.frac
        plot.model.tbm.plus.pp(trans, 
                       fr,
                       poly.bar.orginal = poly.bar.orginal,
                       range = range,
                       fps = 1,
                       gif.path = fp)
        
        for (r in 1:length(trans)) {
          f <- fr[p]
          range.fraction <- c(0.01, f)
          fpp <- file.path(paste0(marginals.path, f, ".png"))
          png(fpp)
          par(mfrow = c(3, 1))
          tmp = inla.tmarginal(function(x) exp(x), trans[[p]]$pos.tbm$res$marginals.hyperpar[[2]]) 
          plot(tmp, type = "l", xlab = "r", ylab = "Density")
          xvals = seq(0, 10, length.out=1000)
          abline(v=range, col="blue")
    
          tmp = inla.tmarginal(function(x) exp(x), trans[[p]]$pos.bm$res$marginals.hyperpar[[2]]) 
          plot(tmp, type = "l", xlab = "r", ylab = "Density")
          xvals = seq(0, 10, length.out=1000)
          abline(v=range, col="blue")
  
          tmp = inla.tmarginal(function(x) (x), trans[[p]]$pos.st$res$marginals.hyperpar[[1]]) 
          plot(tmp, type = "l", xlab = "r", ylab = "Density")
          xvals = seq(0, 10, length.out=1000)
          abline(v=range, col="blue")
          
          dev.off()
        }
      }
    }
  }
}
```


```{r}
#geom 3, 3.1, and 3.2
SM <- c(1.5)
Wl <- c(1, 1)
Wr <- c(3, 4)
R <- c(2,4)
SS <- floor(runif(4, 1, 1000))
fr <- 0.3
      
for (d in 1:length(SM)) {
  for (v in 1:length(Wl)) {
    for(r in 1:length(R)) { #3->| this 3 loops
      smalldist = SM[d]
      width = c(Wl[v],Wr[v])
      range = R[r]        
      max.edge.length = 0.4
      x.mid = 10
      xlim.big  = c(0,20)
      xlim.small = c(3,17)
      ylim.big = c(0,20)
      ylim.small = c(3,17)
      fr = fr
      prior.range = prior.range
      prior.sigma = c(1,0.1)
      sigma.u = 1
      sigma.epsilon = 0.2
      prior.range.st = prior.range
      prior.sigma.st = c(1,0.1)
          
        

      poly1 <- local.square.polygon(xlim=c(xlim.big[1]-1, x.mid-smalldist/2), 
                                    ylim=x.mid+width[1]*c(-.5, .5))

      poly2 <- local.square.polygon(xlim=c(x.mid+smalldist/2, xlim.big[2]+1), 
                                    ylim=x.mid+width[2]*c(-.5, .5))

      poly.original <- SpatialPolygons(c(poly1@polygons, poly2@polygons))
  
      loc1 <- matrix(c(xlim.big[1],ylim.big[1], 
                   xlim.big[2],ylim.big[1], 
                   xlim.big[2],ylim.big[2], 
                   xlim.big[1],ylim.big[2]), 4, 2, byrow = T)
  
      seg <- inla.sp2segment(poly.original)
      mesh <- inla.mesh.2d(loc=loc1, 
                       interior = seg, 
                       max.e = max.edge.length, 
                       offset=1)

      tl <- length(mesh$graph$tv[,1])
      posTri <- matrix(0, tl, 2)

      for (t in 1:tl){
        temp = mesh$loc[mesh$graph$tv[t, ], ]
        posTri[t,] = colMeans(temp)[c(1,2)] 
      }
      
      posTri <- SpatialPoints(posTri)
      bar.original <- over(poly.original, SpatialPoints(posTri), returnList=T)
      bar.original <- unlist(bar.original)
  
      #THIS TAKES A FEW SECONDS AND IT'S ACTUALLY NOT NEEDED IN EVERY LOOP, inla.barrier.polygon
      poly.bar.orginal <- inla.barrier.polygon(mesh, barrier.triangles = bar.original)

      # BARRIER 1
      bar1 <- over(poly1, SpatialPoints(posTri), returnList=T)
      bar1 <- unlist(bar1)

      # BARRIER 2
      bar2 <- over(poly2, SpatialPoints(posTri), returnList=T)
      bar2 <- unlist(bar2)

      mat <-  inla.barrier.fem.plus(mesh, list(bar1, bar2)) 
      fem <- mat 
      barrier.triangles <- list(bar1, bar2)

      # PLOTS
      poly1_h <- local.square.polygon_T(xlim=c(xlim.small[1], x.mid-smalldist/2), 
                                        ylim=x.mid+width[1]*c(-.5, .5))

      poly2_h <- local.square.polygon_T(xlim=c(x.mid+smalldist/2, xlim.small[2]), 
                                        ylim=x.mid+width[2]*c(-.5, .5))

      loc2 <- matrix(c(3,3, 17,3, 17,17, 3,17), 4, 2, byrow = T)

      locp2 <- Polygon(loc2, hole = FALSE)
    
      poly.water <- SpatialPolygons(list(Polygons(list(locp2, poly1_h, poly2_h), '0')))
      poly.water_sf <- st_as_sf(poly.water)
  
      #I'm missing the poly.rect and other that I need for the ggplot, but I don't need it for this loop
      nv <- mesh$n
      dmesh <- book.mesh.dual(mesh)

      domain.polys <- Polygons(list(Polygon(loc1)), '0')
      domainSP <- SpatialPolygons(list(domain.polys))
      domainSPsf <- st_as_sf(domainSP)

      dmesh_sf <- st_as_sf(dmesh) 

      # with sapply
      w <- sapply(1:length(dmesh), function(i) {
        if (length(st_intersects(dmesh_sf[i, ], domainSPsf)[[1]]) == 1)
          return(st_area(st_intersection(dmesh_sf[i, ], domainSPsf)))
        else {
          return(0)
        }
      })
      
      #SAME AS THE GAUSSIAN FIELD UNTIL HERE
      win <- polyCub::as.owin.SpatialPolygons(poly.water)
      npix <- 300
      spatstat.options(npixel = npix)

      beta0 <- -2
      sigma2x <- 0.01
      nu <- 1
  
      #START LOOP FOR SEED
      for (s in 1:length(SS)) { #4->| SS loop
        set.inla.seed = SS[s]
        
        # common for geom 3, and geom 3.2
        set.seed(set.inla.seed) 
        lg.s <- rLGCP('matern', beta0, var = sigma2x,
                   scale = range / sqrt(8), 
                   nu = nu, win = win)

        xy <- cbind(lg.s$x, lg.s$y)
        loc.data <- SpatialPoints(xy)
        loc.data_sf <- st_as_sf(loc.data)

        Lam <- attr(lg.s, 'Lambda')
        rf.s <- log(Lam$v)

        n <- nrow(xy)
        y.pp <- rep(0:1, c(nv, n))
        e.pp <- c(w, rep(0, n)) 
        imat <- Diagonal(nv, rep(1, nv))
        lmat <- inla.spde.make.A(mesh, xy)
        A.pp <- rbind(imat, lmat)
  
        stk.pp <- inla.stack(
          data = list(y = y.pp, e = e.pp), 
          A = list(1, A.pp),
          effects = list(list(b0 = rep(1, nv + n)), list(i = 1:nv)),
          tag = 'pp')
   
        tbm.frac <- list()
        
        # FOR geom3
        fp <- file.path("gif.pp/geom3", paste0("sm", SM[d], "wl", Wl[v], "wr", Wr[v], "r", R[r], "seed", SS[s], "/"))
                        dir.create(fp, recursive = TRUE)
        gif.path = fp
        marginals.path = fp

        for (p in 1:length(fr)) { #
          f <- fr[p]
          range.fraction <- c(f, f)
          tbm.frac[[p]] <- model.tbm.plus.pp(mesh = mesh, fem = fem, 
                               stk.pp = stk.pp,
                               barrier.triangles = barrier.triangles,
                               prior.range = prior.range, prior.sigma = prior.sigma ,  
                               range.fraction = range.fraction,
                               range = range,
                               set.inla.seed = set.inla.seed,
                               loc.data = loc.data,
                               sigma.u = 1, sigma.epsilon = 0.2,
                               poly.original = poly.bar.orginal,
                               prior.range.st = prior.range.st,
                               prior.sigma.st = prior.sigma.st,
                               return.list = TRUE)
        }
        trans <- tbm.frac
        plot.model.tbm.plus.pp(trans, 
                       fr,
                       poly.bar.orginal = poly.bar.orginal,
                       range = range,
                       fps = 1,
                       gif.path = fp)

  
        for (r in 1:length(trans)) {
          f <- fr[p]
          range.fraction <- c(f, f)
          fpp <- file.path(paste0(marginals.path, f, ".png"))
          png(fpp)
          par(mfrow = c(3, 1))
          tmp = inla.tmarginal(function(x) exp(x), trans[[p]]$pos.tbm$res$marginals.hyperpar[[2]]) 
          plot(tmp, type = "l", xlab = "r", ylab = "Density")
          xvals = seq(0, 10, length.out=1000)
          abline(v=range, col="blue")
    
          tmp = inla.tmarginal(function(x) exp(x), trans[[p]]$pos.bm$res$marginals.hyperpar[[2]]) 
          plot(tmp, type = "l", xlab = "r", ylab = "Density")
          xvals = seq(0, 10, length.out=1000)
          abline(v=range, col="blue")
  
          tmp = inla.tmarginal(function(x) (x), trans[[p]]$pos.st$res$marginals.hyperpar[[1]]) 
          plot(tmp, type = "l", xlab = "r", ylab = "Density")
          xvals = seq(0, 10, length.out=1000)
          abline(v=range, col="blue")
          dev.off()
        }
        
        # FOR geom3.2
        fp <- file.path("gif.pp/geom3.2", paste0("sm", SM[d], "wl", Wl[v], "wr", Wr[v], "r", R[r], "seed", SS[s], "/"))
                        dir.create(fp, recursive = TRUE)
        dir.create(fp, recursive = TRUE)
        gif.path = fp
        marginals.path = fp

        for (p in 1:length(fr)) {
          f <- fr[p]
          range.fraction <- c(0.01, f)
          tbm.frac[[p]] <- model.tbm.plus.pp(mesh = mesh, fem = fem, 
                               stk.pp = stk.pp,
                               barrier.triangles = barrier.triangles,
                               prior.range = prior.range, prior.sigma = prior.sigma ,  
                               range.fraction = range.fraction,
                               range = range,
                               set.inla.seed = set.inla.seed,
                               loc.data = loc.data,
                               sigma.u = 1, sigma.epsilon = 0.2,
                               poly.original = poly.bar.orginal,
                               prior.range.st = prior.range.st,
                               prior.sigma.st = prior.sigma.st,
                               return.list = TRUE)
        }
        
        trans <- tbm.frac
        plot.model.tbm.plus.pp(trans, 
                       fr,
                       poly.bar.orginal = poly.bar.orginal,
                       range = range,
                       fps = 1,
                       gif.path = fp)
        
        for (r in 1:length(trans)) {
          f <- fr[p]
          range.fraction <- c(0.01, f)
          fpp <- file.path(paste0(marginals.path, f, ".png"))
          png(fpp)
          par(mfrow = c(3, 1))
          tmp = inla.tmarginal(function(x) exp(x), trans[[p]]$pos.tbm$res$marginals.hyperpar[[2]]) 
          plot(tmp, type = "l", xlab = "r", ylab = "Density")
          xvals = seq(0, 10, length.out=1000)
          abline(v=range, col="blue")
    
          tmp = inla.tmarginal(function(x) exp(x), trans[[p]]$pos.bm$res$marginals.hyperpar[[2]]) 
          plot(tmp, type = "l", xlab = "r", ylab = "Density")
          xvals = seq(0, 10, length.out=1000)
          abline(v=range, col="blue")
  
          tmp = inla.tmarginal(function(x) (x), trans[[p]]$pos.st$res$marginals.hyperpar[[1]]) 
          plot(tmp, type = "l", xlab = "r", ylab = "Density")
          xvals = seq(0, 10, length.out=1000)
          abline(v=range, col="blue")
          
          dev.off()
        }
        
        # FOR geom3.3
        fp <- file.path("gif.pp/geom3.3", paste0("sm", SM[d], "wl", Wl[v], "wr", Wr[v], "r", R[r], "seed", SS[s], "/"))
                        dir.create(fp, recursive = TRUE)
        dir.create(fp, recursive = TRUE)
        gif.path = fp
        marginals.path = fp

        for (p in 1:length(fr)) {
          f <- fr[p]
          range.fraction <- c(f, 0.01)
          tbm.frac[[p]] <- model.tbm.plus.pp(mesh = mesh, fem = fem, 
                               stk.pp = stk.pp,
                               barrier.triangles = barrier.triangles,
                               prior.range = prior.range, prior.sigma = prior.sigma ,  
                               range.fraction = range.fraction,
                               range = range,
                               set.inla.seed = set.inla.seed,
                               loc.data = loc.data,
                               sigma.u = 1, sigma.epsilon = 0.2,
                               poly.original = poly.bar.orginal,
                               prior.range.st = prior.range.st,
                               prior.sigma.st = prior.sigma.st,
                               return.list = TRUE)
        }
        
        trans <- tbm.frac
        plot.model.tbm.plus.pp(trans, 
                       fr,
                       poly.bar.orginal = poly.bar.orginal,
                       range = range,
                       fps = 1,
                       gif.path = fp)
        
        for (r in 1:length(trans)) {
          f <- fr[p]
          range.fraction <- c(f, 0.01)
          fpp <- file.path(paste0(marginals.path, f, ".png"))
          png(fpp)
          par(mfrow = c(3, 1))
          tmp = inla.tmarginal(function(x) exp(x), trans[[p]]$pos.tbm$res$marginals.hyperpar[[2]]) 
          plot(tmp, type = "l", xlab = "r", ylab = "Density")
          xvals = seq(0, 10, length.out=1000)
          abline(v=range, col="blue")
    
          tmp = inla.tmarginal(function(x) exp(x), trans[[p]]$pos.bm$res$marginals.hyperpar[[2]]) 
          plot(tmp, type = "l", xlab = "r", ylab = "Density")
          xvals = seq(0, 10, length.out=1000)
          abline(v=range, col="blue")
  
          tmp = inla.tmarginal(function(x) (x), trans[[p]]$pos.st$res$marginals.hyperpar[[1]]) 
          plot(tmp, type = "l", xlab = "r", ylab = "Density")
          xvals = seq(0, 10, length.out=1000)
          abline(v=range, col="blue")
          
          dev.off()
        }
      }
    }
  }
}
```



seed outside
```{r}
#geom 1, and 1.2
SM <- c(1.5)
W <- c(1, 2, 3)
R <- c(2,4)
SS <- floor(runif(5, 1, 1000))
fr <- 0.3

for (s in 1:length(SS)) { #4->| SS loop     
for (d in 1:length(SM)) {
  for (v in 1:length(W)) {
    for(r in 1:length(R)) { #3->| this 3 loops
      smalldist = SM[d]
      width = c(W[v],W[v])
      range = R[r]        
      max.edge.length = 0.4
      x.mid = 10
      xlim.big  = c(0,20)
      xlim.small = c(3,17)
      ylim.big = c(0,20)
      ylim.small = c(3,17)
      fr = fr
      prior.range = prior.range
      prior.sigma = c(1,0.1)
      sigma.u = 1
      sigma.epsilon = 0.2
      prior.range.st = prior.range
      prior.sigma.st = c(1,0.1)
          
        

      poly1 <- local.square.polygon(xlim=c(xlim.big[1]-1, x.mid-smalldist/2), 
                                    ylim=x.mid+width[1]*c(-.5, .5))

      poly2 <- local.square.polygon(xlim=c(x.mid+smalldist/2, xlim.big[2]+1), 
                                    ylim=x.mid+width[2]*c(-.5, .5))

      poly.original <- SpatialPolygons(c(poly1@polygons, poly2@polygons))
  
      loc1 <- matrix(c(xlim.big[1],ylim.big[1], 
                   xlim.big[2],ylim.big[1], 
                   xlim.big[2],ylim.big[2], 
                   xlim.big[1],ylim.big[2]), 4, 2, byrow = T)
  
      seg <- inla.sp2segment(poly.original)
      mesh <- inla.mesh.2d(loc=loc1, 
                       interior = seg, 
                       max.e = max.edge.length, 
                       offset=1)

      tl <- length(mesh$graph$tv[,1])
      posTri <- matrix(0, tl, 2)

      for (t in 1:tl){
        temp = mesh$loc[mesh$graph$tv[t, ], ]
        posTri[t,] = colMeans(temp)[c(1,2)] 
      }
      
      posTri <- SpatialPoints(posTri)
      bar.original <- over(poly.original, SpatialPoints(posTri), returnList=T)
      bar.original <- unlist(bar.original)
  
      #THIS TAKES A FEW SECONDS AND IT'S ACTUALLY NOT NEEDED IN EVERY LOOP, inla.barrier.polygon
      poly.bar.orginal <- inla.barrier.polygon(mesh, barrier.triangles = bar.original)

      # BARRIER 1
      bar1 <- over(poly1, SpatialPoints(posTri), returnList=T)
      bar1 <- unlist(bar1)
      poly.bar1 <- inla.barrier.polygon(mesh, barrier.triangles = bar1)

      # BARRIER 2
      bar2 <- over(poly2, SpatialPoints(posTri), returnList=T)
      bar2 <- unlist(bar2)
      poly.bar2 <- inla.barrier.polygon(mesh, barrier.triangles = bar2)

      mat <-  inla.barrier.fem.plus(mesh, list(bar1, bar2)) 
      fem <- mat 
      barrier.triangles <- list(bar1, bar2)

      # PLOTS
      poly1_h <- local.square.polygon_T(xlim=c(xlim.small[1], x.mid-smalldist/2), 
                                        ylim=x.mid+width[1]*c(-.5, .5))

      poly2_h <- local.square.polygon_T(xlim=c(x.mid+smalldist/2, xlim.small[2]), 
                                        ylim=x.mid+width[2]*c(-.5, .5))

      loc2 <- matrix(c(3,3, 17,3, 17,17, 3,17), 4, 2, byrow = T)

      locp2 <- Polygon(loc2, hole = FALSE)
    
      poly.water <- SpatialPolygons(list(Polygons(list(locp2, poly1_h, poly2_h), '0')))
      poly.water_sf <- st_as_sf(poly.water)
  
      #I'm missing the poly.rect and other that I need for the ggplot, but I don't need it for this loop
      nv <- mesh$n
      dmesh <- book.mesh.dual(mesh)

      domain.polys <- Polygons(list(Polygon(loc1)), '0')
      domainSP <- SpatialPolygons(list(domain.polys))
      domainSPsf <- st_as_sf(domainSP)

      dmesh_sf <- st_as_sf(dmesh) 

      # with sapply
      w <- sapply(1:length(dmesh), function(i) {
        if (length(st_intersects(dmesh_sf[i, ], domainSPsf)[[1]]) == 1)
          return(st_area(st_intersection(dmesh_sf[i, ], domainSPsf)))
        else {
          return(0)
        }
      })
      
      #SAME AS THE GAUSSIAN FIELD UNTIL HERE
      win <- polyCub::as.owin.SpatialPolygons(poly.water)
      npix <- 300
      spatstat.options(npixel = npix)

      beta0 <- -2
      sigma2x <- 0.01
      nu <- 1
  
      #START LOOP FOR SEED
      
        set.inla.seed = SS[s]
        
        # common for geom 1, and geom 1.2
        set.seed(set.inla.seed) 
        lg.s <- rLGCP('matern', beta0, var = sigma2x,
                   scale = range / sqrt(8), 
                   nu = nu, win = win)

        xy <- cbind(lg.s$x, lg.s$y)
        loc.data <- SpatialPoints(xy)
        loc.data_sf <- st_as_sf(loc.data)

        Lam <- attr(lg.s, 'Lambda')
        rf.s <- log(Lam$v)

        n <- nrow(xy)
        y.pp <- rep(0:1, c(nv, n))
        e.pp <- c(w, rep(0, n)) 
        imat <- Diagonal(nv, rep(1, nv))
        lmat <- inla.spde.make.A(mesh, xy)
        A.pp <- rbind(imat, lmat)
  
        stk.pp <- inla.stack(
          data = list(y = y.pp, e = e.pp), 
          A = list(1, A.pp),
          effects = list(list(b0 = rep(1, nv + n)), list(i = 1:nv)),
          tag = 'pp')
   
        tbm.frac <- list()
        
        # FOR geom1
        fp <- file.path("gif.pp/geom1", paste0("sm", SM[d], "w", W[v], "r", R[r], "seed", SS[s], "/"))
                        dir.create(fp, recursive = TRUE)
        gif.path = fp
        marginals.path = fp

        for (p in 1:length(fr)) { #
          f <- fr[p]
          range.fraction <- c(f, f)
          tbm.frac[[p]] <- model.tbm.plus.pp(mesh = mesh, fem = fem, 
                               stk.pp = stk.pp,
                               barrier.triangles = barrier.triangles,
                               prior.range = prior.range, prior.sigma = prior.sigma ,  
                               range.fraction = range.fraction,
                               range = range,
                               set.inla.seed = set.inla.seed,
                               loc.data = loc.data,
                               sigma.u = 1, sigma.epsilon = 0.2,
                               poly.original = poly.bar.orginal,
                               prior.range.st = prior.range.st,
                               prior.sigma.st = prior.sigma.st,
                               return.list = TRUE)
        }
        trans <- tbm.frac
        plot.model.tbm.plus.pp(trans, 
                       fr,
                       poly.bar.orginal = poly.bar.orginal,
                       range = range,
                       fps = 1,
                       gif.path = fp)

  
        for (r in 1:length(trans)) {
          f <- fr[p]
          range.fraction <- c(f, f)
          fpp <- file.path(paste0(marginals.path, f, ".png"))
          png(fpp)
          par(mfrow = c(3, 1))
          tmp = inla.tmarginal(function(x) exp(x), trans[[p]]$pos.tbm$res$marginals.hyperpar[[2]]) 
          plot(tmp, type = "l", xlab = "r", ylab = "Density")
          xvals = seq(0, 10, length.out=1000)
          abline(v=range, col="blue")
    
          tmp = inla.tmarginal(function(x) exp(x), trans[[p]]$pos.bm$res$marginals.hyperpar[[2]]) 
          plot(tmp, type = "l", xlab = "r", ylab = "Density")
          xvals = seq(0, 10, length.out=1000)
          abline(v=range, col="blue")
  
          tmp = inla.tmarginal(function(x) (x), trans[[p]]$pos.st$res$marginals.hyperpar[[1]]) 
          plot(tmp, type = "l", xlab = "r", ylab = "Density")
          xvals = seq(0, 10, length.out=1000)
          abline(v=range, col="blue")
          dev.off()
        }
        
        # FOR geom1.2
        fp <- file.path("gif.pp/geom1.2", paste0("sm", SM[d], "w", W[v], "r", R[r], "seed", SS[s], "/"))
        dir.create(fp, recursive = TRUE)
        gif.path = fp
        marginals.path = fp

        for (p in 1:length(fr)) {
          f <- fr[p]
          range.fraction <- c(0.01, f)
          tbm.frac[[p]] <- model.tbm.plus.pp(mesh = mesh, fem = fem, 
                               stk.pp = stk.pp,
                               barrier.triangles = barrier.triangles,
                               prior.range = prior.range, prior.sigma = prior.sigma ,  
                               range.fraction = range.fraction,
                               range = range,
                               set.inla.seed = set.inla.seed,
                               loc.data = loc.data,
                               sigma.u = 1, sigma.epsilon = 0.2,
                               poly.original = poly.bar.orginal,
                               prior.range.st = prior.range.st,
                               prior.sigma.st = prior.sigma.st,
                               return.list = TRUE)
        }
        
        trans <- tbm.frac
        plot.model.tbm.plus.pp(trans, 
                       fr,
                       poly.bar.orginal = poly.bar.orginal,
                       range = range,
                       fps = 1,
                       gif.path = fp)
        
        for (r in 1:length(trans)) {
          f <- fr[p]
          range.fraction <- c(0.01, f)
          fpp <- file.path(paste0(marginals.path, f, ".png"))
          png(fpp)
          par(mfrow = c(3, 1))
          tmp = inla.tmarginal(function(x) exp(x), trans[[p]]$pos.tbm$res$marginals.hyperpar[[2]]) 
          plot(tmp, type = "l", xlab = "r", ylab = "Density")
          xvals = seq(0, 10, length.out=1000)
          abline(v=range, col="blue")
    
          tmp = inla.tmarginal(function(x) exp(x), trans[[p]]$pos.bm$res$marginals.hyperpar[[2]]) 
          plot(tmp, type = "l", xlab = "r", ylab = "Density")
          xvals = seq(0, 10, length.out=1000)
          abline(v=range, col="blue")
  
          tmp = inla.tmarginal(function(x) (x), trans[[p]]$pos.st$res$marginals.hyperpar[[1]]) 
          plot(tmp, type = "l", xlab = "r", ylab = "Density")
          xvals = seq(0, 10, length.out=1000)
          abline(v=range, col="blue")
          
          dev.off()
        }
      }
    }
  }
}

#geom 2, and 2.1
SM <- c(0)
W <- c(1, 2, 3)
R <- c(2, 4)
SS <- floor(runif(5, 1, 1000))
fr <- 0.3

for (s in 1:length(SS)) { #4->| SS loop
for (d in 1:length(SM)) {
  for (v in 1:length(W)) {
    for(r in 1:length(R)) { #3->| this 3 loops
      smalldist = SM[d]
      width = c(W[v],W[v])
      range = R[r]        
      max.edge.length = 0.4
      x.mid = 10
      xlim.big  = c(0,20)
      xlim.small = c(3,17)
      ylim.big = c(0,20)
      ylim.small = c(3,17)
      fr = fr
      prior.range = prior.range
      prior.sigma = c(1,0.1)
      sigma.u = 1
      sigma.epsilon = 0.2
      prior.range.st = prior.range
      prior.sigma.st = c(1,0.1)
          
        

      poly1 <- local.square.polygon(xlim=c(xlim.big[1]-1, x.mid-smalldist/2), 
                                    ylim=x.mid+width[1]*c(-.5, .5))

      poly2 <- local.square.polygon(xlim=c(x.mid+smalldist/2, xlim.big[2]+1), 
                                    ylim=x.mid+width[2]*c(-.5, .5))

      poly.original <- SpatialPolygons(c(poly1@polygons, poly2@polygons))
  
      loc1 <- matrix(c(xlim.big[1],ylim.big[1], 
                   xlim.big[2],ylim.big[1], 
                   xlim.big[2],ylim.big[2], 
                   xlim.big[1],ylim.big[2]), 4, 2, byrow = T)
  
      seg <- inla.sp2segment(poly.original)
      mesh <- inla.mesh.2d(loc=loc1, 
                       interior = seg, 
                       max.e = max.edge.length, 
                       offset=1)

      tl <- length(mesh$graph$tv[,1])
      posTri <- matrix(0, tl, 2)

      for (t in 1:tl){
        temp = mesh$loc[mesh$graph$tv[t, ], ]
        posTri[t,] = colMeans(temp)[c(1,2)] 
      }
      
      posTri <- SpatialPoints(posTri)
      bar.original <- over(poly.original, SpatialPoints(posTri), returnList=T)
      bar.original <- unlist(bar.original)
  
      #THIS TAKES A FEW SECONDS AND IT'S ACTUALLY NOT NEEDED IN EVERY LOOP, inla.barrier.polygon
      poly.bar.orginal <- inla.barrier.polygon(mesh, barrier.triangles = bar.original)

      # BARRIER 1
      bar1 <- over(poly1, SpatialPoints(posTri), returnList=T)
      bar1 <- unlist(bar1)
      poly.bar1 <- inla.barrier.polygon(mesh, barrier.triangles = bar1)

      # BARRIER 2
      bar2 <- over(poly2, SpatialPoints(posTri), returnList=T)
      bar2 <- unlist(bar2)
      poly.bar2 <- inla.barrier.polygon(mesh, barrier.triangles = bar2)

      mat <-  inla.barrier.fem.plus(mesh, list(bar1, bar2)) 
      fem <- mat 
      barrier.triangles <- list(bar1, bar2)

      # PLOTS
      poly1_h <- local.square.polygon_T(xlim=c(xlim.small[1], x.mid-smalldist/2), 
                                        ylim=x.mid+width[1]*c(-.5, .5))

      poly2_h <- local.square.polygon_T(xlim=c(x.mid+smalldist/2, xlim.small[2]), 
                                        ylim=x.mid+width[2]*c(-.5, .5))

      loc2 <- matrix(c(3,3, 17,3, 17,17, 3,17), 4, 2, byrow = T)

      locp2 <- Polygon(loc2, hole = FALSE)
    
      poly.water <- SpatialPolygons(list(Polygons(list(locp2, poly1_h, poly2_h), '0')))
      poly.water_sf <- st_as_sf(poly.water)
  
      #I'm missing the poly.rect and other that I need for the ggplot, but I don't need it for this loop
      nv <- mesh$n
      dmesh <- book.mesh.dual(mesh)

      domain.polys <- Polygons(list(Polygon(loc1)), '0')
      domainSP <- SpatialPolygons(list(domain.polys))
      domainSPsf <- st_as_sf(domainSP)

      dmesh_sf <- st_as_sf(dmesh) 

      # with sapply
      w <- sapply(1:length(dmesh), function(i) {
        if (length(st_intersects(dmesh_sf[i, ], domainSPsf)[[1]]) == 1)
          return(st_area(st_intersection(dmesh_sf[i, ], domainSPsf)))
        else {
          return(0)
        }
      })
      
      #SAME AS THE GAUSSIAN FIELD UNTIL HERE
      win <- polyCub::as.owin.SpatialPolygons(poly.water)
      npix <- 300
      spatstat.options(npixel = npix)

      beta0 <- -2
      sigma2x <- 0.01
      nu <- 1
  
      #START LOOP FOR SEED
      
        set.inla.seed = SS[s]
        
        # common for geom 2, and geom 2.2
        set.seed(set.inla.seed) 
        lg.s <- rLGCP('matern', beta0, var = sigma2x,
                   scale = range / sqrt(8), 
                   nu = nu, win = win)

        xy <- cbind(lg.s$x, lg.s$y)
        loc.data <- SpatialPoints(xy)
        loc.data_sf <- st_as_sf(loc.data)

        Lam <- attr(lg.s, 'Lambda')
        rf.s <- log(Lam$v)

        n <- nrow(xy)
        y.pp <- rep(0:1, c(nv, n))
        e.pp <- c(w, rep(0, n)) 
        imat <- Diagonal(nv, rep(1, nv))
        lmat <- inla.spde.make.A(mesh, xy)
        A.pp <- rbind(imat, lmat)
  
        stk.pp <- inla.stack(
          data = list(y = y.pp, e = e.pp), 
          A = list(1, A.pp),
          effects = list(list(b0 = rep(1, nv + n)), list(i = 1:nv)),
          tag = 'pp')
   
        tbm.frac <- list()
        
        # FOR geom2 
        fp <- file.path("gif.pp/geom2", paste0("sm", SM[d], "w", W[v], "r", R[r], "seed", SS[s], "/"))
                        dir.create(fp, recursive = TRUE)
        gif.path = fp
        marginals.path = fp

        for (p in 1:length(fr)) { #
          f <- fr[p]
          range.fraction <- c(f, f)
          tbm.frac[[p]] <- model.tbm.plus.pp(mesh = mesh, fem = fem, 
                               stk.pp = stk.pp,
                               barrier.triangles = barrier.triangles,
                               prior.range = prior.range, prior.sigma = prior.sigma ,  
                               range.fraction = range.fraction,
                               range = range,
                               set.inla.seed = set.inla.seed,
                               loc.data = loc.data,
                               sigma.u = 1, sigma.epsilon = 0.2,
                               poly.original = poly.bar.orginal,
                               prior.range.st = prior.range.st,
                               prior.sigma.st = prior.sigma.st,
                               return.list = TRUE)
        }
        trans <- tbm.frac
        plot.model.tbm.plus.pp(trans, 
                       fr,
                       poly.bar.orginal = poly.bar.orginal,
                       range = range,
                       fps = 1,
                       gif.path = fp)

  
        for (r in 1:length(trans)) {
          f <- fr[p]
          range.fraction <- c(f, f)
          fpp <- file.path(paste0(marginals.path, f, ".png"))
          png(fpp)
          par(mfrow = c(3, 1))
          tmp = inla.tmarginal(function(x) exp(x), trans[[p]]$pos.tbm$res$marginals.hyperpar[[2]]) 
          plot(tmp, type = "l", xlab = "r", ylab = "Density")
          xvals = seq(0, 10, length.out=1000)
          abline(v=range, col="blue")
    
          tmp = inla.tmarginal(function(x) exp(x), trans[[p]]$pos.bm$res$marginals.hyperpar[[2]]) 
          plot(tmp, type = "l", xlab = "r", ylab = "Density")
          xvals = seq(0, 10, length.out=1000)
          abline(v=range, col="blue")
  
          tmp = inla.tmarginal(function(x) (x), trans[[p]]$pos.st$res$marginals.hyperpar[[1]]) 
          plot(tmp, type = "l", xlab = "r", ylab = "Density")
          xvals = seq(0, 10, length.out=1000)
          abline(v=range, col="blue")
          dev.off()
        }
        
        # FOR geom2.2
        fp <- file.path("gif.pp/geom2.2", paste0("sm", SM[d], "w", W[v], "r", R[r], "seed", SS[s], "/"))
        dir.create(fp, recursive = TRUE)
        gif.path = fp
        marginals.path = fp

        for (p in 1:length(fr)) {
          f <- fr[p]
          range.fraction <- c(0.01, f)
          tbm.frac[[p]] <- model.tbm.plus.pp(mesh = mesh, fem = fem, 
                               stk.pp = stk.pp,
                               barrier.triangles = barrier.triangles,
                               prior.range = prior.range, prior.sigma = prior.sigma ,  
                               range.fraction = range.fraction,
                               range = range,
                               set.inla.seed = set.inla.seed,
                               loc.data = loc.data,
                               sigma.u = 1, sigma.epsilon = 0.2,
                               poly.original = poly.bar.orginal,
                               prior.range.st = prior.range.st,
                               prior.sigma.st = prior.sigma.st,
                               return.list = TRUE)
        }
        
        trans <- tbm.frac
        plot.model.tbm.plus.pp(trans, 
                       fr,
                       poly.bar.orginal = poly.bar.orginal,
                       range = range,
                       fps = 1,
                       gif.path = fp)
        
        for (r in 1:length(trans)) {
          f <- fr[p]
          range.fraction <- c(0.01, f)
          fpp <- file.path(paste0(marginals.path, f, ".png"))
          png(fpp)
          par(mfrow = c(3, 1))
          tmp = inla.tmarginal(function(x) exp(x), trans[[p]]$pos.tbm$res$marginals.hyperpar[[2]]) 
          plot(tmp, type = "l", xlab = "r", ylab = "Density")
          xvals = seq(0, 10, length.out=1000)
          abline(v=range, col="blue")
    
          tmp = inla.tmarginal(function(x) exp(x), trans[[p]]$pos.bm$res$marginals.hyperpar[[2]]) 
          plot(tmp, type = "l", xlab = "r", ylab = "Density")
          xvals = seq(0, 10, length.out=1000)
          abline(v=range, col="blue")
  
          tmp = inla.tmarginal(function(x) (x), trans[[p]]$pos.st$res$marginals.hyperpar[[1]]) 
          plot(tmp, type = "l", xlab = "r", ylab = "Density")
          xvals = seq(0, 10, length.out=1000)
          abline(v=range, col="blue")
          
          dev.off()
        }
      }
    }
  }
}

#geom 3, 3.1, and 3.2
SM <- c(1.5)
Wl <- c(1, 1)
Wr <- c(3, 4)
R <- c(2,4)
SS <- floor(runif(4, 1, 1000))
fr <- 0.3

for (s in 1:length(SS)) { #4->| SS loop    
for (d in 1:length(SM)) {
  for (v in 1:length(Wl)) {
    for(r in 1:length(R)) { #3->| this 3 loops
      smalldist = SM[d]
      width = c(Wl[v],Wr[v])
      range = R[r]        
      max.edge.length = 0.4
      x.mid = 10
      xlim.big  = c(0,20)
      xlim.small = c(3,17)
      ylim.big = c(0,20)
      ylim.small = c(3,17)
      fr = fr
      prior.range = prior.range
      prior.sigma = c(1,0.1)
      sigma.u = 1
      sigma.epsilon = 0.2
      prior.range.st = prior.range
      prior.sigma.st = c(1,0.1)
          
        

      poly1 <- local.square.polygon(xlim=c(xlim.big[1]-1, x.mid-smalldist/2), 
                                    ylim=x.mid+width[1]*c(-.5, .5))

      poly2 <- local.square.polygon(xlim=c(x.mid+smalldist/2, xlim.big[2]+1), 
                                    ylim=x.mid+width[2]*c(-.5, .5))

      poly.original <- SpatialPolygons(c(poly1@polygons, poly2@polygons))
  
      loc1 <- matrix(c(xlim.big[1],ylim.big[1], 
                   xlim.big[2],ylim.big[1], 
                   xlim.big[2],ylim.big[2], 
                   xlim.big[1],ylim.big[2]), 4, 2, byrow = T)
  
      seg <- inla.sp2segment(poly.original)
      mesh <- inla.mesh.2d(loc=loc1, 
                       interior = seg, 
                       max.e = max.edge.length, 
                       offset=1)

      tl <- length(mesh$graph$tv[,1])
      posTri <- matrix(0, tl, 2)

      for (t in 1:tl){
        temp = mesh$loc[mesh$graph$tv[t, ], ]
        posTri[t,] = colMeans(temp)[c(1,2)] 
      }
      
      posTri <- SpatialPoints(posTri)
      bar.original <- over(poly.original, SpatialPoints(posTri), returnList=T)
      bar.original <- unlist(bar.original)
  
      #THIS TAKES A FEW SECONDS AND IT'S ACTUALLY NOT NEEDED IN EVERY LOOP, inla.barrier.polygon
      poly.bar.orginal <- inla.barrier.polygon(mesh, barrier.triangles = bar.original)

      # BARRIER 1
      bar1 <- over(poly1, SpatialPoints(posTri), returnList=T)
      bar1 <- unlist(bar1)
      poly.bar1 <- inla.barrier.polygon(mesh, barrier.triangles = bar1)

      # BARRIER 2
      bar2 <- over(poly2, SpatialPoints(posTri), returnList=T)
      bar2 <- unlist(bar2)
      poly.bar2 <- inla.barrier.polygon(mesh, barrier.triangles = bar2)

      mat <-  inla.barrier.fem.plus(mesh, list(bar1, bar2)) 
      fem <- mat 
      barrier.triangles <- list(bar1, bar2)

      # PLOTS
      poly1_h <- local.square.polygon_T(xlim=c(xlim.small[1], x.mid-smalldist/2), 
                                        ylim=x.mid+width[1]*c(-.5, .5))

      poly2_h <- local.square.polygon_T(xlim=c(x.mid+smalldist/2, xlim.small[2]), 
                                        ylim=x.mid+width[2]*c(-.5, .5))

      loc2 <- matrix(c(3,3, 17,3, 17,17, 3,17), 4, 2, byrow = T)

      locp2 <- Polygon(loc2, hole = FALSE)
    
      poly.water <- SpatialPolygons(list(Polygons(list(locp2, poly1_h, poly2_h), '0')))
      poly.water_sf <- st_as_sf(poly.water)
  
      #I'm missing the poly.rect and other that I need for the ggplot, but I don't need it for this loop
      nv <- mesh$n
      dmesh <- book.mesh.dual(mesh)

      domain.polys <- Polygons(list(Polygon(loc1)), '0')
      domainSP <- SpatialPolygons(list(domain.polys))
      domainSPsf <- st_as_sf(domainSP)

      dmesh_sf <- st_as_sf(dmesh) 

      # with sapply
      w <- sapply(1:length(dmesh), function(i) {
        if (length(st_intersects(dmesh_sf[i, ], domainSPsf)[[1]]) == 1)
          return(st_area(st_intersection(dmesh_sf[i, ], domainSPsf)))
        else {
          return(0)
        }
      })
      
      #SAME AS THE GAUSSIAN FIELD UNTIL HERE
      win <- polyCub::as.owin.SpatialPolygons(poly.water)
      npix <- 300
      spatstat.options(npixel = npix)

      beta0 <- -2
      sigma2x <- 0.01
      nu <- 1
  
      #START LOOP FOR SEED
      
        set.inla.seed = SS[s]
        
        # common for geom 3, and geom 3.2
        set.seed(set.inla.seed) 
        lg.s <- rLGCP('matern', beta0, var = sigma2x,
                   scale = range / sqrt(8), 
                   nu = nu, win = win)

        xy <- cbind(lg.s$x, lg.s$y)
        loc.data <- SpatialPoints(xy)
        loc.data_sf <- st_as_sf(loc.data)

        Lam <- attr(lg.s, 'Lambda')
        rf.s <- log(Lam$v)

        n <- nrow(xy)
        y.pp <- rep(0:1, c(nv, n))
        e.pp <- c(w, rep(0, n)) 
        imat <- Diagonal(nv, rep(1, nv))
        lmat <- inla.spde.make.A(mesh, xy)
        A.pp <- rbind(imat, lmat)
  
        stk.pp <- inla.stack(
          data = list(y = y.pp, e = e.pp), 
          A = list(1, A.pp),
          effects = list(list(b0 = rep(1, nv + n)), list(i = 1:nv)),
          tag = 'pp')
   
        tbm.frac <- list()
        
        # FOR geom3
        fp <- file.path("gif.pp/geom3", paste0("sm", SM[d], "wl", Wl[v], "wr", Wr[v], "r", R[r], "seed", SS[s], "/"))
                        dir.create(fp, recursive = TRUE)
        gif.path = fp
        marginals.path = fp

        for (p in 1:length(fr)) { #
          f <- fr[p]
          range.fraction <- c(f, f)
          tbm.frac[[p]] <- model.tbm.plus.pp(mesh = mesh, fem = fem, 
                               stk.pp = stk.pp,
                               barrier.triangles = barrier.triangles,
                               prior.range = prior.range, prior.sigma = prior.sigma ,  
                               range.fraction = range.fraction,
                               range = range,
                               set.inla.seed = set.inla.seed,
                               loc.data = loc.data,
                               sigma.u = 1, sigma.epsilon = 0.2,
                               poly.original = poly.bar.orginal,
                               prior.range.st = prior.range.st,
                               prior.sigma.st = prior.sigma.st,
                               return.list = TRUE)
        }
        trans <- tbm.frac
        plot.model.tbm.plus.pp(trans, 
                       fr,
                       poly.bar.orginal = poly.bar.orginal,
                       range = range,
                       fps = 1,
                       gif.path = fp)

  
        for (r in 1:length(trans)) {
          f <- fr[p]
          range.fraction <- c(f, f)
          fpp <- file.path(paste0(marginals.path, f, ".png"))
          png(fpp)
          par(mfrow = c(3, 1))
          tmp = inla.tmarginal(function(x) exp(x), trans[[p]]$pos.tbm$res$marginals.hyperpar[[2]]) 
          plot(tmp, type = "l", xlab = "r", ylab = "Density")
          xvals = seq(0, 10, length.out=1000)
          abline(v=range, col="blue")
    
          tmp = inla.tmarginal(function(x) exp(x), trans[[p]]$pos.bm$res$marginals.hyperpar[[2]]) 
          plot(tmp, type = "l", xlab = "r", ylab = "Density")
          xvals = seq(0, 10, length.out=1000)
          abline(v=range, col="blue")
  
          tmp = inla.tmarginal(function(x) (x), trans[[p]]$pos.st$res$marginals.hyperpar[[1]]) 
          plot(tmp, type = "l", xlab = "r", ylab = "Density")
          xvals = seq(0, 10, length.out=1000)
          abline(v=range, col="blue")
          dev.off()
        }
        
        # FOR geom3.2
        fp <- file.path("gif.pp/geom3.2", paste0("sm", SM[d], "wl", Wl[v], "wr", Wr[v], "r", R[r], "seed", SS[s], "/"))
                        dir.create(fp, recursive = TRUE)
        dir.create(fp, recursive = TRUE)
        gif.path = fp
        marginals.path = fp

        for (p in 1:length(fr)) {
          f <- fr[p]
          range.fraction <- c(0.01, f)
          tbm.frac[[p]] <- model.tbm.plus.pp(mesh = mesh, fem = fem, 
                               stk.pp = stk.pp,
                               barrier.triangles = barrier.triangles,
                               prior.range = prior.range, prior.sigma = prior.sigma ,  
                               range.fraction = range.fraction,
                               range = range,
                               set.inla.seed = set.inla.seed,
                               loc.data = loc.data,
                               sigma.u = 1, sigma.epsilon = 0.2,
                               poly.original = poly.bar.orginal,
                               prior.range.st = prior.range.st,
                               prior.sigma.st = prior.sigma.st,
                               return.list = TRUE)
        }
        
        trans <- tbm.frac
        plot.model.tbm.plus.pp(trans, 
                       fr,
                       poly.bar.orginal = poly.bar.orginal,
                       range = range,
                       fps = 1,
                       gif.path = fp)
        
        for (r in 1:length(trans)) {
          f <- fr[p]
          range.fraction <- c(0.01, f)
          fpp <- file.path(paste0(marginals.path, f, ".png"))
          png(fpp)
          par(mfrow = c(3, 1))
          tmp = inla.tmarginal(function(x) exp(x), trans[[p]]$pos.tbm$res$marginals.hyperpar[[2]]) 
          plot(tmp, type = "l", xlab = "r", ylab = "Density")
          xvals = seq(0, 10, length.out=1000)
          abline(v=range, col="blue")
    
          tmp = inla.tmarginal(function(x) exp(x), trans[[p]]$pos.bm$res$marginals.hyperpar[[2]]) 
          plot(tmp, type = "l", xlab = "r", ylab = "Density")
          xvals = seq(0, 10, length.out=1000)
          abline(v=range, col="blue")
  
          tmp = inla.tmarginal(function(x) (x), trans[[p]]$pos.st$res$marginals.hyperpar[[1]]) 
          plot(tmp, type = "l", xlab = "r", ylab = "Density")
          xvals = seq(0, 10, length.out=1000)
          abline(v=range, col="blue")
          
          dev.off()
        }
        
        # FOR geom3.3
        fp <- file.path("gif.pp/geom3.3", paste0("sm", SM[d], "wl", Wl[v], "wr", Wr[v], "r", R[r], "seed", SS[s], "/"))
                        dir.create(fp, recursive = TRUE)
        dir.create(fp, recursive = TRUE)
        gif.path = fp
        marginals.path = fp

        for (p in 1:length(fr)) {
          f <- fr[p]
          range.fraction <- c(f, 0.01)
          tbm.frac[[p]] <- model.tbm.plus.pp(mesh = mesh, fem = fem, 
                               stk.pp = stk.pp,
                               barrier.triangles = barrier.triangles,
                               prior.range = prior.range, prior.sigma = prior.sigma ,  
                               range.fraction = range.fraction,
                               range = range,
                               set.inla.seed = set.inla.seed,
                               loc.data = loc.data,
                               sigma.u = 1, sigma.epsilon = 0.2,
                               poly.original = poly.bar.orginal,
                               prior.range.st = prior.range.st,
                               prior.sigma.st = prior.sigma.st,
                               return.list = TRUE)
        }
        
        trans <- tbm.frac
        plot.model.tbm.plus.pp(trans, 
                       fr,
                       poly.bar.orginal = poly.bar.orginal,
                       range = range,
                       fps = 1,
                       gif.path = fp)
        
        for (r in 1:length(trans)) {
          f <- fr[p]
          range.fraction <- c(f, 0.01)
          fpp <- file.path(paste0(marginals.path, f, ".png"))
          png(fpp)
          par(mfrow = c(3, 1))
          tmp = inla.tmarginal(function(x) exp(x), trans[[p]]$pos.tbm$res$marginals.hyperpar[[2]]) 
          plot(tmp, type = "l", xlab = "r", ylab = "Density")
          xvals = seq(0, 10, length.out=1000)
          abline(v=range, col="blue")
    
          tmp = inla.tmarginal(function(x) exp(x), trans[[p]]$pos.bm$res$marginals.hyperpar[[2]]) 
          plot(tmp, type = "l", xlab = "r", ylab = "Density")
          xvals = seq(0, 10, length.out=1000)
          abline(v=range, col="blue")
  
          tmp = inla.tmarginal(function(x) (x), trans[[p]]$pos.st$res$marginals.hyperpar[[1]]) 
          plot(tmp, type = "l", xlab = "r", ylab = "Density")
          xvals = seq(0, 10, length.out=1000)
          abline(v=range, col="blue")
          
          dev.off()
        }
      }
    }
  }
}
```

######selected

```{r}
#geom 1, and 1.2
SM <- c(1.5)
W <- c(2)
R <- 4
SS <- 874
fr <- 0.3
      
for (d in 1:length(SM)) {
  for (v in 1:length(W)) {
    for(r in 1:length(R)) { #3->| this 3 loops
      smalldist = SM[d]
      width = c(W[v],W[v])
      range = R[r]        
      max.edge.length = 0.4
      x.mid = 10
      xlim.big  = c(0,20)
      xlim.small = c(3,17)
      ylim.big = c(0,20)
      ylim.small = c(3,17)
      fr = fr
      prior.range = prior.range
      prior.sigma = c(1,0.1)
      sigma.u = 1
      sigma.epsilon = 0.2
      prior.range.st = prior.range
      prior.sigma.st = c(1,0.1)
          
        

      poly1 <- local.square.polygon(xlim=c(xlim.big[1]-1, x.mid-smalldist/2), 
                                    ylim=x.mid+width[1]*c(-.5, .5))

      poly2 <- local.square.polygon(xlim=c(x.mid+smalldist/2, xlim.big[2]+1), 
                                    ylim=x.mid+width[2]*c(-.5, .5))

      poly.original <- SpatialPolygons(c(poly1@polygons, poly2@polygons))
  
      loc1 <- matrix(c(xlim.big[1],ylim.big[1], 
                   xlim.big[2],ylim.big[1], 
                   xlim.big[2],ylim.big[2], 
                   xlim.big[1],ylim.big[2]), 4, 2, byrow = T)
  
      seg <- inla.sp2segment(poly.original)
      mesh <- inla.mesh.2d(loc=loc1, 
                       interior = seg, 
                       max.e = max.edge.length, 
                       offset=1)

      tl <- length(mesh$graph$tv[,1])
      posTri <- matrix(0, tl, 2)

      for (t in 1:tl){
        temp = mesh$loc[mesh$graph$tv[t, ], ]
        posTri[t,] = colMeans(temp)[c(1,2)] 
      }
      
      posTri <- SpatialPoints(posTri)
      bar.original <- over(poly.original, SpatialPoints(posTri), returnList=T)
      bar.original <- unlist(bar.original)
  
      #THIS TAKES A FEW SECONDS AND IT'S ACTUALLY NOT NEEDED IN EVERY LOOP, inla.barrier.polygon
      poly.bar.orginal <- inla.barrier.polygon(mesh, barrier.triangles = bar.original)

      # BARRIER 1
      bar1 <- over(poly1, SpatialPoints(posTri), returnList=T)
      bar1 <- unlist(bar1)
      poly.bar1 <- inla.barrier.polygon(mesh, barrier.triangles = bar1)

      # BARRIER 2
      bar2 <- over(poly2, SpatialPoints(posTri), returnList=T)
      bar2 <- unlist(bar2)
      poly.bar2 <- inla.barrier.polygon(mesh, barrier.triangles = bar2)

      mat <-  inla.barrier.fem.plus(mesh, list(bar1, bar2)) 
      fem <- mat 
      barrier.triangles <- list(bar1, bar2)

      # PLOTS
      poly1_h <- local.square.polygon_T(xlim=c(xlim.small[1], x.mid-smalldist/2), 
                                        ylim=x.mid+width[1]*c(-.5, .5))

      poly2_h <- local.square.polygon_T(xlim=c(x.mid+smalldist/2, xlim.small[2]), 
                                        ylim=x.mid+width[2]*c(-.5, .5))

      loc2 <- matrix(c(3,3, 17,3, 17,17, 3,17), 4, 2, byrow = T)

      locp2 <- Polygon(loc2, hole = FALSE)
    
      poly.water <- SpatialPolygons(list(Polygons(list(locp2, poly1_h, poly2_h), '0')))
      poly.water_sf <- st_as_sf(poly.water)
  
      #I'm missing the poly.rect and other that I need for the ggplot, but I don't need it for this loop
      nv <- mesh$n
      dmesh <- book.mesh.dual(mesh)

      domain.polys <- Polygons(list(Polygon(loc1)), '0')
      domainSP <- SpatialPolygons(list(domain.polys))
      domainSPsf <- st_as_sf(domainSP)

      dmesh_sf <- st_as_sf(dmesh) 

      # with sapply
      w <- sapply(1:length(dmesh), function(i) {
        if (length(st_intersects(dmesh_sf[i, ], domainSPsf)[[1]]) == 1)
          return(st_area(st_intersection(dmesh_sf[i, ], domainSPsf)))
        else {
          return(0)
        }
      })
      
      #SAME AS THE GAUSSIAN FIELD UNTIL HERE
      win <- polyCub::as.owin.SpatialPolygons(poly.water)
      npix <- 300
      spatstat.options(npixel = npix)

      beta0 <- -2
      sigma2x <- 0.01
      nu <- 1
  
      #START LOOP FOR SEED
      for (s in 1:length(SS)) { #4->| SS loop
        set.inla.seed = SS[s]
        
        # common for geom 1, and geom 1.2
        set.seed(set.inla.seed) 
        lg.s <- rLGCP('matern', beta0, var = sigma2x,
                   scale = range / sqrt(8), 
                   nu = nu, win = win)

        xy <- cbind(lg.s$x, lg.s$y)
        loc.data <- SpatialPoints(xy)
        loc.data_sf <- st_as_sf(loc.data)

        Lam <- attr(lg.s, 'Lambda')
        rf.s <- log(Lam$v)

        n <- nrow(xy)
        y.pp <- rep(0:1, c(nv, n))
        e.pp <- c(w, rep(0, n)) 
        imat <- Diagonal(nv, rep(1, nv))
        lmat <- inla.spde.make.A(mesh, xy)
        A.pp <- rbind(imat, lmat)
  
        stk.pp <- inla.stack(
          data = list(y = y.pp, e = e.pp), 
          A = list(1, A.pp),
          effects = list(list(b0 = rep(1, nv + n)), list(i = 1:nv)),
          tag = 'pp')
   
        tbm.frac <- list()
        
        # FOR geom1
        fp <- file.path("gif.sel/geom1", paste0("sm", SM[d], "w", W[v], "r", R[r], "seed", SS[s], "/"))
                        dir.create(fp, recursive = TRUE)
        gif.path = fp
        marginals.path = fp

        for (p in 1:length(fr)) { #
          f <- fr[p]
          range.fraction <- c(f, f)
          tbm.frac[[p]] <- model.tbm.plus.pp(mesh = mesh, fem = fem, 
                               stk.pp = stk.pp,
                               barrier.triangles = barrier.triangles,
                               prior.range = prior.range, prior.sigma = prior.sigma ,  
                               range.fraction = range.fraction,
                               range = range,
                               set.inla.seed = set.inla.seed,
                               loc.data = loc.data,
                               sigma.u = 1, sigma.epsilon = 0.2,
                               poly.original = poly.bar.orginal,
                               prior.range.st = prior.range.st,
                               prior.sigma.st = prior.sigma.st,
                               return.list = TRUE)
        }
        trans <- tbm.frac
        trans.geom1 <- trans
        plot.model.tbm.plus.pp(trans, 
                       fr,
                       poly.bar.orginal = poly.bar.orginal,
                       range = range,
                       fps = 1,
                       gif.path = fp)

  
        for (r in 1:length(trans)) {
          f <- fr[p]
          range.fraction <- c(f, f)
          fpp <- file.path(paste0(marginals.path, f, ".png"))
          png(fpp)
          par(mfrow = c(3, 1))
          tmp = inla.tmarginal(function(x) exp(x), trans[[p]]$pos.tbm$res$marginals.hyperpar[[2]]) 
          plot(tmp, type = "l", xlab = "r", ylab = "Density TBM")
          xvals = seq(0, 10, length.out=1000)
          abline(v=range, col="blue")
    
          tmp = inla.tmarginal(function(x) exp(x), trans[[p]]$pos.bm$res$marginals.hyperpar[[2]]) 
          plot(tmp, type = "l", xlab = "r", ylab = "Density BM")
          xvals = seq(0, 10, length.out=1000)
          abline(v=range, col="blue")
  
          tmp = inla.tmarginal(function(x) (x), trans[[p]]$pos.st$res$marginals.hyperpar[[1]]) 
          plot(tmp, type = "l", xlab = "r", ylab = "Density st")
          xvals = seq(0, 10, length.out=1000)
          abline(v=range, col="blue")
          dev.off()
        }
        
        # FOR geom1.2
        fp <- file.path("gif.sel/geom1.2", paste0("sm", SM[d], "w", W[v], "r", R[r], "seed", SS[s], "/"))
        dir.create(fp, recursive = TRUE)
        gif.path = fp
        marginals.path = fp

        for (p in 1:length(fr)) {
          f <- fr[p]
          range.fraction <- c(0.01, f)
          tbm.frac[[p]] <- model.tbm.plus.pp(mesh = mesh, fem = fem, 
                               stk.pp = stk.pp,
                               barrier.triangles = barrier.triangles,
                               prior.range = prior.range, prior.sigma = prior.sigma ,  
                               range.fraction = range.fraction,
                               range = range,
                               set.inla.seed = set.inla.seed,
                               loc.data = loc.data,
                               sigma.u = 1, sigma.epsilon = 0.2,
                               poly.original = poly.bar.orginal,
                               prior.range.st = prior.range.st,
                               prior.sigma.st = prior.sigma.st,
                               return.list = TRUE)
        }
        
        trans <- tbm.frac
        trans.geom1.1 <- trans
        plot.model.tbm.plus.pp.01l(trans, 
                       fr,
                       poly.bar.orginal = poly.bar.orginal,
                       range = range,
                       fps = 1,
                       gif.path = fp)
        
        for (r in 1:length(trans)) {
          f <- fr[p]
          range.fraction <- c(0.01, f)
          fpp <- file.path(paste0(marginals.path, f, ".png"))
          png(fpp)
          par(mfrow = c(3, 1))
          tmp = inla.tmarginal(function(x) exp(x), trans[[p]]$pos.tbm$res$marginals.hyperpar[[2]]) 
          plot(tmp, type = "l", xlab = "r", ylab = "Density TBM")
          xvals = seq(0, 10, length.out=1000)
          abline(v=range, col="blue")
    
          tmp = inla.tmarginal(function(x) exp(x), trans[[p]]$pos.bm$res$marginals.hyperpar[[2]]) 
          plot(tmp, type = "l", xlab = "r", ylab = "Density BM")
          xvals = seq(0, 10, length.out=1000)
          abline(v=range, col="blue")
  
          tmp = inla.tmarginal(function(x) (x), trans[[p]]$pos.st$res$marginals.hyperpar[[1]]) 
          plot(tmp, type = "l", xlab = "r", ylab = "Density st")
          xvals = seq(0, 10, length.out=1000)
          abline(v=range, col="blue")
          
          dev.off()
        }
      }
    }
  }
}
```

```{r}
#geom 2, and 2.1
SM <- c(0)
W <- c(1)
R <- c(4)
SS <- 763
fr <- 0.3
      
for (d in 1:length(SM)) {
  for (v in 1:length(W)) {
    for(r in 1:length(R)) { #3->| this 3 loops
      smalldist = SM[d]
      width = c(W[v],W[v])
      range = R[r]        
      max.edge.length = 0.4
      x.mid = 10
      xlim.big  = c(0,20)
      xlim.small = c(3,17)
      ylim.big = c(0,20)
      ylim.small = c(3,17)
      fr = fr
      prior.range = prior.range
      prior.sigma = c(1,0.1)
      sigma.u = 1
      sigma.epsilon = 0.2
      prior.range.st = prior.range
      prior.sigma.st = c(1,0.1)
          
        

      poly1 <- local.square.polygon(xlim=c(xlim.big[1]-1, x.mid-smalldist/2), 
                                    ylim=x.mid+width[1]*c(-.5, .5))

      poly2 <- local.square.polygon(xlim=c(x.mid+smalldist/2, xlim.big[2]+1), 
                                    ylim=x.mid+width[2]*c(-.5, .5))

      poly.original <- SpatialPolygons(c(poly1@polygons, poly2@polygons))
  
      loc1 <- matrix(c(xlim.big[1],ylim.big[1], 
                   xlim.big[2],ylim.big[1], 
                   xlim.big[2],ylim.big[2], 
                   xlim.big[1],ylim.big[2]), 4, 2, byrow = T)
  
      seg <- inla.sp2segment(poly.original)
      mesh <- inla.mesh.2d(loc=loc1, 
                       interior = seg, 
                       max.e = max.edge.length, 
                       offset=1)

      tl <- length(mesh$graph$tv[,1])
      posTri <- matrix(0, tl, 2)

      for (t in 1:tl){
        temp = mesh$loc[mesh$graph$tv[t, ], ]
        posTri[t,] = colMeans(temp)[c(1,2)] 
      }
      
      posTri <- SpatialPoints(posTri)
      bar.original <- over(poly.original, SpatialPoints(posTri), returnList=T)
      bar.original <- unlist(bar.original)
  
      #THIS TAKES A FEW SECONDS AND IT'S ACTUALLY NOT NEEDED IN EVERY LOOP, inla.barrier.polygon
      poly.bar.orginal <- inla.barrier.polygon(mesh, barrier.triangles = bar.original)

      # BARRIER 1
      bar1 <- over(poly1, SpatialPoints(posTri), returnList=T)
      bar1 <- unlist(bar1)

      # BARRIER 2
      bar2 <- over(poly2, SpatialPoints(posTri), returnList=T)
      bar2 <- unlist(bar2)

      mat <-  inla.barrier.fem.plus(mesh, list(bar1, bar2)) 
      fem <- mat 
      barrier.triangles <- list(bar1, bar2)

      # PLOTS
      poly1_h <- local.square.polygon_T(xlim=c(xlim.small[1], x.mid-smalldist/2), 
                                        ylim=x.mid+width[1]*c(-.5, .5))

      poly2_h <- local.square.polygon_T(xlim=c(x.mid+smalldist/2, xlim.small[2]), 
                                        ylim=x.mid+width[2]*c(-.5, .5))

      loc2 <- matrix(c(3,3, 17,3, 17,17, 3,17), 4, 2, byrow = T)

      locp2 <- Polygon(loc2, hole = FALSE)
    
      poly.water <- SpatialPolygons(list(Polygons(list(locp2, poly1_h, poly2_h), '0')))
      poly.water_sf <- st_as_sf(poly.water)
  
      #I'm missing the poly.rect and other that I need for the ggplot, but I don't need it for this loop
      nv <- mesh$n
      dmesh <- book.mesh.dual(mesh)

      domain.polys <- Polygons(list(Polygon(loc1)), '0')
      domainSP <- SpatialPolygons(list(domain.polys))
      domainSPsf <- st_as_sf(domainSP)

      dmesh_sf <- st_as_sf(dmesh) 

      # with sapply
      w <- sapply(1:length(dmesh), function(i) {
        if (length(st_intersects(dmesh_sf[i, ], domainSPsf)[[1]]) == 1)
          return(st_area(st_intersection(dmesh_sf[i, ], domainSPsf)))
        else {
          return(0)
        }
      })
      
      #SAME AS THE GAUSSIAN FIELD UNTIL HERE
      win <- polyCub::as.owin.SpatialPolygons(poly.water)
      npix <- 300
      spatstat.options(npixel = npix)

      beta0 <- -2
      sigma2x <- 0.01
      nu <- 1
  
      #START LOOP FOR SEED
      for (s in 1:length(SS)) { #4->| SS loop
        set.inla.seed = SS[s]
        
        # common for geom 2, and geom 2.2
        set.seed(set.inla.seed) 
        lg.s <- rLGCP('matern', beta0, var = sigma2x,
                   scale = range / sqrt(8), 
                   nu = nu, win = win)

        xy <- cbind(lg.s$x, lg.s$y)
        loc.data <- SpatialPoints(xy)
        loc.data_sf <- st_as_sf(loc.data)

        n <- nrow(xy)
        y.pp <- rep(0:1, c(nv, n))
        e.pp <- c(w, rep(0, n)) 
        imat <- Diagonal(nv, rep(1, nv))
        lmat <- inla.spde.make.A(mesh, xy)
        A.pp <- rbind(imat, lmat)
  
        stk.pp <- inla.stack(
          data = list(y = y.pp, e = e.pp), 
          A = list(1, A.pp),
          effects = list(list(b0 = rep(1, nv + n)), list(i = 1:nv)),
          tag = 'pp')
   
        tbm.frac <- list()
        
        # FOR geom2 
        fp <- file.path("gif.sel/geom2", paste0("sm", SM[d], "w", W[v], "r", R[r], "seed", SS[s], "/"))
                        dir.create(fp, recursive = TRUE)
        gif.path = fp
        marginals.path = fp

        for (p in 1:length(fr)) { #
          f <- fr[p]
          range.fraction <- c(f, f)
          tbm.frac[[p]] <- model.tbm.plus.pp(mesh = mesh, fem = fem, 
                               stk.pp = stk.pp,
                               barrier.triangles = barrier.triangles,
                               prior.range = prior.range, prior.sigma = prior.sigma ,  
                               range.fraction = range.fraction,
                               range = range,
                               set.inla.seed = set.inla.seed,
                               loc.data = loc.data,
                               sigma.u = 1, sigma.epsilon = 0.2,
                               poly.original = poly.bar.orginal,
                               prior.range.st = prior.range.st,
                               prior.sigma.st = prior.sigma.st,
                               return.list = TRUE)
        }
        trans <- tbm.frac
        trans.geom2 <- trans
        plot.model.tbm.plus.pp(trans, 
                       fr,
                       poly.bar.orginal = poly.bar.orginal,
                       range = range,
                       fps = 1,
                       gif.path = fp)

  
        for (r in 1:length(trans)) {
          f <- fr[p]
          range.fraction <- c(f, f)
          fpp <- file.path(paste0(marginals.path, f, ".png"))
          png(fpp)
          par(mfrow = c(3, 1))
          tmp = inla.tmarginal(function(x) exp(x), trans[[p]]$pos.tbm$res$marginals.hyperpar[[2]]) 
          plot(tmp, type = "l", xlab = "r", ylab = "Density TBM")
          xvals = seq(0, 10, length.out=1000)
          abline(v=range, col="blue")
    
          tmp = inla.tmarginal(function(x) exp(x), trans[[p]]$pos.bm$res$marginals.hyperpar[[2]]) 
          plot(tmp, type = "l", xlab = "r", ylab = "Density BM")
          xvals = seq(0, 10, length.out=1000)
          abline(v=range, col="blue")
  
          tmp = inla.tmarginal(function(x) (x), trans[[p]]$pos.st$res$marginals.hyperpar[[1]]) 
          plot(tmp, type = "l", xlab = "r", ylab = "Density st")
          xvals = seq(0, 10, length.out=1000)
          abline(v=range, col="blue")
          dev.off()
        }
        
        # FOR geom2.2
        fp <- file.path("gif.sel/geom2.2", paste0("sm", SM[d], "w", W[v], "r", R[r], "seed", SS[s], "/"))
        dir.create(fp, recursive = TRUE)
        gif.path = fp
        marginals.path = fp

        for (p in 1:length(fr)) {
          f <- fr[p]
          range.fraction <- c(0.01, f)
          tbm.frac[[p]] <- model.tbm.plus.pp(mesh = mesh, fem = fem, 
                               stk.pp = stk.pp,
                               barrier.triangles = barrier.triangles,
                               prior.range = prior.range, prior.sigma = prior.sigma ,  
                               range.fraction = range.fraction,
                               range = range,
                               set.inla.seed = set.inla.seed,
                               loc.data = loc.data,
                               sigma.u = 1, sigma.epsilon = 0.2,
                               poly.original = poly.bar.orginal,
                               prior.range.st = prior.range.st,
                               prior.sigma.st = prior.sigma.st,
                               return.list = TRUE)
        }
        
        trans <- tbm.frac
        trans.geom2.2 <- trans
        plot.model.tbm.plus.pp.01l(trans, 
                       fr,
                       poly.bar.orginal = poly.bar.orginal,
                       range = range,
                       fps = 1,
                       gif.path = fp)
        
        for (r in 1:length(trans)) {
          f <- fr[p]
          range.fraction <- c(0.01, f)
          fpp <- file.path(paste0(marginals.path, f, ".png"))
          png(fpp)
          par(mfrow = c(3, 1))
          tmp = inla.tmarginal(function(x) exp(x), trans[[p]]$pos.tbm$res$marginals.hyperpar[[2]]) 
          plot(tmp, type = "l", xlab = "r", ylab = "Density TBM")
          xvals = seq(0, 10, length.out=1000)
          abline(v=range, col="blue")
    
          tmp = inla.tmarginal(function(x) exp(x), trans[[p]]$pos.bm$res$marginals.hyperpar[[2]]) 
          plot(tmp, type = "l", xlab = "r", ylab = "Density BM")
          xvals = seq(0, 10, length.out=1000)
          abline(v=range, col="blue")
  
          tmp = inla.tmarginal(function(x) (x), trans[[p]]$pos.st$res$marginals.hyperpar[[1]]) 
          plot(tmp, type = "l", xlab = "r", ylab = "Density st")
          xvals = seq(0, 10, length.out=1000)
          abline(v=range, col="blue")
          
          dev.off()
        }
      }
    }
  }
}
```


```{r}
#geom 3, 3.1, and 3.2
SM <- c(1.5)
Wl <- c(1)
Wr <- c(4)
R <- 2
SS <- 799
fr <- 0.3
      
for (d in 1:length(SM)) {
  for (v in 1:length(Wl)) {
    for(r in 1:length(R)) { #3->| this 3 loops
      smalldist = SM[d]
      width = c(Wl[v],Wr[v])
      range = R[r]        
      max.edge.length = 0.4
      x.mid = 10
      xlim.big  = c(0,20)
      xlim.small = c(3,17)
      ylim.big = c(0,20)
      ylim.small = c(3,17)
      fr = fr
      prior.range = prior.range
      prior.sigma = c(1,0.1)
      sigma.u = 1
      sigma.epsilon = 0.2
      prior.range.st = prior.range
      prior.sigma.st = c(1,0.1)
          
        

      poly1 <- local.square.polygon(xlim=c(xlim.big[1]-1, x.mid-smalldist/2), 
                                    ylim=x.mid+width[1]*c(-.5, .5))

      poly2 <- local.square.polygon(xlim=c(x.mid+smalldist/2, xlim.big[2]+1), 
                                    ylim=x.mid+width[2]*c(-.5, .5))

      poly.original <- SpatialPolygons(c(poly1@polygons, poly2@polygons))
  
      loc1 <- matrix(c(xlim.big[1],ylim.big[1], 
                   xlim.big[2],ylim.big[1], 
                   xlim.big[2],ylim.big[2], 
                   xlim.big[1],ylim.big[2]), 4, 2, byrow = T)
  
      seg <- inla.sp2segment(poly.original)
      mesh <- inla.mesh.2d(loc=loc1, 
                       interior = seg, 
                       max.e = max.edge.length, 
                       offset=1)

      tl <- length(mesh$graph$tv[,1])
      posTri <- matrix(0, tl, 2)

      for (t in 1:tl){
        temp = mesh$loc[mesh$graph$tv[t, ], ]
        posTri[t,] = colMeans(temp)[c(1,2)] 
      }
      
      posTri <- SpatialPoints(posTri)
      bar.original <- over(poly.original, SpatialPoints(posTri), returnList=T)
      bar.original <- unlist(bar.original)
  
      #THIS TAKES A FEW SECONDS AND IT'S ACTUALLY NOT NEEDED IN EVERY LOOP, inla.barrier.polygon
      poly.bar.orginal <- inla.barrier.polygon(mesh, barrier.triangles = bar.original)

      # BARRIER 1
      bar1 <- over(poly1, SpatialPoints(posTri), returnList=T)
      bar1 <- unlist(bar1)

      # BARRIER 2
      bar2 <- over(poly2, SpatialPoints(posTri), returnList=T)
      bar2 <- unlist(bar2)

      mat <-  inla.barrier.fem.plus(mesh, list(bar1, bar2)) 
      fem <- mat 
      barrier.triangles <- list(bar1, bar2)

      # PLOTS
      poly1_h <- local.square.polygon_T(xlim=c(xlim.small[1], x.mid-smalldist/2), 
                                        ylim=x.mid+width[1]*c(-.5, .5))

      poly2_h <- local.square.polygon_T(xlim=c(x.mid+smalldist/2, xlim.small[2]), 
                                        ylim=x.mid+width[2]*c(-.5, .5))

      loc2 <- matrix(c(3,3, 17,3, 17,17, 3,17), 4, 2, byrow = T)

      locp2 <- Polygon(loc2, hole = FALSE)
    
      poly.water <- SpatialPolygons(list(Polygons(list(locp2, poly1_h, poly2_h), '0')))
      poly.water_sf <- st_as_sf(poly.water)
  
      #I'm missing the poly.rect and other that I need for the ggplot, but I don't need it for this loop
      nv <- mesh$n
      dmesh <- book.mesh.dual(mesh)

      domain.polys <- Polygons(list(Polygon(loc1)), '0')
      domainSP <- SpatialPolygons(list(domain.polys))
      domainSPsf <- st_as_sf(domainSP)

      dmesh_sf <- st_as_sf(dmesh) 

      # with sapply
      w <- sapply(1:length(dmesh), function(i) {
        if (length(st_intersects(dmesh_sf[i, ], domainSPsf)[[1]]) == 1)
          return(st_area(st_intersection(dmesh_sf[i, ], domainSPsf)))
        else {
          return(0)
        }
      })
      
      #SAME AS THE GAUSSIAN FIELD UNTIL HERE
      win <- polyCub::as.owin.SpatialPolygons(poly.water)
      npix <- 300
      spatstat.options(npixel = npix)

      beta0 <- -2
      sigma2x <- 0.01
      nu <- 1
  
      #START LOOP FOR SEED
      for (s in 1:length(SS)) { #4->| SS loop
        set.inla.seed = SS[s]
        
        # common for geom 3, and geom 3.2
        set.seed(set.inla.seed) 
        lg.s <- rLGCP('matern', beta0, var = sigma2x,
                   scale = range / sqrt(8), 
                   nu = nu, win = win)

        xy <- cbind(lg.s$x, lg.s$y)
        loc.data <- SpatialPoints(xy)
        loc.data_sf <- st_as_sf(loc.data)

        Lam <- attr(lg.s, 'Lambda')
        rf.s <- log(Lam$v)

        n <- nrow(xy)
        y.pp <- rep(0:1, c(nv, n))
        e.pp <- c(w, rep(0, n)) 
        imat <- Diagonal(nv, rep(1, nv))
        lmat <- inla.spde.make.A(mesh, xy)
        A.pp <- rbind(imat, lmat)
  
        stk.pp <- inla.stack(
          data = list(y = y.pp, e = e.pp), 
          A = list(1, A.pp),
          effects = list(list(b0 = rep(1, nv + n)), list(i = 1:nv)),
          tag = 'pp')
   
        tbm.frac <- list()
        
        # FOR geom3
        fp <- file.path("gif.sel/geom3", paste0("sm", SM[d], "wl", Wl[v], "wr", Wr[v], "r", R[r], "seed", SS[s], "/"))
                        dir.create(fp, recursive = TRUE)
        gif.path = fp
        marginals.path = fp

        for (p in 1:length(fr)) { #
          f <- fr[p]
          range.fraction <- c(f, f)
          tbm.frac[[p]] <- model.tbm.plus.pp(mesh = mesh, fem = fem, 
                               stk.pp = stk.pp,
                               barrier.triangles = barrier.triangles,
                               prior.range = prior.range, prior.sigma = prior.sigma ,  
                               range.fraction = range.fraction,
                               range = range,
                               set.inla.seed = set.inla.seed,
                               loc.data = loc.data,
                               sigma.u = 1, sigma.epsilon = 0.2,
                               poly.original = poly.bar.orginal,
                               prior.range.st = prior.range.st,
                               prior.sigma.st = prior.sigma.st,
                               return.list = TRUE)
        }
        trans <- tbm.frac
        trans.geom3 <- trans
        plot.model.tbm.plus.pp(trans, 
                       fr,
                       poly.bar.orginal = poly.bar.orginal,
                       range = range,
                       fps = 1,
                       gif.path = fp)

  
        for (r in 1:length(trans)) {
          f <- fr[p]
          range.fraction <- c(f, f)
          fpp <- file.path(paste0(marginals.path, f, ".png"))
          png(fpp)
          par(mfrow = c(3, 1))
          tmp = inla.tmarginal(function(x) exp(x), trans[[p]]$pos.tbm$res$marginals.hyperpar[[2]]) 
          plot(tmp, type = "l", xlab = "r", ylab = "Density TBM")
          xvals = seq(0, 10, length.out=1000)
          abline(v=range, col="blue")
    
          tmp = inla.tmarginal(function(x) exp(x), trans[[p]]$pos.bm$res$marginals.hyperpar[[2]]) 
          plot(tmp, type = "l", xlab = "r", ylab = "Density BM")
          xvals = seq(0, 10, length.out=1000)
          abline(v=range, col="blue")
  
          tmp = inla.tmarginal(function(x) (x), trans[[p]]$pos.st$res$marginals.hyperpar[[1]]) 
          plot(tmp, type = "l", xlab = "r", ylab = "Density st")
          xvals = seq(0, 10, length.out=1000)
          abline(v=range, col="blue")
          dev.off()
        }
        
        # FOR geom3.2
        fp <- file.path("gif.sel/geom3.2", paste0("sm", SM[d], "wl", Wl[v], "wr", Wr[v], "r", R[r], "seed", SS[s], "/"))
                        dir.create(fp, recursive = TRUE)
        dir.create(fp, recursive = TRUE)
        gif.path = fp
        marginals.path = fp

        for (p in 1:length(fr)) {
          f <- fr[p]
          range.fraction <- c(0.01, f)
          tbm.frac[[p]] <- model.tbm.plus.pp(mesh = mesh, fem = fem, 
                               stk.pp = stk.pp,
                               barrier.triangles = barrier.triangles,
                               prior.range = prior.range, prior.sigma = prior.sigma ,  
                               range.fraction = range.fraction,
                               range = range,
                               set.inla.seed = set.inla.seed,
                               loc.data = loc.data,
                               sigma.u = 1, sigma.epsilon = 0.2,
                               poly.original = poly.bar.orginal,
                               prior.range.st = prior.range.st,
                               prior.sigma.st = prior.sigma.st,
                               return.list = TRUE)
        }
        
        trans <- tbm.frac
        trans.geom3.2 <- trans
        plot.model.tbm.plus.pp.01l(trans, 
                       fr,
                       poly.bar.orginal = poly.bar.orginal,
                       range = range,
                       fps = 1,
                       gif.path = fp)
        
        for (r in 1:length(trans)) {
          f <- fr[p]
          range.fraction <- c(0.01, f)
          fpp <- file.path(paste0(marginals.path, f, ".png"))
          png(fpp)
          par(mfrow = c(3, 1))
          tmp = inla.tmarginal(function(x) exp(x), trans[[p]]$pos.tbm$res$marginals.hyperpar[[2]]) 
          plot(tmp, type = "l", xlab = "r", ylab = "Density TBM")
          xvals = seq(0, 10, length.out=1000)
          abline(v=range, col="blue")
    
          tmp = inla.tmarginal(function(x) exp(x), trans[[p]]$pos.bm$res$marginals.hyperpar[[2]]) 
          plot(tmp, type = "l", xlab = "r", ylab = "Density BM")
          xvals = seq(0, 10, length.out=1000)
          abline(v=range, col="blue")
  
          tmp = inla.tmarginal(function(x) (x), trans[[p]]$pos.st$res$marginals.hyperpar[[1]]) 
          plot(tmp, type = "l", xlab = "r", ylab = "Density st")
          xvals = seq(0, 10, length.out=1000)
          abline(v=range, col="blue")
          
          dev.off()
        }
        
        # FOR geom3.3
        fp <- file.path("gif.sel/geom3.3", paste0("sm", SM[d], "wl", Wl[v], "wr", Wr[v], "r", R[r], "seed", SS[s], "/"))
                        dir.create(fp, recursive = TRUE)
        dir.create(fp, recursive = TRUE)
        gif.path = fp
        marginals.path = fp

        for (p in 1:length(fr)) {
          f <- fr[p]
          range.fraction <- c(f, 0.01)
          tbm.frac[[p]] <- model.tbm.plus.pp(mesh = mesh, fem = fem, 
                               stk.pp = stk.pp,
                               barrier.triangles = barrier.triangles,
                               prior.range = prior.range, prior.sigma = prior.sigma ,  
                               range.fraction = range.fraction,
                               range = range,
                               set.inla.seed = set.inla.seed,
                               loc.data = loc.data,
                               sigma.u = 1, sigma.epsilon = 0.2,
                               poly.original = poly.bar.orginal,
                               prior.range.st = prior.range.st,
                               prior.sigma.st = prior.sigma.st,
                               return.list = TRUE)
        }
        
        trans <- tbm.frac
        trans.geom3.3 <- trans
        plot.model.tbm.plus.pp.01r(trans, 
                       fr,
                       poly.bar.orginal = poly.bar.orginal,
                       range = range,
                       fps = 1,
                       gif.path = fp)
        
        for (r in 1:length(trans)) {
          f <- fr[p]
          range.fraction <- c(f, 0.01)
          fpp <- file.path(paste0(marginals.path, f, ".png"))
          png(fpp)
          par(mfrow = c(3, 1))
          tmp = inla.tmarginal(function(x) exp(x), trans[[p]]$pos.tbm$res$marginals.hyperpar[[2]]) 
          plot(tmp, type = "l", xlab = "r", ylab = "Density TBM")
          xvals = seq(0, 10, length.out=1000)
          abline(v=range, col="blue")
    
          tmp = inla.tmarginal(function(x) exp(x), trans[[p]]$pos.bm$res$marginals.hyperpar[[2]]) 
          plot(tmp, type = "l", xlab = "r", ylab = "Density BM")
          xvals = seq(0, 10, length.out=1000)
          abline(v=range, col="blue")
  
          tmp = inla.tmarginal(function(x) (x), trans[[p]]$pos.st$res$marginals.hyperpar[[1]]) 
          plot(tmp, type = "l", xlab = "r", ylab = "Density st")
          xvals = seq(0, 10, length.out=1000)
          abline(v=range, col="blue")
          
          dev.off()
        }
      }
    }
  }
}
```


```{r}
#geom 3, 3.1, and 3.2
SM <- c(1.5)
Wl <- c(1)
Wr <- c(3)
R <- 2
SS <- 84
fr <- 0.3
      
for (d in 1:length(SM)) {
  for (v in 1:length(Wl)) {
    for(r in 1:length(R)) { #3->| this 3 loops
      smalldist = SM[d]
      width = c(Wl[v],Wr[v])
      range = R[r]        
      max.edge.length = 0.4
      x.mid = 10
      xlim.big  = c(0,20)
      xlim.small = c(3,17)
      ylim.big = c(0,20)
      ylim.small = c(3,17)
      fr = fr
      prior.range = prior.range
      prior.sigma = c(1,0.1)
      sigma.u = 1
      sigma.epsilon = 0.2
      prior.range.st = prior.range
      prior.sigma.st = c(1,0.1)
          
        

      poly1 <- local.square.polygon(xlim=c(xlim.big[1]-1, x.mid-smalldist/2), 
                                    ylim=x.mid+width[1]*c(-.5, .5))

      poly2 <- local.square.polygon(xlim=c(x.mid+smalldist/2, xlim.big[2]+1), 
                                    ylim=x.mid+width[2]*c(-.5, .5))

      poly.original <- SpatialPolygons(c(poly1@polygons, poly2@polygons))
  
      loc1 <- matrix(c(xlim.big[1],ylim.big[1], 
                   xlim.big[2],ylim.big[1], 
                   xlim.big[2],ylim.big[2], 
                   xlim.big[1],ylim.big[2]), 4, 2, byrow = T)
  
      seg <- inla.sp2segment(poly.original)
      mesh <- inla.mesh.2d(loc=loc1, 
                       interior = seg, 
                       max.e = max.edge.length, 
                       offset=1)

      tl <- length(mesh$graph$tv[,1])
      posTri <- matrix(0, tl, 2)

      for (t in 1:tl){
        temp = mesh$loc[mesh$graph$tv[t, ], ]
        posTri[t,] = colMeans(temp)[c(1,2)] 
      }
      
      posTri <- SpatialPoints(posTri)
      bar.original <- over(poly.original, SpatialPoints(posTri), returnList=T)
      bar.original <- unlist(bar.original)
  
      #THIS TAKES A FEW SECONDS AND IT'S ACTUALLY NOT NEEDED IN EVERY LOOP, inla.barrier.polygon
      poly.bar.orginal <- inla.barrier.polygon(mesh, barrier.triangles = bar.original)

      # BARRIER 1
      bar1 <- over(poly1, SpatialPoints(posTri), returnList=T)
      bar1 <- unlist(bar1)

      # BARRIER 2
      bar2 <- over(poly2, SpatialPoints(posTri), returnList=T)
      bar2 <- unlist(bar2)

      mat <-  inla.barrier.fem.plus(mesh, list(bar1, bar2)) 
      fem <- mat 
      barrier.triangles <- list(bar1, bar2)

      # PLOTS
      poly1_h <- local.square.polygon_T(xlim=c(xlim.small[1], x.mid-smalldist/2), 
                                        ylim=x.mid+width[1]*c(-.5, .5))

      poly2_h <- local.square.polygon_T(xlim=c(x.mid+smalldist/2, xlim.small[2]), 
                                        ylim=x.mid+width[2]*c(-.5, .5))

      loc2 <- matrix(c(3,3, 17,3, 17,17, 3,17), 4, 2, byrow = T)

      locp2 <- Polygon(loc2, hole = FALSE)
    
      poly.water <- SpatialPolygons(list(Polygons(list(locp2, poly1_h, poly2_h), '0')))
      poly.water_sf <- st_as_sf(poly.water)
  
      #I'm missing the poly.rect and other that I need for the ggplot, but I don't need it for this loop
      nv <- mesh$n
      dmesh <- book.mesh.dual(mesh)

      domain.polys <- Polygons(list(Polygon(loc1)), '0')
      domainSP <- SpatialPolygons(list(domain.polys))
      domainSPsf <- st_as_sf(domainSP)

      dmesh_sf <- st_as_sf(dmesh) 

      # with sapply
      w <- sapply(1:length(dmesh), function(i) {
        if (length(st_intersects(dmesh_sf[i, ], domainSPsf)[[1]]) == 1)
          return(st_area(st_intersection(dmesh_sf[i, ], domainSPsf)))
        else {
          return(0)
        }
      })
      
      #SAME AS THE GAUSSIAN FIELD UNTIL HERE
      win <- polyCub::as.owin.SpatialPolygons(poly.water)
      npix <- 300
      spatstat.options(npixel = npix)

      beta0 <- -2
      sigma2x <- 0.01
      nu <- 1
  
      #START LOOP FOR SEED
      for (s in 1:length(SS)) { #4->| SS loop
        set.inla.seed = SS[s]
        
        # common for geom 3, and geom 3.2
        set.seed(set.inla.seed) 
        lg.s <- rLGCP('matern', beta0, var = sigma2x,
                   scale = range / sqrt(8), 
                   nu = nu, win = win)

        xy <- cbind(lg.s$x, lg.s$y)
        loc.data <- SpatialPoints(xy)
        loc.data_sf <- st_as_sf(loc.data)

        Lam <- attr(lg.s, 'Lambda')
        rf.s <- log(Lam$v)

        n <- nrow(xy)
        y.pp <- rep(0:1, c(nv, n))
        e.pp <- c(w, rep(0, n)) 
        imat <- Diagonal(nv, rep(1, nv))
        lmat <- inla.spde.make.A(mesh, xy)
        A.pp <- rbind(imat, lmat)
  
        stk.pp <- inla.stack(
          data = list(y = y.pp, e = e.pp), 
          A = list(1, A.pp),
          effects = list(list(b0 = rep(1, nv + n)), list(i = 1:nv)),
          tag = 'pp')
   
        tbm.frac <- list()
        
        # FOR geom3
        fp <- file.path("gif.sel/geom3", paste0("sm", SM[d], "wl", Wl[v], "wr", Wr[v], "r", R[r], "seed", SS[s], "/"))
                        dir.create(fp, recursive = TRUE)
        gif.path = fp
        marginals.path = fp

        for (p in 1:length(fr)) { #
          f <- fr[p]
          range.fraction <- c(f, f)
          tbm.frac[[p]] <- model.tbm.plus.pp(mesh = mesh, fem = fem, 
                               stk.pp = stk.pp,
                               barrier.triangles = barrier.triangles,
                               prior.range = prior.range, prior.sigma = prior.sigma ,  
                               range.fraction = range.fraction,
                               range = range,
                               set.inla.seed = set.inla.seed,
                               loc.data = loc.data,
                               sigma.u = 1, sigma.epsilon = 0.2,
                               poly.original = poly.bar.orginal,
                               prior.range.st = prior.range.st,
                               prior.sigma.st = prior.sigma.st,
                               return.list = TRUE)
        }
        trans <- tbm.frac
        trans.geom3 <- trans
        plot.model.tbm.plus.pp(trans, 
                       fr,
                       poly.bar.orginal = poly.bar.orginal,
                       range = range,
                       fps = 1,
                       gif.path = fp)

  
        for (r in 1:length(trans)) {
          f <- fr[p]
          range.fraction <- c(f, f)
          fpp <- file.path(paste0(marginals.path, f, ".png"))
          png(fpp)
          par(mfrow = c(3, 1))
          tmp = inla.tmarginal(function(x) exp(x), trans[[p]]$pos.tbm$res$marginals.hyperpar[[2]]) 
          plot(tmp, type = "l", xlab = "r", ylab = "Density TBM")
          xvals = seq(0, 10, length.out=1000)
          abline(v=range, col="blue")
    
          tmp = inla.tmarginal(function(x) exp(x), trans[[p]]$pos.bm$res$marginals.hyperpar[[2]]) 
          plot(tmp, type = "l", xlab = "r", ylab = "Density BM")
          xvals = seq(0, 10, length.out=1000)
          abline(v=range, col="blue")
  
          tmp = inla.tmarginal(function(x) (x), trans[[p]]$pos.st$res$marginals.hyperpar[[1]]) 
          plot(tmp, type = "l", xlab = "r", ylab = "Density st")
          xvals = seq(0, 10, length.out=1000)
          abline(v=range, col="blue")
          dev.off()
        }
        
        # FOR geom3.2
        fp <- file.path("gif.sel/geom3.2", paste0("sm", SM[d], "wl", Wl[v], "wr", Wr[v], "r", R[r], "seed", SS[s], "/"))
                        dir.create(fp, recursive = TRUE)
        dir.create(fp, recursive = TRUE)
        gif.path = fp
        marginals.path = fp

        for (p in 1:length(fr)) {
          f <- fr[p]
          range.fraction <- c(0.01, f)
          tbm.frac[[p]] <- model.tbm.plus.pp(mesh = mesh, fem = fem, 
                               stk.pp = stk.pp,
                               barrier.triangles = barrier.triangles,
                               prior.range = prior.range, prior.sigma = prior.sigma ,  
                               range.fraction = range.fraction,
                               range = range,
                               set.inla.seed = set.inla.seed,
                               loc.data = loc.data,
                               sigma.u = 1, sigma.epsilon = 0.2,
                               poly.original = poly.bar.orginal,
                               prior.range.st = prior.range.st,
                               prior.sigma.st = prior.sigma.st,
                               return.list = TRUE)
        }
        
        trans <- tbm.frac
        trans.geom3.2 <- trans
        plot.model.tbm.plus.pp.01l(trans, 
                       fr,
                       poly.bar.orginal = poly.bar.orginal,
                       range = range,
                       fps = 1,
                       gif.path = fp)
        
        for (r in 1:length(trans)) {
          f <- fr[p]
          range.fraction <- c(0.01, f)
          fpp <- file.path(paste0(marginals.path, f, ".png"))
          png(fpp)
          par(mfrow = c(3, 1))
          tmp = inla.tmarginal(function(x) exp(x), trans[[p]]$pos.tbm$res$marginals.hyperpar[[2]]) 
          plot(tmp, type = "l", xlab = "r", ylab = "Density TBM")
          xvals = seq(0, 10, length.out=1000)
          abline(v=range, col="blue")
    
          tmp = inla.tmarginal(function(x) exp(x), trans[[p]]$pos.bm$res$marginals.hyperpar[[2]]) 
          plot(tmp, type = "l", xlab = "r", ylab = "Density BM")
          xvals = seq(0, 10, length.out=1000)
          abline(v=range, col="blue")
  
          tmp = inla.tmarginal(function(x) (x), trans[[p]]$pos.st$res$marginals.hyperpar[[1]]) 
          plot(tmp, type = "l", xlab = "r", ylab = "Density st")
          xvals = seq(0, 10, length.out=1000)
          abline(v=range, col="blue")
          
          dev.off()
        }
        
        # FOR geom3.3
        fp <- file.path("gif.sel/geom3.3", paste0("sm", SM[d], "wl", Wl[v], "wr", Wr[v], "r", R[r], "seed", SS[s], "/"))
                        dir.create(fp, recursive = TRUE)
        dir.create(fp, recursive = TRUE)
        gif.path = fp
        marginals.path = fp

        for (p in 1:length(fr)) {
          f <- fr[p]
          range.fraction <- c(f, 0.01)
          tbm.frac[[p]] <- model.tbm.plus.pp(mesh = mesh, fem = fem, 
                               stk.pp = stk.pp,
                               barrier.triangles = barrier.triangles,
                               prior.range = prior.range, prior.sigma = prior.sigma ,  
                               range.fraction = range.fraction,
                               range = range,
                               set.inla.seed = set.inla.seed,
                               loc.data = loc.data,
                               sigma.u = 1, sigma.epsilon = 0.2,
                               poly.original = poly.bar.orginal,
                               prior.range.st = prior.range.st,
                               prior.sigma.st = prior.sigma.st,
                               return.list = TRUE)
        }
        
        trans <- tbm.frac
        trans.geom3.3 <- trans
        plot.model.tbm.plus.pp.01r(trans, 
                       fr,
                       poly.bar.orginal = poly.bar.orginal,
                       range = range,
                       fps = 1,
                       gif.path = fp)
        
        for (r in 1:length(trans)) {
          f <- fr[p]
          range.fraction <- c(f, 0.01)
          fpp <- file.path(paste0(marginals.path, f, ".png"))
          png(fpp)
          par(mfrow = c(3, 1))
          tmp = inla.tmarginal(function(x) exp(x), trans[[p]]$pos.tbm$res$marginals.hyperpar[[2]]) 
          plot(tmp, type = "l", xlab = "r", ylab = "Density TBM")
          xvals = seq(0, 10, length.out=1000)
          abline(v=range, col="blue")
    
          tmp = inla.tmarginal(function(x) exp(x), trans[[p]]$pos.bm$res$marginals.hyperpar[[2]]) 
          plot(tmp, type = "l", xlab = "r", ylab = "Density BM")
          xvals = seq(0, 10, length.out=1000)
          abline(v=range, col="blue")
  
          tmp = inla.tmarginal(function(x) (x), trans[[p]]$pos.st$res$marginals.hyperpar[[1]]) 
          plot(tmp, type = "l", xlab = "r", ylab = "Density st")
          xvals = seq(0, 10, length.out=1000)
          abline(v=range, col="blue")
          
          dev.off()
        }
      }
    }
  }
}
```

mesh plots

```{r}
#geom 1, and 1.2
SM <- c(1.5)
W <- c(2)
R <- 4
SS <- 874
fr <- 0.3
      
for (d in 1:length(SM)) {
  for (v in 1:length(W)) {
    for(r in 1:length(R)) { #3->| this 3 loops
      smalldist = SM[d]
      width = c(W[v],W[v])
      range = R[r]        
      max.edge.length = 0.4
      x.mid = 10
      xlim.big  = c(0,20)
      xlim.small = c(3,17)
      ylim.big = c(0,20)
      ylim.small = c(3,17)
      fr = fr
      prior.range = prior.range
      prior.sigma = c(1,0.1)
      sigma.u = 1
      sigma.epsilon = 0.2
      prior.range.st = prior.range
      prior.sigma.st = c(1,0.1)
          
        

      poly1 <- local.square.polygon(xlim=c(xlim.big[1]-1, x.mid-smalldist/2), 
                                    ylim=x.mid+width[1]*c(-.5, .5))

      poly2 <- local.square.polygon(xlim=c(x.mid+smalldist/2, xlim.big[2]+1), 
                                    ylim=x.mid+width[2]*c(-.5, .5))

      poly.original <- SpatialPolygons(c(poly1@polygons, poly2@polygons))
  
      loc1 <- matrix(c(xlim.big[1],ylim.big[1], 
                   xlim.big[2],ylim.big[1], 
                   xlim.big[2],ylim.big[2], 
                   xlim.big[1],ylim.big[2]), 4, 2, byrow = T)
  
      seg <- inla.sp2segment(poly.original)
      mesh <- inla.mesh.2d(loc=loc1, 
                       interior = seg, 
                       max.e = max.edge.length, 
                       offset=1)

      tl <- length(mesh$graph$tv[,1])
      posTri <- matrix(0, tl, 2)

      for (t in 1:tl){
        temp = mesh$loc[mesh$graph$tv[t, ], ]
        posTri[t,] = colMeans(temp)[c(1,2)] 
      }
      
      posTri <- SpatialPoints(posTri)
      bar.original <- over(poly.original, SpatialPoints(posTri), returnList=T)
      bar.original <- unlist(bar.original)
  
      #THIS TAKES A FEW SECONDS AND IT'S ACTUALLY NOT NEEDED IN EVERY LOOP, inla.barrier.polygon
      poly.bar.orginal <- inla.barrier.polygon(mesh, barrier.triangles = bar.original)

      # BARRIER 1
      bar1 <- over(poly1, SpatialPoints(posTri), returnList=T)
      bar1 <- unlist(bar1)
      poly.bar1 <- inla.barrier.polygon(mesh, barrier.triangles = bar1)

      # BARRIER 2
      bar2 <- over(poly2, SpatialPoints(posTri), returnList=T)
      bar2 <- unlist(bar2)
      poly.bar2 <- inla.barrier.polygon(mesh, barrier.triangles = bar2)

      mat <-  inla.barrier.fem.plus(mesh, list(bar1, bar2)) 
      fem <- mat 
      barrier.triangles <- list(bar1, bar2)

      # PLOTS
      poly1_h <- local.square.polygon_T(xlim=c(xlim.small[1], x.mid-smalldist/2), 
                                        ylim=x.mid+width[1]*c(-.5, .5))

      poly2_h <- local.square.polygon_T(xlim=c(x.mid+smalldist/2, xlim.small[2]), 
                                        ylim=x.mid+width[2]*c(-.5, .5))

      loc2 <- matrix(c(3,3, 17,3, 17,17, 3,17), 4, 2, byrow = T)

      locp2 <- Polygon(loc2, hole = FALSE)
    
      poly.water <- SpatialPolygons(list(Polygons(list(locp2, poly1_h, poly2_h), '0')))
      poly.water_sf <- st_as_sf(poly.water)
      
      poly.rect <- SpatialPolygons(list(Polygons(list(poly1_h, poly2_h), '0')))
      poly.rect_sf <- st_as_sf(poly.rect)
      poly.sq <- SpatialPolygons(list(Polygons(list(locp2), '0')))
      poly.sq_sf <- st_as_sf(poly.sq)

      sq_bbox <- st_bbox(poly.sq_sf) %>% st_as_sfc()
      poly1_bbox <- st_bbox(poly1) %>% st_as_sfc()
      poly2_bbox <- st_bbox(poly2) %>% st_as_sfc()
      
      win <- polyCub::as.owin.SpatialPolygons(poly.water)
      npix <- 300
      spatstat.options(npixel = npix)

      beta0 <- -2
      sigma2x <- 0.01
      nu <- 1
  
      #START LOOP FOR SEED
      for (s in 1:length(SS)) { #4->| SS loop
        set.inla.seed = SS[s]
        
        # common for geom 3, and geom 3.2
        set.seed(set.inla.seed) 
        lg.s <- rLGCP('matern', beta0, var = sigma2x,
                   scale = range / sqrt(8), 
                   nu = nu, win = win)

        xy <- cbind(lg.s$x, lg.s$y)
        loc.data <- SpatialPoints(xy)
        loc.data_sf <- st_as_sf(loc.data)
      }
      
      gg.mesh <- ggplot() + 
      inlabru::gg(mesh) +
      geom_sf(data =poly.rect_sf,
          col='black', alpha=0) + #alpha color inside rect
      geom_sf(data=poly1_bbox, fill=NA, color="red", linewidth = 0.7, linetype = "dashed") +
      geom_sf(data=poly2_bbox, fill=NA, color="red", linewidth = 0.7, linetype = "dashed") +
      geom_sf(data=sq_bbox, fill=NA, color="black", linewidth = 0.7)
      
      gg.mesh.water <- ggplot() +
      inlabru::gg(mesh) +
      geom_sf(data =poly.rect_sf,
          col='black', alpha=1) + #alpha color inside rect
      geom_sf(data=sq_bbox, fill=NA, color="black", linewidth = 0.7) +
      geom_sf(data=poly1_bbox, color="black", linewidth = 0.7) +
      geom_sf(data=poly2_bbox, color="black", linewidth = 0.7) +
      ylim(c(3, 17)) +
      xlim(c(3, 17))

      gg.mesh +
        geom_sf(data =loc.data_sf,
          col='black',size=1.7,alpha=0.5)

      gg.mesh.water +
        geom_sf(data =loc.data_sf,
          col='black',size=1.7,alpha=0.5)

      gg2b.1 <- gg.mesh +
        ggtitle("Mesh")

      gg2b.2 <- gg.mesh.water +
        ggtitle("Barrier layout")

      gg2b.3 <- gg.mesh.water +
        geom_sf(data =loc.data_sf,
          col='black',size=1.7,alpha=0.5) +
        ggtitle("Simulated data")

      fpp <- file.path("gif.sel/geom1/mesh.pp874.png")
#png(fpp)
      gridExtra::grid.arrange(gg2b.1, gg2b.2, gg2b.3, ncol=3, nrow=2, 
               top="Two symmaterical barriers and a canal scenario")
      dev.off()
    }
  }
}

  
```


```{r}
#geom 2, and 2.1
SM <- c(0)
W <- c(1)
R <- c(4)
SS <- 763
fr <- 0.3
      
for (d in 1:length(SM)) {
  for (v in 1:length(W)) {
    for(r in 1:length(R)) { #3->| this 3 loops
      smalldist = SM[d]
      width = c(W[v],W[v])
      range = R[r]        
      max.edge.length = 0.4
      x.mid = 10
      xlim.big  = c(0,20)
      xlim.small = c(3,17)
      ylim.big = c(0,20)
      ylim.small = c(3,17)
      fr = fr
      prior.range = prior.range
      prior.sigma = c(1,0.1)
      sigma.u = 1
      sigma.epsilon = 0.2
      prior.range.st = prior.range
      prior.sigma.st = c(1,0.1)
          
        

      poly1 <- local.square.polygon(xlim=c(xlim.big[1]-1, x.mid-smalldist/2), 
                                    ylim=x.mid+width[1]*c(-.5, .5))

      poly2 <- local.square.polygon(xlim=c(x.mid+smalldist/2, xlim.big[2]+1), 
                                    ylim=x.mid+width[2]*c(-.5, .5))

      poly.original <- SpatialPolygons(c(poly1@polygons, poly2@polygons))
  
      loc1 <- matrix(c(xlim.big[1],ylim.big[1], 
                   xlim.big[2],ylim.big[1], 
                   xlim.big[2],ylim.big[2], 
                   xlim.big[1],ylim.big[2]), 4, 2, byrow = T)
  
      seg <- inla.sp2segment(poly.original)
      mesh <- inla.mesh.2d(loc=loc1, 
                       interior = seg, 
                       max.e = max.edge.length, 
                       offset=1)

      tl <- length(mesh$graph$tv[,1])
      posTri <- matrix(0, tl, 2)

      for (t in 1:tl){
        temp = mesh$loc[mesh$graph$tv[t, ], ]
        posTri[t,] = colMeans(temp)[c(1,2)] 
      }
      
      posTri <- SpatialPoints(posTri)
      bar.original <- over(poly.original, SpatialPoints(posTri), returnList=T)
      bar.original <- unlist(bar.original)
  
      #THIS TAKES A FEW SECONDS AND IT'S ACTUALLY NOT NEEDED IN EVERY LOOP, inla.barrier.polygon
      poly.bar.orginal <- inla.barrier.polygon(mesh, barrier.triangles = bar.original)

      # BARRIER 1
      bar1 <- over(poly1, SpatialPoints(posTri), returnList=T)
      bar1 <- unlist(bar1)
      poly.bar1 <- inla.barrier.polygon(mesh, barrier.triangles = bar1)

      # BARRIER 2
      bar2 <- over(poly2, SpatialPoints(posTri), returnList=T)
      bar2 <- unlist(bar2)
      poly.bar2 <- inla.barrier.polygon(mesh, barrier.triangles = bar2)

      mat <-  inla.barrier.fem.plus(mesh, list(bar1, bar2)) 
      fem <- mat 
      barrier.triangles <- list(bar1, bar2)

      # PLOTS
      poly1_h <- local.square.polygon_T(xlim=c(xlim.small[1], x.mid-smalldist/2), 
                                        ylim=x.mid+width[1]*c(-.5, .5))

      poly2_h <- local.square.polygon_T(xlim=c(x.mid+smalldist/2, xlim.small[2]), 
                                        ylim=x.mid+width[2]*c(-.5, .5))

      loc2 <- matrix(c(3,3, 17,3, 17,17, 3,17), 4, 2, byrow = T)

      locp2 <- Polygon(loc2, hole = FALSE)
    
      poly.water <- SpatialPolygons(list(Polygons(list(locp2, poly1_h, poly2_h), '0')))
      poly.water_sf <- st_as_sf(poly.water)
      
      poly.rect <- SpatialPolygons(list(Polygons(list(poly1_h, poly2_h), '0')))
      poly.rect_sf <- st_as_sf(poly.rect)
      poly.sq <- SpatialPolygons(list(Polygons(list(locp2), '0')))
      poly.sq_sf <- st_as_sf(poly.sq)

      sq_bbox <- st_bbox(poly.sq_sf) %>% st_as_sfc()
      poly1_bbox <- st_bbox(poly1) %>% st_as_sfc()
      poly2_bbox <- st_bbox(poly2) %>% st_as_sfc()
      
      win <- polyCub::as.owin.SpatialPolygons(poly.water)
      npix <- 300
      spatstat.options(npixel = npix)

      beta0 <- -2
      sigma2x <- 0.01
      nu <- 1
  
      #START LOOP FOR SEED
      for (s in 1:length(SS)) { #4->| SS loop
        set.inla.seed = SS[s]
        
        # common for geom 3, and geom 3.2
        set.seed(set.inla.seed) 
        lg.s <- rLGCP('matern', beta0, var = sigma2x,
                   scale = range / sqrt(8), 
                   nu = nu, win = win)

        xy <- cbind(lg.s$x, lg.s$y)
        loc.data <- SpatialPoints(xy)
        loc.data_sf <- st_as_sf(loc.data)
      }
      
      gg.mesh <- ggplot() + 
      inlabru::gg(mesh) +
      geom_sf(data =poly.rect_sf,
          col='black', alpha=0) + #alpha color inside rect
      geom_sf(data=poly1_bbox, fill=NA, color="red", linewidth = 0.7, linetype = "dashed") +
      geom_sf(data=poly2_bbox, fill=NA, color="red", linewidth = 0.7, linetype = "dashed") +
      geom_sf(data=sq_bbox, fill=NA, color="black", linewidth = 0.7)
      
      gg.mesh.water <- ggplot() +
      inlabru::gg(mesh) +
      geom_sf(data =poly.rect_sf,
          col='black', alpha=1) + #alpha color inside rect
      geom_sf(data=sq_bbox, fill=NA, color="black", linewidth = 0.7) +
      geom_sf(data=poly1_bbox, color="black", linewidth = 0.7) +
      geom_sf(data=poly2_bbox, color="black", linewidth = 0.7) +
      ylim(c(3, 17)) +
      xlim(c(3, 17))

      gg.mesh +
        geom_sf(data =loc.data_sf,
          col='black',size=1.7,alpha=0.5)

      gg.mesh.water +
        geom_sf(data =loc.data_sf,
          col='black',size=1.7,alpha=0.5)

      gg2b.1 <- gg.mesh +
        ggtitle("Mesh")

      gg2b.2 <- gg.mesh.water +
        ggtitle("Barrier layout")

      gg2b.3 <- gg.mesh.water +
        geom_sf(data =loc.data_sf,
          col='black',size=1.7,alpha=0.5) +
        ggtitle("Simulated data")

      fpp <- file.path("gif.sel/geom2/mesh.pp763.png")
#png(fpp)
      gridExtra::grid.arrange(gg2b.1, gg2b.2, gg2b.3, ncol=3, nrow=2, 
               top="One barrier separating the study area scenario")
      dev.off()
    }
  }
}

  
```

```{r}
#geom 3
SM <- c(1.5)
Wl <- c(1)
Wr <- c(4)
R <- 2
SS <- 799
fr <- 0.3
      
for (d in 1:length(SM)) {
  for (v in 1:length(W)) {
    for(r in 1:length(R)) { #3->| this 3 loops
      smalldist = SM[d]
      width = c(Wl[v],Wr[v])
      range = R[r]        
      max.edge.length = 0.4
      x.mid = 10
      xlim.big  = c(0,20)
      xlim.small = c(3,17)
      ylim.big = c(0,20)
      ylim.small = c(3,17)
      fr = fr
      prior.range = prior.range
      prior.sigma = c(1,0.1)
      sigma.u = 1
      sigma.epsilon = 0.2
      prior.range.st = prior.range
      prior.sigma.st = c(1,0.1)
          
        

      poly1 <- local.square.polygon(xlim=c(xlim.big[1]-1, x.mid-smalldist/2), 
                                    ylim=x.mid+width[1]*c(-.5, .5))

      poly2 <- local.square.polygon(xlim=c(x.mid+smalldist/2, xlim.big[2]+1), 
                                    ylim=x.mid+width[2]*c(-.5, .5))

      poly.original <- SpatialPolygons(c(poly1@polygons, poly2@polygons))
  
      loc1 <- matrix(c(xlim.big[1],ylim.big[1], 
                   xlim.big[2],ylim.big[1], 
                   xlim.big[2],ylim.big[2], 
                   xlim.big[1],ylim.big[2]), 4, 2, byrow = T)
  
      seg <- inla.sp2segment(poly.original)
      mesh <- inla.mesh.2d(loc=loc1, 
                       interior = seg, 
                       max.e = max.edge.length, 
                       offset=1)

      tl <- length(mesh$graph$tv[,1])
      posTri <- matrix(0, tl, 2)

      for (t in 1:tl){
        temp = mesh$loc[mesh$graph$tv[t, ], ]
        posTri[t,] = colMeans(temp)[c(1,2)] 
      }
      
      posTri <- SpatialPoints(posTri)
      bar.original <- over(poly.original, SpatialPoints(posTri), returnList=T)
      bar.original <- unlist(bar.original)
  
      #THIS TAKES A FEW SECONDS AND IT'S ACTUALLY NOT NEEDED IN EVERY LOOP, inla.barrier.polygon
      poly.bar.orginal <- inla.barrier.polygon(mesh, barrier.triangles = bar.original)

      # BARRIER 1
      bar1 <- over(poly1, SpatialPoints(posTri), returnList=T)
      bar1 <- unlist(bar1)
      poly.bar1 <- inla.barrier.polygon(mesh, barrier.triangles = bar1)

      # BARRIER 2
      bar2 <- over(poly2, SpatialPoints(posTri), returnList=T)
      bar2 <- unlist(bar2)
      poly.bar2 <- inla.barrier.polygon(mesh, barrier.triangles = bar2)

      mat <-  inla.barrier.fem.plus(mesh, list(bar1, bar2)) 
      fem <- mat 
      barrier.triangles <- list(bar1, bar2)

      # PLOTS
      poly1_h <- local.square.polygon_T(xlim=c(xlim.small[1], x.mid-smalldist/2), 
                                        ylim=x.mid+width[1]*c(-.5, .5))

      poly2_h <- local.square.polygon_T(xlim=c(x.mid+smalldist/2, xlim.small[2]), 
                                        ylim=x.mid+width[2]*c(-.5, .5))

      loc2 <- matrix(c(3,3, 17,3, 17,17, 3,17), 4, 2, byrow = T)

      locp2 <- Polygon(loc2, hole = FALSE)
    
      poly.water <- SpatialPolygons(list(Polygons(list(locp2, poly1_h, poly2_h), '0')))
      poly.water_sf <- st_as_sf(poly.water)
      
      poly.rect <- SpatialPolygons(list(Polygons(list(poly1_h, poly2_h), '0')))
      poly.rect_sf <- st_as_sf(poly.rect)
      poly.sq <- SpatialPolygons(list(Polygons(list(locp2), '0')))
      poly.sq_sf <- st_as_sf(poly.sq)

      sq_bbox <- st_bbox(poly.sq_sf) %>% st_as_sfc()
      poly1_bbox <- st_bbox(poly1) %>% st_as_sfc()
      poly2_bbox <- st_bbox(poly2) %>% st_as_sfc()
      
      win <- polyCub::as.owin.SpatialPolygons(poly.water)
      npix <- 300
      spatstat.options(npixel = npix)

      beta0 <- -2
      sigma2x <- 0.01
      nu <- 1
  
      #START LOOP FOR SEED
      for (s in 1:length(SS)) { #4->| SS loop
        set.inla.seed = SS[s]
        
        # common for geom 3, and geom 3.2
        set.seed(set.inla.seed) 
        lg.s <- rLGCP('matern', beta0, var = sigma2x,
                   scale = range / sqrt(8), 
                   nu = nu, win = win)

        xy <- cbind(lg.s$x, lg.s$y)
        loc.data <- SpatialPoints(xy)
        loc.data_sf <- st_as_sf(loc.data)
      }
      
      gg.mesh <- ggplot() + 
      inlabru::gg(mesh) +
      geom_sf(data =poly.rect_sf,
          col='black', alpha=0) + #alpha color inside rect
      geom_sf(data=poly1_bbox, fill=NA, color="red", linewidth = 0.7, linetype = "dashed") +
      geom_sf(data=poly2_bbox, fill=NA, color="red", linewidth = 0.7, linetype = "dashed") +
      geom_sf(data=sq_bbox, fill=NA, color="black", linewidth = 0.7)
      
      gg.mesh.water <- ggplot() +
      inlabru::gg(mesh) +
      geom_sf(data =poly.rect_sf,
          col='black', alpha=1) + #alpha color inside rect
      geom_sf(data=sq_bbox, fill=NA, color="black", linewidth = 0.7) +
      geom_sf(data=poly1_bbox, color="black", linewidth = 0.7) +
      geom_sf(data=poly2_bbox, color="black", linewidth = 0.7) +
      ylim(c(3, 17)) +
      xlim(c(3, 17))


      gg2b.1 <- gg.mesh +
        ggtitle("Mesh")

      gg2b.2 <- gg.mesh.water +
        ggtitle("Barrier layout")

      gg2b.3 <- gg.mesh.water +
        geom_sf(data =loc.data_sf,
          col='black',size=1.7,alpha=0.5) +
        ggtitle("Simulated data")

      fpp <- file.path("gif.sel/geom3/mesh.pp799.png")
#png(fpp)
      gridExtra::grid.arrange(gg2b.1, gg2b.2, gg2b.3, ncol=3, nrow=2, 
               top="Two assymetrical barriers scenario")
      dev.off()
    }
  }
}

  
```

```{r}
#geom 3
#geom 3, 3.1, and 3.2
SM <- c(1.5)
Wl <- c(1)
Wr <- c(3)
R <- 2
SS <- 84
fr <- 0.3
      
for (d in 1:length(SM)) {
  for (v in 1:length(W)) {
    for(r in 1:length(R)) { #3->| this 3 loops
      smalldist = SM[d]
      width = c(Wl[v],Wr[v])
      range = R[r]        
      max.edge.length = 0.4
      x.mid = 10
      xlim.big  = c(0,20)
      xlim.small = c(3,17)
      ylim.big = c(0,20)
      ylim.small = c(3,17)
      fr = fr
      prior.range = prior.range
      prior.sigma = c(1,0.1)
      sigma.u = 1
      sigma.epsilon = 0.2
      prior.range.st = prior.range
      prior.sigma.st = c(1,0.1)
          
        

      poly1 <- local.square.polygon(xlim=c(xlim.big[1]-1, x.mid-smalldist/2), 
                                    ylim=x.mid+width[1]*c(-.5, .5))

      poly2 <- local.square.polygon(xlim=c(x.mid+smalldist/2, xlim.big[2]+1), 
                                    ylim=x.mid+width[2]*c(-.5, .5))

      poly.original <- SpatialPolygons(c(poly1@polygons, poly2@polygons))
  
      loc1 <- matrix(c(xlim.big[1],ylim.big[1], 
                   xlim.big[2],ylim.big[1], 
                   xlim.big[2],ylim.big[2], 
                   xlim.big[1],ylim.big[2]), 4, 2, byrow = T)
  
      seg <- inla.sp2segment(poly.original)
      mesh <- inla.mesh.2d(loc=loc1, 
                       interior = seg, 
                       max.e = max.edge.length, 
                       offset=1)

      tl <- length(mesh$graph$tv[,1])
      posTri <- matrix(0, tl, 2)

      for (t in 1:tl){
        temp = mesh$loc[mesh$graph$tv[t, ], ]
        posTri[t,] = colMeans(temp)[c(1,2)] 
      }
      
      posTri <- SpatialPoints(posTri)
      bar.original <- over(poly.original, SpatialPoints(posTri), returnList=T)
      bar.original <- unlist(bar.original)
  
      #THIS TAKES A FEW SECONDS AND IT'S ACTUALLY NOT NEEDED IN EVERY LOOP, inla.barrier.polygon
      poly.bar.orginal <- inla.barrier.polygon(mesh, barrier.triangles = bar.original)

      # BARRIER 1
      bar1 <- over(poly1, SpatialPoints(posTri), returnList=T)
      bar1 <- unlist(bar1)
      poly.bar1 <- inla.barrier.polygon(mesh, barrier.triangles = bar1)

      # BARRIER 2
      bar2 <- over(poly2, SpatialPoints(posTri), returnList=T)
      bar2 <- unlist(bar2)
      poly.bar2 <- inla.barrier.polygon(mesh, barrier.triangles = bar2)

      mat <-  inla.barrier.fem.plus(mesh, list(bar1, bar2)) 
      fem <- mat 
      barrier.triangles <- list(bar1, bar2)

      # PLOTS
      poly1_h <- local.square.polygon_T(xlim=c(xlim.small[1], x.mid-smalldist/2), 
                                        ylim=x.mid+width[1]*c(-.5, .5))

      poly2_h <- local.square.polygon_T(xlim=c(x.mid+smalldist/2, xlim.small[2]), 
                                        ylim=x.mid+width[2]*c(-.5, .5))

      loc2 <- matrix(c(3,3, 17,3, 17,17, 3,17), 4, 2, byrow = T)

      locp2 <- Polygon(loc2, hole = FALSE)
    
      poly.water <- SpatialPolygons(list(Polygons(list(locp2, poly1_h, poly2_h), '0')))
      poly.water_sf <- st_as_sf(poly.water)
      
      poly.rect <- SpatialPolygons(list(Polygons(list(poly1_h, poly2_h), '0')))
      poly.rect_sf <- st_as_sf(poly.rect)
      poly.sq <- SpatialPolygons(list(Polygons(list(locp2), '0')))
      poly.sq_sf <- st_as_sf(poly.sq)

      sq_bbox <- st_bbox(poly.sq_sf) %>% st_as_sfc()
      poly1_bbox <- st_bbox(poly1) %>% st_as_sfc()
      poly2_bbox <- st_bbox(poly2) %>% st_as_sfc()
      
      win <- polyCub::as.owin.SpatialPolygons(poly.water)
      npix <- 300
      spatstat.options(npixel = npix)

      beta0 <- -2
      sigma2x <- 0.01
      nu <- 1
  
      #START LOOP FOR SEED
      for (s in 1:length(SS)) { #4->| SS loop
        set.inla.seed = SS[s]
        
        # common for geom 3, and geom 3.2
        set.seed(set.inla.seed) 
        lg.s <- rLGCP('matern', beta0, var = sigma2x,
                   scale = range / sqrt(8), 
                   nu = nu, win = win)

        xy <- cbind(lg.s$x, lg.s$y)
        loc.data <- SpatialPoints(xy)
        loc.data_sf <- st_as_sf(loc.data)
      }
      
      gg.mesh <- ggplot() + 
      inlabru::gg(mesh) +
      geom_sf(data =poly.rect_sf,
          col='black', alpha=0) + #alpha color inside rect
      geom_sf(data=poly1_bbox, fill=NA, color="red", linewidth = 0.7, linetype = "dashed") +
      geom_sf(data=poly2_bbox, fill=NA, color="red", linewidth = 0.7, linetype = "dashed") +
      geom_sf(data=sq_bbox, fill=NA, color="black", linewidth = 0.7)
      
      gg.mesh.water <- ggplot() +
      inlabru::gg(mesh) +
      geom_sf(data =poly.rect_sf,
          col='black', alpha=1) + #alpha color inside rect
      geom_sf(data=sq_bbox, fill=NA, color="black", linewidth = 0.7) +
      geom_sf(data=poly1_bbox, color="black", linewidth = 0.7) +
      geom_sf(data=poly2_bbox, color="black", linewidth = 0.7) +
      ylim(c(3, 17)) +
      xlim(c(3, 17))


      gg2b.1 <- gg.mesh +
        ggtitle("Mesh")

      gg2b.2 <- gg.mesh.water +
        ggtitle("Barrier layout")

      gg2b.3 <- gg.mesh.water +
        geom_sf(data =loc.data_sf,
          col='black',size=1.7,alpha=0.5) +
        ggtitle("Simulated data")

      fpp <- file.path("gif.sel/geom3/mesh.pp84.png")
#png(fpp)
      gridExtra::grid.arrange(gg2b.1, gg2b.2, gg2b.3, ncol=3, nrow=2, 
               top="Two assymetrical barriers scenario")
      dev.off()
    }
  }
}

  
```

```{r}

```

#geom 1, and 1.2
SM <- c(1.5)
W <- c(2)
R <- 4
SS <- 874
fr <- 0.3

#geom 2, and 2.1
SM <- c(0)
W <- c(1)
R <- c(4)
SS <- 763
fr <- 0.3

#geom 3
SM <- c(1.5)
Wl <- c(1)
Wr <- c(4)
R <- 2
SS <- 799
fr <- 0.3

#geom 3, 3.1, and 3.2
SM <- c(1.5)
Wl <- c(1)
Wr <- c(3)
R <- 2
SS <- 84
fr <- 0.3

```{r}
local.find.correlation_H = function(Q, location, mesh) {
  sd = sqrt(diag(inla.qinv(Q)))
  # - the marginal standard deviations
  
  A.tmp = inla.spde.make.A(mesh=mesh, loc = matrix(c(location[1], location[2]),1,2))
  # - create a fake A matrix, to extract the closest mesh node index
  id.node = which.max(A.tmp[1, ])
  # - index of the closest node
  
  ## Solve a matrix system to find the column of the covariance matrix
  Inode = rep(0, dim(Q)[1]); Inode[id.node] = 1
  covar.column = solve(Q, Inode)
  corr = drop(matrix(covar.column)) / (sd*sd[id.node])
  return(corr)
}

local.plot.field_H = function(field, mesh, xlim, ylim, ...){ #same as ratios.draft
  stopifnot(length(field) == mesh$n)
  # - error when using the wrong mesh
  if (missing(xlim)) xlim = poly.water@bbox[1, ] 
  if (missing(ylim)) ylim = poly.water@bbox[2, ]
  # - choose plotting region to be the same as the study area polygon
  proj = inla.mesh.projector(mesh, xlim = xlim, 
                             ylim = ylim, dims=c(300, 300))
  # - Can project from the mesh onto a 300x300 grid 
  #   for plots
  field.proj = inla.mesh.project(proj, field)
  # - Do the projection
  image.plot(list(x = proj$x, y=proj$y, z = field.proj), 
             xlim = xlim, ylim = ylim, ...)  
}

corr.model.tbm <- 
             function(id.node = id.node,
                      mesh = mesh, 
                      fem = fem, 
                      barrier.triangles = barrier.triangles, 
                      prior.range = prior.range, prior.sigma = prior.sigma,
                      range.fraction = range.fraction,
                      range = range,
                      set.inla.seed = set.inla.seed, # make sure is the same as prev. fx if loc.data = T
                      loc.data = loc.data, 
                      sigma.u = 1, sigma.epsilon = 0.2,
                      poly.original = poly.bar.orginal,
                      prior.range.st = prior.range,    
                      prior.sigma.st = prior.sigma) {
  
  #tbm
  tbm <- inla.barrier.pcmatern.plus(mesh, fem, barrier.triangles, 
                                    prior.range, prior.sigma, 
                                    range.fraction)
  
  Q <- inla.rgeneric.q(tbm, "Q", theta = c(log(prior.sigma[1]), log(prior.range[1])))
  
  sd <- sqrt(diag(inla.qinv(Q)))
  Inode <- rep(0, dim(Q)[1])
  Inode[id.node] <- 1

  covar.column <- solve(Q, Inode)
  corr.tbm = drop(matrix(covar.column))/(sd*sd[id.node])

  #bm
  bm <- inla.barrier.pcmatern.plus(mesh, fem, barrier.triangles,
                                   prior.range, prior.sigma, 
                                   range.fraction = c(0.01, 0.01))
  Q <- inla.rgeneric.q(bm, "Q", theta = c(log(prior.sigma[1]), log(prior.range[1])))
  
  sd <- sqrt(diag(inla.qinv(Q)))
  Inode <- rep(0, dim(Q)[1])
  Inode[id.node] <- 1

  covar.column <- solve(Q, Inode)
  corr.bm = drop(matrix(covar.column))/(sd*sd[id.node])
  
  #st
  st <- inla.barrier.pcmatern.plus(mesh, fem, barrier.triangles,
                                   prior.range, prior.sigma, 
                                   range.fraction = c(1,1))
  Q <- inla.rgeneric.q(st, "Q", theta = c(log(prior.sigma[1]), log(prior.range[1])))
  
  sd <- sqrt(diag(inla.qinv(Q)))
  Inode <- rep(0, dim(Q)[1])
  Inode[id.node] <- 1

  covar.column <- solve(Q, Inode)
  corr.st = drop(matrix(covar.column))/(sd*sd[id.node])
  
  return.list <- list(corr.tbm = corr.tbm, corr.bm = corr.bm, corr.st = corr.st)
  return(return.list)
}
```

```{r}
# run geom 1 again to get gg.mesh, etc
gg.mesh
gg.mesh.water
x <- c(14, 12, 10)
y <- c(12, 12, 12)
location <- matrix(c(x,y), ncol = 2)

location.sp <- SpatialPoints(location)

gg.mesh.water +
  geom_sf(data = st_as_sf(location.sp), col = "red")

## barrier area pair of points
A.tmp <- inla.spde.make.A(mesh=mesh,
                     loc = matrix(c(location[1,1],location[1,2]), nrow=1, ncol=2))

id.node = which.max(A.tmp[1, ])
id.coord <- c(mesh$loc[id.node, 1], mesh$loc[id.node, 2])

gg.mesh.water +
  geom_sf(data = st_as_sf(SpatialPoints(
    matrix(c(id.coord[1], id.coord[2]), ncol = 2))), col = "red") +
  xlim(c(10, 17)) +
  ylim(c(10,14))

# function for all points
id.node.tbm <- function(mesh, 
                        location, 
                        npoint){ #npoint=nrow(location)
  A.tmp <- list()
  id.node <- list()
  id.coord <- list()
  for (n in 1:npoint) {
    
    A.tmp[[n]] <- inla.spde.make.A(mesh=mesh,
                      loc = matrix(c(location[n,1],location[n,2]), nrow=1, ncol=2))

    id.node[[n]] = which.max(A.tmp[[n]][1, ])
    id.coord[[n]] <- c(mesh$loc[id.node[[n]], 1], mesh$loc[id.node[[n]], 2])
  }
  return.list <- list(id.node = id.node, id.coord = id.coord)
  return(return.list)
}
```


```{r}
range.fraction <- c(0.3, 0.3)
id <- id.node.tbm(mesh = mesh, location = location, npoint = nrow(location))
corr <- list()
corr[[1]] <- corr.model.tbm(id.node = id$id.node[[1]],
                      mesh = mesh, 
                      fem = fem, 
                      barrier.triangles = barrier.triangles, 
                      prior.range = prior.range, prior.sigma = prior.sigma,
                      range.fraction = range.fraction,
                      range = range,
                      set.inla.seed = set.inla.seed,
                      loc.data = loc.data, 
                      sigma.u = 1, sigma.epsilon = 0.2,
                      poly.original = poly.bar.orginal,
                      prior.range.st = prior.range,    
                      prior.sigma.st = prior.sigma)
corr[[2]] <- corr.model.tbm(id.node = id$id.node[[2]],
                      mesh = mesh, 
                      fem = fem, 
                      barrier.triangles = barrier.triangles, 
                      prior.range = prior.range, prior.sigma = prior.sigma,
                      range.fraction = range.fraction,
                      range = range,
                      set.inla.seed = set.inla.seed,
                      loc.data = loc.data, 
                      sigma.u = 1, sigma.epsilon = 0.2,
                      poly.original = poly.bar.orginal,
                      prior.range.st = prior.range,    
                      prior.sigma.st = prior.sigma)
corr[[3]] <- corr.model.tbm(id.node = id$id.node[[3]],
                      mesh = mesh, 
                      fem = fem, 
                      barrier.triangles = barrier.triangles, 
                      prior.range = prior.range, prior.sigma = prior.sigma,
                      range.fraction = range.fraction,
                      range = range,
                      set.inla.seed = set.inla.seed,
                      loc.data = loc.data, 
                      sigma.u = 1, sigma.epsilon = 0.2,
                      poly.original = poly.bar.orginal,
                      prior.range.st = prior.range,    
                      prior.sigma.st = prior.sigma)

fpp <- file.path("gif.sel/geom1", paste0("corr2points.pp874.png"))
#png(fpp)
par(mfrow = c(3,3))
##tbm
local.plot.field_H(corr[[1]]$corr.tbm, mesh, zlim = c(0.1,1))
points(id$id.coord[[1]][1], id$id.coord[[1]][2], pch = 20)
plot(poly.bar.orginal, add=T) #, col = "snow3"
title(main = c("Transparent Barrier Model"))

local.plot.field_H(corr[[2]]$corr.tbm, mesh, zlim = c(0.1,1))
points(id$id.coord[[2]][1], id$id.coord[[2]][2], pch = 20)
plot(poly.bar.orginal, add=T)

local.plot.field_H(corr[[3]]$corr.tbm, mesh, zlim = c(0.1,1))
points(id$id.coord[[3]][1], id$id.coord[[3]][2], pch = 20)
plot(poly.bar.orginal, add=T)

##bm
local.plot.field_H(corr[[1]]$corr.bm, mesh, zlim = c(0.1,1))
points(id$id.coord[[1]][1], id$id.coord[[1]][2], pch = 20)
plot(poly.bar.orginal, add=T) #, col = "snow3"
title(main = c("Barrier Model"))

local.plot.field_H(corr[[2]]$corr.bm, mesh, zlim = c(0.1,1))
points(id$id.coord[[2]][1], id$id.coord[[2]][2], pch = 20)
plot(poly.bar.orginal, add=T)

local.plot.field_H(corr[[3]]$corr.bm, mesh, zlim = c(0.1,1))
points(id$id.coord[[3]][1], id$id.coord[[3]][2], pch = 20)
plot(poly.bar.orginal, add=T)

##st
local.plot.field_H(corr[[1]]$corr.st, mesh, zlim = c(0.1,1))
points(id$id.coord[[1]][1], id$id.coord[[1]][2], pch = 20)
plot(poly.bar.orginal, add=T) #, col = "snow3"
title(main = c("Stationary Model"))

local.plot.field_H(corr[[2]]$corr.st, mesh, zlim = c(0.1,1))
points(id$id.coord[[2]][1], id$id.coord[[2]][2], pch = 20)
plot(poly.bar.orginal, add=T)

local.plot.field_H(corr[[3]]$corr.st, mesh, zlim = c(0.1,1))
points(id$id.coord[[3]][1], id$id.coord[[3]][2], pch = 20)
plot(poly.bar.orginal, add=T)

dev.off()

##geom1.2

range.fraction <- c(0.01, 0.5)
corr <- list()
corr[[1]] <- corr.model.tbm(id.node = id$id.node[[1]],
                      mesh = mesh, 
                      fem = fem, 
                      barrier.triangles = barrier.triangles, 
                      prior.range = prior.range, prior.sigma = prior.sigma,
                      range.fraction = range.fraction,
                      range = range,
                      set.inla.seed = set.inla.seed,
                      loc.data = loc.data, 
                      sigma.u = 1, sigma.epsilon = 0.2,
                      poly.original = poly.bar.orginal,
                      prior.range.st = prior.range,    
                      prior.sigma.st = prior.sigma)
corr[[2]] <- corr.model.tbm(id.node = id$id.node[[2]],
                      mesh = mesh, 
                      fem = fem, 
                      barrier.triangles = barrier.triangles, 
                      prior.range = prior.range, prior.sigma = prior.sigma,
                      range.fraction = range.fraction,
                      range = range,
                      set.inla.seed = set.inla.seed,
                      loc.data = loc.data, 
                      sigma.u = 1, sigma.epsilon = 0.2,
                      poly.original = poly.bar.orginal,
                      prior.range.st = prior.range,    
                      prior.sigma.st = prior.sigma)
corr[[3]] <- corr.model.tbm(id.node = id$id.node[[3]],
                      mesh = mesh, 
                      fem = fem, 
                      barrier.triangles = barrier.triangles, 
                      prior.range = prior.range, prior.sigma = prior.sigma,
                      range.fraction = range.fraction,
                      range = range,
                      set.inla.seed = set.inla.seed,
                      loc.data = loc.data, 
                      sigma.u = 1, sigma.epsilon = 0.2,
                      poly.original = poly.bar.orginal,
                      prior.range.st = prior.range,    
                      prior.sigma.st = prior.sigma)

fpp <- file.path("gif.sel/geom1.2", paste0("corr2points.pp874.png"))
png(fpp)
par(mfrow = c(3,3))
##tbm
local.plot.field_H(corr[[1]]$corr.tbm, mesh, zlim = c(0.1,1))
points(id$id.coord[[1]][1], id$id.coord[[1]][2], pch = 20)
plot(poly.bar.orginal, add=T) #, col = "snow3"
title(main = c("Transparent Barrier Model"))

local.plot.field_H(corr[[2]]$corr.tbm, mesh, zlim = c(0.1,1))
points(id$id.coord[[2]][1], id$id.coord[[2]][2], pch = 20)
plot(poly.bar.orginal, add=T)

local.plot.field_H(corr[[3]]$corr.tbm, mesh, zlim = c(0.1,1))
points(id$id.coord[[3]][1], id$id.coord[[3]][2], pch = 20)
plot(poly.bar.orginal, add=T)

##bm
local.plot.field_H(corr[[1]]$corr.bm, mesh, zlim = c(0.1,1))
points(id$id.coord[[1]][1], id$id.coord[[1]][2], pch = 20)
plot(poly.bar.orginal, add=T) #, col = "snow3"
title(main = c("Barrier Model"))

local.plot.field_H(corr[[2]]$corr.bm, mesh, zlim = c(0.1,1))
points(id$id.coord[[2]][1], id$id.coord[[2]][2], pch = 20)
plot(poly.bar.orginal, add=T)

local.plot.field_H(corr[[3]]$corr.bm, mesh, zlim = c(0.1,1))
points(id$id.coord[[3]][1], id$id.coord[[3]][2], pch = 20)
plot(poly.bar.orginal, add=T)

##st
local.plot.field_H(corr[[1]]$corr.st, mesh, zlim = c(0.1,1))
points(id$id.coord[[1]][1], id$id.coord[[1]][2], pch = 20)
plot(poly.bar.orginal, add=T) #, col = "snow3"
title(main = c("Stationary Model"))

local.plot.field_H(corr[[2]]$corr.st, mesh, zlim = c(0.1,1))
points(id$id.coord[[2]][1], id$id.coord[[2]][2], pch = 20)
plot(poly.bar.orginal, add=T)

local.plot.field_H(corr[[3]]$corr.st, mesh, zlim = c(0.1,1))
points(id$id.coord[[3]][1], id$id.coord[[3]][2], pch = 20)
plot(poly.bar.orginal, add=T)

dev.off()
```

```{r}
range.fraction <- c(0.5, 0.5)
id <- id.node.tbm(mesh = mesh, location = location, npoint = nrow(location))
corr <- list()
corr[[1]] <- corr.model.tbm(id.node = id$id.node[[1]],
                      mesh = mesh, 
                      fem = fem, 
                      barrier.triangles = barrier.triangles, 
                      prior.range = prior.range, prior.sigma = prior.sigma,
                      range.fraction = range.fraction,
                      range = range,
                      set.inla.seed = set.inla.seed,
                      loc.data = loc.data, 
                      sigma.u = 1, sigma.epsilon = 0.2,
                      poly.original = poly.bar.orginal,
                      prior.range.st = prior.range,    
                      prior.sigma.st = prior.sigma)
corr[[2]] <- corr.model.tbm(id.node = id$id.node[[2]],
                      mesh = mesh, 
                      fem = fem, 
                      barrier.triangles = barrier.triangles, 
                      prior.range = prior.range, prior.sigma = prior.sigma,
                      range.fraction = range.fraction,
                      range = range,
                      set.inla.seed = set.inla.seed,
                      loc.data = loc.data, 
                      sigma.u = 1, sigma.epsilon = 0.2,
                      poly.original = poly.bar.orginal,
                      prior.range.st = prior.range,    
                      prior.sigma.st = prior.sigma)
corr[[3]] <- corr.model.tbm(id.node = id$id.node[[3]],
                      mesh = mesh, 
                      fem = fem, 
                      barrier.triangles = barrier.triangles, 
                      prior.range = prior.range, prior.sigma = prior.sigma,
                      range.fraction = range.fraction,
                      range = range,
                      set.inla.seed = set.inla.seed,
                      loc.data = loc.data, 
                      sigma.u = 1, sigma.epsilon = 0.2,
                      poly.original = poly.bar.orginal,
                      prior.range.st = prior.range,    
                      prior.sigma.st = prior.sigma)

fpp <- file.path("gif.sel/geom2", paste0("corr2points.pp763.png"))
png(fpp)
par(mfrow = c(3,3))
##tbm
local.plot.field_H(corr[[1]]$corr.tbm, mesh, zlim = c(0.1,1))
points(id$id.coord[[1]][1], id$id.coord[[1]][2], pch = 20)
plot(poly.bar.orginal, add=T) #, col = "snow3"
title(main = c("Transparent Barrier Model"))

local.plot.field_H(corr[[2]]$corr.tbm, mesh, zlim = c(0.1,1))
points(id$id.coord[[2]][1], id$id.coord[[2]][2], pch = 20)
plot(poly.bar.orginal, add=T)

local.plot.field_H(corr[[3]]$corr.tbm, mesh, zlim = c(0.1,1))
points(id$id.coord[[3]][1], id$id.coord[[3]][2], pch = 20)
plot(poly.bar.orginal, add=T)

##bm
local.plot.field_H(corr[[1]]$corr.bm, mesh, zlim = c(0.1,1))
points(id$id.coord[[1]][1], id$id.coord[[1]][2], pch = 20)
plot(poly.bar.orginal, add=T) #, col = "snow3"
title(main = c("Barrier Model"))

local.plot.field_H(corr[[2]]$corr.bm, mesh, zlim = c(0.1,1))
points(id$id.coord[[2]][1], id$id.coord[[2]][2], pch = 20)
plot(poly.bar.orginal, add=T)

local.plot.field_H(corr[[3]]$corr.bm, mesh, zlim = c(0.1,1))
points(id$id.coord[[3]][1], id$id.coord[[3]][2], pch = 20)
plot(poly.bar.orginal, add=T)

##st
local.plot.field_H(corr[[1]]$corr.st, mesh, zlim = c(0.1,1))
points(id$id.coord[[1]][1], id$id.coord[[1]][2], pch = 20)
plot(poly.bar.orginal, add=T) #, col = "snow3"
title(main = c("Stationary Model"))

local.plot.field_H(corr[[2]]$corr.st, mesh, zlim = c(0.1,1))
points(id$id.coord[[2]][1], id$id.coord[[2]][2], pch = 20)
plot(poly.bar.orginal, add=T)

local.plot.field_H(corr[[3]]$corr.st, mesh, zlim = c(0.1,1))
points(id$id.coord[[3]][1], id$id.coord[[3]][2], pch = 20)
plot(poly.bar.orginal, add=T)

dev.off()

##geom1.2

range.fraction <- c(0.01, 0.5)
corr <- list()
corr[[1]] <- corr.model.tbm(id.node = id$id.node[[1]],
                      mesh = mesh, 
                      fem = fem, 
                      barrier.triangles = barrier.triangles, 
                      prior.range = prior.range, prior.sigma = prior.sigma,
                      range.fraction = range.fraction,
                      range = range,
                      set.inla.seed = set.inla.seed,
                      loc.data = loc.data, 
                      sigma.u = 1, sigma.epsilon = 0.2,
                      poly.original = poly.bar.orginal,
                      prior.range.st = prior.range,    
                      prior.sigma.st = prior.sigma)
corr[[2]] <- corr.model.tbm(id.node = id$id.node[[2]],
                      mesh = mesh, 
                      fem = fem, 
                      barrier.triangles = barrier.triangles, 
                      prior.range = prior.range, prior.sigma = prior.sigma,
                      range.fraction = range.fraction,
                      range = range,
                      set.inla.seed = set.inla.seed,
                      loc.data = loc.data, 
                      sigma.u = 1, sigma.epsilon = 0.2,
                      poly.original = poly.bar.orginal,
                      prior.range.st = prior.range,    
                      prior.sigma.st = prior.sigma)
corr[[3]] <- corr.model.tbm(id.node = id$id.node[[3]],
                      mesh = mesh, 
                      fem = fem, 
                      barrier.triangles = barrier.triangles, 
                      prior.range = prior.range, prior.sigma = prior.sigma,
                      range.fraction = range.fraction,
                      range = range,
                      set.inla.seed = set.inla.seed,
                      loc.data = loc.data, 
                      sigma.u = 1, sigma.epsilon = 0.2,
                      poly.original = poly.bar.orginal,
                      prior.range.st = prior.range,    
                      prior.sigma.st = prior.sigma)

fpp <- file.path("gif.sel/geom2.2", paste0("corr2points.pp763.png"))
png(fpp)
par(mfrow = c(3,3))
##tbm
local.plot.field_H(corr[[1]]$corr.tbm, mesh, zlim = c(0.1,1))
points(id$id.coord[[1]][1], id$id.coord[[1]][2], pch = 20)
plot(poly.bar.orginal, add=T) #, col = "snow3"
title(main = c("Transparent Barrier Model"))

local.plot.field_H(corr[[2]]$corr.tbm, mesh, zlim = c(0.1,1))
points(id$id.coord[[2]][1], id$id.coord[[2]][2], pch = 20)
plot(poly.bar.orginal, add=T)

local.plot.field_H(corr[[3]]$corr.tbm, mesh, zlim = c(0.1,1))
points(id$id.coord[[3]][1], id$id.coord[[3]][2], pch = 20)
plot(poly.bar.orginal, add=T)

##bm
local.plot.field_H(corr[[1]]$corr.bm, mesh, zlim = c(0.1,1))
points(id$id.coord[[1]][1], id$id.coord[[1]][2], pch = 20)
plot(poly.bar.orginal, add=T) #, col = "snow3"
title(main = c("Barrier Model"))

local.plot.field_H(corr[[2]]$corr.bm, mesh, zlim = c(0.1,1))
points(id$id.coord[[2]][1], id$id.coord[[2]][2], pch = 20)
plot(poly.bar.orginal, add=T)

local.plot.field_H(corr[[3]]$corr.bm, mesh, zlim = c(0.1,1))
points(id$id.coord[[3]][1], id$id.coord[[3]][2], pch = 20)
plot(poly.bar.orginal, add=T)

##st
local.plot.field_H(corr[[1]]$corr.st, mesh, zlim = c(0.1,1))
points(id$id.coord[[1]][1], id$id.coord[[1]][2], pch = 20)
plot(poly.bar.orginal, add=T) #, col = "snow3"
title(main = c("Stationary Model"))

local.plot.field_H(corr[[2]]$corr.st, mesh, zlim = c(0.1,1))
points(id$id.coord[[2]][1], id$id.coord[[2]][2], pch = 20)
plot(poly.bar.orginal, add=T)

local.plot.field_H(corr[[3]]$corr.st, mesh, zlim = c(0.1,1))
points(id$id.coord[[3]][1], id$id.coord[[3]][2], pch = 20)
plot(poly.bar.orginal, add=T)

dev.off()
```
```{r}
#run geom 3 799
range.fraction <- c(0.5, 0.5)
id <- id.node.tbm(mesh = mesh, location = location, npoint = nrow(location))
corr <- list()
corr[[1]] <- corr.model.tbm(id.node = id$id.node[[1]],
                      mesh = mesh, 
                      fem = fem, 
                      barrier.triangles = barrier.triangles, 
                      prior.range = prior.range, prior.sigma = prior.sigma,
                      range.fraction = range.fraction,
                      range = range,
                      set.inla.seed = set.inla.seed,
                      loc.data = loc.data, 
                      sigma.u = 1, sigma.epsilon = 0.2,
                      poly.original = poly.bar.orginal,
                      prior.range.st = prior.range,    
                      prior.sigma.st = prior.sigma)
corr[[2]] <- corr.model.tbm(id.node = id$id.node[[2]],
                      mesh = mesh, 
                      fem = fem, 
                      barrier.triangles = barrier.triangles, 
                      prior.range = prior.range, prior.sigma = prior.sigma,
                      range.fraction = range.fraction,
                      range = range,
                      set.inla.seed = set.inla.seed,
                      loc.data = loc.data, 
                      sigma.u = 1, sigma.epsilon = 0.2,
                      poly.original = poly.bar.orginal,
                      prior.range.st = prior.range,    
                      prior.sigma.st = prior.sigma)
corr[[3]] <- corr.model.tbm(id.node = id$id.node[[3]],
                      mesh = mesh, 
                      fem = fem, 
                      barrier.triangles = barrier.triangles, 
                      prior.range = prior.range, prior.sigma = prior.sigma,
                      range.fraction = range.fraction,
                      range = range,
                      set.inla.seed = set.inla.seed,
                      loc.data = loc.data, 
                      sigma.u = 1, sigma.epsilon = 0.2,
                      poly.original = poly.bar.orginal,
                      prior.range.st = prior.range,    
                      prior.sigma.st = prior.sigma)

fpp <- file.path("gif.sel/geom3", paste0("corr2points.pp799.png"))
png(fpp)
par(mfrow = c(3,3))
##tbm
local.plot.field_H(corr[[1]]$corr.tbm, mesh, zlim = c(0.1,1))
points(id$id.coord[[1]][1], id$id.coord[[1]][2], pch = 20)
plot(poly.bar.orginal, add=T) #, col = "snow3"
title(main = c("Transparent Barrier Model"))

local.plot.field_H(corr[[2]]$corr.tbm, mesh, zlim = c(0.1,1))
points(id$id.coord[[2]][1], id$id.coord[[2]][2], pch = 20)
plot(poly.bar.orginal, add=T)

local.plot.field_H(corr[[3]]$corr.tbm, mesh, zlim = c(0.1,1))
points(id$id.coord[[3]][1], id$id.coord[[3]][2], pch = 20)
plot(poly.bar.orginal, add=T)

##bm
local.plot.field_H(corr[[1]]$corr.bm, mesh, zlim = c(0.1,1))
points(id$id.coord[[1]][1], id$id.coord[[1]][2], pch = 20)
plot(poly.bar.orginal, add=T) #, col = "snow3"
title(main = c("Barrier Model"))

local.plot.field_H(corr[[2]]$corr.bm, mesh, zlim = c(0.1,1))
points(id$id.coord[[2]][1], id$id.coord[[2]][2], pch = 20)
plot(poly.bar.orginal, add=T)

local.plot.field_H(corr[[3]]$corr.bm, mesh, zlim = c(0.1,1))
points(id$id.coord[[3]][1], id$id.coord[[3]][2], pch = 20)
plot(poly.bar.orginal, add=T)

##st
local.plot.field_H(corr[[1]]$corr.st, mesh, zlim = c(0.1,1))
points(id$id.coord[[1]][1], id$id.coord[[1]][2], pch = 20)
plot(poly.bar.orginal, add=T) #, col = "snow3"
title(main = c("Stationary Model"))

local.plot.field_H(corr[[2]]$corr.st, mesh, zlim = c(0.1,1))
points(id$id.coord[[2]][1], id$id.coord[[2]][2], pch = 20)
plot(poly.bar.orginal, add=T)

local.plot.field_H(corr[[3]]$corr.st, mesh, zlim = c(0.1,1))
points(id$id.coord[[3]][1], id$id.coord[[3]][2], pch = 20)
plot(poly.bar.orginal, add=T)

dev.off()

##geom3.2

range.fraction <- c(0.01, 0.5)
corr <- list()
corr[[1]] <- corr.model.tbm(id.node = id$id.node[[1]],
                      mesh = mesh, 
                      fem = fem, 
                      barrier.triangles = barrier.triangles, 
                      prior.range = prior.range, prior.sigma = prior.sigma,
                      range.fraction = range.fraction,
                      range = range,
                      set.inla.seed = set.inla.seed,
                      loc.data = loc.data, 
                      sigma.u = 1, sigma.epsilon = 0.2,
                      poly.original = poly.bar.orginal,
                      prior.range.st = prior.range,    
                      prior.sigma.st = prior.sigma)
corr[[2]] <- corr.model.tbm(id.node = id$id.node[[2]],
                      mesh = mesh, 
                      fem = fem, 
                      barrier.triangles = barrier.triangles, 
                      prior.range = prior.range, prior.sigma = prior.sigma,
                      range.fraction = range.fraction,
                      range = range,
                      set.inla.seed = set.inla.seed,
                      loc.data = loc.data, 
                      sigma.u = 1, sigma.epsilon = 0.2,
                      poly.original = poly.bar.orginal,
                      prior.range.st = prior.range,    
                      prior.sigma.st = prior.sigma)
corr[[3]] <- corr.model.tbm(id.node = id$id.node[[3]],
                      mesh = mesh, 
                      fem = fem, 
                      barrier.triangles = barrier.triangles, 
                      prior.range = prior.range, prior.sigma = prior.sigma,
                      range.fraction = range.fraction,
                      range = range,
                      set.inla.seed = set.inla.seed,
                      loc.data = loc.data, 
                      sigma.u = 1, sigma.epsilon = 0.2,
                      poly.original = poly.bar.orginal,
                      prior.range.st = prior.range,    
                      prior.sigma.st = prior.sigma)

fpp <- file.path("gif.sel/geom3.2", paste0("corr2points.pp799.png"))
png(fpp)
par(mfrow = c(3,3))
##tbm
local.plot.field_H(corr[[1]]$corr.tbm, mesh, zlim = c(0.1,1))
points(id$id.coord[[1]][1], id$id.coord[[1]][2], pch = 20)
plot(poly.bar.orginal, add=T) #, col = "snow3"
title(main = c("Transparent Barrier Model"))

local.plot.field_H(corr[[2]]$corr.tbm, mesh, zlim = c(0.1,1))
points(id$id.coord[[2]][1], id$id.coord[[2]][2], pch = 20)
plot(poly.bar.orginal, add=T)

local.plot.field_H(corr[[3]]$corr.tbm, mesh, zlim = c(0.1,1))
points(id$id.coord[[3]][1], id$id.coord[[3]][2], pch = 20)
plot(poly.bar.orginal, add=T)

##bm
local.plot.field_H(corr[[1]]$corr.bm, mesh, zlim = c(0.1,1))
points(id$id.coord[[1]][1], id$id.coord[[1]][2], pch = 20)
plot(poly.bar.orginal, add=T) #, col = "snow3"
title(main = c("Barrier Model"))

local.plot.field_H(corr[[2]]$corr.bm, mesh, zlim = c(0.1,1))
points(id$id.coord[[2]][1], id$id.coord[[2]][2], pch = 20)
plot(poly.bar.orginal, add=T)

local.plot.field_H(corr[[3]]$corr.bm, mesh, zlim = c(0.1,1))
points(id$id.coord[[3]][1], id$id.coord[[3]][2], pch = 20)
plot(poly.bar.orginal, add=T)

##st
local.plot.field_H(corr[[1]]$corr.st, mesh, zlim = c(0.1,1))
points(id$id.coord[[1]][1], id$id.coord[[1]][2], pch = 20)
plot(poly.bar.orginal, add=T) #, col = "snow3"
title(main = c("Stationary Model"))

local.plot.field_H(corr[[2]]$corr.st, mesh, zlim = c(0.1,1))
points(id$id.coord[[2]][1], id$id.coord[[2]][2], pch = 20)
plot(poly.bar.orginal, add=T)

local.plot.field_H(corr[[3]]$corr.st, mesh, zlim = c(0.1,1))
points(id$id.coord[[3]][1], id$id.coord[[3]][2], pch = 20)
plot(poly.bar.orginal, add=T)

dev.off()

##geom3.3

range.fraction <- c(0.5, 0.01)
corr <- list()
corr[[1]] <- corr.model.tbm(id.node = id$id.node[[1]],
                      mesh = mesh, 
                      fem = fem, 
                      barrier.triangles = barrier.triangles, 
                      prior.range = prior.range, prior.sigma = prior.sigma,
                      range.fraction = range.fraction,
                      range = range,
                      set.inla.seed = set.inla.seed,
                      loc.data = loc.data, 
                      sigma.u = 1, sigma.epsilon = 0.2,
                      poly.original = poly.bar.orginal,
                      prior.range.st = prior.range,    
                      prior.sigma.st = prior.sigma)
corr[[2]] <- corr.model.tbm(id.node = id$id.node[[2]],
                      mesh = mesh, 
                      fem = fem, 
                      barrier.triangles = barrier.triangles, 
                      prior.range = prior.range, prior.sigma = prior.sigma,
                      range.fraction = range.fraction,
                      range = range,
                      set.inla.seed = set.inla.seed,
                      loc.data = loc.data, 
                      sigma.u = 1, sigma.epsilon = 0.2,
                      poly.original = poly.bar.orginal,
                      prior.range.st = prior.range,    
                      prior.sigma.st = prior.sigma)
corr[[3]] <- corr.model.tbm(id.node = id$id.node[[3]],
                      mesh = mesh, 
                      fem = fem, 
                      barrier.triangles = barrier.triangles, 
                      prior.range = prior.range, prior.sigma = prior.sigma,
                      range.fraction = range.fraction,
                      range = range,
                      set.inla.seed = set.inla.seed,
                      loc.data = loc.data, 
                      sigma.u = 1, sigma.epsilon = 0.2,
                      poly.original = poly.bar.orginal,
                      prior.range.st = prior.range,    
                      prior.sigma.st = prior.sigma)

fpp <- file.path("gif.sel/geom3.3", paste0("corr2points.pp799.png"))
png(fpp)
par(mfrow = c(3,3))
##tbm
local.plot.field_H(corr[[1]]$corr.tbm, mesh, zlim = c(0.1,1))
points(id$id.coord[[1]][1], id$id.coord[[1]][2], pch = 20)
plot(poly.bar.orginal, add=T) #, col = "snow3"
title(main = c("Transparent Barrier Model"))

local.plot.field_H(corr[[2]]$corr.tbm, mesh, zlim = c(0.1,1))
points(id$id.coord[[2]][1], id$id.coord[[2]][2], pch = 20)
plot(poly.bar.orginal, add=T)

local.plot.field_H(corr[[3]]$corr.tbm, mesh, zlim = c(0.1,1))
points(id$id.coord[[3]][1], id$id.coord[[3]][2], pch = 20)
plot(poly.bar.orginal, add=T)

##bm
local.plot.field_H(corr[[1]]$corr.bm, mesh, zlim = c(0.1,1))
points(id$id.coord[[1]][1], id$id.coord[[1]][2], pch = 20)
plot(poly.bar.orginal, add=T) #, col = "snow3"
title(main = c("Barrier Model"))

local.plot.field_H(corr[[2]]$corr.bm, mesh, zlim = c(0.1,1))
points(id$id.coord[[2]][1], id$id.coord[[2]][2], pch = 20)
plot(poly.bar.orginal, add=T)

local.plot.field_H(corr[[3]]$corr.bm, mesh, zlim = c(0.1,1))
points(id$id.coord[[3]][1], id$id.coord[[3]][2], pch = 20)
plot(poly.bar.orginal, add=T)

##st
local.plot.field_H(corr[[1]]$corr.st, mesh, zlim = c(0.1,1))
points(id$id.coord[[1]][1], id$id.coord[[1]][2], pch = 20)
plot(poly.bar.orginal, add=T) #, col = "snow3"
title(main = c("Stationary Model"))

local.plot.field_H(corr[[2]]$corr.st, mesh, zlim = c(0.1,1))
points(id$id.coord[[2]][1], id$id.coord[[2]][2], pch = 20)
plot(poly.bar.orginal, add=T)

local.plot.field_H(corr[[3]]$corr.st, mesh, zlim = c(0.1,1))
points(id$id.coord[[3]][1], id$id.coord[[3]][2], pch = 20)
plot(poly.bar.orginal, add=T)

dev.off()
```

```{r}
#run geom 3 84
range.fraction <- c(0.5, 0.5)
id <- id.node.tbm(mesh = mesh, location = location, npoint = nrow(location))
corr <- list()
corr[[1]] <- corr.model.tbm(id.node = id$id.node[[1]],
                      mesh = mesh, 
                      fem = fem, 
                      barrier.triangles = barrier.triangles, 
                      prior.range = prior.range, prior.sigma = prior.sigma,
                      range.fraction = range.fraction,
                      range = range,
                      set.inla.seed = set.inla.seed,
                      loc.data = loc.data, 
                      sigma.u = 1, sigma.epsilon = 0.2,
                      poly.original = poly.bar.orginal,
                      prior.range.st = prior.range,    
                      prior.sigma.st = prior.sigma)
corr[[2]] <- corr.model.tbm(id.node = id$id.node[[2]],
                      mesh = mesh, 
                      fem = fem, 
                      barrier.triangles = barrier.triangles, 
                      prior.range = prior.range, prior.sigma = prior.sigma,
                      range.fraction = range.fraction,
                      range = range,
                      set.inla.seed = set.inla.seed,
                      loc.data = loc.data, 
                      sigma.u = 1, sigma.epsilon = 0.2,
                      poly.original = poly.bar.orginal,
                      prior.range.st = prior.range,    
                      prior.sigma.st = prior.sigma)
corr[[3]] <- corr.model.tbm(id.node = id$id.node[[3]],
                      mesh = mesh, 
                      fem = fem, 
                      barrier.triangles = barrier.triangles, 
                      prior.range = prior.range, prior.sigma = prior.sigma,
                      range.fraction = range.fraction,
                      range = range,
                      set.inla.seed = set.inla.seed,
                      loc.data = loc.data, 
                      sigma.u = 1, sigma.epsilon = 0.2,
                      poly.original = poly.bar.orginal,
                      prior.range.st = prior.range,    
                      prior.sigma.st = prior.sigma)

fpp <- file.path("gif.sel/geom3", paste0("corr2points.pp84.png"))
png(fpp)
par(mfrow = c(3,3))
##tbm
local.plot.field_H(corr[[1]]$corr.tbm, mesh, zlim = c(0.1,1))
points(id$id.coord[[1]][1], id$id.coord[[1]][2], pch = 20)
plot(poly.bar.orginal, add=T) #, col = "snow3"
title(main = c("Transparent Barrier Model"))

local.plot.field_H(corr[[2]]$corr.tbm, mesh, zlim = c(0.1,1))
points(id$id.coord[[2]][1], id$id.coord[[2]][2], pch = 20)
plot(poly.bar.orginal, add=T)

local.plot.field_H(corr[[3]]$corr.tbm, mesh, zlim = c(0.1,1))
points(id$id.coord[[3]][1], id$id.coord[[3]][2], pch = 20)
plot(poly.bar.orginal, add=T)

##bm
local.plot.field_H(corr[[1]]$corr.bm, mesh, zlim = c(0.1,1))
points(id$id.coord[[1]][1], id$id.coord[[1]][2], pch = 20)
plot(poly.bar.orginal, add=T) #, col = "snow3"
title(main = c("Barrier Model"))

local.plot.field_H(corr[[2]]$corr.bm, mesh, zlim = c(0.1,1))
points(id$id.coord[[2]][1], id$id.coord[[2]][2], pch = 20)
plot(poly.bar.orginal, add=T)

local.plot.field_H(corr[[3]]$corr.bm, mesh, zlim = c(0.1,1))
points(id$id.coord[[3]][1], id$id.coord[[3]][2], pch = 20)
plot(poly.bar.orginal, add=T)

##st
local.plot.field_H(corr[[1]]$corr.st, mesh, zlim = c(0.1,1))
points(id$id.coord[[1]][1], id$id.coord[[1]][2], pch = 20)
plot(poly.bar.orginal, add=T) #, col = "snow3"
title(main = c("Stationary Model"))

local.plot.field_H(corr[[2]]$corr.st, mesh, zlim = c(0.1,1))
points(id$id.coord[[2]][1], id$id.coord[[2]][2], pch = 20)
plot(poly.bar.orginal, add=T)

local.plot.field_H(corr[[3]]$corr.st, mesh, zlim = c(0.1,1))
points(id$id.coord[[3]][1], id$id.coord[[3]][2], pch = 20)
plot(poly.bar.orginal, add=T)

dev.off()

##geom3.2

range.fraction <- c(0.01, 0.5)
corr <- list()
corr[[1]] <- corr.model.tbm(id.node = id$id.node[[1]],
                      mesh = mesh, 
                      fem = fem, 
                      barrier.triangles = barrier.triangles, 
                      prior.range = prior.range, prior.sigma = prior.sigma,
                      range.fraction = range.fraction,
                      range = range,
                      set.inla.seed = set.inla.seed,
                      loc.data = loc.data, 
                      sigma.u = 1, sigma.epsilon = 0.2,
                      poly.original = poly.bar.orginal,
                      prior.range.st = prior.range,    
                      prior.sigma.st = prior.sigma)
corr[[2]] <- corr.model.tbm(id.node = id$id.node[[2]],
                      mesh = mesh, 
                      fem = fem, 
                      barrier.triangles = barrier.triangles, 
                      prior.range = prior.range, prior.sigma = prior.sigma,
                      range.fraction = range.fraction,
                      range = range,
                      set.inla.seed = set.inla.seed,
                      loc.data = loc.data, 
                      sigma.u = 1, sigma.epsilon = 0.2,
                      poly.original = poly.bar.orginal,
                      prior.range.st = prior.range,    
                      prior.sigma.st = prior.sigma)
corr[[3]] <- corr.model.tbm(id.node = id$id.node[[3]],
                      mesh = mesh, 
                      fem = fem, 
                      barrier.triangles = barrier.triangles, 
                      prior.range = prior.range, prior.sigma = prior.sigma,
                      range.fraction = range.fraction,
                      range = range,
                      set.inla.seed = set.inla.seed,
                      loc.data = loc.data, 
                      sigma.u = 1, sigma.epsilon = 0.2,
                      poly.original = poly.bar.orginal,
                      prior.range.st = prior.range,    
                      prior.sigma.st = prior.sigma)

fpp <- file.path("gif.sel/geom3.2", paste0("corr2points.pp84.png"))
png(fpp)
par(mfrow = c(3,3))
##tbm
local.plot.field_H(corr[[1]]$corr.tbm, mesh, zlim = c(0.1,1))
points(id$id.coord[[1]][1], id$id.coord[[1]][2], pch = 20)
plot(poly.bar.orginal, add=T) #, col = "snow3"
title(main = c("Transparent Barrier Model"))

local.plot.field_H(corr[[2]]$corr.tbm, mesh, zlim = c(0.1,1))
points(id$id.coord[[2]][1], id$id.coord[[2]][2], pch = 20)
plot(poly.bar.orginal, add=T)

local.plot.field_H(corr[[3]]$corr.tbm, mesh, zlim = c(0.1,1))
points(id$id.coord[[3]][1], id$id.coord[[3]][2], pch = 20)
plot(poly.bar.orginal, add=T)

##bm
local.plot.field_H(corr[[1]]$corr.bm, mesh, zlim = c(0.1,1))
points(id$id.coord[[1]][1], id$id.coord[[1]][2], pch = 20)
plot(poly.bar.orginal, add=T) #, col = "snow3"
title(main = c("Barrier Model"))

local.plot.field_H(corr[[2]]$corr.bm, mesh, zlim = c(0.1,1))
points(id$id.coord[[2]][1], id$id.coord[[2]][2], pch = 20)
plot(poly.bar.orginal, add=T)

local.plot.field_H(corr[[3]]$corr.bm, mesh, zlim = c(0.1,1))
points(id$id.coord[[3]][1], id$id.coord[[3]][2], pch = 20)
plot(poly.bar.orginal, add=T)

##st
local.plot.field_H(corr[[1]]$corr.st, mesh, zlim = c(0.1,1))
points(id$id.coord[[1]][1], id$id.coord[[1]][2], pch = 20)
plot(poly.bar.orginal, add=T) #, col = "snow3"
title(main = c("Stationary Model"))

local.plot.field_H(corr[[2]]$corr.st, mesh, zlim = c(0.1,1))
points(id$id.coord[[2]][1], id$id.coord[[2]][2], pch = 20)
plot(poly.bar.orginal, add=T)

local.plot.field_H(corr[[3]]$corr.st, mesh, zlim = c(0.1,1))
points(id$id.coord[[3]][1], id$id.coord[[3]][2], pch = 20)
plot(poly.bar.orginal, add=T)

dev.off()

##geom3.3

range.fraction <- c(0.5, 0.01)
corr <- list()
corr[[1]] <- corr.model.tbm(id.node = id$id.node[[1]],
                      mesh = mesh, 
                      fem = fem, 
                      barrier.triangles = barrier.triangles, 
                      prior.range = prior.range, prior.sigma = prior.sigma,
                      range.fraction = range.fraction,
                      range = range,
                      set.inla.seed = set.inla.seed,
                      loc.data = loc.data, 
                      sigma.u = 1, sigma.epsilon = 0.2,
                      poly.original = poly.bar.orginal,
                      prior.range.st = prior.range,    
                      prior.sigma.st = prior.sigma)
corr[[2]] <- corr.model.tbm(id.node = id$id.node[[2]],
                      mesh = mesh, 
                      fem = fem, 
                      barrier.triangles = barrier.triangles, 
                      prior.range = prior.range, prior.sigma = prior.sigma,
                      range.fraction = range.fraction,
                      range = range,
                      set.inla.seed = set.inla.seed,
                      loc.data = loc.data, 
                      sigma.u = 1, sigma.epsilon = 0.2,
                      poly.original = poly.bar.orginal,
                      prior.range.st = prior.range,    
                      prior.sigma.st = prior.sigma)
corr[[3]] <- corr.model.tbm(id.node = id$id.node[[3]],
                      mesh = mesh, 
                      fem = fem, 
                      barrier.triangles = barrier.triangles, 
                      prior.range = prior.range, prior.sigma = prior.sigma,
                      range.fraction = range.fraction,
                      range = range,
                      set.inla.seed = set.inla.seed,
                      loc.data = loc.data, 
                      sigma.u = 1, sigma.epsilon = 0.2,
                      poly.original = poly.bar.orginal,
                      prior.range.st = prior.range,    
                      prior.sigma.st = prior.sigma)

fpp <- file.path("gif.sel/geom3.3", paste0("corr2points.pp84.png"))
png(fpp)
par(mfrow = c(3,3))
##tbm
local.plot.field_H(corr[[1]]$corr.tbm, mesh, zlim = c(0.1,1))
points(id$id.coord[[1]][1], id$id.coord[[1]][2], pch = 20)
plot(poly.bar.orginal, add=T) #, col = "snow3"
title(main = c("Transparent Barrier Model"))

local.plot.field_H(corr[[2]]$corr.tbm, mesh, zlim = c(0.1,1))
points(id$id.coord[[2]][1], id$id.coord[[2]][2], pch = 20)
plot(poly.bar.orginal, add=T)

local.plot.field_H(corr[[3]]$corr.tbm, mesh, zlim = c(0.1,1))
points(id$id.coord[[3]][1], id$id.coord[[3]][2], pch = 20)
plot(poly.bar.orginal, add=T)

##bm
local.plot.field_H(corr[[1]]$corr.bm, mesh, zlim = c(0.1,1))
points(id$id.coord[[1]][1], id$id.coord[[1]][2], pch = 20)
plot(poly.bar.orginal, add=T) #, col = "snow3"
title(main = c("Barrier Model"))

local.plot.field_H(corr[[2]]$corr.bm, mesh, zlim = c(0.1,1))
points(id$id.coord[[2]][1], id$id.coord[[2]][2], pch = 20)
plot(poly.bar.orginal, add=T)

local.plot.field_H(corr[[3]]$corr.bm, mesh, zlim = c(0.1,1))
points(id$id.coord[[3]][1], id$id.coord[[3]][2], pch = 20)
plot(poly.bar.orginal, add=T)

##st
local.plot.field_H(corr[[1]]$corr.st, mesh, zlim = c(0.1,1))
points(id$id.coord[[1]][1], id$id.coord[[1]][2], pch = 20)
plot(poly.bar.orginal, add=T) #, col = "snow3"
title(main = c("Stationary Model"))

local.plot.field_H(corr[[2]]$corr.st, mesh, zlim = c(0.1,1))
points(id$id.coord[[2]][1], id$id.coord[[2]][2], pch = 20)
plot(poly.bar.orginal, add=T)

local.plot.field_H(corr[[3]]$corr.st, mesh, zlim = c(0.1,1))
points(id$id.coord[[3]][1], id$id.coord[[3]][2], pch = 20)
plot(poly.bar.orginal, add=T)

dev.off()
```
corr.model.tbm <- 
             function(id.node = id.node,
                      mesh = mesh, 
                      fem = fem, 
                      barrier.triangles = barrier.triangles, 
                      prior.range = prior.range, prior.sigma = prior.sigma,
                      range.fraction = range.fraction,
                      range = range,
                      set.inla.seed = set.inla.seed, # make sure is the same as prev. fx if loc.data = T
                      loc.data = loc.data, 
                      sigma.u = 1, sigma.epsilon = 0.2,
                      poly.original = poly.bar.orginal,
                      prior.range.st = prior.range,    
                      prior.sigma.st = prior.sigma) 

```{r}
```

```{r}
#geom 1, and 1.2
SM <- c(1.5)
W <- c(2)
R <- 4
SS <- 874
fr <- 0.3
      
for (d in 1:length(SM)) {
  for (v in 1:length(W)) {
    for(r in 1:length(R)) { #3->| this 3 loops
      smalldist = SM[d]
      width = c(W[v],W[v])
      range = R[r]        
      max.edge.length = 0.4
      x.mid = 10
      xlim.big  = c(0,20)
      xlim.small = c(3,17)
      ylim.big = c(0,20)
      ylim.small = c(3,17)
      fr = fr
      prior.range = prior.range
      prior.sigma = c(1,0.1)
      sigma.u = 1
      sigma.epsilon = 0.2
      prior.range.st = prior.range
      prior.sigma.st = c(1,0.1)
          
        

      poly1 <- local.square.polygon(xlim=c(xlim.big[1]-1, x.mid-smalldist/2), 
                                    ylim=x.mid+width[1]*c(-.5, .5))

      poly2 <- local.square.polygon(xlim=c(x.mid+smalldist/2, xlim.big[2]+1), 
                                    ylim=x.mid+width[2]*c(-.5, .5))

      poly.original <- SpatialPolygons(c(poly1@polygons, poly2@polygons))
  
      loc1 <- matrix(c(xlim.big[1],ylim.big[1], 
                   xlim.big[2],ylim.big[1], 
                   xlim.big[2],ylim.big[2], 
                   xlim.big[1],ylim.big[2]), 4, 2, byrow = T)
  
      seg <- inla.sp2segment(poly.original)
      mesh <- inla.mesh.2d(loc=loc1, 
                       interior = seg, 
                       max.e = max.edge.length, 
                       offset=1)

      tl <- length(mesh$graph$tv[,1])
      posTri <- matrix(0, tl, 2)

      for (t in 1:tl){
        temp = mesh$loc[mesh$graph$tv[t, ], ]
        posTri[t,] = colMeans(temp)[c(1,2)] 
      }
      
      posTri <- SpatialPoints(posTri)
      bar.original <- over(poly.original, SpatialPoints(posTri), returnList=T)
      bar.original <- unlist(bar.original)
  
      #THIS TAKES A FEW SECONDS AND IT'S ACTUALLY NOT NEEDED IN EVERY LOOP, inla.barrier.polygon
      poly.bar.orginal <- inla.barrier.polygon(mesh, barrier.triangles = bar.original)

      # BARRIER 1
      bar1 <- over(poly1, SpatialPoints(posTri), returnList=T)
      bar1 <- unlist(bar1)
      poly.bar1 <- inla.barrier.polygon(mesh, barrier.triangles = bar1)

      # BARRIER 2
      bar2 <- over(poly2, SpatialPoints(posTri), returnList=T)
      bar2 <- unlist(bar2)
      poly.bar2 <- inla.barrier.polygon(mesh, barrier.triangles = bar2)

      mat <-  inla.barrier.fem.plus(mesh, list(bar1, bar2)) 
      fem <- mat 
      barrier.triangles <- list(bar1, bar2)

      # PLOTS
      poly1_h <- local.square.polygon_T(xlim=c(xlim.small[1], x.mid-smalldist/2), 
                                        ylim=x.mid+width[1]*c(-.5, .5))

      poly2_h <- local.square.polygon_T(xlim=c(x.mid+smalldist/2, xlim.small[2]), 
                                        ylim=x.mid+width[2]*c(-.5, .5))

      loc2 <- matrix(c(3,3, 17,3, 17,17, 3,17), 4, 2, byrow = T)

      locp2 <- Polygon(loc2, hole = FALSE)
    
      poly.water <- SpatialPolygons(list(Polygons(list(locp2, poly1_h, poly2_h), '0')))
      poly.water_sf <- st_as_sf(poly.water)
  
      #I'm missing the poly.rect and other that I need for the ggplot, but I don't need it for this loop
      nv <- mesh$n
      dmesh <- book.mesh.dual(mesh)

      domain.polys <- Polygons(list(Polygon(loc1)), '0')
      domainSP <- SpatialPolygons(list(domain.polys))
      domainSPsf <- st_as_sf(domainSP)

      dmesh_sf <- st_as_sf(dmesh) 

      # with sapply
      w <- sapply(1:length(dmesh), function(i) {
        if (length(st_intersects(dmesh_sf[i, ], domainSPsf)[[1]]) == 1)
          return(st_area(st_intersection(dmesh_sf[i, ], domainSPsf)))
        else {
          return(0)
        }
      })
      
      #SAME AS THE GAUSSIAN FIELD UNTIL HERE
      win <- polyCub::as.owin.SpatialPolygons(poly.water)
      npix <- 300
      spatstat.options(npixel = npix)

      beta0 <- -2
      sigma2x <- 0.01
      nu <- 1
  
      #START LOOP FOR SEED
      for (s in 1:length(SS)) { #4->| SS loop
        set.inla.seed = SS[s]
        
        # common for geom 1, and geom 1.2
        set.seed(set.inla.seed) 
        lg.s <- rLGCP('matern', beta0, var = sigma2x,
                   scale = range / sqrt(8), 
                   nu = nu, win = win)

        xy <- cbind(lg.s$x, lg.s$y)
        loc.data <- SpatialPoints(xy)
        loc.data_sf <- st_as_sf(loc.data)

        Lam <- attr(lg.s, 'Lambda')
        rf.s <- log(Lam$v)

        n <- nrow(xy)
        y.pp <- rep(0:1, c(nv, n))
        e.pp <- c(w, rep(0, n)) 
        imat <- Diagonal(nv, rep(1, nv))
        lmat <- inla.spde.make.A(mesh, xy)
        A.pp <- rbind(imat, lmat)
  
        stk.pp <- inla.stack(
          data = list(y = y.pp, e = e.pp), 
          A = list(1, A.pp),
          effects = list(list(b0 = rep(1, nv + n)), list(i = 1:nv)),
          tag = 'pp')
   
        tbm.frac <- list()
        
        # FOR geom1
        fp <- file.path("gif.sel/geom1", paste0("sm", SM[d], "w", W[v], "r", R[r], "seed", SS[s], "/"))
                        dir.create(fp, recursive = TRUE)
        gif.path = fp
        marginals.path = fp

        for (p in 1:length(fr)) { #
          f <- fr[p]
          range.fraction <- c(f, f)
          tbm.frac[[p]] <- model.tbm.plus.pp(mesh = mesh, fem = fem, 
                               stk.pp = stk.pp,
                               barrier.triangles = barrier.triangles,
                               prior.range = prior.range, prior.sigma = prior.sigma ,  
                               range.fraction = range.fraction,
                               range = range,
                               set.inla.seed = set.inla.seed,
                               loc.data = loc.data,
                               sigma.u = 1, sigma.epsilon = 0.2,
                               poly.original = poly.bar.orginal,
                               prior.range.st = prior.range.st,
                               prior.sigma.st = prior.sigma.st,
                               return.list = TRUE)
        }
        trans <- tbm.frac
        trans.geom1 <- trans
        plot.model.tbm.plus.pp(trans, 
                       fr,
                       poly.bar.orginal = poly.bar.orginal,
                       range = range,
                       fps = 1,
                       gif.path = fp)

  
        for (r in 1:length(trans)) {
          f <- fr[p]
          range.fraction <- c(f, f)
          fpp <- file.path(paste0(marginals.path, f, ".png"))
          png(fpp)
          par(mfrow = c(3, 1))
          tmp = inla.tmarginal(function(x) exp(x), trans[[p]]$pos.tbm$res$marginals.hyperpar[[2]]) 
          plot(tmp, type = "l", xlab = "r", ylab = "Density TBM")
          xvals = seq(0, 10, length.out=1000)
          abline(v=range, col="blue")
    
          tmp = inla.tmarginal(function(x) exp(x), trans[[p]]$pos.bm$res$marginals.hyperpar[[2]]) 
          plot(tmp, type = "l", xlab = "r", ylab = "Density BM")
          xvals = seq(0, 10, length.out=1000)
          abline(v=range, col="blue")
  
          tmp = inla.tmarginal(function(x) (x), trans[[p]]$pos.st$res$marginals.hyperpar[[1]]) 
          plot(tmp, type = "l", xlab = "r", ylab = "Density st")
          xvals = seq(0, 10, length.out=1000)
          abline(v=range, col="blue")
          dev.off()
        }
        
        # FOR geom1.2
        fp <- file.path("gif.sel/geom1.2", paste0("sm", SM[d], "w", W[v], "r", R[r], "seed", SS[s], "/"))
        dir.create(fp, recursive = TRUE)
        gif.path = fp
        marginals.path = fp

        for (p in 1:length(fr)) {
          f <- fr[p]
          range.fraction <- c(0.01, f)
          tbm.frac[[p]] <- model.tbm.plus.pp(mesh = mesh, fem = fem, 
                               stk.pp = stk.pp,
                               barrier.triangles = barrier.triangles,
                               prior.range = prior.range, prior.sigma = prior.sigma ,  
                               range.fraction = range.fraction,
                               range = range,
                               set.inla.seed = set.inla.seed,
                               loc.data = loc.data,
                               sigma.u = 1, sigma.epsilon = 0.2,
                               poly.original = poly.bar.orginal,
                               prior.range.st = prior.range.st,
                               prior.sigma.st = prior.sigma.st,
                               return.list = TRUE)
        }
        
        trans <- tbm.frac
        trans.geom1.1 <- trans
        plot.model.tbm.plus.pp.01l(trans, 
                       fr,
                       poly.bar.orginal = poly.bar.orginal,
                       range = range,
                       fps = 1,
                       gif.path = fp)
        
        for (r in 1:length(trans)) {
          f <- fr[p]
          range.fraction <- c(0.01, f)
          fpp <- file.path(paste0(marginals.path, f, ".png"))
          png(fpp)
          par(mfrow = c(3, 1))
          tmp = inla.tmarginal(function(x) exp(x), trans[[p]]$pos.tbm$res$marginals.hyperpar[[2]]) 
          plot(tmp, type = "l", xlab = "r", ylab = "Density TBM")
          xvals = seq(0, 10, length.out=1000)
          abline(v=range, col="blue")
    
          tmp = inla.tmarginal(function(x) exp(x), trans[[p]]$pos.bm$res$marginals.hyperpar[[2]]) 
          plot(tmp, type = "l", xlab = "r", ylab = "Density BM")
          xvals = seq(0, 10, length.out=1000)
          abline(v=range, col="blue")
  
          tmp = inla.tmarginal(function(x) (x), trans[[p]]$pos.st$res$marginals.hyperpar[[1]]) 
          plot(tmp, type = "l", xlab = "r", ylab = "Density st")
          xvals = seq(0, 10, length.out=1000)
          abline(v=range, col="blue")
          
          dev.off()
        }
      }
    }
  }
}
```



for article/plots
geom 3.2
sm1.5wl1wr4r2seed84
```{r}
#3.2
prior.range = c(1, 0.5); prior.sigma = c(1, 0.1)
SM <- c(1.5)
Wl <- c(1)
Wr <- c(4)
R <- 4
SS <- 799
fr <- c(0.01, 0.2, 0.3, 0.4, 0.5,0.7,0.8,1)
#fr <- c(0.01, 0.2, 0.3, 0.4, 0.5,0.7,0.8,1)
      
for (d in 1:length(SM)) {
  for (v in 1:length(Wl)) {
    for(r in 1:length(R)) { #3->| this 3 loops
      smalldist = SM[d]
      width = c(Wl[v],Wr[v])
      range = R[r]        
      max.edge.length = 0.4
      x.mid = 10
      xlim.big  = c(0,20)
      xlim.small = c(3,17)
      ylim.big = c(0,20)
      ylim.small = c(3,17)
      fr = fr
      prior.range = prior.range
      prior.sigma = c(1,0.1)
      sigma.u = 1
      sigma.epsilon = 0.2
      prior.range.st = prior.range
      prior.sigma.st = c(1,0.1)
          
        

      poly1 <- local.square.polygon(xlim=c(xlim.big[1]-1, x.mid-smalldist/2), 
                                    ylim=x.mid+width[1]*c(-.5, .5))

      poly2 <- local.square.polygon(xlim=c(x.mid+smalldist/2, xlim.big[2]+1), 
                                    ylim=x.mid+width[2]*c(-.5, .5))

      poly.original <- SpatialPolygons(c(poly1@polygons, poly2@polygons))
  
      loc1 <- matrix(c(xlim.big[1],ylim.big[1], 
                   xlim.big[2],ylim.big[1], 
                   xlim.big[2],ylim.big[2], 
                   xlim.big[1],ylim.big[2]), 4, 2, byrow = T)
  
      seg <- inla.sp2segment(poly.original)
      mesh <- inla.mesh.2d(loc=loc1, 
                       interior = seg, 
                       max.e = max.edge.length, 
                       offset=1)

      tl <- length(mesh$graph$tv[,1])
      posTri <- matrix(0, tl, 2)

      for (t in 1:tl){
        temp = mesh$loc[mesh$graph$tv[t, ], ]
        posTri[t,] = colMeans(temp)[c(1,2)] 
      }
      
      posTri <- SpatialPoints(posTri)
      bar.original <- over(poly.original, SpatialPoints(posTri), returnList=T)
      bar.original <- unlist(bar.original)
  
      #THIS TAKES A FEW SECONDS AND IT'S ACTUALLY NOT NEEDED IN EVERY LOOP, inla.barrier.polygon
      poly.bar.orginal <- inla.barrier.polygon(mesh, barrier.triangles = bar.original)

      # BARRIER 1
      bar1 <- over(poly1, SpatialPoints(posTri), returnList=T)
      bar1 <- unlist(bar1)

      # BARRIER 2
      bar2 <- over(poly2, SpatialPoints(posTri), returnList=T)
      bar2 <- unlist(bar2)

      mat <-  inla.barrier.fem.plus(mesh, list(bar1, bar2)) 
      fem <- mat 
      barrier.triangles <- list(bar1, bar2)

      # PLOTS
      poly1_h <- local.square.polygon_T(xlim=c(xlim.small[1], x.mid-smalldist/2), 
                                        ylim=x.mid+width[1]*c(-.5, .5))

      poly2_h <- local.square.polygon_T(xlim=c(x.mid+smalldist/2, xlim.small[2]), 
                                        ylim=x.mid+width[2]*c(-.5, .5))

      loc2 <- matrix(c(3,3, 17,3, 17,17, 3,17), 4, 2, byrow = T)

      locp2 <- Polygon(loc2, hole = FALSE)
    
      poly.water <- SpatialPolygons(list(Polygons(list(locp2, poly1_h, poly2_h), '0')))
      poly.water_sf <- st_as_sf(poly.water)
  
      #I'm missing the poly.rect and other that I need for the ggplot, but I don't need it for this loop
      nv <- mesh$n
      dmesh <- book.mesh.dual(mesh)

      domain.polys <- Polygons(list(Polygon(loc1)), '0')
      domainSP <- SpatialPolygons(list(domain.polys))
      domainSPsf <- st_as_sf(domainSP)

      dmesh_sf <- st_as_sf(dmesh) 

      # with sapply
      w <- sapply(1:length(dmesh), function(i) {
        if (length(st_intersects(dmesh_sf[i, ], domainSPsf)[[1]]) == 1)
          return(st_area(st_intersection(dmesh_sf[i, ], domainSPsf)))
        else {
          return(0)
        }
      })
      
      #SAME AS THE GAUSSIAN FIELD UNTIL HERE
      win <- polyCub::as.owin.SpatialPolygons(poly.water)
      npix <- 300
      spatstat.options(npixel = npix)

      beta0 <- -2
      sigma2x <- 0.01
      nu <- 1
  
      #START LOOP FOR SEED
      for (s in 1:length(SS)) { #4->| SS loop
        set.inla.seed = SS[s]
        
        # common for geom 3, and geom 3.2
        set.seed(set.inla.seed) 
        lg.s <- rLGCP('matern', beta0, var = sigma2x,
                   scale = range / sqrt(8), 
                   nu = nu, win = win)

        xy <- cbind(lg.s$x, lg.s$y)
        loc.data <- SpatialPoints(xy)
        loc.data_sf <- st_as_sf(loc.data)

        Lam <- attr(lg.s, 'Lambda')
        rf.s <- log(Lam$v)

        n <- nrow(xy)
        y.pp <- rep(0:1, c(nv, n))
        e.pp <- c(w, rep(0, n)) 
        imat <- Diagonal(nv, rep(1, nv))
        lmat <- inla.spde.make.A(mesh, xy)
        A.pp <- rbind(imat, lmat)
  
        stk.pp <- inla.stack(
          data = list(y = y.pp, e = e.pp), 
          A = list(1, A.pp),
          effects = list(list(b0 = rep(1, nv + n)), list(i = 1:nv)),
          tag = 'pp')
   
        tbm.frac <- list()
        
        
        # FOR geom3.2
        for (p in 1:length(fr)) {
          
          fp <- file.path("plots", paste0("sm", SM[d], "wl", Wl[v], "wr", Wr[v], "r", R[r], "seed", SS[s], "fr",fr[p], "/"))
                        dir.create(fp, recursive = TRUE)
          dir.create(fp, recursive = TRUE)
          gif.path = fp
          marginals.path = fp

          f <- fr[p]
          range.fraction <- c(0.01, f)
          tbm.frac[[p]] <- model.tbm.plus.pp(mesh = mesh, fem = fem, 
                               stk.pp = stk.pp,
                               barrier.triangles = barrier.triangles,
                               prior.range = prior.range, prior.sigma = prior.sigma ,  
                               range.fraction = range.fraction,
                               range = range,
                               set.inla.seed = set.inla.seed,
                               loc.data = loc.data,
                               sigma.u = 1, sigma.epsilon = 0.2,
                               poly.original = poly.bar.orginal,
                               prior.range.st = prior.range.st,
                               prior.sigma.st = prior.sigma.st,
                               return.list = TRUE)
          
          trans[[1]] <- tbm.frac[[p]]
          plot.model.tbm.plus.pp.01l.z(trans, 
                       fr,
                       poly.bar.orginal = poly.bar.orginal,
                       range = range,
                       fps = 1,
                       gif.path = fp)
          
          fpp <- file.path(paste0(marginals.path, "tbm", f, ".png"))
          png(fpp)
          #par(mfrow = c(3, 1))
          tmp = inla.tmarginal(function(x) exp(x), trans[[1]]$pos.tbm$res$marginals.hyperpar[[2]]) 
          plot(tmp, type = "l", xlab = "r", ylab = "Density", xlim = c(0,10))
          xvals = seq(0, 10, length.out=1000)
          abline(v=range, col="blue")
          dev.off()
          
          fpp <- file.path(paste0(marginals.path, "bm", f, ".png"))
          png(fpp)
          tmp = inla.tmarginal(function(x) exp(x), trans[[1]]$pos.bm$res$marginals.hyperpar[[2]]) 
          plot(tmp, type = "l", xlab = "r", ylab = "Density", xlim = c(0,10))
          xvals = seq(0, 10, length.out=1000)
          abline(v=range, col="blue")
          dev.off()
  
          fpp <- file.path(paste0(marginals.path, "st", f, ".png"))
          png(fpp)
          tmp = inla.tmarginal(function(x) (x), trans[[1]]$pos.st$res$marginals.hyperpar[[1]]) 
          plot(tmp, type = "l", xlab = "r", ylab = "Density", xlim = c(0,10))
          xvals = seq(0, 10, length.out=1000)
          abline(v=range, col="blue")
          dev.off()
        }
        
        
      }
    }
  }
}
```

geom3
sm1.5wl1wr4r2seed84fr0.01
```{r}
#3.2
prior.range = c(1, 0.5); prior.sigma = c(1, 0.1)
SM <- c(1.5)
Wl <- c(1)
Wr <- c(4)
R <- 2
SS <- 84
fr <- c(0.01, 0.2, 0.3, 0.4, 0.5,0.7,0.8,1)
#fr <- c(0.01, 0.2, 0.3, 0.4, 0.5,0.7,0.8,1)
      
for (d in 1:length(SM)) {
  for (v in 1:length(Wl)) {
    for(r in 1:length(R)) { #3->| this 3 loops
      smalldist = SM[d]
      width = c(Wl[v],Wr[v])
      range = R[r]        
      max.edge.length = 0.4
      x.mid = 10
      xlim.big  = c(0,20)
      xlim.small = c(3,17)
      ylim.big = c(0,20)
      ylim.small = c(3,17)
      fr = fr
      prior.range = prior.range
      prior.sigma = c(1,0.1)
      sigma.u = 1
      sigma.epsilon = 0.2
      prior.range.st = prior.range
      prior.sigma.st = c(1,0.1)
          
        

      poly1 <- local.square.polygon(xlim=c(xlim.big[1]-1, x.mid-smalldist/2), 
                                    ylim=x.mid+width[1]*c(-.5, .5))

      poly2 <- local.square.polygon(xlim=c(x.mid+smalldist/2, xlim.big[2]+1), 
                                    ylim=x.mid+width[2]*c(-.5, .5))

      poly.original <- SpatialPolygons(c(poly1@polygons, poly2@polygons))
  
      loc1 <- matrix(c(xlim.big[1],ylim.big[1], 
                   xlim.big[2],ylim.big[1], 
                   xlim.big[2],ylim.big[2], 
                   xlim.big[1],ylim.big[2]), 4, 2, byrow = T)
  
      seg <- inla.sp2segment(poly.original)
      mesh <- inla.mesh.2d(loc=loc1, 
                       interior = seg, 
                       max.e = max.edge.length, 
                       offset=1)

      tl <- length(mesh$graph$tv[,1])
      posTri <- matrix(0, tl, 2)

      for (t in 1:tl){
        temp = mesh$loc[mesh$graph$tv[t, ], ]
        posTri[t,] = colMeans(temp)[c(1,2)] 
      }
      
      posTri <- SpatialPoints(posTri)
      bar.original <- over(poly.original, SpatialPoints(posTri), returnList=T)
      bar.original <- unlist(bar.original)
  
      #THIS TAKES A FEW SECONDS AND IT'S ACTUALLY NOT NEEDED IN EVERY LOOP, inla.barrier.polygon
      poly.bar.orginal <- inla.barrier.polygon(mesh, barrier.triangles = bar.original)

      # BARRIER 1
      bar1 <- over(poly1, SpatialPoints(posTri), returnList=T)
      bar1 <- unlist(bar1)

      # BARRIER 2
      bar2 <- over(poly2, SpatialPoints(posTri), returnList=T)
      bar2 <- unlist(bar2)

      mat <-  inla.barrier.fem.plus(mesh, list(bar1, bar2)) 
      fem <- mat 
      barrier.triangles <- list(bar1, bar2)

      # PLOTS
      poly1_h <- local.square.polygon_T(xlim=c(xlim.small[1], x.mid-smalldist/2), 
                                        ylim=x.mid+width[1]*c(-.5, .5))

      poly2_h <- local.square.polygon_T(xlim=c(x.mid+smalldist/2, xlim.small[2]), 
                                        ylim=x.mid+width[2]*c(-.5, .5))

      loc2 <- matrix(c(3,3, 17,3, 17,17, 3,17), 4, 2, byrow = T)

      locp2 <- Polygon(loc2, hole = FALSE)
    
      poly.water <- SpatialPolygons(list(Polygons(list(locp2, poly1_h, poly2_h), '0')))
      poly.water_sf <- st_as_sf(poly.water)
  
      #I'm missing the poly.rect and other that I need for the ggplot, but I don't need it for this loop
      nv <- mesh$n
      dmesh <- book.mesh.dual(mesh)

      domain.polys <- Polygons(list(Polygon(loc1)), '0')
      domainSP <- SpatialPolygons(list(domain.polys))
      domainSPsf <- st_as_sf(domainSP)

      dmesh_sf <- st_as_sf(dmesh) 

      # with sapply
      w <- sapply(1:length(dmesh), function(i) {
        if (length(st_intersects(dmesh_sf[i, ], domainSPsf)[[1]]) == 1)
          return(st_area(st_intersection(dmesh_sf[i, ], domainSPsf)))
        else {
          return(0)
        }
      })
      
      #SAME AS THE GAUSSIAN FIELD UNTIL HERE
      win <- polyCub::as.owin.SpatialPolygons(poly.water)
      npix <- 300
      spatstat.options(npixel = npix)

      beta0 <- -2
      sigma2x <- 0.01
      nu <- 1
  
      #START LOOP FOR SEED
      for (s in 1:length(SS)) { #4->| SS loop
        set.inla.seed = SS[s]
        
        # common for geom 3, and geom 3.2
        set.seed(set.inla.seed) 
        lg.s <- rLGCP('matern', beta0, var = sigma2x,
                   scale = range / sqrt(8), 
                   nu = nu, win = win)

        xy <- cbind(lg.s$x, lg.s$y)
        loc.data <- SpatialPoints(xy)
        loc.data_sf <- st_as_sf(loc.data)

        Lam <- attr(lg.s, 'Lambda')
        rf.s <- log(Lam$v)

        n <- nrow(xy)
        y.pp <- rep(0:1, c(nv, n))
        e.pp <- c(w, rep(0, n)) 
        imat <- Diagonal(nv, rep(1, nv))
        lmat <- inla.spde.make.A(mesh, xy)
        A.pp <- rbind(imat, lmat)
  
        stk.pp <- inla.stack(
          data = list(y = y.pp, e = e.pp), 
          A = list(1, A.pp),
          effects = list(list(b0 = rep(1, nv + n)), list(i = 1:nv)),
          tag = 'pp')
   
        tbm.frac <- list()
        
        
        # FOR geom3.2
        for (p in 1:length(fr)) {
          
          fp <- file.path("plots", paste0("sm", SM[d], "wl", Wl[v], "wr", Wr[v], "r", R[r], "seed", SS[s], "fr",fr[p], "/"))
                        dir.create(fp, recursive = TRUE)
          dir.create(fp, recursive = TRUE)
          gif.path = fp
          marginals.path = fp

          f <- fr[p]
          range.fraction <- c(0.01, f)
          tbm.frac[[p]] <- model.tbm.plus.pp(mesh = mesh, fem = fem, 
                               stk.pp = stk.pp,
                               barrier.triangles = barrier.triangles,
                               prior.range = prior.range, prior.sigma = prior.sigma ,  
                               range.fraction = range.fraction,
                               range = range,
                               set.inla.seed = set.inla.seed,
                               loc.data = loc.data,
                               sigma.u = 1, sigma.epsilon = 0.2,
                               poly.original = poly.bar.orginal,
                               prior.range.st = prior.range.st,
                               prior.sigma.st = prior.sigma.st,
                               return.list = TRUE)
          
          trans[[1]] <- tbm.frac[[p]]
          plot.model.tbm.plus.pp(trans, 
                       fr,
                       poly.bar.orginal = poly.bar.orginal,
                       range = range,
                       fps = 1,
                       gif.path = fp)
          
          fpp <- file.path(paste0(marginals.path, "tbm", f, ".png"))
          png(fpp)
          #par(mfrow = c(3, 1))
          tmp = inla.tmarginal(function(x) exp(x), trans[[1]]$pos.tbm$res$marginals.hyperpar[[2]]) 
          plot(tmp, type = "l", xlab = "r", ylab = "Density", xlim = c(0,10))
          xvals = seq(0, 10, length.out=1000)
          abline(v=range, col="blue")
          dev.off()
          
          fpp <- file.path(paste0(marginals.path, "bm", f, ".png"))
          png(fpp)
          tmp = inla.tmarginal(function(x) exp(x), trans[[1]]$pos.bm$res$marginals.hyperpar[[2]]) 
          plot(tmp, type = "l", xlab = "r", ylab = "Density", xlim = c(0,10))
          xvals = seq(0, 10, length.out=1000)
          abline(v=range, col="blue")
          dev.off()
  
          fpp <- file.path(paste0(marginals.path, "st", f, ".png"))
          png(fpp)
          tmp = inla.tmarginal(function(x) (x), trans[[1]]$pos.st$res$marginals.hyperpar[[1]]) 
          plot(tmp, type = "l", xlab = "r", ylab = "Density", xlim = c(0,10))
          xvals = seq(0, 10, length.out=1000)
          abline(v=range, col="blue")
          dev.off()
        }
        
        
      }
    }
  }
}
```

geom 3.2

sm1.5wl1wr4r2seed84fr0.2

```{r}
#3.2
prior.range = c(1, 0.5); prior.sigma = c(1, 0.1)
SM <- c(1.5)
Wl <- c(1)
Wr <- c(4)
R <- 2
SS <- 84
fr <- c(0.01, 0.2, 0.3, 0.4, 0.5,0.7,0.8,1)
#fr <- c(0.01, 0.2, 0.3, 0.4, 0.5,0.7,0.8,1)
      
for (d in 1:length(SM)) {
  for (v in 1:length(Wl)) {
    for(r in 1:length(R)) { #3->| this 3 loops
      smalldist = SM[d]
      width = c(Wl[v],Wr[v])
      range = R[r]        
      max.edge.length = 0.4
      x.mid = 10
      xlim.big  = c(0,20)
      xlim.small = c(3,17)
      ylim.big = c(0,20)
      ylim.small = c(3,17)
      fr = fr
      prior.range = prior.range
      prior.sigma = c(1,0.1)
      sigma.u = 1
      sigma.epsilon = 0.2
      prior.range.st = prior.range
      prior.sigma.st = c(1,0.1)
          
        

      poly1 <- local.square.polygon(xlim=c(xlim.big[1]-1, x.mid-smalldist/2), 
                                    ylim=x.mid+width[1]*c(-.5, .5))

      poly2 <- local.square.polygon(xlim=c(x.mid+smalldist/2, xlim.big[2]+1), 
                                    ylim=x.mid+width[2]*c(-.5, .5))

      poly.original <- SpatialPolygons(c(poly1@polygons, poly2@polygons))
  
      loc1 <- matrix(c(xlim.big[1],ylim.big[1], 
                   xlim.big[2],ylim.big[1], 
                   xlim.big[2],ylim.big[2], 
                   xlim.big[1],ylim.big[2]), 4, 2, byrow = T)
  
      seg <- inla.sp2segment(poly.original)
      mesh <- inla.mesh.2d(loc=loc1, 
                       interior = seg, 
                       max.e = max.edge.length, 
                       offset=1)

      tl <- length(mesh$graph$tv[,1])
      posTri <- matrix(0, tl, 2)

      for (t in 1:tl){
        temp = mesh$loc[mesh$graph$tv[t, ], ]
        posTri[t,] = colMeans(temp)[c(1,2)] 
      }
      
      posTri <- SpatialPoints(posTri)
      bar.original <- over(poly.original, SpatialPoints(posTri), returnList=T)
      bar.original <- unlist(bar.original)
  
      #THIS TAKES A FEW SECONDS AND IT'S ACTUALLY NOT NEEDED IN EVERY LOOP, inla.barrier.polygon
      poly.bar.orginal <- inla.barrier.polygon(mesh, barrier.triangles = bar.original)

      # BARRIER 1
      bar1 <- over(poly1, SpatialPoints(posTri), returnList=T)
      bar1 <- unlist(bar1)

      # BARRIER 2
      bar2 <- over(poly2, SpatialPoints(posTri), returnList=T)
      bar2 <- unlist(bar2)

      mat <-  inla.barrier.fem.plus(mesh, list(bar1, bar2)) 
      fem <- mat 
      barrier.triangles <- list(bar1, bar2)

      # PLOTS
      poly1_h <- local.square.polygon_T(xlim=c(xlim.small[1], x.mid-smalldist/2), 
                                        ylim=x.mid+width[1]*c(-.5, .5))

      poly2_h <- local.square.polygon_T(xlim=c(x.mid+smalldist/2, xlim.small[2]), 
                                        ylim=x.mid+width[2]*c(-.5, .5))

      loc2 <- matrix(c(3,3, 17,3, 17,17, 3,17), 4, 2, byrow = T)

      locp2 <- Polygon(loc2, hole = FALSE)
    
      poly.water <- SpatialPolygons(list(Polygons(list(locp2, poly1_h, poly2_h), '0')))
      poly.water_sf <- st_as_sf(poly.water)
  
      #I'm missing the poly.rect and other that I need for the ggplot, but I don't need it for this loop
      nv <- mesh$n
      dmesh <- book.mesh.dual(mesh)

      domain.polys <- Polygons(list(Polygon(loc1)), '0')
      domainSP <- SpatialPolygons(list(domain.polys))
      domainSPsf <- st_as_sf(domainSP)

      dmesh_sf <- st_as_sf(dmesh) 

      # with sapply
      w <- sapply(1:length(dmesh), function(i) {
        if (length(st_intersects(dmesh_sf[i, ], domainSPsf)[[1]]) == 1)
          return(st_area(st_intersection(dmesh_sf[i, ], domainSPsf)))
        else {
          return(0)
        }
      })
      
      #SAME AS THE GAUSSIAN FIELD UNTIL HERE
      win <- polyCub::as.owin.SpatialPolygons(poly.water)
      npix <- 300
      spatstat.options(npixel = npix)

      beta0 <- -2
      sigma2x <- 0.01
      nu <- 1
  
      #START LOOP FOR SEED
      for (s in 1:length(SS)) { #4->| SS loop
        set.inla.seed = SS[s]
        
        # common for geom 3, and geom 3.2
        set.seed(set.inla.seed) 
        lg.s <- rLGCP('matern', beta0, var = sigma2x,
                   scale = range / sqrt(8), 
                   nu = nu, win = win)

        xy <- cbind(lg.s$x, lg.s$y)
        loc.data <- SpatialPoints(xy)
        loc.data_sf <- st_as_sf(loc.data)

        Lam <- attr(lg.s, 'Lambda')
        rf.s <- log(Lam$v)

        n <- nrow(xy)
        y.pp <- rep(0:1, c(nv, n))
        e.pp <- c(w, rep(0, n)) 
        imat <- Diagonal(nv, rep(1, nv))
        lmat <- inla.spde.make.A(mesh, xy)
        A.pp <- rbind(imat, lmat)
  
        stk.pp <- inla.stack(
          data = list(y = y.pp, e = e.pp), 
          A = list(1, A.pp),
          effects = list(list(b0 = rep(1, nv + n)), list(i = 1:nv)),
          tag = 'pp')
   
        tbm.frac <- list()
        
        
        # FOR geom3.2
        for (p in 1:length(fr)) {
          
          fp <- file.path("plots", paste0("sm", SM[d], "w", W[v], "r", R[r], "seed", SS[s], "fr",fr[p], "/"))
                        dir.create(fp, recursive = TRUE)
          dir.create(fp, recursive = TRUE)
          gif.path = fp
          marginals.path = fp

          f <- fr[p]
          range.fraction <- c(0.01, f)
          tbm.frac[[p]] <- model.tbm.plus.pp(mesh = mesh, fem = fem, 
                               stk.pp = stk.pp,
                               barrier.triangles = barrier.triangles,
                               prior.range = prior.range, prior.sigma = prior.sigma ,  
                               range.fraction = range.fraction,
                               range = range,
                               set.inla.seed = set.inla.seed,
                               loc.data = loc.data,
                               sigma.u = 1, sigma.epsilon = 0.2,
                               poly.original = poly.bar.orginal,
                               prior.range.st = prior.range.st,
                               prior.sigma.st = prior.sigma.st,
                               return.list = TRUE)
          
          trans[[1]] <- tbm.frac[[p]]
          plot.model.tbm.plus.pp.01l(trans, 
                       fr,
                       poly.bar.orginal = poly.bar.orginal,
                       range = range,
                       fps = 1,
                       gif.path = fp)
          
          fpp <- file.path(paste0(marginals.path, "tbm", f, ".png"))
          png(fpp)
          #par(mfrow = c(3, 1))
          tmp = inla.tmarginal(function(x) exp(x), trans[[1]]$pos.tbm$res$marginals.hyperpar[[2]]) 
          plot(tmp, type = "l", xlab = "r", ylab = "Density", xlim = c(0,10))
          xvals = seq(0, 10, length.out=1000)
          abline(v=range, col="blue")
          dev.off()
          
          fpp <- file.path(paste0(marginals.path, "bm", f, ".png"))
          png(fpp)
          tmp = inla.tmarginal(function(x) exp(x), trans[[1]]$pos.bm$res$marginals.hyperpar[[2]]) 
          plot(tmp, type = "l", xlab = "r", ylab = "Density", xlim = c(0,10))
          xvals = seq(0, 10, length.out=1000)
          abline(v=range, col="blue")
          dev.off()
  
          fpp <- file.path(paste0(marginals.path, "st", f, ".png"))
          png(fpp)
          tmp = inla.tmarginal(function(x) (x), trans[[1]]$pos.st$res$marginals.hyperpar[[1]]) 
          plot(tmp, type = "l", xlab = "r", ylab = "Density", xlim = c(0,10))
          xvals = seq(0, 10, length.out=1000)
          abline(v=range, col="blue")
          dev.off()
        }
        
        
      }
    }
  }
}
```

sm0w3r4seed273

```{r}
#2.2
prior.range = c(1, 0.5); prior.sigma = c(1, 0.1)
SM <- c(0)
W <- c(1)
R <- 4
SS <- c(273)
fr <- c(0.01, 0.2, 0.3, 0.4, 0.5,0.7,0.8,1)
#fr <- c(0.01, 0.2, 0.3, 0.4, 0.5,0.7,0.8,1)
      
for (d in 1:length(SM)) {
  for (v in 1:length(W)) {
    for(r in 1:length(R)) { #3->| this 3 loops
      smalldist = SM[d]
      width = c(W[v],W[v])
      range = R[r]        
      max.edge.length = 0.4
      x.mid = 10
      xlim.big  = c(0,20)
      xlim.small = c(3,17)
      ylim.big = c(0,20)
      ylim.small = c(3,17)
      fr = fr
      prior.range = prior.range
      prior.sigma = c(1,0.1)
      sigma.u = 1
      sigma.epsilon = 0.2
      prior.range.st = prior.range
      prior.sigma.st = c(1,0.1)
          
        

      poly1 <- local.square.polygon(xlim=c(xlim.big[1]-1, x.mid-smalldist/2), 
                                    ylim=x.mid+width[1]*c(-.5, .5))

      poly2 <- local.square.polygon(xlim=c(x.mid+smalldist/2, xlim.big[2]+1), 
                                    ylim=x.mid+width[2]*c(-.5, .5))

      poly.original <- SpatialPolygons(c(poly1@polygons, poly2@polygons))
  
      loc1 <- matrix(c(xlim.big[1],ylim.big[1], 
                   xlim.big[2],ylim.big[1], 
                   xlim.big[2],ylim.big[2], 
                   xlim.big[1],ylim.big[2]), 4, 2, byrow = T)
  
      seg <- inla.sp2segment(poly.original)
      mesh <- inla.mesh.2d(loc=loc1, 
                       interior = seg, 
                       max.e = max.edge.length, 
                       offset=1)

      tl <- length(mesh$graph$tv[,1])
      posTri <- matrix(0, tl, 2)

      for (t in 1:tl){
        temp = mesh$loc[mesh$graph$tv[t, ], ]
        posTri[t,] = colMeans(temp)[c(1,2)] 
      }
      
      posTri <- SpatialPoints(posTri)
      bar.original <- over(poly.original, SpatialPoints(posTri), returnList=T)
      bar.original <- unlist(bar.original)
  
      #THIS TAKES A FEW SECONDS AND IT'S ACTUALLY NOT NEEDED IN EVERY LOOP, inla.barrier.polygon
      poly.bar.orginal <- inla.barrier.polygon(mesh, barrier.triangles = bar.original)

      # BARRIER 1
      bar1 <- over(poly1, SpatialPoints(posTri), returnList=T)
      bar1 <- unlist(bar1)

      # BARRIER 2
      bar2 <- over(poly2, SpatialPoints(posTri), returnList=T)
      bar2 <- unlist(bar2)

      mat <-  inla.barrier.fem.plus(mesh, list(bar1, bar2)) 
      fem <- mat 
      barrier.triangles <- list(bar1, bar2)

      # PLOTS
      poly1_h <- local.square.polygon_T(xlim=c(xlim.small[1], x.mid-smalldist/2), 
                                        ylim=x.mid+width[1]*c(-.5, .5))

      poly2_h <- local.square.polygon_T(xlim=c(x.mid+smalldist/2, xlim.small[2]), 
                                        ylim=x.mid+width[2]*c(-.5, .5))

      loc2 <- matrix(c(3,3, 17,3, 17,17, 3,17), 4, 2, byrow = T)

      locp2 <- Polygon(loc2, hole = FALSE)
    
      poly.water <- SpatialPolygons(list(Polygons(list(locp2, poly1_h, poly2_h), '0')))
      poly.water_sf <- st_as_sf(poly.water)
  
      #I'm missing the poly.rect and other that I need for the ggplot, but I don't need it for this loop
      nv <- mesh$n
      dmesh <- book.mesh.dual(mesh)

      domain.polys <- Polygons(list(Polygon(loc1)), '0')
      domainSP <- SpatialPolygons(list(domain.polys))
      domainSPsf <- st_as_sf(domainSP)

      dmesh_sf <- st_as_sf(dmesh) 

      # with sapply
      w <- sapply(1:length(dmesh), function(i) {
        if (length(st_intersects(dmesh_sf[i, ], domainSPsf)[[1]]) == 1)
          return(st_area(st_intersection(dmesh_sf[i, ], domainSPsf)))
        else {
          return(0)
        }
      })
      
      #SAME AS THE GAUSSIAN FIELD UNTIL HERE
      win <- polyCub::as.owin.SpatialPolygons(poly.water)
      npix <- 300
      spatstat.options(npixel = npix)

      beta0 <- -2
      sigma2x <- 0.01
      nu <- 1
  
      #START LOOP FOR SEED
      for (s in 1:length(SS)) {
        set.inla.seed = SS[s]
        
        set.seed(set.inla.seed) 
        lg.s <- rLGCP('matern', beta0, var = sigma2x,
                   scale = range / sqrt(8), 
                   nu = nu, win = win)

        xy <- cbind(lg.s$x, lg.s$y)
        loc.data <- SpatialPoints(xy)
        loc.data_sf <- st_as_sf(loc.data)

        Lam <- attr(lg.s, 'Lambda')
        rf.s <- log(Lam$v)

        n <- nrow(xy)
        y.pp <- rep(0:1, c(nv, n))
        e.pp <- c(w, rep(0, n)) 
        imat <- Diagonal(nv, rep(1, nv))
        lmat <- inla.spde.make.A(mesh, xy)
        A.pp <- rbind(imat, lmat)
  
        stk.pp <- inla.stack(
          data = list(y = y.pp, e = e.pp), 
          A = list(1, A.pp),
          effects = list(list(b0 = rep(1, nv + n)), list(i = 1:nv)),
          tag = 'pp')
   
        tbm.frac <- list()
        
        
        # FOR geom3.2
        for (p in 1:length(fr)) {
          
          fp <- file.path("plots", paste0("sm", SM[d], "w", W[v], "r", R[r], "seed", SS[s], "fr",fr[p], "/"))
                        dir.create(fp, recursive = TRUE)
          dir.create(fp, recursive = TRUE)
          gif.path = fp
          marginals.path = fp

          f <- fr[p]
          range.fraction <- c(0.01, f)
          tbm.frac[[p]] <- model.tbm.plus.pp(mesh = mesh, fem = fem, 
                               stk.pp = stk.pp,
                               barrier.triangles = barrier.triangles,
                               prior.range = prior.range, prior.sigma = prior.sigma ,  
                               range.fraction = range.fraction,
                               range = range,
                               set.inla.seed = set.inla.seed,
                               loc.data = loc.data,
                               sigma.u = 1, sigma.epsilon = 0.2,
                               poly.original = poly.bar.orginal,
                               prior.range.st = prior.range.st,
                               prior.sigma.st = prior.sigma.st,
                               return.list = TRUE)
          
          trans[[1]] <- tbm.frac[[p]]
          plot.model.tbm.plus.pp(trans, 
                       fr,
                       poly.bar.orginal = poly.bar.orginal,
                       range = range,
                       fps = 1,
                       gif.path = fp)
          
          fpp <- file.path(paste0(marginals.path, "tbm", f, ".png"))
          png(fpp)
          #par(mfrow = c(3, 1))
          tmp = inla.tmarginal(function(x) exp(x), trans[[1]]$pos.tbm$res$marginals.hyperpar[[2]]) 
          plot(tmp, type = "l", xlab = "r", ylab = "Density", xlim = c(0,10))
          xvals = seq(0, 10, length.out=1000)
          abline(v=range, col="blue")
          dev.off()
          
          fpp <- file.path(paste0(marginals.path, "bm", f, ".png"))
          png(fpp)
          tmp = inla.tmarginal(function(x) exp(x), trans[[1]]$pos.bm$res$marginals.hyperpar[[2]]) 
          plot(tmp, type = "l", xlab = "r", ylab = "Density", xlim = c(0,10))
          xvals = seq(0, 10, length.out=1000)
          abline(v=range, col="blue")
          dev.off()
  
          fpp <- file.path(paste0(marginals.path, "st", f, ".png"))
          png(fpp)
          tmp = inla.tmarginal(function(x) (x), trans[[1]]$pos.st$res$marginals.hyperpar[[1]]) 
          plot(tmp, type = "l", xlab = "r", ylab = "Density", xlim = c(0,10))
          xvals = seq(0, 10, length.out=1000)
          abline(v=range, col="blue")
          dev.off()
        }
        
        
      }
    }
  }
}




poly.rect <- SpatialPolygons(list(Polygons(list(poly1_h, poly2_h), '0')))
  poly.rect_sf <- st_as_sf(poly.rect)
  poly.sq <- SpatialPolygons(list(Polygons(list(locp2), '0')))
  poly.sq_sf <- st_as_sf(poly.sq)

  sq_bbox <- st_bbox(poly.sq_sf) %>% st_as_sfc()
  poly1_bbox <- st_bbox(poly1) %>% st_as_sfc()
  poly2_bbox <- st_bbox(poly2) %>% st_as_sfc()
  

loc.out <- matrix(c(xlim.big[1],ylim.big[1], 
                 xlim.big[2],ylim.big[1], 
                 xlim.big[2],ylim.big[2], 
                 xlim.big[1],ylim.big[2],
                 xlim.big[1],ylim.big[1]), 5, 2, byrow = T)
loc.out.sp <- SpatialPolygons(list(Polygons(list(Polygon(loc.out, FALSE)), '0')))

loc.in <- matrix(c(xlim.small[1], ylim.small[1],
                   xlim.small[2], xlim.small[1],
                   xlim.small[2], ylim.small[2],
                   xlim.small[1], xlim.small[2],
                   xlim.small[1], ylim.small[1]), 5, 2, byrow = T)
loc.in.sp <- SpatialPolygons(list(Polygons(list(Polygon(loc.in, FALSE)), '0')))

plot(loc.out.sp)
plot(loc.in.sp)

poly.out <- gDifference(loc.out.sp, loc.in.sp)
plot(poly.out, col = alpha("skyblue", 0.5))
poly.out_sf <- st_as_sf(poly.out)

gg.mesh.sim2 <- ggplot() + 
  inlabru::gg(mesh) +
  geom_sf(data =poly.rect_sf,
          col='black', alpha=0) + #alpha color inside rect
  geom_sf(data=poly1_bbox, fill=NA, color="red", linewidth = 0.7) +
  geom_sf(data=poly2_bbox, fill=NA, color="red", linewidth = 0.7) +
  geom_sf(data=sq_bbox, fill=NA, color="black", linewidth = 0.7, linetype = "dashed")

gg.mesh.water.sim2 <- ggplot() +
  inlabru::gg(mesh) +
  geom_sf(data =poly.rect_sf,
          col='black', alpha=1) + #alpha color inside rect
  geom_sf(data=sq_bbox, fill=NA, color="black", linewidth = 0.7) +
  geom_sf(data=poly1_bbox, color="red", linewidth = 0.7, fill = "white") +
  geom_sf(data=poly2_bbox, color="red", linewidth = 0.7, fill = "white") +
  geom_sf(data=poly.out_sf, color="black", linewidth = 0.7, fill = "white",  linetype = "dashed") +
  ylim(c(2, 18)) +
  xlim(c(2, 18)) +
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank())
gg.mesh.sim2; gg.mesh.water.sim2

gg.mesh.data.sim2 <- gg.mesh.water.sim2 +
        geom_sf(data =loc.data_sf,
        col='black',size=1.7,alpha=0.5) 

#sm0w1r4seed273 <- list(trans = tbm.frac, mesh = mesh, gg.mesh.water = gg.mesh.water.sim2, gg.mesh = gg.mesh.sim2, gg.mesh.data = gg.mesh.data.sim2, barrier.triangles = barrier.triangles)
fpp <- file.path("plots/mesh/geom2.2pp.mesh.png")
#png(fpp)

gg.mesh.data.sim2 
      
dev.off()
```


```{r}
```

```{r}
plot.model.tbm.plus.pp.01l.z <- 
  function(trans, 
           fr,
           max.frac = 1,
           poly.bar.orginal = poly.bar.orginal,
           range = range,
           fps = 1,
           set.inla.seed = set.inla.seed,
                              col=alpha('grey', 0),
                              plot.points = points(loc.data, 
                                              pch = 16, 
                                              cex = 0.8, 
                                              col=alpha('gray', 0)),
                              gif.path = "gif.pp/",
                              pal.field = turbo(50),
                              pal.pos.mean = turbo(50),
                              pal.pos.sd = turbo(50),
                              pal.pos.q25 = turbo(50),
                              pal.pos.q50 = turbo(50),
                              pal.pos.q975 = turbo(50),
                              
                              pal.pos.mean.st = turbo(50),
                              pal.pos.sd.st = turbo(50),
                              pal.pos.q25.st = turbo(50),
                              pal.pos.q50.st = turbo(50),
                              pal.pos.q975.st = turbo(50),
                              ...
    ){
#  dir_out_f <- file.path(tempdir(), "truefield_gif")
#  dir.create(dir_out_f, recursive = TRUE)
  
  # t. barrier model
  dir_out_pm.tbm <- file.path(tempdir(), "mean.tbm_gif")
  dir.create(dir_out_pm.tbm, recursive = TRUE)
  
  dir_out_sd.tbm <- file.path(tempdir(), "sd.tbm_gif")
  dir.create(dir_out_sd.tbm, recursive = TRUE)
  
  dir_out_q25.tbm <- file.path(tempdir(), "q25.tbm_gif")
  dir.create(dir_out_q25.tbm, recursive = TRUE)
  
  dir_out_q5.tbm <- file.path(tempdir(), "q5.tbm_gif")
  dir.create(dir_out_q5.tbm, recursive = TRUE)
  
  dir_out_q975.tbm <- file.path(tempdir(), "q975.tbm_gif")
  dir.create(dir_out_q975.tbm, recursive = TRUE)
  
  # barrier model
  dir_out_pm <- file.path(tempdir(), "mean.bm_gif")
  dir.create(dir_out_pm, recursive = TRUE)
  
  dir_out_sd <- file.path(tempdir(), "sd.bm_gif")
  dir.create(dir_out_sd, recursive = TRUE)
  
  dir_out_q25 <- file.path(tempdir(), "q25.bm_gif")
  dir.create(dir_out_q25, recursive = TRUE)
  
  dir_out_q5 <- file.path(tempdir(), "q5.bm_gif")
  dir.create(dir_out_q5, recursive = TRUE)
  
  dir_out_q975 <- file.path(tempdir(), "q975.bm_gif")
  dir.create(dir_out_q975, recursive = TRUE)
  
  # stationary model
  dir_out_s <- file.path(tempdir(), "mean.st_gif")
  dir.create(dir_out_s, recursive = TRUE)
  
  dir_out_st.sd <- file.path(tempdir(), "sd.st_gif")
  dir.create(dir_out_st.sd, recursive = TRUE)
  
  dir_out_st.q25 <- file.path(tempdir(), "q25.st_gif")
  dir.create(dir_out_st.q25, recursive = TRUE)
  
  dir_out_st.q5 <- file.path(tempdir(), "q5.st_gif")
  dir.create(dir_out_st.q5, recursive = TRUE)
  
  dir_out_st.q975 <- file.path(tempdir(), "q975.st_gif")
  dir.create(dir_out_st.q975, recursive = TRUE)
  
  for (r in 1:length(trans)) {
    
    f <- fr[r]
    range.fraction <- c(0.01, f)
    
    ## TBM
    # POSTERIOR MEAN
    fpp <- file.path(dir_out_pm.tbm, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.tbm$res$summary.random$i$mean, zlim = c(-1, 3),
                     main="Spatial estimate for Transparent Barrier model",
                     sub = paste("range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     axes = F, pal = pal.pos.mean)
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()
    
    #POS SD
    fpp <- file.path(dir_out_sd.tbm, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.tbm$res$summary.random$i$sd, 
                     main="Spatial sd estimate for Transparent Barrier model",
                     sub = paste("Barrier Model, range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     axes = F, pal = pal.pos.sd)
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()
    
    #POS QUANTILES
    # 0.025
    fpp <- file.path(dir_out_q25.tbm, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.tbm$res$summary.random$i[,4], 
                     main="Spatial 0.025 quantile estimate for Transparent Barrier model",
                     sub = paste("Barrier Model, range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     axes = F, pal = pal.pos.q25)
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()

    # 0.5
    fpp <- file.path(dir_out_q5.tbm, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.tbm$res$summary.random$i[,5], 
                     main="Spatial 0.5 quantile estimate for Transparent Barrier model",
                     sub = paste("Barrier Model, range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     axes = F, pal = pal.pos.q50)
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()
    
    # 0.975
    fpp <- file.path(dir_out_q975.tbm, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.tbm$res$summary.random$i[,6], 
                     main="Spatial 0.975 quantile estimate for Transparent Barrier model",
                     sub = paste("Barrier Model, range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     axes = F, pal = pal.pos.q975)
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()
    
    ##BM
    fpp <- file.path(dir_out_pm, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.bm$res$summary.random$i$mean, zlim = c(-1, 3),
                     main="Spatial estimate for Barrier model",
                     sub = paste("range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     axes = F, pal = pal.pos.mean)
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()
    
    #POS SD
    fpp <- file.path(dir_out_sd, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.bm$res$summary.random$i$sd, 
                     main="Spatial sd estimate for Barrier model",
                     sub = paste("Barrier Model, range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     axes = F, pal = pal.pos.sd)
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()
    
    #POS QUANTILES
    # 0.025
    fpp <- file.path(dir_out_q25, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.bm$res$summary.random$i[,4], 
                     main="Spatial 0.025 quantile estimate for Barrier model",
                     sub = paste("Barrier Model, range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     axes = F, pal = pal.pos.q25)
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()

    # 0.5
    fpp <- file.path(dir_out_q5, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.bm$res$summary.random$i[,5], 
                     main="Spatial 0.5 quantile estimate for Barrier model",
                     sub = paste("Barrier Model, range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     axes = F, pal = pal.pos.q50)
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()
    
    # 0.975
    fpp <- file.path(dir_out_q975, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.bm$res$summary.random$i[,6], 
                     main="Spatial 0.975 quantile estimate for Barrier model",
                     sub = paste("Barrier Model, range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     axes = F, pal = pal.pos.q975)
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()
    
    # SPATIAL ESTIMATE WITH STATIONARY MODEL
    fpp <- file.path(dir_out_s, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.st$res$summary.random$i$mean, zlim = c(-1, 3),
                     main="Spatial estimate with the stationary model",
                     sub = paste("Barrier Model, range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     axes = F, pal = pal.pos.mean.st) 
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()
    
    #POS SD st
    fpp <- file.path(dir_out_st.sd, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.st$res$summary.random$i$sd, 
                     main="Spatial sd estimate with the stationary model",
                     sub = paste("Barrier Model, range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     axes = F, pal = pal.pos.sd.st)
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()
    
    #POS QUANTILES st
    # 0.025 st
    fpp <- file.path(dir_out_st.q25, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.st$res$summary.random$i[,4], 
                     main="Spatial 0.025 estimate with the stationary model",
                     sub = paste("Barrier Model, range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     axes = F, pal = pal.pos.q25.st)
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()

    # 0.5 st
    fpp <- file.path(dir_out_st.q5, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.st$res$summary.random$i[,5], 
                     main="Spatial 0.5 quantile estimate with the stationary model",
                     sub = paste("Barrier Model, range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     axes = F, pal = pal.pos.q50.st)
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()
    
    # 0.975 st
    fpp <- file.path(dir_out_st.q975, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.st$res$summary.random$i[,6], 
                     main="Spatial 0.975 quantile estimate with the stationary model",
                     sub = paste("Barrier Model, range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     axes = F, pal = pal.pos.q975.st)
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()
  }
    
    ## TBM
    # POSTERIOR MEAN
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_pm.tbm, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "mean.tbm.gif"))
    
    #POS SD
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_sd.tbm, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "sd.tbm.gif"))
    
    #POS QUANTILES
    # 0.025
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_q25.tbm, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "q25.tbm.gif"))
    
    # 0.5
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_q5.tbm, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "q5.tbm.gif"))
    
    # 0.975
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_q975.tbm, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "q975.tbm.gif"))
    
    ## BM
    # POSTERIOR MEAN
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_pm, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "mean.bm.gif"))
    
    #POS SD
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_sd, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "sd.bm.gif"))
    
    #POS QUANTILES
    # 0.025
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_q25, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "q25.bm.gif"))
    
    # 0.5
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_q5, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "q5.bm.gif"))
    
    # 0.975
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_q975, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "q975.bm.gif"))
    
    ## st
    # u
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_s, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "mean.st.gif"))
    
    # st sd
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_st.sd, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "sd.st.gif"))
    
    #POS QUANTILES st
    # 0.025
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_st.q25, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "q25.st.gif"))
    
    # 0.5
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_st.q5, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "q5.st.gif"))
    
    # 0.975
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_st.q975, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "q975.st.gif"))
    
    unlink(dir_out_pm.tbm, recursive = T)
    unlink(dir_out_sd.tbm, recursive = T)
    unlink(dir_out_q25.tbm, recursive = T)
    unlink(dir_out_q5.tbm, recursive = T)
    unlink(dir_out_q975.tbm, recursive = T)
    
    unlink(dir_out_pm, recursive = T)
    unlink(dir_out_sd, recursive = T)
    unlink(dir_out_q25, recursive = T)
    unlink(dir_out_q5, recursive = T)
    unlink(dir_out_q975, recursive = T)
    unlink(dir_out_s, recursive = T)
    unlink(dir_out_st.sd, recursive = T)
    unlink(dir_out_st.q25, recursive = T)
    unlink(dir_out_st.q5, recursive = T)
    unlink(dir_out_st.q975, recursive = T)
}
```


```{r}
plot.model.tbm.plus.pp.01r.z <- 
  function(trans, 
           fr,
           max.frac = 1,
           poly.bar.orginal = poly.bar.orginal,
           range = range,
           fps = 1,
           set.inla.seed = set.inla.seed,
                              col=alpha('grey', 0),
                              plot.points = points(loc.data, 
                                              pch = 16, 
                                              cex = 0.8, 
                                              col=alpha('gray', 0)),
                              gif.path = "gif.pp/",
                              pal.field = turbo(50),
                              pal.pos.mean = turbo(50),
                              pal.pos.sd = turbo(50),
                              pal.pos.q25 = turbo(50),
                              pal.pos.q50 = turbo(50),
                              pal.pos.q975 = turbo(50),
                              
                              pal.pos.mean.st = turbo(50),
                              pal.pos.sd.st = turbo(50),
                              pal.pos.q25.st = turbo(50),
                              pal.pos.q50.st = turbo(50),
                              pal.pos.q975.st = turbo(50),
                              ...
    ){
#  dir_out_f <- file.path(tempdir(), "truefield_gif")
#  dir.create(dir_out_f, recursive = TRUE)
  
  # t. barrier model
  dir_out_pm.tbm <- file.path(tempdir(), "mean.tbm_gif")
  dir.create(dir_out_pm.tbm, recursive = TRUE)
  
  dir_out_sd.tbm <- file.path(tempdir(), "sd.tbm_gif")
  dir.create(dir_out_sd.tbm, recursive = TRUE)
  
  dir_out_q25.tbm <- file.path(tempdir(), "q25.tbm_gif")
  dir.create(dir_out_q25.tbm, recursive = TRUE)
  
  dir_out_q5.tbm <- file.path(tempdir(), "q5.tbm_gif")
  dir.create(dir_out_q5.tbm, recursive = TRUE)
  
  dir_out_q975.tbm <- file.path(tempdir(), "q975.tbm_gif")
  dir.create(dir_out_q975.tbm, recursive = TRUE)
  
  # barrier model
  dir_out_pm <- file.path(tempdir(), "mean.bm_gif")
  dir.create(dir_out_pm, recursive = TRUE)
  
  dir_out_sd <- file.path(tempdir(), "sd.bm_gif")
  dir.create(dir_out_sd, recursive = TRUE)
  
  dir_out_q25 <- file.path(tempdir(), "q25.bm_gif")
  dir.create(dir_out_q25, recursive = TRUE)
  
  dir_out_q5 <- file.path(tempdir(), "q5.bm_gif")
  dir.create(dir_out_q5, recursive = TRUE)
  
  dir_out_q975 <- file.path(tempdir(), "q975.bm_gif")
  dir.create(dir_out_q975, recursive = TRUE)
  
  # stationary model
  dir_out_s <- file.path(tempdir(), "mean.st_gif")
  dir.create(dir_out_s, recursive = TRUE)
  
  dir_out_st.sd <- file.path(tempdir(), "sd.st_gif")
  dir.create(dir_out_st.sd, recursive = TRUE)
  
  dir_out_st.q25 <- file.path(tempdir(), "q25.st_gif")
  dir.create(dir_out_st.q25, recursive = TRUE)
  
  dir_out_st.q5 <- file.path(tempdir(), "q5.st_gif")
  dir.create(dir_out_st.q5, recursive = TRUE)
  
  dir_out_st.q975 <- file.path(tempdir(), "q975.st_gif")
  dir.create(dir_out_st.q975, recursive = TRUE)
  
  for (r in 1:length(trans)) {
    
    f <- fr[r]
    range.fraction <- c(f, 0.01)
    
    ## TBM
    # POSTERIOR MEAN
    fpp <- file.path(dir_out_pm.tbm, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.tbm$res$summary.random$i$mean, zlim = c(-1, 3),
                     main="Spatial estimate for Transparent Barrier model",
                     sub = paste("range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     axes = F, pal = pal.pos.mean)
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()
    
    #POS SD
    fpp <- file.path(dir_out_sd.tbm, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.tbm$res$summary.random$i$sd, 
                     main="Spatial sd estimate for Transparent Barrier model",
                     sub = paste("Barrier Model, range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     axes = F, pal = pal.pos.sd)
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()
    
    #POS QUANTILES
    # 0.025
    fpp <- file.path(dir_out_q25.tbm, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.tbm$res$summary.random$i[,4], 
                     main="Spatial 0.025 quantile estimate for Transparent Barrier model",
                     sub = paste("Barrier Model, range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     axes = F, pal = pal.pos.q25)
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()

    # 0.5
    fpp <- file.path(dir_out_q5.tbm, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.tbm$res$summary.random$i[,5], 
                     main="Spatial 0.5 quantile estimate for Transparent Barrier model",
                     sub = paste("Barrier Model, range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     axes = F, pal = pal.pos.q50)
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()
    
    # 0.975
    fpp <- file.path(dir_out_q975.tbm, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.tbm$res$summary.random$i[,6], 
                     main="Spatial 0.975 quantile estimate for Transparent Barrier model",
                     sub = paste("Barrier Model, range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     axes = F, pal = pal.pos.q975)
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()
    
    ##BM
    fpp <- file.path(dir_out_pm, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.bm$res$summary.random$i$mean, zlim = c(-1, 3),
                     main="Spatial estimate for Barrier model",
                     sub = paste("range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     axes = F, pal = pal.pos.mean)
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()
    
    #POS SD
    fpp <- file.path(dir_out_sd, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.bm$res$summary.random$i$sd, 
                     main="Spatial sd estimate for Barrier model",
                     sub = paste("Barrier Model, range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     axes = F, pal = pal.pos.sd)
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()
    
    #POS QUANTILES
    # 0.025
    fpp <- file.path(dir_out_q25, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.bm$res$summary.random$i[,4], 
                     main="Spatial 0.025 quantile estimate for Barrier model",
                     sub = paste("Barrier Model, range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     axes = F, pal = pal.pos.q25)
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()

    # 0.5
    fpp <- file.path(dir_out_q5, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.bm$res$summary.random$i[,5], 
                     main="Spatial 0.5 quantile estimate for Barrier model",
                     sub = paste("Barrier Model, range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     axes = F, pal = pal.pos.q50)
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()
    
    # 0.975
    fpp <- file.path(dir_out_q975, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.bm$res$summary.random$i[,6], 
                     main="Spatial 0.975 quantile estimate for Barrier model",
                     sub = paste("Barrier Model, range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     axes = F, pal = pal.pos.q975)
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()
    
    # SPATIAL ESTIMATE WITH STATIONARY MODEL
    fpp <- file.path(dir_out_s, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.st$res$summary.random$i$mean, zlim = c(-1, 3),
                     main="Spatial estimate with the stationary model",
                     sub = paste("Barrier Model, range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     axes = F, pal = pal.pos.mean.st) 
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()
    
    #POS SD st
    fpp <- file.path(dir_out_st.sd, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.st$res$summary.random$i$sd, 
                     main="Spatial sd estimate with the stationary model",
                     sub = paste("Barrier Model, range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     axes = F, pal = pal.pos.sd.st)
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()
    
    #POS QUANTILES st
    # 0.025 st
    fpp <- file.path(dir_out_st.q25, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.st$res$summary.random$i[,4], 
                     main="Spatial 0.025 estimate with the stationary model",
                     sub = paste("Barrier Model, range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     axes = F, pal = pal.pos.q25.st)
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()

    # 0.5 st
    fpp <- file.path(dir_out_st.q5, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.st$res$summary.random$i[,5], 
                     main="Spatial 0.5 quantile estimate with the stationary model",
                     sub = paste("Barrier Model, range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     axes = F, pal = pal.pos.q50.st)
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()
    
    # 0.975 st
    fpp <- file.path(dir_out_st.q975, paste0(f, ".png"))
    png(fpp)
    
    local.plot.field(trans[[r]]$pos.st$res$summary.random$i[,6], 
                     main="Spatial 0.975 quantile estimate with the stationary model",
                     sub = paste("Barrier Model, range.fraction = c(", 
                               range.fraction[1], ", ", range.fraction[2], ")"),
                     axes = F, pal = pal.pos.q975.st)
    plot(poly.bar.orginal, add=T, col = col)
    dev.off()
  }
    
    ## TBM
    # POSTERIOR MEAN
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_pm.tbm, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "mean.tbm.gif"))
    
    #POS SD
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_sd.tbm, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "sd.tbm.gif"))
    
    #POS QUANTILES
    # 0.025
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_q25.tbm, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "q25.tbm.gif"))
    
    # 0.5
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_q5.tbm, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "q5.tbm.gif"))
    
    # 0.975
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_q975.tbm, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "q975.tbm.gif"))
    
    ## BM
    # POSTERIOR MEAN
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_pm, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "mean.bm.gif"))
    
    #POS SD
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_sd, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "sd.bm.gif"))
    
    #POS QUANTILES
    # 0.025
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_q25, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "q25.bm.gif"))
    
    # 0.5
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_q5, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "q5.bm.gif"))
    
    # 0.975
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_q975, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "q975.bm.gif"))
    
    ## st
    # u
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_s, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "mean.st.gif"))
    
    # st sd
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_st.sd, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "sd.st.gif"))
    
    #POS QUANTILES st
    # 0.025
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_st.q25, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "q25.st.gif"))
    
    # 0.5
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_st.q5, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "q5.st.gif"))
    
    # 0.975
    image_write(image = image_animate(
      image_join(
        lapply(list.files(dir_out_st.q975, full.names = TRUE), image_read)), 
      fps = fps), 
      path = paste0(gif.path, "q975.st.gif"))
    
    unlink(dir_out_pm.tbm, recursive = T)
    unlink(dir_out_sd.tbm, recursive = T)
    unlink(dir_out_q25.tbm, recursive = T)
    unlink(dir_out_q5.tbm, recursive = T)
    unlink(dir_out_q975.tbm, recursive = T)
    
    unlink(dir_out_pm, recursive = T)
    unlink(dir_out_sd, recursive = T)
    unlink(dir_out_q25, recursive = T)
    unlink(dir_out_q5, recursive = T)
    unlink(dir_out_q975, recursive = T)
    unlink(dir_out_s, recursive = T)
    unlink(dir_out_st.sd, recursive = T)
    unlink(dir_out_st.q25, recursive = T)
    unlink(dir_out_st.q5, recursive = T)
    unlink(dir_out_st.q975, recursive = T)
}
```


stk.pp <- inla.stack(
          data = list(y = y.pp, e = e.pp), 
          A = list(1, A.pp),
          effects = list(list(b0 = rep(1, nv + n)), list(i = 1:nv)),
          tag = 'pp')
   
        tbm.frac <- list()
        
        # FOR geom3
        fp <- file.path("gif.sel/geom3", paste0("sm", SM[d], "wl", Wl[v], "wr", Wr[v], "r", R[r], "seed", SS[s], "/"))
                        dir.create(fp, recursive = TRUE)
        gif.path = fp
        marginals.path = fp

        for (p in 1:length(fr)) { #
          f <- fr[p]
          range.fraction <- c(f, f)
          tbm.frac[[p]] <- model.tbm.plus.pp(mesh = mesh, fem = fem, 
                               stk.pp = stk.pp,
                               barrier.triangles = barrier.triangles,
                               prior.range = prior.range, prior.sigma = prior.sigma ,  
                               range.fraction = range.fraction,
                               range = range,
                               set.inla.seed = set.inla.seed,
                               loc.data = loc.data,
                               sigma.u = 1, sigma.epsilon = 0.2,
                               poly.original = poly.bar.orginal,
                               prior.range.st = prior.range.st,
                               prior.sigma.st = prior.sigma.st,
                               return.list = TRUE)
        }
        trans <- tbm.frac
        trans.geom3 <- trans
        plot.model.tbm.plus.pp(trans, 
                       fr,
                       poly.bar.orginal = poly.bar.orginal,
                       range = range,
                       fps = 1,
                       gif.path = fp)

  
        for (r in 1:length(trans)) {
          f <- fr[p]
          range.fraction <- c(f, f)
          fpp <- file.path(paste0(marginals.path, f, ".png"))
          png(fpp)
          par(mfrow = c(3, 1))
          tmp = inla.tmarginal(function(x) exp(x), trans[[p]]$pos.tbm$res$marginals.hyperpar[[2]]) 
          plot(tmp, type = "l", xlab = "r", ylab = "Density TBM")
          xvals = seq(0, 10, length.out=1000)
          abline(v=range, col="blue")
    
          tmp = inla.tmarginal(function(x) exp(x), trans[[p]]$pos.bm$res$marginals.hyperpar[[2]]) 
          plot(tmp, type = "l", xlab = "r", ylab = "Density BM")
          xvals = seq(0, 10, length.out=1000)
          abline(v=range, col="blue")
  
          tmp = inla.tmarginal(function(x) (x), trans[[p]]$pos.st$res$marginals.hyperpar[[1]]) 
          plot(tmp, type = "l", xlab = "r", ylab = "Density st")
          xvals = seq(0, 10, length.out=1000)
          abline(v=range, col="blue")
          dev.off()
        }
        
        # FOR geom3.2
        fp <- file.path("gif.sel/geom3.2", paste0("sm", SM[d], "wl", Wl[v], "wr", Wr[v], "r", R[r], "seed", SS[s], "/"))
                        dir.create(fp, recursive = TRUE)
        dir.create(fp, recursive = TRUE)
        gif.path = fp
        marginals.path = fp

        for (p in 1:length(fr)) {
          f <- fr[p]
          range.fraction <- c(0.01, f)
          tbm.frac[[p]] <- model.tbm.plus.pp(mesh = mesh, fem = fem, 
                               stk.pp = stk.pp,
                               barrier.triangles = barrier.triangles,
                               prior.range = prior.range, prior.sigma = prior.sigma ,  
                               range.fraction = range.fraction,
                               range = range,
                               set.inla.seed = set.inla.seed,
                               loc.data = loc.data,
                               sigma.u = 1, sigma.epsilon = 0.2,
                               poly.original = poly.bar.orginal,
                               prior.range.st = prior.range.st,
                               prior.sigma.st = prior.sigma.st,
                               return.list = TRUE)
        }
        
        trans <- tbm.frac
        trans.geom3.2 <- trans
        plot.model.tbm.plus.pp.01l(trans, 
                       fr,
                       poly.bar.orginal = poly.bar.orginal,
                       range = range,
                       fps = 1,
                       gif.path = fp)
        
        for (r in 1:length(trans)) {
          f <- fr[p]
          range.fraction <- c(0.01, f)
          fpp <- file.path(paste0(marginals.path, f, ".png"))
          png(fpp)
          par(mfrow = c(3, 1))
          tmp = inla.tmarginal(function(x) exp(x), trans[[p]]$pos.tbm$res$marginals.hyperpar[[2]]) 
          plot(tmp, type = "l", xlab = "r", ylab = "Density TBM")
          xvals = seq(0, 10, length.out=1000)
          abline(v=range, col="blue")
    
          tmp = inla.tmarginal(function(x) exp(x), trans[[p]]$pos.bm$res$marginals.hyperpar[[2]]) 
          plot(tmp, type = "l", xlab = "r", ylab = "Density BM")
          xvals = seq(0, 10, length.out=1000)
          abline(v=range, col="blue")
  
          tmp = inla.tmarginal(function(x) (x), trans[[p]]$pos.st$res$marginals.hyperpar[[1]]) 
          plot(tmp, type = "l", xlab = "r", ylab = "Density st")
          xvals = seq(0, 10, length.out=1000)
          abline(v=range, col="blue")
          
          dev.off()
        }
        
        # FOR geom3.3
        fp <- file.path("gif.sel/geom3.3", paste0("sm", SM[d], "wl", Wl[v], "wr", Wr[v], "r", R[r], "seed", SS[s], "/"))
                        dir.create(fp, recursive = TRUE)
        dir.create(fp, recursive = TRUE)
        gif.path = fp
        marginals.path = fp

        for (p in 1:length(fr)) {
          f <- fr[p]
          range.fraction <- c(f, 0.01)
          tbm.frac[[p]] <- model.tbm.plus.pp(mesh = mesh, fem = fem, 
                               stk.pp = stk.pp,
                               barrier.triangles = barrier.triangles,
                               prior.range = prior.range, prior.sigma = prior.sigma ,  
                               range.fraction = range.fraction,
                               range = range,
                               set.inla.seed = set.inla.seed,
                               loc.data = loc.data,
                               sigma.u = 1, sigma.epsilon = 0.2,
                               poly.original = poly.bar.orginal,
                               prior.range.st = prior.range.st,
                               prior.sigma.st = prior.sigma.st,
                               return.list = TRUE)
        }
        
        trans <- tbm.frac
        trans.geom3.3 <- trans
        plot.model.tbm.plus.pp.01r(trans, 
                       fr,
                       poly.bar.orginal = poly.bar.orginal,
                       range = range,
                       fps = 1,
                       gif.path = fp)
        
        for (r in 1:length(trans)) {
          f <- fr[p]
          range.fraction <- c(f, 0.01)
          fpp <- file.path(paste0(marginals.path, f, ".png"))
          png(fpp)
          par(mfrow = c(3, 1))
          tmp = inla.tmarginal(function(x) exp(x), trans[[p]]$pos.tbm$res$marginals.hyperpar[[2]]) 
          plot(tmp, type = "l", xlab = "r", ylab = "Density TBM")
          xvals = seq(0, 10, length.out=1000)
          abline(v=range, col="blue")
    
          tmp = inla.tmarginal(function(x) exp(x), trans[[p]]$pos.bm$res$marginals.hyperpar[[2]]) 
          plot(tmp, type = "l", xlab = "r", ylab = "Density BM")
          xvals = seq(0, 10, length.out=1000)
          abline(v=range, col="blue")
  
          tmp = inla.tmarginal(function(x) (x), trans[[p]]$pos.st$res$marginals.hyperpar[[1]]) 
          plot(tmp, type = "l", xlab = "r", ylab = "Density st")
          xvals = seq(0, 10, length.out=1000)
          abline(v=range, col="blue")
          
          dev.off()
        }
      }
    }
  }
}

